---
name: 新增/删除数据库功能
change_id: 2026-02-28-database-create-drop
created_at: 2026-02-28T10:00:00Z
updated_at: 2026-02-28T10:00:00Z
---

# 需求审查文档

## 1. 概述

**需求名称**: 新增/删除数据库功能  
**变更 ID**: 2026-02-28-database-create-drop  
**需求来源**: requirements/requirements_change/requirements_change_20.md  
**利益相关者**: 开发者（工具使用者）  
**创建时间**: 2026-02-28  
**最后更新**: 2026-02-28

## 2. 功能需求（FR）

### FR1: 创建数据库

**用户故事**:  
作为数据库管理员，我希望在连接树中右键即可创建数据库，以便无需手动编写 CREATE DATABASE SQL。

**描述**:  
在连接节点（已连接状态）或数据库节点上右键，选择"创建数据库"，弹出对话框填写数据库名称及可选参数（字符集、排序规则），确认后执行 CREATE DATABASE DDL。

**输入**:
- 数据库名称（必填）
- 字符集 / Character Set（MySQL 可选，默认 utf8mb4）
- 排序规则 / Collation（可选）

**输出**:
- 成功：提示创建成功，刷新数据库列表
- 失败：提示错误信息

**前置条件**:
- 连接已建立（状态为 connected）

**后置条件**:
- 新数据库出现在连接树中

**业务规则**:
- BR1: 数据库名称校验
- BR2: SQL 生成规则（按数据库类型）

**验收标准**:
- AC1: MySQL 连接下创建数据库，指定 utf8mb4 字符集和 utf8mb4_general_ci 排序规则，执行成功后数据库列表自动刷新可见
- AC2: SQL Server 连接下创建数据库，指定排序规则，执行成功后数据库列表自动刷新可见
- AC3: 数据库名称为空时提交按钮禁用
- AC4: 数据库名称包含非法字符时前端提示校验错误
- AC5: 数据库名称超长时前端提示校验错误
- AC6: 创建已存在的同名数据库时，后端返回错误并提示用户

**确认项**:
- [ ] [P1-完整性] 字符集/排序规则的可选值来源未定义 - 建议明确：是硬编码常见选项列表，还是通过 SQL 动态查询（如 MySQL `SHOW CHARACTER SET`、`SHOW COLLATION`）
- [ ] [P1-完整性] MySQL 排序规则与字符集的联动关系未定义 - 建议明确：切换字符集后排序规则下拉列表如何更新，默认选中哪个排序规则
- [ ] [P1-完整性] 对话框中未定义"取消"操作的行为 - 建议补充：点击取消或关闭对话框时不执行任何操作
- [ ] [P1-完整性] SQL Server 的 Collation 可选值来源未定义 - 建议明确是否通过 `SELECT * FROM fn_helpcollations()` 动态查询
- [ ] [P2-清晰性] "自动刷新当前连接节点下的数据库列表"未明确刷新范围 - 建议明确：只刷新当前连接节点的子节点，还是整棵树
- [ ] [P2-完整性] 未定义创建数据库对话框是否需要加载中状态（loading） - 建议：执行 DDL 期间禁用确认按钮并显示 loading

### FR2: 删除数据库

**用户故事**:  
作为数据库管理员，我希望在连接树中右键即可删除数据库，以便快速清理不需要的数据库。

**描述**:  
在数据库节点上右键，选择"删除数据库"，弹出确认对话框，显示警告信息和 SQL 预览，用户手动输入数据库名称二次确认后执行 DROP DATABASE DDL。

**输入**:
- 用户手动输入的数据库名称（用于二次确认）

**输出**:
- 成功：提示删除成功，刷新数据库列表，清理关联编辑器状态
- 失败：提示错误信息

**前置条件**:
- 连接已建立
- 目标数据库不是系统数据库

**后置条件**:
- 数据库从服务器中删除
- 连接树刷新，数据库节点消失
- 使用该数据库的编辑器 Tab 的数据库选择被清空

**业务规则**:
- BR3: 系统数据库保护
- BR4: SQL Server 删除前断开活跃连接

**验收标准**:
- AC1: 右键系统数据库时，"删除数据库"菜单项不显示或置灰
- AC2: 确认对话框显示警告文案和 SQL 预览
- AC3: 用户输入的数据库名称与目标不一致时，确认按钮禁用
- AC4: 用户输入正确数据库名称后确认，执行 DROP DATABASE 成功，数据库列表刷新
- AC5: 当前编辑器正在使用被删除的数据库时，自动清空编辑器的数据库选择
- AC6: SQL Server 下删除数据库时，自动先执行 SET SINGLE_USER

**确认项**:
- [ ] [P0-完整性] 删除数据库时，该数据库下如果有活跃的编辑器 session（独占连接），需先销毁这些 session - 建议补充：删除前调用 `destroySessionsByConnection` 或按 database 过滤销毁相关 session
- [ ] [P1-完整性] "清空编辑器的数据库选择"的具体行为未定义 - 建议明确：是将 `selectedDatabase` 设为空字符串，还是弹出提示让用户重新选择
- [ ] [P1-完整性] 未定义删除数据库时如果有其他用户/工具正在使用该数据库的场景 - 对 MySQL 来说如果有活跃连接，DROP DATABASE 也可能失败，建议增加相应错误提示
- [ ] [P1-准确性] SQL Server 的 `ALTER DATABASE SET SINGLE_USER WITH ROLLBACK IMMEDIATE` 需要 sysadmin 或 db_owner 权限 - 建议在文档中说明权限要求，或在执行失败时给出明确的权限不足提示
- [ ] [P1-清晰性] "需用户手动输入数据库名称进行二次确认"未明确是否区分大小写 - 建议明确：MySQL 下不区分大小写，SQL Server 下按照服务器排序规则
- [ ] [P2-清晰性] 系统数据库保护的交互方式未明确 - 建议明确：是不显示菜单项（隐藏）还是显示但置灰并提示原因

## 3. 业务规则（BR）

### BR1: 数据库名称校验
- 不能为空
- 不能包含特殊字符：空格、`.`、`/`、`\`、`:`、`*`、`?`、`"`、`<`、`>`、`|`
- MySQL 长度限制：最长 64 字符
- SQL Server 长度限制：最长 128 字符

### BR2: SQL 生成规则
- MySQL: `CREATE DATABASE \`名称\` CHARACTER SET {charset} COLLATE {collation};`
- SQL Server: `CREATE DATABASE [名称] COLLATE {collation};`
- 字符集和排序规则为空时省略对应子句

### BR3: 系统数据库保护
- MySQL 系统数据库：`mysql`、`information_schema`、`performance_schema`、`sys`
- SQL Server 系统数据库：`master`、`tempdb`、`model`、`msdb`
- 系统数据库不允许删除操作

### BR4: SQL Server 删除前处理
- 删除前执行 `ALTER DATABASE [名称] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;`
- 然后执行 `DROP DATABASE [名称];`

## 4. 数据模型（DM）

本需求不涉及新增数据实体。操作对象为数据库服务器中的 Database，通过 DDL 语句直接操作。

**涉及的现有数据结构**:

| 结构 | 说明 |
|------|------|
| `TreeNodeType` | 需确认是否新增节点类型或复用现有 `database` 类型 |
| `ConnectionTree` 右键菜单 | 需增加 `createDatabase`、`dropDatabase` 菜单项 |
| i18n 资源文件 | 需新增 `contextMenu.createDatabase`、`contextMenu.dropDatabase` 等键值 |

## 5. 异常处理

| 异常场景 | 处理方式 |
|---------|---------|
| 数据库名称为空 | 前端校验，提交按钮禁用 |
| 数据库名称含非法字符 | 前端校验，提示错误 |
| 数据库名称超长 | 前端校验，提示错误 |
| 创建同名数据库 | 后端返回错误（如 `database exists`），前端弹出错误提示 |
| 删除系统数据库 | 前端拦截（不显示或置灰菜单项） |
| 二次确认名称不匹配 | 确认按钮禁用 |
| DROP DATABASE 执行失败（权限不足/活跃连接） | 前端弹出错误提示，显示后端返回的错误信息 |
| DDL 执行超时 | 提示超时错误 |

## 6. 测试策略

### 功能测试
- MySQL 下创建数据库（含字符集/排序规则）
- SQL Server 下创建数据库（含排序规则）
- MySQL 下删除普通数据库
- SQL Server 下删除普通数据库（验证 SINGLE_USER 前置操作）
- 创建后自动刷新连接树
- 删除后自动刷新连接树
- 删除当前编辑器使用的数据库后编辑器状态清理

### 异常测试
- 创建同名数据库
- 名称含特殊字符
- 名称超长
- 删除系统数据库（菜单应被隐藏/禁用）
- 二次确认输入错误名称
- 权限不足时删除数据库

### 交互测试
- 取消创建对话框
- 取消删除确认对话框
- 创建/删除期间的 loading 状态

## 7. 风险评估

### 整体评估
- **P0 问题**: 1 个
- **P1 问题**: 6 个
- **P2 问题**: 3 个
- **整体风险**: 🔴 高
- **建议**: 需先澄清 P0 问题后方可进入设计阶段

### 关键风险点
1. **活跃 session 未清理**（P0-完整性）- 删除数据库时，如果该数据库下有编辑器独占连接（session），不销毁会导致连接泄漏或删除失败
2. **字符集/排序规则来源未定义**（P1-完整性）- 创建数据库对话框中下拉选项的数据来源不明确，影响实现方案选择
3. **SQL Server 权限要求**（P1-准确性）- SET SINGLE_USER 需要特定权限，需明确说明

### 改进建议
1. **立即澄清 P0 问题**：明确删除数据库前的 session 清理策略（建议遍历所有 Tab，销毁使用该数据库的 session）
2. **优化 P1 问题**：明确字符集/排序规则数据来源、交互细节、权限说明
3. **完善 P2 问题**：明确刷新范围、loading 状态、系统数据库保护交互方式

### 进入下一阶段条件
- P0 问题全部解决
- P1 问题解决率 >= 80%
- 整体风险降至 🟢 低 或 🟡 中
