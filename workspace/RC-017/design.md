# RC-017 功能设计：编辑器右键菜单增加"执行"功能

## 1. 功能概述

| 项目 | 内容 |
|------|------|
| 变更ID | RC-017 |
| 功能名称 | 编辑器右键菜单增加"执行"功能 |
| 设计日期 | 2026-01-29 |

### 1.1 功能描述
在 Monaco 编辑器的右键菜单中添加"执行"菜单项，点击后执行选中的 SQL（或全部内容），行为与工具栏执行按钮一致。

---

## 2. 用例设计

### 2.1 正常用例

#### UC-001: 选中 SQL 后右键执行
**前置条件**: 已连接数据库，编辑器中有 SQL 内容
**操作**: 选中部分 SQL → 右键 → 点击"执行"
**预期结果**: 执行选中的 SQL，结果显示在结果面板

#### UC-002: 未选中文本时右键执行
**前置条件**: 已连接数据库，编辑器中有 SQL 内容
**操作**: 不选中任何文本 → 右键 → 点击"执行"
**预期结果**: 执行编辑器全部内容

### 2.2 异常用例

#### UC-003: 未连接数据库时执行
**触发条件**: 未连接数据库
**处理**: 提示"请先连接数据库"
**结果**: 不执行 SQL

#### UC-004: 有未保存修改时执行
**触发条件**: 结果表格有未保存的数据修改
**处理**: 弹出确认对话框
**结果**: 根据用户选择处理

#### UC-005: SQL 语法错误
**触发条件**: SQL 语句有语法错误
**处理**: 显示错误信息
**结果**: 执行失败

### 2.3 边界用例

#### UC-006: 编辑器内容为空
**触发条件**: 编辑器无任何内容
**处理**: 提示"请输入 SQL 语句"

---

## 3. 技术方案

### 3.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        App.vue                               │
│  ┌─────────────────┐    eventBus      ┌─────────────────┐   │
│  │  SqlEditor.vue  │ ──────────────→  │   Toolbar.vue   │   │
│  │                 │  'execute-sql'   │                 │   │
│  │  addAction()    │                  │ handleExecute() │   │
│  └─────────────────┘                  └─────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 实现步骤

1. **eventBus.ts** - 添加 `execute-sql` 事件类型
2. **SqlEditor.vue** - 使用 `editor.addAction()` 注册右键菜单项
3. **Toolbar.vue** - 监听 `execute-sql` 事件，调用 `handleExecute()`

### 3.3 代码变更

#### 3.3.1 eventBus.ts
```typescript
// 添加事件类型
export interface EventBusEvents {
  // ... 现有事件
  'execute-sql': void  // 新增：触发 SQL 执行
}
```

#### 3.3.2 SqlEditor.vue
```typescript
// 在 initEditor() 中添加
editor.addAction({
  id: 'sql.execute',
  label: '执行',
  contextMenuGroupId: 'navigation',
  contextMenuOrder: 0,
  run: () => {
    eventBus.emit('execute-sql')
  }
})
```

#### 3.3.3 Toolbar.vue
```typescript
// 在 onMounted 中添加监听
onMounted(() => {
  eventBus.on('execute-sql', handleExecute)
})

onUnmounted(() => {
  eventBus.off('execute-sql', handleExecute)
})
```

---

## 4. 影响分析

| 文件 | 修改类型 | 风险等级 |
|------|----------|----------|
| `eventBus.ts` | 新增事件类型 | 低 |
| `SqlEditor.vue` | 新增 addAction | 低 |
| `Toolbar.vue` | 新增事件监听 | 低 |

---

## 5. 测试契约

| 编号 | 场景 | 预期结果 |
|------|------|----------|
| TC01 | 右键菜单显示 | 显示"执行"菜单项 |
| TC02 | 未连接时执行 | 提示"请先连接数据库" |
| TC03 | 有未保存修改 | 弹出确认对话框 |
| TC04 | 执行有效 SQL | 正常显示结果 |
| TC05 | 执行无效 SQL | 显示错误信息 |
| TC06 | 未选中时执行 | 执行全部内容 |
