# 需求规格说明书

## 1. 概述

- **需求来源**: requirements/requirements_change/requirements_change_10.md
- **变更 ID**: RC-010
- **变更日期**: 2026-01-22
- **优先级**: P2-中
- **影响范围**: 全栈

## 2. 业务目标

优化 SQL 结果表格的编辑体验和数据展示格式，确保用户在编辑单元格、查看日期类型数据和导出数据时获得一致且友好的体验。

**成功指标**:
- 编辑单元格后保存状态正确管理
- 日期类型数据编辑时按显示格式展示
- BIT 类型数据显示为 true/false
- 导出数据格式与表格显示一致

## 3. 功能性需求（FR）

### FR-001: 编辑后保存状态管理修复

**功能描述**: 修复编辑单元格回车保存后，执行新查询时提示"还没有保存"的问题

**用户场景**: 用户双击单元格编辑内容，按回车确认保存后，数据已成功写入数据库，此时执行新的 SQL 查询不应提示未保存警告

**业务规则**:
- 编辑单元格按回车后，如果数据库更新成功，应清除该行的修改标记
- 执行新查询时，只有真正存在未提交的修改才应提示

**异常处理**:
- 数据库更新失败时，保持修改标记不变

**验收标准**:
- [ ] 正常场景: 编辑单元格→回车保存成功→执行新查询→无警告提示
- [ ] 边界条件: 编辑多个单元格，部分保存成功→只对成功保存的行清除标记
- [ ] 异常情况: 编辑单元格→回车但数据库更新失败→修改标记保留→执行新查询提示未保存

**确认项**: [CLARIFIED]
- 决议: 回车保存成功后自动清除该行的修改标记
- 理由: 数据已持久化到数据库，不需要再提示用户

---

### FR-002: 编辑单元格状态栏提示

**功能描述**: 双击单元格进入编辑模式时，在状态栏显示"编辑后回车保存"提示

**用户场景**: 用户双击可编辑单元格，进入编辑模式，状态栏显示操作提示，帮助用户了解如何保存修改

**输入/输出**: 
- 输入: 双击单元格事件
- 输出: 状态栏显示提示文字

**业务规则**:
- 仅在进入编辑模式时显示提示
- 提示文字: "编辑后回车保存"
- 编辑完成（回车/ESC/失焦）后提示消失

**验收标准**:
- [ ] 正常场景: 双击可编辑单元格→状态栏显示"编辑后回车保存"
- [ ] 边界条件: 双击主键列（不可编辑）→状态栏无编辑提示
- [ ] 异常情况: 非可编辑表格→双击无反应，状态栏无提示

---

### FR-003: 日期类型编辑格式修复

**功能描述**: 双击日期类型单元格时，编辑框中显示格式化后的日期字符串（如 "2026-01-21"），而不是 ISO 格式（如 "2026-01-20T16:00:00.000Z"）

**用户场景**: 用户双击日期/时间类型的单元格，编辑框中显示与表格显示一致的格式，方便用户理解和修改

**业务规则**:
- DATE 类型: 显示为 "YYYY-MM-DD"
- DATETIME/TIMESTAMP 类型: 显示为 "YYYY-MM-DD HH:mm:ss" 或 "YYYY-MM-DD HH:mm:ss.SSS"（有毫秒时）
- TIME 类型: 显示为 "HH:mm:ss" 或 "HH:mm:ss.SSS"
- YEAR 类型: 显示为 "YYYY"
- 编辑值不需要加引号

**验收标准**:
- [ ] 正常场景: 双击 DATE 列单元格→编辑框显示 "2026-01-21" 格式
- [ ] 边界条件: 双击 DATETIME 列（含毫秒）→显示 "2026-01-21 12:30:45.123"
- [ ] 异常情况: 日期值为 NULL→编辑框显示空字符串

---

### FR-004: BIT 类型显示优化

**功能描述**: BIT 类型字段在表格中显示为 "true" 或 "false"，而不是原始的 1/0 或 Buffer 对象

**用户场景**: 用户查询包含 BIT 类型字段的表，表格中直观显示布尔值含义

**业务规则**:
- BIT(1) 类型: 值为 1 或 Buffer [0x01] → 显示 "true"
- BIT(1) 类型: 值为 0 或 Buffer [0x00] → 显示 "false"
- BIT(n>1) 类型: 保持原有显示逻辑（二进制值）
- NULL 值: 显示 "NULL"

**验收标准**:
- [ ] 正常场景: BIT(1) 字段值为 1→表格显示 "true"
- [ ] 边界条件: BIT(1) 字段值为 Buffer [0x00]→表格显示 "false"
- [ ] 异常情况: BIT(1) 字段值为 NULL→表格显示 "NULL"

---

### FR-005: 导出数据格式优化

**功能描述**: 导出数据（CSV/Excel/JSON）时，按表格显示的格式进行导出

**用户场景**: 用户导出查询结果到文件，文件中的数据格式与表格中看到的一致

**业务规则**:
- 日期类型: 导出格式化后的字符串，而非 ISO 格式
- BIT(1) 类型: 导出 "true"/"false"
- NULL 值: 
  - CSV: 导出空字符串
  - JSON: 导出 null
  - Excel: 导出空单元格
- JSON 对象类型: 导出 JSON 字符串

**验收标准**:
- [ ] 正常场景: 导出 CSV→日期列为 "2026-01-21" 格式，BIT 列为 "true"/"false"
- [ ] 正常场景: 导出 Excel→格式与 CSV 一致
- [ ] 正常场景: 导出 JSON→日期为格式化字符串，BIT 为 "true"/"false"

---

## 4. 非功能性需求（NFR）

### NFR-001: 性能要求
- 单元格编辑响应时间 < 100ms
- 导出 10000 行数据 < 5s

### NFR-002: 易用性要求
- 状态栏提示文字清晰可读
- 编辑框内容与显示格式一致，减少用户认知负担

## 5. 验收标准总览

### 功能验收清单
| 序号 | 功能点 | 验收标准 |
|------|--------|----------|
| 1 | 编辑后保存状态 | 回车保存成功后执行新查询无警告 |
| 2 | 状态栏提示 | 编辑模式显示"编辑后回车保存" |
| 3 | 日期编辑格式 | 编辑框显示格式化日期而非 ISO |
| 4 | BIT 类型显示 | BIT(1) 显示为 true/false |
| 5 | 导出格式 | 导出文件格式与表格显示一致 |

### 非功能验收清单
| 序号 | 需求 | 验收标准 |
|------|------|----------|
| 1 | 编辑响应 | < 100ms |
| 2 | 导出性能 | 10000行 < 5s |

## 6. 附录

### 变更历史
| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-22 | 1.0 | 初始版本 |

### 参考文档
- requirements/requirements_change/requirements_change_10.md
