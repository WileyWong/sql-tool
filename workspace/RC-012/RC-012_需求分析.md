# RC-012 Electron原生菜单替换 - 需求分析文档

## 1. 需求概述

将当前使用HTML实现的自定义菜单栏替换为Electron原生菜单，以获得更好的系统一致性和用户体验。

## 2. 现状分析

### 2.1 当前菜单实现

**文件位置**: `src/renderer/components/MenuBar.vue`

**当前菜单结构**:
| 菜单 | 当前功能项 |
|------|-----------|
| 文件(F) | 新建连接、新建查询、最近打开的文件（子菜单）、打开文件、保存、另存为、退出 |
| 编辑(E) | 撤销、重做、剪切、复制、粘贴、查找、替换 |
| 查看(V) | 展开全部、折叠全部、刷新 |
| 查询(Q) | 执行、执行选中、显示执行计划、停止执行 |
| 工具(T) | 选项、导入数据、导出数据 |
| 帮助(H) | 文档、关于 |

### 2.2 当前技术特点

1. **纯Vue组件实现**: 使用Vue 3 + CSS样式模拟菜单行为
2. **主进程隐藏菜单**: `Menu.setApplicationMenu(null)` 已禁用原生菜单
3. **IPC通信已建立**: 文件操作等功能通过IPC与主进程通信

## 3. 目标菜单结构

根据需求变更单，目标菜单结构如下：

### 3.1 文件菜单 (保留)
| 菜单项 | 快捷键 | 功能 |
|--------|--------|------|
| 新建连接 | Ctrl+N | 打开新建连接对话框 |
| 新建查询 | Ctrl+T | 创建新的SQL查询标签页 |
| --- | - | 分隔线 |
| 最近打开的文件 | - | 子菜单，显示最近打开的文件列表 |
| --- | - | 分隔线 |
| 打开文件 | Ctrl+O | 打开文件对话框 |
| 保存 | Ctrl+S | 保存当前文件 |
| 另存为 | Ctrl+Shift+S | 另存为对话框 |
| --- | - | 分隔线 |
| 退出 | Alt+F4 | 退出应用程序 |

### 3.2 编辑菜单 (保留)
| 菜单项 | 快捷键 | 功能实现 |
|--------|--------|----------|
| 撤销 | Ctrl+Z | 触发webContents的undo |
| 重做 | Ctrl+Y | 触发webContents的redo |
| --- | - | 分隔线 |
| 剪切 | Ctrl+X | 触发webContents的cut |
| 复制 | Ctrl+C | 触发webContents的copy |
| 粘贴 | Ctrl+V | 触发webContents的paste |

> 注：移除"查找"和"替换"功能项（可后续单独实现）

### 3.3 查看/查询/工具菜单 (删除)
这三个菜单因功能未完善，暂时删除。

### 3.4 帮助菜单 (保留)
| 菜单项 | 功能 |
|--------|------|
| 关于 | 显示应用版本信息对话框 |

## 4. 变更影响分析

### 4.1 需要修改的文件

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/main/index.ts` | **修改** | 创建Electron原生菜单 |
| `src/renderer/components/MenuBar.vue` | **删除** | 移除HTML菜单组件 |
| `src/renderer/App.vue` | **修改** | 移除MenuBar组件引用 |
| `src/preload/index.ts` | **修改** | 添加菜单相关IPC通道 |
| `src/shared/constants/index.ts` | **修改** | 添加新的IPC通道常量 |

### 4.2 新增文件

| 文件 | 说明 |
|------|------|
| `src/main/menu.ts` | 菜单创建模块 |

### 4.3 功能映射

原有菜单功能需要通过IPC从主进程传递到渲染进程：

| 功能 | IPC通道 | 方向 |
|------|---------|------|
| 新建连接 | menu:new-connection | 主→渲染 |
| 新建查询 | menu:new-query | 主→渲染 |
| 打开文件 | menu:open-file | 主→渲染 |
| 打开最近文件 | menu:open-recent | 主→渲染 |
| 保存 | menu:save | 主→渲染 |
| 另存为 | menu:save-as | 主→渲染 |
| 关于 | menu:about | 主→渲染 |

编辑操作（撤销/重做/剪切/复制/粘贴）直接使用Electron的`role`属性实现，无需IPC。

## 5. 技术方案要点

### 5.1 Electron原生菜单特性

- 使用 `Menu.buildFromTemplate()` 创建菜单
- 使用 `role` 属性实现标准编辑操作
- 子菜单支持动态更新（最近文件列表）
- 支持快捷键绑定

### 5.2 IPC通信设计

```
主进程(Menu点击) → IPC send → 渲染进程(处理业务逻辑)
渲染进程(更新最近文件) → IPC invoke → 主进程(更新菜单)
```

## 6. 风险与注意事项

1. **最近文件菜单动态更新**: 需要在保存/打开文件后更新菜单子项
2. **快捷键冲突**: 确保原生菜单快捷键与编辑器快捷键不冲突
3. **跨平台兼容**: macOS菜单结构与Windows/Linux有差异，需考虑

## 7. 验收标准

1. ✅ 菜单使用Electron原生菜单显示
2. ✅ 文件菜单包含：新建连接、新建查询、最近打开的文件、打开文件、保存、另存为、退出
3. ✅ 编辑菜单包含：撤销、重做、剪切、复制、粘贴，且功能正常
4. ✅ 查看、查询、工具菜单已删除
5. ✅ 帮助菜单只有"关于"选项，点击显示版本信息
