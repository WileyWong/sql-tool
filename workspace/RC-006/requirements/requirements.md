---
change_id: RC-006
stage: requirements
document_type: requirements_specification
author: System
status: final
---

# 需求规格说明书

## 1. 概述

- **需求来源**: requirements/requirements_change/requirements_change_6.md
- **变更 ID**: RC-006
- **变更范围**: 全栈（前端UI优化、后端连接管理、数据处理）
- **变更日期**: 2026-01-12
- **优先级**: P1-高优先级

## 2. 业务目标

### 业务背景
用户在使用SQL工具过程中发现的使用体验问题，影响了工作效率和用户体验。主要问题包括：
- SQL查询结果页签过多导致界面混乱
- 长时间使用后数据库连接断开
- 大量连接时难以快速定位目标
- JSON字段编辑体验不佳
- 数据库结构变更后智能提示不同步

### 用户价值
- **提升效率**: 简化结果页签管理，减少界面混乱
- **增强稳定性**: 改善数据库连接的稳定性，减少重连操作
- **优化体验**: 增强过滤和搜索功能，提升操作便利性
- **改善编辑**: 优化JSON数据编辑体验，提升数据处理效率

### 业务目标
1. 简化SQL查询结果管理，提升界面整洁度
2. 提升长时间使用的系统稳定性
3. 增强用户界面的易用性和便利性
4. 改善数据编辑和智能提示的用户体验

## 3. 功能性需求（FR）

### FR-001: SQL查询结果页签优化

**功能描述**: 每个编辑器只保留一个"结果"页签，新的查询结果覆盖之前的结果，避免页签过多的问题。

**用户场景**: 用户在同一个编辑器中连续执行多个SQL查询时，希望结果显示更加简洁。

**输入/输出**: 
- 输入：SQL查询语句
- 输出：在固定的"结果"页签中显示查询结果

**业务规则**: 
- 每个编辑器只有一个"结果"页签（不再是"结果1"、"结果2"等）
- 新查询结果覆盖旧结果
- 如果旧结果有未保存的修改，需要用户确认

**异常处理**: 
- 有未保存修改时，弹出确认对话框（提交/放弃/取消）

**验收标准**:
- [x] 正常场景: 连续执行两个查询，第二个结果覆盖第一个，页签名称为"结果"
- [x] 边界条件: 结果有修改时执行新查询，弹出确认对话框
- [x] 异常情况: 用户选择取消时，不执行新查询

**确认项**:
- [CLARIFIED] 确认对话框的具体交互方式和文案
  - 决议: 使用现有的修改提交功能逻辑，弹出确认对话框（提交/放弃/取消）
  - 理由: 保持与现有功能的一致性
  - 验收标准: 有未保存修改时弹出三选项确认对话框

- [CLARIFIED] "提交"操作的具体含义
  - 决议: 沿用现有的修改提交功能，JSON类型优化不改变提交逻辑
  - 理由: 保持系统行为的一致性
  - 验收标准: 提交操作按现有逻辑执行UPDATE语句

### FR-002: 数据库连接保活机制

**功能描述**: 解决编辑器长时间打开后连接断开的问题，确保连接的持续可用性。

**用户场景**: 用户打开编辑器连接数据库后，长时间不操作，再次执行SQL时不会出现"Can't add new command when connection is in closed state"错误。

**输入/输出**: 
- 输入：长时间空闲后的SQL执行请求
- 输出：正常执行SQL并返回结果

**业务规则**: 
- 执行SQL前检测连接状态
- 连接断开时自动重连
- 透明的连接恢复，用户无感知

**异常处理**: 
- 连接断开时自动重连
- 重连失败时提示用户具体错误信息

**验收标准**:
- [x] 正常场景: 长时间空闲后仍能正常执行SQL
- [x] 边界条件: 网络中断后能自动恢复连接
- [x] 异常情况: 数据库服务停止时给出明确的错误提示

**确认项**:
- [CLARIFIED] 连接保活的检测间隔和策略
  - 决议: 使用懒加载重连策略（执行时检测并重连）
  - 理由: 避免不必要的网络开销，按需重连
  - 验收标准: 执行SQL时检测连接状态，断开则自动重连

- [CLARIFIED] 重连失败的重试次数和间隔
  - 决议: 执行时检测并重连，失败直接提示用户
  - 理由: 简化逻辑，避免用户长时间等待
  - 验收标准: 重连失败时立即显示错误信息

### FR-003: 编辑器服务器/数据库选择器过滤功能

**功能描述**: 编辑器上方的服务器和数据库下拉选择支持输入过滤，方便用户快速找到目标连接。

**用户场景**: 用户有多个数据库连接时，通过输入关键字快速筛选和选择目标服务器或数据库。

**输入/输出**: 
- 输入：过滤关键字
- 输出：匹配的服务器/数据库列表

**业务规则**: 
- 支持不区分大小写的模糊匹配
- 实时过滤显示
- 保持原有的选择和切换功能

**异常处理**: 
- 无匹配结果时显示空列表或提示信息
- 清空输入时恢复完整列表

**验收标准**:
- [x] 正常场景: 输入关键字后实时显示匹配的选项
- [x] 边界条件: 输入不存在的关键字时显示空列表
- [x] 异常情况: 清空输入时恢复完整列表

**确认项**:
- [CLARIFIED] 过滤匹配的规则
  - 决议: 不区分大小写的模糊匹配，不使用正则表达式
  - 理由: 简单易用，满足大部分使用场景
  - 验收标准: 输入"test"能匹配"TestDB"、"my_test_db"等

### FR-004: 数据库树组件过滤功能

**功能描述**: 左侧数据库树组件支持节点级别的过滤，鼠标悬停时显示过滤按钮，支持多层级过滤：
- 服务器（连接）节点：过滤下级数据库列表
- 数据库节点：过滤下级表、视图、函数等子节点

**用户场景**: 
- 用户有多个数据库时，通过在服务器节点过滤快速找到目标数据库
- 用户在数据库节点下有大量表时，通过过滤快速找到目标表、视图或函数

**输入/输出**: 
- 输入：鼠标悬停服务器/数据库节点，点击过滤按钮，输入过滤关键字
- 输出：匹配的子节点（数据库/表/视图/函数等）

**业务规则**: 
- 鼠标悬停服务器节点时显示"过滤"文字按钮，过滤数据库列表
- 鼠标悬停数据库节点时显示"过滤"文字按钮，过滤表、视图、函数
- 点击后原地变为单行文本框
- 回车键执行过滤，ESC键退出过滤模式
- 每个节点独立维护过滤状态

**异常处理**: 
- 无匹配结果时显示提示信息
- 清空过滤条件时恢复原始显示状态

**验收标准**:
- [x] 正常场景: 悬停服务器节点显示过滤按钮，输入后过滤数据库列表
- [x] 正常场景: 悬停数据库节点显示过滤按钮，输入后过滤子节点
- [x] 边界条件: 在不同节点间切换时，各自保持独立的过滤状态
- [x] 异常情况: 输入无效字符时正常处理，不影响系统稳定性

**确认项**:
- [CLARIFIED] 过滤状态的持久性
  - 决议: 每个树节点独立维护过滤状态，不同树节点分别过滤
  - 理由: 每个节点的过滤需求不同，独立过滤更符合使用习惯
  - 验收标准: 每个服务器/数据库节点都可以独立设置和保持过滤条件

- [CLARIFIED] 过滤按钮的具体样式和位置
  - 决议: 浮动文字"过滤"，点击后变为单行文本框，回车过滤，ESC退出
  - 理由: 简洁直观的交互方式
  - 验收标准: 悬停显示"过滤"文字，点击后原地变为输入框

### FR-005: JSON字段编辑优化

**功能描述**: 优化查询结果中JSON字段的显示和编辑功能，解决当前显示为"[object Object]"无法编辑的问题。

**用户场景**: 用户查询包含JSON字段的数据时，能够正常查看JSON内容并进行编辑操作。

**输入/输出**: 
- 输入：双击JSON字段
- 输出：可编辑的JSON字符串内容（而非[object Object]）

**业务规则**: 
- JSON对象以可读的字符串形式显示
- 编辑方式与其他字符串字段保持一致
- 支持直接编辑JSON内容

**异常处理**: 
- JSON格式错误时，依赖数据库UPDATE操作的错误反馈
- 编辑取消时恢复原始值

**验收标准**:
- [x] 正常场景: 双击JSON字段显示可编辑的字符串内容，而非[object Object]
- [x] 边界条件: 编辑复杂嵌套JSON结构时正常显示和编辑
- [x] 异常情况: 输入无效JSON时，UPDATE操作会返回数据库错误信息

**确认项**:
- [CLARIFIED] JSON编辑器的具体形式
  - 决议: 与其他字符串类型字段保持一致，内联文本框编辑
  - 理由: 保持界面一致性，降低学习成本
  - 验收标准: 双击JSON字段后能像字符串字段一样直接编辑

- [CLARIFIED] JSON格式验证的时机和方式
  - 决议: 不进行前端JSON格式验证，依赖数据库UPDATE时的错误反馈
  - 理由: 简化前端逻辑，数据库是最终验证点
  - 验收标准: 格式错误时UPDATE操作报错并显示数据库错误信息

### FR-006: 数据库元数据同步优化

**功能描述**: 左侧树组件刷新后，SQL编辑器的智能提示能够同步更新表结构信息，解决新增表能提示但列信息不更新的问题。

**用户场景**: 用户在数据库中新增、修改或删除表结构后，在左侧树组件刷新，SQL编辑器中能够获得最新的智能提示。

**输入/输出**: 
- 输入：左侧树组件右键点击"刷新"
- 输出：所有连接到当前数据库的SQL编辑器智能提示更新

**业务规则**: 
- 树组件刷新操作触发元数据同步
- 同步范围包括所有连接到当前数据库的SQL编辑器
- 智能提示包含最新的表名、列名、数据类型等信息
- 支持新增、修改、删除的表结构变更

**异常处理**: 
- 元数据同步失败时使用alert提示具体错误原因
- 同步失败不影响现有的智能提示功能

**验收标准**:
- [x] 正常场景: 刷新后所有相关编辑器能提示新增的表和列
- [x] 边界条件: 删除的表和列不再出现在智能提示中
- [x] 异常情况: 同步失败时显示具体错误信息，不影响现有功能

**确认项**:
- [CLARIFIED] 元数据同步的触发时机和范围
  - 决议: 左侧树组件右键"刷新"时，同步给所有连接到当前数据库的SQL编辑器
  - 理由: 确保所有相关编辑器的智能提示保持同步
  - 验收标准: 刷新后所有相关编辑器的智能提示都能获得最新的表结构信息

- [CLARIFIED] 同步失败时的用户反馈方式
  - 决议: 使用alert直接提示失败原因
  - 理由: 简单直接的错误反馈方式
  - 验收标准: 同步失败时弹出alert显示具体错误信息

## 4. 非功能性需求（NFR）

### 性能要求
- **响应时间**: 过滤操作响应时间 < 200ms
- **连接恢复**: 自动重连操作 < 3秒
- **元数据同步**: 智能提示更新 < 1秒

### 可用性要求
- **连接稳定性**: 长时间空闲后连接恢复成功率 > 95%
- **过滤准确性**: 过滤结果准确率 100%
- **编辑一致性**: JSON字段编辑体验与字符串字段一致

### 易用性要求
- **界面简洁**: 结果页签数量固定为1个
- **操作直观**: 过滤功能易于发现和使用
- **反馈及时**: 错误信息清晰明确

### 兼容性要求
- **向后兼容**: 不影响现有的数据编辑和提交功能
- **数据完整性**: 确保JSON编辑不破坏数据结构

## 5. 验收标准总览

### 功能验收清单
- [ ] FR-001: SQL查询结果页签优化 - 单一"结果"页签，覆盖机制，修改确认
- [ ] FR-002: 数据库连接保活机制 - 懒加载重连，透明恢复
- [ ] FR-003: 编辑器选择器过滤功能 - 模糊匹配，实时过滤
- [ ] FR-004: 数据库树组件过滤功能 - 悬停按钮，独立状态
- [ ] FR-005: JSON字段编辑优化 - 字符串显示，内联编辑
- [ ] FR-006: 数据库元数据同步优化 - 刷新触发，全局同步

### 非功能验收清单
- [ ] 过滤操作响应时间 < 200ms
- [ ] 自动重连操作 < 3秒
- [ ] 智能提示更新 < 1秒
- [ ] 长时间空闲连接恢复成功率 > 95%
- [ ] 界面操作直观易用
- [ ] 错误提示清晰准确

## 6. 附录

### 变更历史
- 2026-01-12: 初始需求创建 (RC-006)
- 2026-01-13: 需求澄清完成，生成最终规格

### 参考文档
- requirements/requirements_change/requirements_change_6.md
- 现有系统的数据编辑和连接管理功能

### 测试用例映射
- TC01 → FR-001: 结果页签覆盖机制
- TC02 → FR-001: 修改确认对话框
- TC03 → FR-002: 长时间连接保活
- TC04 → FR-003: 选择器过滤功能
- TC05 → FR-005: JSON字段编辑
- TC06 → FR-006: 元数据同步更新