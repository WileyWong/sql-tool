---
change_id: 2025-12-19-sql-tool
document_type: feature-design
stage: design
created_at: 2025-12-19
author: AI Assistant
---

# SQL Tool 功能详细设计文档

## 1. 功能分解

### 1.1 功能模块总览

| 模块 | 子功能 | 优先级 | 说明 |
|------|--------|--------|------|
| **M1 连接管理** | 新建连接、编辑连接、删除连接、测试连接 | P0 | 核心功能，无连接无法使用 |
| **M2 数据库浏览** | 连接树展示、展开折叠、刷新、右键菜单 | P0 | 核心功能，数据库结构导航 |
| **M3 SQL 编辑器** | 语法高亮、自动联想、语法检查、多标签页 | P0 | 核心功能，SQL 编写体验 |
| **M4 查询执行** | 执行 SQL、停止执行、执行计划 | P0 | 核心功能，SQL 执行能力 |
| **M5 结果展示** | 结果表格、消息面板、执行计划图 | P0 | 核心功能，结果呈现 |
| **M6 文件管理** | 新建查询、打开文件、保存文件 | P1 | 重要功能，SQL 文件管理 |

### 1.2 功能依赖关系

```
M1 连接管理 ──► M2 数据库浏览 ──► M3 SQL 编辑器（联想依赖数据库结构）
                                        │
                                        ▼
                                  M4 查询执行 ──► M5 结果展示
                                        │
M6 文件管理 ◄──────────────────────────┘
```

---

## 2. M1 连接管理模块

### 2.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F1.1 | 新建连接 | P0 | 创建新的数据库连接配置 |
| F1.2 | 编辑连接 | P0 | 修改已有连接配置 |
| F1.3 | 删除连接 | P0 | 删除连接配置 |
| F1.4 | 测试连接 | P0 | 验证连接配置是否有效 |
| F1.5 | 连接数据库 | P0 | 建立数据库连接 |
| F1.6 | 断开连接 | P0 | 关闭数据库连接 |

### 2.2 F1.1 新建连接

#### 用例设计

**UC-1.1.1 正常用例：成功新建连接**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-1.1.1 |
| **名称** | 成功新建连接 |
| **参与者** | 用户 |
| **前置条件** | 应用已启动 |
| **主流程** | 1. 用户点击"新建连接"按钮<br>2. 系统弹出新建连接对话框<br>3. 用户填写连接信息（名称、服务地址、用户名、密码）<br>4. 用户点击"保存"按钮<br>5. 系统验证输入合法性<br>6. 系统加密密码并保存到本地<br>7. 系统关闭对话框，刷新连接树 |
| **后置条件** | 连接配置已保存，连接树显示新连接 |

**UC-1.1.2 异常用例：必填字段为空**

| 项目 | 内容 |
|------|------|
| **触发条件** | 用户未填写必填字段（名称/服务地址/用户名/密码） |
| **处理流程** | 1. 系统高亮显示空字段<br>2. 显示错误提示"请填写必填字段"<br>3. 阻止保存操作 |
| **结果** | 保存失败，对话框保持打开 |

**UC-1.1.3 异常用例：服务地址格式错误**

| 项目 | 内容 |
|------|------|
| **触发条件** | 服务地址不符合 host:port 格式 |
| **处理流程** | 1. 系统验证服务地址格式<br>2. 显示错误提示"服务地址格式错误，请使用 host:port 格式"<br>3. 阻止保存操作 |
| **结果** | 保存失败，对话框保持打开 |

**UC-1.1.4 异常用例：连接名称重复**

| 项目 | 内容 |
|------|------|
| **触发条件** | 输入的连接名称已存在 |
| **处理流程** | 1. 系统检查名称唯一性<br>2. 显示错误提示"连接名称已存在，请使用其他名称"<br>3. 阻止保存操作 |
| **结果** | 保存失败，对话框保持打开 |

**UC-1.1.5 边界用例：连接名称长度边界**

| 项目 | 内容 |
|------|------|
| **触发条件** | 连接名称长度为 1 字符或 50 字符 |
| **处理流程** | 1. 系统验证名称长度在 1-50 字符范围内<br>2. 验证通过，允许保存 |
| **结果** | 保存成功 |

**UC-1.1.6 边界用例：端口号边界**

| 项目 | 内容 |
|------|------|
| **触发条件** | 端口号为 1 或 65535 |
| **处理流程** | 1. 系统验证端口号在 1-65535 范围内<br>2. 验证通过，允许保存 |
| **结果** | 保存成功 |

**UC-1.1.7 边界用例：省略端口号**

| 项目 | 内容 |
|------|------|
| **触发条件** | 服务地址只填写 host，未填写端口 |
| **处理流程** | 1. 系统检测到未指定端口<br>2. 自动使用默认端口 3306 |
| **结果** | 保存成功，端口默认为 3306 |

#### 输入定义

| 字段 | 类型 | 必填 | 长度 | 格式 | 默认值 | 验证规则 | 示例 |
|------|------|------|------|------|--------|----------|------|
| name | string | 是 | 1-50 | - | - | 非空、唯一、无特殊字符 | "本地开发库" |
| host | string | 是 | 1-255 | hostname/IP | - | 非空、合法主机名或IP | "localhost" |
| port | number | 否 | - | 1-65535 | 3306 | 1-65535 整数 | 3306 |
| username | string | 是 | 1-32 | - | - | 非空 | "root" |
| password | string | 是 | 1-128 | - | - | 非空 | "******" |
| database | string | 否 | 0-64 | - | - | 合法数据库名 | "test_db" |

#### 输出定义

**成功输出**:

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| success | boolean | 操作是否成功 | true |
| connectionId | string | 连接唯一标识 | "conn_1703001234567" |
| message | string | 成功提示 | "连接已保存" |

**失败输出**:

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| E1001 | 请填写必填字段 | 必填字段为空 |
| E1002 | 服务地址格式错误 | 不符合 host:port 格式 |
| E1003 | 端口号必须在 1-65535 范围内 | 端口号超出范围 |
| E1004 | 连接名称已存在 | 名称重复 |
| E1005 | 连接名称过长，最多50字符 | 名称超长 |

### 2.3 F1.4 测试连接

#### 用例设计

**UC-1.4.1 正常用例：测试连接成功**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-1.4.1 |
| **名称** | 测试连接成功 |
| **前置条件** | 用户已填写连接信息 |
| **主流程** | 1. 用户点击"测试连接"按钮<br>2. 系统显示"正在连接..."<br>3. 系统尝试建立数据库连接<br>4. 连接成功，显示"连接成功" |
| **后置条件** | 测试连接关闭，不保持连接状态 |

**UC-1.4.2 异常用例：连接超时**

| 项目 | 内容 |
|------|------|
| **触发条件** | 10 秒内无法建立连接 |
| **处理流程** | 1. 系统等待 10 秒<br>2. 显示错误提示"连接超时，请检查服务地址和网络" |
| **结果** | 测试失败 |

**UC-1.4.3 异常用例：认证失败**

| 项目 | 内容 |
|------|------|
| **触发条件** | 用户名或密码错误 |
| **处理流程** | 1. 数据库返回认证错误<br>2. 显示错误提示"认证失败，请检查用户名和密码" |
| **结果** | 测试失败 |

**UC-1.4.4 异常用例：主机不可达**

| 项目 | 内容 |
|------|------|
| **触发条件** | 无法连接到指定主机 |
| **处理流程** | 1. 网络连接失败<br>2. 显示错误提示"无法连接到服务器，请检查服务地址" |
| **结果** | 测试失败 |

**UC-1.4.5 边界用例：测试连接时字段未填写完整**

| 项目 | 内容 |
|------|------|
| **触发条件** | 必填字段为空时点击测试连接 |
| **处理流程** | 1. 系统先验证必填字段<br>2. 显示错误提示"请先填写必填字段" |
| **结果** | 测试未执行 |

#### 输出定义

**成功输出**:

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| success | boolean | 测试是否成功 | true |
| message | string | 成功提示 | "连接成功" |
| serverVersion | string | 服务器版本 | "8.0.32" |

**失败输出**:

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| E1101 | 连接超时，请检查服务地址和网络 | 连接超时 |
| E1102 | 认证失败，请检查用户名和密码 | 认证错误 |
| E1103 | 无法连接到服务器，请检查服务地址 | 主机不可达 |
| E1104 | 数据库不存在 | 指定的默认数据库不存在 |

---

## 3. M2 数据库浏览模块

### 3.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F2.1 | 连接树展示 | P0 | 树形展示连接和数据库结构 |
| F2.2 | 展开/折叠节点 | P0 | 展开或折叠树节点 |
| F2.3 | 刷新树 | P0 | 刷新整个连接树 |
| F2.4 | 刷新节点 | P1 | 刷新指定节点 |
| F2.5 | 右键菜单 | P0 | 节点右键菜单操作 |

### 3.2 F2.1 连接树展示

#### 用例设计

**UC-2.1.1 正常用例：展示已保存的连接**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-2.1.1 |
| **名称** | 展示已保存的连接 |
| **前置条件** | 存在已保存的连接配置 |
| **主流程** | 1. 应用启动<br>2. 系统加载本地连接配置<br>3. 连接树显示所有已保存的连接（未连接状态） |
| **后置条件** | 连接树显示连接列表 |

**UC-2.1.2 正常用例：展示数据库结构**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-2.1.2 |
| **名称** | 展示数据库结构 |
| **前置条件** | 连接已建立 |
| **主流程** | 1. 用户展开连接节点<br>2. 系统查询数据库列表<br>3. 显示数据库节点<br>4. 用户展开数据库节点<br>5. 显示表、视图、函数等子节点 |
| **后置条件** | 树形展示完整数据库结构 |

**UC-2.1.3 边界用例：无已保存连接**

| 项目 | 内容 |
|------|------|
| **触发条件** | 首次使用，无任何连接配置 |
| **处理流程** | 1. 连接树区域显示空状态提示<br>2. 显示"暂无连接，点击新建连接"<br>3. 点击可触发新建连接 |
| **结果** | 显示空状态引导 |

**UC-2.1.4 异常用例：加载数据库结构失败**

| 项目 | 内容 |
|------|------|
| **触发条件** | 连接断开或权限不足 |
| **处理流程** | 1. 查询数据库结构失败<br>2. 节点显示错误图标<br>3. 提示"加载失败，请检查连接" |
| **结果** | 显示错误状态 |

#### 树结构定义

```
连接名称 (未连接/已连接图标)
├── 数据库1
│   ├── 表
│   │   ├── table1
│   │   └── table2
│   ├── 视图
│   │   └── view1
│   └── 函数
│       └── func1
└── 数据库2
    └── ...
```

#### 节点类型定义

| 节点类型 | 图标 | 可展开 | 右键菜单 |
|----------|------|--------|----------|
| connection | 数据库图标（灰色/绿色） | 是 | 连接/断开、编辑、删除、刷新 |
| database | 数据库图标 | 是 | 刷新 |
| tables | 文件夹图标 | 是 | 刷新 |
| table | 表格图标 | 否 | 查询前100行 |
| views | 文件夹图标 | 是 | 刷新 |
| view | 视图图标 | 否 | 查询 |
| functions | 文件夹图标 | 是 | 刷新 |
| function | 函数图标 | 否 | - |

### 3.3 F2.5 右键菜单

#### 菜单项定义

**连接节点右键菜单**:

| 菜单项 | 条件 | 操作 |
|--------|------|------|
| 连接 | 未连接状态 | 建立数据库连接 |
| 断开连接 | 已连接状态 | 断开数据库连接 |
| 编辑连接 | - | 打开编辑连接对话框 |
| 删除连接 | - | 删除连接配置 |
| 刷新 | 已连接状态 | 刷新数据库结构 |

**表节点右键菜单**:

| 菜单项 | 操作 |
|--------|------|
| 查询前100行 | 在编辑器中打开 `SELECT * FROM table LIMIT 100` |

---

## 4. M3 SQL 编辑器模块

### 4.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F3.1 | 语法高亮 | P0 | SQL 关键字、字符串等高亮显示 |
| F3.2 | 自动联想 | P0 | 智能代码补全 |
| F3.3 | 语法检查 | P0 | 实时语法错误检测 |
| F3.4 | 多标签页 | P0 | 多个 SQL 编辑标签页 |

### 4.2 F3.2 自动联想

#### 用例设计

**UC-3.2.1 正常用例：关键字联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.1 |
| **名称** | SQL 关键字联想 |
| **前置条件** | 编辑器已打开 |
| **主流程** | 1. 用户输入 "sel"<br>2. 系统显示联想列表：SELECT, SET, SHOW...<br>3. 用户按 Tab/Enter 选择<br>4. 系统插入选中的关键字 |
| **后置条件** | 关键字已插入编辑器 |

**UC-3.2.2 正常用例：表名联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.2 |
| **名称** | 表名联想 |
| **前置条件** | 已连接数据库，输入 "SELECT * FROM " |
| **主流程** | 1. 用户输入 "SELECT * FROM "<br>2. 系统显示当前数据库的表、视图列表<br>3. 用户输入 "t" 过滤<br>4. 列表实时更新为 t 开头的表 |
| **后置条件** | 显示过滤后的表名列表 |

**UC-3.2.3 正常用例：字段名联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.3 |
| **名称** | 字段名联想 |
| **前置条件** | 已输入 "SELECT * FROM users WHERE " |
| **主流程** | 1. 光标在 WHERE 后<br>2. 系统显示 users 表的字段列表<br>3. 用户选择字段 |
| **后置条件** | 字段名已插入 |

**UC-3.2.4 正常用例：表别名字段联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.4 |
| **名称** | 表别名字段联想 |
| **前置条件** | 已输入 "SELECT * FROM users u WHERE u." |
| **主流程** | 1. 用户输入 "u."<br>2. 系统识别 u 是 users 表的别名<br>3. 显示 users 表的字段列表 |
| **后置条件** | 显示别名对应表的字段 |

**UC-3.2.5 正常用例：JOIN 表联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.5 |
| **名称** | JOIN 表联想 |
| **前置条件** | 已输入 "SELECT * FROM t1 INNER JOIN " |
| **主流程** | 1. 光标在 JOIN 后<br>2. 系统显示可用表列表 |
| **后置条件** | 显示表列表 |

**UC-3.2.6 正常用例：JOIN ON 字段联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.6 |
| **名称** | JOIN ON 字段联想 |
| **前置条件** | 已输入 "SELECT * FROM t1 INNER JOIN t2 ON " |
| **主流程** | 1. 光标在 ON 后<br>2. 系统识别参与 JOIN 的表（t1, t2）<br>3. 显示 t1 和 t2 的所有字段<br>4. 字段名不唯一时，自动添加表名前缀（如 t1.id, t2.id） |
| **后置条件** | 显示 JOIN 相关表的字段列表 |

**UC-3.2.7 正常用例：子查询字段联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.7 |
| **名称** | 子查询字段联想 |
| **前置条件** | 已输入 "SELECT * FROM (SELECT f1, f2, f3 FROM t1) sub WHERE " |
| **主流程** | 1. 光标在外层 SELECT 的 * 位置或 WHERE 后<br>2. 系统解析子查询的输出字段（f1, f2, f3）<br>3. 显示子查询导出的字段列表 |
| **后置条件** | 显示子查询导出的字段 |

**UC-3.2.8 正常用例：SELECT 列位置字段联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.8 |
| **名称** | SELECT 列位置字段联想 |
| **前置条件** | 已输入 "SELECT * FROM t1"，光标在 * 位置 |
| **主流程** | 1. 用户删除 * 并输入字符<br>2. 系统识别当前位置为 SELECT 列位置<br>3. 系统识别 FROM 子句中的表（t1）<br>4. 显示 t1 表的所有字段和常用函数 |
| **后置条件** | 显示表字段和函数列表 |

**UC-3.2.9 正常用例：DDL 语法联想**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.2.9 |
| **名称** | DDL 语法联想 |
| **前置条件** | 用户输入 DDL 语句开头 |
| **主流程** | 1. 用户输入 "CREATE "<br>2. 系统显示 DDL 对象类型：TABLE, VIEW, INDEX, FUNCTION, PROCEDURE...<br>3. 用户选择 TABLE 后<br>4. 系统提示列定义语法关键字（如 INT, VARCHAR, PRIMARY KEY 等） |
| **后置条件** | 显示 DDL 语法提示 |

**UC-3.2.10 异常用例：未连接数据库**

| 项目 | 内容 |
|------|------|
| **触发条件** | 未连接任何数据库 |
| **处理流程** | 1. 用户输入 "SELECT * FROM "<br>2. 仅显示 SQL 关键字，不显示表名 |
| **结果** | 联想列表仅包含关键字 |

**UC-3.2.11 边界用例：注释区域内**

| 项目 | 内容 |
|------|------|
| **触发条件** | 光标在注释区域内（-- 或 /* */） |
| **处理流程** | 1. 系统检测到光标在注释内<br>2. 不显示联想列表 |
| **结果** | 无联想 |

**UC-3.2.12 边界用例：联想列表为空**

| 项目 | 内容 |
|------|------|
| **触发条件** | 输入的字符无匹配项 |
| **处理流程** | 1. 过滤后无匹配结果<br>2. 联想列表自动关闭 |
| **结果** | 无联想显示 |

#### 联想规则定义

| 上下文 | 联想内容 | 排序规则 |
|--------|----------|----------|
| 语句开始 | SQL 关键字（SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, DROP...） | 字母顺序 |
| FROM 后 | 表名、视图名 | 字母顺序 |
| JOIN 后 | 表名、视图名 | 字母顺序 |
| ON 后（JOIN 语句） | 参与 JOIN 的所有表的字段，字段名冲突时加表名前缀 | 字母顺序 |
| SELECT 列位置（已有 FROM） | FROM 子句中表的字段、常用函数 | 字母顺序 |
| WHERE 后 | FROM 子句中表的字段、函数 | 字母顺序 |
| 表别名. 后 | 该表的字段 | 字母顺序 |
| 子查询外层 | 子查询导出的字段（SELECT 列表中的字段/别名） | 字母顺序 |
| CREATE 后 | DDL 对象类型（TABLE, VIEW, INDEX, FUNCTION, PROCEDURE, TRIGGER） | 字母顺序 |
| CREATE TABLE 列定义 | 数据类型（INT, VARCHAR, TEXT, DATE...）、约束（PRIMARY KEY, NOT NULL, UNIQUE...） | 字母顺序 |
| ALTER TABLE 后 | ALTER 操作（ADD, DROP, MODIFY, CHANGE, RENAME） | 字母顺序 |

#### 联想列表规格

| 属性 | 值 |
|------|-----|
| 最大显示条数 | 20 |
| 触发方式 | 实时自动触发 |
| 确认方式 | Tab/Enter |
| 关闭方式 | Esc/点击其他区域 |
| 过滤方式 | 前缀匹配，不区分大小写 |

### 4.3 F3.3 语法检查

#### 用例设计

**UC-3.3.1 正常用例：检测语法错误**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.3.1 |
| **名称** | 检测语法错误 |
| **前置条件** | 编辑器已打开 |
| **主流程** | 1. 用户输入 "SELEC * FROM users"<br>2. 系统检测到 SELEC 不是有效关键字<br>3. 在 SELEC 下方显示红色波浪线<br>4. 用户悬停查看错误详情 |
| **后置条件** | 显示语法错误标记 |

**UC-3.3.2 正常用例：悬浮显示错误详情**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.3.2 |
| **名称** | 悬浮显示错误详情 |
| **前置条件** | 存在语法错误标记 |
| **主流程** | 1. 用户将鼠标悬停在红色波浪线上<br>2. 系统显示错误提示框<br>3. 提示框包含错误信息 |
| **后置条件** | 显示错误详情 |

**UC-3.3.3 边界用例：多个语法错误**

| 项目 | 内容 |
|------|------|
| **触发条件** | SQL 中存在多个语法错误 |
| **处理流程** | 1. 系统检测所有语法错误<br>2. 每个错误位置都显示红色波浪线 |
| **结果** | 所有错误都被标记 |

#### 错误显示规格

| 属性 | 值 |
|------|-----|
| 错误标记 | 红色波浪线 |
| 悬浮提示 | 错误信息 + 建议修复 |
| 检测时机 | 输入停止 300ms 后 |

### 4.4 F3.4 多标签页

#### 用例设计

**UC-3.4.1 正常用例：新建标签页**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.4.1 |
| **名称** | 新建标签页 |
| **前置条件** | 应用已启动 |
| **主流程** | 1. 用户点击"新建查询"或 Ctrl+N<br>2. 系统创建新标签页<br>3. 标签页命名为"查询N"（N 递增） |
| **后置条件** | 新标签页已创建并激活 |

**UC-3.4.2 正常用例：关闭未保存标签页**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-3.4.2 |
| **名称** | 关闭未保存标签页 |
| **前置条件** | 标签页有未保存的内容 |
| **主流程** | 1. 用户点击关闭按钮<br>2. 系统弹出确认对话框"是否保存更改？"<br>3. 用户选择保存/不保存/取消 |
| **后置条件** | 根据用户选择执行相应操作 |

**UC-3.4.3 边界用例：关闭最后一个标签页**

| 项目 | 内容 |
|------|------|
| **触发条件** | 只剩一个标签页时关闭 |
| **处理流程** | 1. 关闭当前标签页<br>2. 自动创建新的空白标签页"查询1" |
| **结果** | 始终保持至少一个标签页 |

#### 标签页命名规则

| 场景 | 命名规则 |
|------|----------|
| 新建查询 | "查询1"、"查询2"... |
| 打开文件 | 文件名（如 "script.sql"） |
| 保存后 | 更新为保存的文件名 |

---

## 5. M4 查询执行模块

### 5.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F4.1 | 执行 SQL | P0 | 执行 SQL 语句 |
| F4.2 | 停止执行 | P0 | 中断正在执行的查询 |
| F4.3 | 执行计划 | P1 | 获取 SQL 执行计划 |

### 5.2 F4.1 执行 SQL

#### 用例设计

**UC-4.1.1 正常用例：执行单条 SELECT**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-4.1.1 |
| **名称** | 执行单条 SELECT |
| **前置条件** | 已连接数据库，编辑器有 SQL |
| **主流程** | 1. 用户点击"执行"或按 F5<br>2. 系统发送 SQL 到数据库<br>3. 数据库返回结果集<br>4. 结果面板显示数据表格 |
| **后置条件** | 结果面板显示查询结果 |

**UC-4.1.2 正常用例：执行选中的 SQL**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-4.1.2 |
| **名称** | 执行选中的 SQL |
| **前置条件** | 用户选中了部分 SQL 文本 |
| **主流程** | 1. 用户选中部分 SQL<br>2. 点击"执行"<br>3. 系统仅执行选中的 SQL |
| **后置条件** | 仅执行选中部分 |

**UC-4.1.3 正常用例：执行多条 SQL**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-4.1.3 |
| **名称** | 执行多条 SQL |
| **前置条件** | 编辑器有多条 SQL（分号分隔） |
| **主流程** | 1. 用户点击"执行"<br>2. 系统批量执行所有 SQL<br>3. 每个 SELECT 结果显示为独立标签页<br>4. 非查询语句结果显示在消息面板 |
| **后置条件** | 多结果集标签页显示 |

**UC-4.1.4 异常用例：执行遇错停止**

| 项目 | 内容 |
|------|------|
| **触发条件** | 多条 SQL 中某条执行失败 |
| **处理流程** | 1. 执行到错误语句<br>2. 停止执行，后续语句不再执行<br>3. 消息面板显示错误信息<br>4. 已执行成功的结果正常显示 |
| **结果** | 遇错停止，显示错误信息 |

**UC-4.1.5 异常用例：未连接数据库**

| 项目 | 内容 |
|------|------|
| **触发条件** | 未选择任何连接 |
| **处理流程** | 1. 用户点击执行<br>2. 系统提示"请先选择数据库连接" |
| **结果** | 执行失败 |

**UC-4.1.6 异常用例：执行超时**

| 项目 | 内容 |
|------|------|
| **触发条件** | SQL 执行超过 10 分钟 |
| **处理流程** | 1. 系统检测到超时<br>2. 自动中断查询<br>3. 消息面板显示"查询超时" |
| **结果** | 查询被中断 |

**UC-4.1.7 边界用例：空 SQL**

| 项目 | 内容 |
|------|------|
| **触发条件** | 编辑器内容为空或只有空白字符 |
| **处理流程** | 1. 系统检测到无有效 SQL<br>2. 提示"请输入 SQL 语句" |
| **结果** | 不执行 |

**UC-4.1.8 边界用例：结果集超过最大行数**

| 项目 | 内容 |
|------|------|
| **触发条件** | 查询结果超过设定的最大行数（默认 5000） |
| **处理流程** | 1. 系统自动添加 LIMIT 限制<br>2. 消息面板提示"结果已截断，显示前 N 行" |
| **结果** | 显示截断后的结果 |

#### 输入定义

| 字段 | 类型 | 说明 |
|------|------|------|
| sql | string | 要执行的 SQL 语句 |
| connectionId | string | 当前连接 ID |
| maxRows | number | 最大返回行数（默认 5000） |

#### 输出定义

**SELECT 成功输出**:

| 字段 | 类型 | 说明 |
|------|------|------|
| type | string | "resultset" |
| columns | array | 列定义 [{name, type}] |
| rows | array | 数据行 |
| rowCount | number | 返回行数 |
| executionTime | number | 执行时间（ms） |

**非查询成功输出**:

| 字段 | 类型 | 说明 |
|------|------|------|
| type | string | "message" |
| affectedRows | number | 影响行数 |
| message | string | 执行结果描述 |
| executionTime | number | 执行时间（ms） |

**失败输出**:

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| E4001 | 请先选择数据库连接 | 未连接 |
| E4002 | 请输入 SQL 语句 | SQL 为空 |
| E4003 | 查询超时 | 执行超时 |
| E4004 | SQL 语法错误: {detail} | 语法错误 |
| E4005 | 表不存在: {table} | 表不存在 |
| E4006 | 列不存在: {column} | 列不存在 |
| E4007 | 权限不足 | 无执行权限 |

### 5.3 F4.2 停止执行

#### 用例设计

**UC-4.2.1 正常用例：停止正在执行的查询**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-4.2.1 |
| **名称** | 停止执行 |
| **前置条件** | 有正在执行的查询 |
| **主流程** | 1. 用户点击"停止"按钮<br>2. 系统发送 KILL QUERY 命令<br>3. 查询被中断<br>4. 消息面板显示"查询已取消" |
| **后置条件** | 查询已中断，已提交数据不回滚 |

**UC-4.2.2 边界用例：无执行中的查询**

| 项目 | 内容 |
|------|------|
| **触发条件** | 点击停止时无执行中的查询 |
| **处理流程** | 停止按钮为禁用状态，无法点击 |
| **结果** | 无操作 |

### 5.4 F4.3 执行计划

#### 用例设计

**UC-4.3.1 正常用例：获取执行计划**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-4.3.1 |
| **名称** | 获取执行计划 |
| **前置条件** | 已连接数据库，有 SELECT 语句 |
| **主流程** | 1. 用户点击"执行计划"按钮<br>2. 系统执行 EXPLAIN 命令<br>3. "执行计划"标签页显示流程图<br>4. "结果"标签页显示 EXPLAIN 表格 |
| **后置条件** | 显示执行计划 |

**UC-4.3.2 异常用例：非 SELECT 语句**

| 项目 | 内容 |
|------|------|
| **触发条件** | SQL 不是 SELECT 语句 |
| **处理流程** | 1. 系统检测 SQL 类型<br>2. 提示"执行计划仅支持 SELECT 语句" |
| **结果** | 不执行 |

---

## 6. M5 结果展示模块

### 6.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F5.1 | 结果表格 | P0 | 表格形式展示查询结果 |
| F5.2 | 消息面板 | P0 | 显示执行消息和错误 |
| F5.3 | 执行计划图 | P1 | 流程图形式展示执行计划 |
| F5.4 | 多结果集标签页 | P0 | 多个结果集切换 |

### 6.2 F5.1 结果表格

#### 用例设计

**UC-5.1.1 正常用例：显示查询结果**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.1.1 |
| **名称** | 显示查询结果 |
| **前置条件** | SELECT 查询执行成功 |
| **主流程** | 1. 查询返回结果<br>2. 结果面板创建表格<br>3. 表头显示列名<br>4. 表格显示数据行 |
| **后置条件** | 结果表格显示完整 |

**UC-5.1.2 边界用例：空结果集**

| 项目 | 内容 |
|------|------|
| **触发条件** | 查询返回 0 行 |
| **处理流程** | 1. 显示空表格（仅表头）<br>2. 消息面板显示"查询返回 0 行" |
| **结果** | 显示空结果 |

**UC-5.1.3 边界用例：大量列**

| 项目 | 内容 |
|------|------|
| **触发条件** | 结果集有很多列（>20） |
| **处理流程** | 1. 表格支持横向滚动<br>2. 所有列都可查看 |
| **结果** | 可滚动查看所有列 |

#### 表格规格

| 属性 | 值 |
|------|-----|
| 列宽 | 自适应内容，可拖拽调整 |
| 行高 | 固定高度 |
| 滚动 | 支持横向和纵向滚动 |
| 选择 | 支持单元格选择和复制 |

### 6.3 F5.4 多结果集标签页

#### 用例设计

**UC-5.4.1 正常用例：多结果集显示**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.4.1 |
| **名称** | 多结果集显示 |
| **前置条件** | 执行多条 SELECT 语句 |
| **主流程** | 1. 执行 3 条 SELECT<br>2. 创建"结果1"、"结果2"、"结果3"标签页<br>3. 每个标签页显示对应结果 |
| **后置条件** | 可切换查看各结果集 |

#### 标签页命名规则

| 结果类型 | 标签页名称 |
|----------|------------|
| 第 1 个 SELECT | 结果1 |
| 第 2 个 SELECT | 结果2 |
| 执行计划 | 执行计划 |
| 消息 | 消息 |

---

## 7. M6 文件管理模块

### 7.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F6.1 | 新建查询 | P1 | 创建新的 SQL 编辑标签页 |
| F6.2 | 打开文件 | P1 | 打开本地 SQL 文件 |
| F6.3 | 保存文件 | P1 | 保存 SQL 到本地文件 |

### 7.2 F6.3 保存文件

#### 用例设计

**UC-6.3.1 正常用例：保存新文件**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-6.3.1 |
| **名称** | 保存新文件 |
| **前置条件** | 标签页内容未保存过 |
| **主流程** | 1. 用户按 Ctrl+S 或点击保存<br>2. 系统弹出"另存为"对话框<br>3. 用户选择路径和文件名<br>4. 系统保存文件<br>5. 标签页名称更新为文件名 |
| **后置条件** | 文件已保存 |

**UC-6.3.2 正常用例：保存已有文件**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-6.3.2 |
| **名称** | 保存已有文件 |
| **前置条件** | 文件已有保存路径 |
| **主流程** | 1. 用户按 Ctrl+S<br>2. 系统直接保存到原路径<br>3. 显示"已保存"提示 |
| **后置条件** | 文件已更新 |

**UC-6.3.3 异常用例：保存失败**

| 项目 | 内容 |
|------|------|
| **触发条件** | 文件路径不可写或磁盘已满 |
| **处理流程** | 1. 保存操作失败<br>2. 显示错误提示"保存失败: {原因}" |
| **结果** | 保存失败 |

---

## 8. 错误处理设计

### 8.1 错误码定义

#### 客户端错误 (E1xxx - E4xxx)

| 错误码 | 类别 | 错误信息 | 处理建议 |
|--------|------|----------|----------|
| E1001 | 连接 | 请填写必填字段 | 检查必填字段 |
| E1002 | 连接 | 服务地址格式错误 | 使用 host:port 格式 |
| E1003 | 连接 | 端口号必须在 1-65535 范围内 | 修正端口号 |
| E1004 | 连接 | 连接名称已存在 | 使用其他名称 |
| E1005 | 连接 | 连接名称过长 | 缩短名称 |
| E1101 | 测试 | 连接超时 | 检查网络和服务地址 |
| E1102 | 测试 | 认证失败 | 检查用户名密码 |
| E1103 | 测试 | 无法连接到服务器 | 检查服务地址 |
| E1104 | 测试 | 数据库不存在 | 检查数据库名 |
| E2001 | 浏览 | 加载数据库结构失败 | 检查连接和权限 |
| E3001 | 编辑 | 无法获取表结构 | 检查连接 |
| E4001 | 执行 | 请先选择数据库连接 | 选择连接 |
| E4002 | 执行 | 请输入 SQL 语句 | 输入 SQL |
| E4003 | 执行 | 查询超时 | 优化 SQL 或增加超时时间 |
| E4004 | 执行 | SQL 语法错误 | 修正 SQL |
| E4005 | 执行 | 表不存在 | 检查表名 |
| E4006 | 执行 | 列不存在 | 检查列名 |
| E4007 | 执行 | 权限不足 | 联系管理员 |

#### 系统错误 (E5xxx)

| 错误码 | 错误信息 | 处理建议 |
|--------|----------|----------|
| E5001 | 配置文件读取失败 | 重启应用 |
| E5002 | 配置文件写入失败 | 检查磁盘空间和权限 |
| E5003 | 加密失败 | 重启应用 |
| E5004 | 解密失败 | 配置文件可能已损坏 |

### 8.2 错误信息设计原则

1. **用户友好**: 使用用户可理解的语言，避免技术术语
2. **清晰明确**: 说明错误原因和解决方案
3. **安全性**: 不暴露敏感信息（如完整连接字符串、密码）
4. **一致性**: 同类错误使用统一格式

### 8.3 重试机制

| 场景 | 重试策略 |
|------|----------|
| 连接超时 | 自动重试 3 次，间隔 1s/2s/4s |
| 查询超时 | 不自动重试，用户手动重试 |
| 网络断开 | 自动重连 3 次 |
| 文件保存失败 | 不自动重试，提示用户 |

---

## 9. 功能间交互设计

### 9.1 交互流程

#### 9.1.1 新建连接到执行查询流程

```
用户点击新建连接
    │
    ▼
ConnectionDialog 打开
    │
    ▼
用户填写连接信息 ──► 点击测试连接 ──► 显示测试结果
    │
    ▼
点击保存
    │
    ▼
connection store 保存连接 ──► IPC ──► main/storage 加密存储
    │
    ▼
ConnectionTree 刷新显示新连接
    │
    ▼
用户双击连接
    │
    ▼
connection store 建立连接 ──► IPC ──► main/database 连接数据库
    │
    ▼
加载数据库结构 ──► 更新 dbTree
    │
    ▼
用户在 SqlEditor 输入 SQL
    │
    ▼
触发自动联想 ──► 从 dbTree 获取表/字段信息
    │
    ▼
用户点击执行
    │
    ▼
editor store 获取 SQL ──► IPC ──► main/database 执行查询
    │
    ▼
result store 接收结果 ──► ResultPanel 显示
```

### 9.2 数据传递方式

| 场景 | 方式 | 说明 |
|------|------|------|
| 渲染进程 → 主进程 | IPC (invoke) | 同步请求响应 |
| 主进程 → 渲染进程 | IPC (send) | 异步通知 |
| 组件间通信 | Pinia Store | 状态共享 |

### 9.3 状态同步

| 状态 | 存储位置 | 同步方式 |
|------|----------|----------|
| 连接列表 | connection store + 本地文件 | 启动时加载，变更时保存 |
| 当前连接 | connection store | 内存状态 |
| 数据库结构 | connection store | 连接时加载，刷新时更新 |
| 编辑器内容 | editor store | 内存状态 |
| 查询结果 | result store | 内存状态 |

---

## 11. 需求变更功能设计 (2025-12-22)

### 11.1 F2.6 双击切换数据库

#### 用例设计

**UC-2.6.1 正常用例：双击切换数据库**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-2.6.1 |
| **名称** | 双击切换数据库 |
| **前置条件** | 连接已建立，数据库树已展开 |
| **主流程** | 1. 用户双击数据库节点<br>2. 系统设置该数据库为当前查询数据库<br>3. 该数据库节点高亮显示<br>4. 后续查询使用该数据库 |
| **后置条件** | 当前数据库已切换，CSS 高亮显示 |

**UC-2.6.2 边界用例：双击非数据库节点**

| 项目 | 内容 |
|------|------|
| **触发条件** | 用户双击表节点或连接节点 |
| **处理流程** | 1. 系统检测节点类型<br>2. 非数据库节点不触发切换 |
| **结果** | 无操作 |

### 11.2 F2.7 CSS 高亮显示

#### 样式定义

| 节点类型 | 选中状态样式 |
|----------|--------------|
| 服务器连接 | 青色文字（#00bcd4）、加粗字体 |
| 数据库 | 高亮背景色（#e3f2fd）、左侧边框指示 |

#### CSS 类定义

```css
.current-connection {
  color: #00bcd4;
  font-weight: bold;
}

.current-database {
  background-color: #e3f2fd;
  border-left: 3px solid #2196f3;
}
```

### 11.3 F5.5 单元格可编辑功能

#### 功能清单

| 功能 ID | 功能名称 | 优先级 | 说明 |
|---------|----------|--------|------|
| F5.5.1 | 单表查询检测 | P0 | 判断查询是否为单表 SELECT |
| F5.5.2 | 主键检测 | P0 | 获取表的主键列信息 |
| F5.5.3 | 可编辑标记 | P0 | 标记结果集是否可编辑 |
| F5.5.4 | 单元格编辑 | P0 | 双击进入编辑模式 |
| F5.5.5 | 提交更新 | P0 | 回车生成并执行 UPDATE |
| F5.5.6 | 取消编辑 | P0 | ESC 恢复原值 |

#### 用例设计

**UC-5.5.1 正常用例：编辑单元格并提交**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.5.1 |
| **名称** | 编辑单元格并提交 |
| **前置条件** | 单表查询结果已显示，表有主键 |
| **主流程** | 1. 用户双击非主键列单元格<br>2. 单元格进入编辑模式，显示输入框<br>3. 用户修改值<br>4. 用户按回车<br>5. 系统生成 UPDATE 语句<br>6. 系统执行 UPDATE<br>7. 更新成功，单元格显示新值 |
| **后置条件** | 数据库数据已更新，界面显示新值 |

**UC-5.5.2 正常用例：取消编辑**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.5.2 |
| **名称** | 取消编辑 |
| **前置条件** | 单元格处于编辑模式 |
| **主流程** | 1. 用户按 ESC<br>2. 系统退出编辑模式<br>3. 单元格恢复原值显示 |
| **后置条件** | 数据未修改，显示原值 |

**UC-5.5.3 异常用例：UPDATE 执行失败**

| 项目 | 内容 |
|------|------|
| **触发条件** | UPDATE 语句执行失败（约束冲突、权限不足等） |
| **处理流程** | 1. 系统捕获错误<br>2. 显示错误提示<br>3. 单元格恢复原值<br>4. 退出编辑模式 |
| **结果** | 数据未修改，显示错误信息 |

**UC-5.5.4 边界用例：双击主键列**

| 项目 | 内容 |
|------|------|
| **触发条件** | 用户双击主键列单元格 |
| **处理流程** | 1. 系统检测到是主键列<br>2. 不进入编辑模式<br>3. 主键列显示 🔑 图标标识 |
| **结果** | 主键列不可编辑 |

**UC-5.5.5 边界用例：多表 JOIN 查询**

| 项目 | 内容 |
|------|------|
| **触发条件** | 执行 JOIN 查询 |
| **处理流程** | 1. 系统检测到多表查询<br>2. 结果集标记为不可编辑<br>3. 双击单元格无响应 |
| **结果** | 不支持编辑 |

**UC-5.5.6 边界用例：无主键表**

| 项目 | 内容 |
|------|------|
| **触发条件** | 单表查询，但表无主键 |
| **处理流程** | 1. 系统检测到无主键<br>2. 结果集标记为不可编辑 |
| **结果** | 不支持编辑 |

**UC-5.5.7 边界用例：子查询**

| 项目 | 内容 |
|------|------|
| **触发条件** | SELECT 包含子查询 |
| **处理流程** | 1. 系统检测到子查询<br>2. 结果集标记为不可编辑 |
| **结果** | 不支持编辑 |

**UC-5.5.8 边界用例：聚合函数查询**

| 项目 | 内容 |
|------|------|
| **触发条件** | SELECT 包含 COUNT/SUM/AVG 等聚合函数 |
| **处理流程** | 1. 系统检测到聚合查询<br>2. 结果集标记为不可编辑 |
| **结果** | 不支持编辑 |

#### 单表查询检测规则

**可编辑条件**（必须全部满足）:
1. 仅查询单个表（无 JOIN）
2. 无子查询
3. 无 UNION/INTERSECT/EXCEPT
4. 无 GROUP BY
5. 无聚合函数（COUNT/SUM/AVG/MAX/MIN）
6. 表存在主键

**SQL 解析正则**:
```javascript
// 单表 SELECT 模式
const singleTablePattern = /^\s*SELECT\s+.+\s+FROM\s+`?(\w+)`?(\s+AS\s+\w+)?(\s+WHERE\s+.+)?(\s+ORDER\s+BY\s+.+)?(\s+LIMIT\s+\d+)?(\s+OFFSET\s+\d+)?\s*;?\s*$/i

// 排除模式
const excludePatterns = [
  /\bJOIN\b/i,           // JOIN
  /\bUNION\b/i,          // UNION
  /\bGROUP\s+BY\b/i,     // GROUP BY
  /\bHAVING\b/i,         // HAVING
  /\(\s*SELECT\b/i,      // 子查询
  /\b(COUNT|SUM|AVG|MAX|MIN)\s*\(/i  // 聚合函数
]
```

#### 输入定义

**updateCell 参数**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| connectionId | string | 是 | 连接 ID |
| database | string | 是 | 数据库名 |
| table | string | 是 | 表名 |
| primaryKeyValues | object | 是 | 主键列名和值的映射 |
| column | string | 是 | 要更新的列名 |
| newValue | any | 是 | 新值 |

#### 输出定义

**成功输出**:

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | true |
| message | string | "更新成功" |
| affectedRows | number | 影响行数（应为 1） |

**失败输出**:

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| E5501 | 更新失败：数据已被其他用户修改 | 并发冲突 |
| E5502 | 更新失败：违反约束条件 | 约束冲突 |
| E5503 | 更新失败：权限不足 | 无 UPDATE 权限 |
| E5504 | 更新失败：连接已断开 | 连接丢失 |

### 11.4 F5.6 导出功能

#### 用例设计

**UC-5.6.1 正常用例：导出为 CSV**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.6.1 |
| **名称** | 导出为 CSV |
| **前置条件** | 有查询结果 |
| **主流程** | 1. 用户点击"导出 CSV"按钮<br>2. 系统弹出保存对话框<br>3. 用户选择保存路径<br>4. 系统生成 CSV 文件<br>5. 显示"导出成功"提示 |
| **后置条件** | CSV 文件已保存 |

**UC-5.6.2 正常用例：导出为 JSON**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-5.6.2 |
| **名称** | 导出为 JSON |
| **前置条件** | 有查询结果 |
| **主流程** | 1. 用户点击"导出 JSON"按钮<br>2. 系统弹出保存对话框<br>3. 用户选择保存路径<br>4. 系统生成 JSON 文件<br>5. 显示"导出成功"提示 |
| **后置条件** | JSON 文件已保存 |

**UC-5.6.3 边界用例：无查询结果**

| 项目 | 内容 |
|------|------|
| **触发条件** | 结果集为空或无结果 |
| **处理流程** | 导出按钮禁用或提示"无数据可导出" |
| **结果** | 不执行导出 |

#### 导出格式定义

**CSV 格式**:
```csv
column1,column2,column3
value1,value2,value3
"value with,comma","value with ""quote""",value3
```

**JSON 格式**:
```json
{
  "columns": ["column1", "column2", "column3"],
  "data": [
    {"column1": "value1", "column2": "value2", "column3": "value3"}
  ],
  "exportTime": "2025-12-22T10:00:00Z",
  "rowCount": 1
}
```

### 11.5 F6.4 保存快捷键

#### 用例设计

**UC-6.4.1 正常用例：Ctrl+S 保存**

| 项目 | 内容 |
|------|------|
| **用例 ID** | UC-6.4.1 |
| **名称** | Ctrl+S 保存 |
| **前置条件** | 编辑器有内容 |
| **主流程** | 1. 用户按 Ctrl+S（Windows）或 Cmd+S（Mac）<br>2. 触发保存操作（同 F6.3） |
| **后置条件** | 文件已保存 |

#### 快捷键定义

| 快捷键 | 平台 | 功能 |
|--------|------|------|
| Ctrl+S | Windows/Linux | 保存当前查询 |
| Cmd+S | macOS | 保存当前查询 |

---

## 12. 质量检查清单（更新）

### 12.1 功能分解验证

- [x] 主要功能模块已识别（6 个模块 + 5 个变更功能）
- [x] 每个功能已分解为子功能
- [x] 功能优先级已明确（P0/P1）
- [x] 功能边界清晰，无重叠

### 12.2 用例设计验证

- [x] 每个功能都有正常用例（≥ 1 个）
- [x] 每个功能都有异常用例（≥ 3 个）
- [x] 每个功能都有边界用例（≥ 3 个）
- [x] 用例描述清晰、完整
- [x] 变更功能用例已补充（F2.6/F2.7/F5.5/F5.6/F6.4）

### 12.3 输入输出验证

- [x] 每个功能的输入已定义
- [x] 每个功能的成功输出已定义
- [x] 每个功能的失败输出已定义
- [x] 数据格式已统一
- [x] updateCell API 输入输出已定义

### 12.4 错误处理验证

- [x] 错误码已定义（20+ 个，含 E55xx 新增）
- [x] 错误信息用户友好
- [x] 重试机制已设计
