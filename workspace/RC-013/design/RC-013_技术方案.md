---
change_id: RC-013
stage: design
document_type: technical_design
status: final
---

# RC-013 æŠ€æœ¯æ–¹æ¡ˆ - è¡¨å Hover åŠŸèƒ½å¢å¼º

## 1. æ¦‚è¿°

### 1.1 è®¾è®¡ç›®æ ‡
å®ç° SQL ç¼–è¾‘å™¨ä¸­è¡¨å hover åŠŸèƒ½çš„å¢å¼ºï¼ŒåŒ…æ‹¬ï¼š
- æ˜¾ç¤ºå®Œæ•´å­—æ®µåˆ—è¡¨ï¼ˆæ”¯æŒæ»šåŠ¨ï¼‰
- è¡¨åå¯ç‚¹å‡»æ‰“å¼€è¡¨ç®¡ç†å¯¹è¯æ¡†
- æ˜¾ç¤ºä¸»é”®æ ‡è¯†å’Œå­—æ®µæ³¨é‡Š
- çŠ¶æ€æ æ˜¾ç¤ºæ“ä½œæç¤º

### 1.2 æŠ€æœ¯çº¦æŸ
- ä½¿ç”¨ Monaco Editor çš„ HoverProvider API
- å¤ç”¨ç°æœ‰ TableManageDialog.vue ç»„ä»¶
- å¤ç”¨ç°æœ‰ connection store ä¸­çš„ openTableManageDialog æ–¹æ³•
- ä¿æŒä¸ç°æœ‰æ·±è‰²ä¸»é¢˜é£æ ¼ä¸€è‡´

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Monaco Editor                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     Hover Provider                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ HoverProvider.tsâ”‚â”€â”€â”€â–¶â”‚ Markdown with HTML + onclick â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ (Main Process)  â”‚    â”‚ (æ”¯æŒç‚¹å‡»çš„ Markdown å†…å®¹)     â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  useLanguageServer.ts                       â”‚ â”‚
â”‚  â”‚  - æ¥æ”¶ hover ç»“æœ                                          â”‚ â”‚
â”‚  â”‚  - å¤„ç†ç‚¹å‡»äº‹ä»¶ (é€šè¿‡ command æœºåˆ¶)                          â”‚ â”‚
â”‚  â”‚  - é€šçŸ¥ StatusBar æ˜¾ç¤ºæç¤º                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Renderer Components                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   StatusBar.vue     â”‚   â”‚     TableManageDialog.vue       â”‚ â”‚
â”‚  â”‚  æ˜¾ç¤ºæ“ä½œæç¤º        â”‚   â”‚     å±•ç¤ºè¡¨è¯¦ç»†ä¿¡æ¯              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

```
1. ç”¨æˆ· hover è¡¨å
   â””â”€â–¶ Monaco è°ƒç”¨ provideHover
       â””â”€â–¶ IPC è°ƒç”¨ sqlLanguageServer.hover
           â””â”€â–¶ HoverProvider.createTableHover ç”Ÿæˆå¢å¼ºå†…å®¹
               â””â”€â–¶ è¿”å›å¸¦å…ƒæ•°æ®çš„ Hover å†…å®¹

2. ç”¨æˆ·ç‚¹å‡»è¡¨å
   â””â”€â–¶ Monaco command æœºåˆ¶è§¦å‘
       â””â”€â–¶ useLanguageServer å¤„ç†ç‚¹å‡»
           â””â”€â–¶ connectionStore.openTableManageDialog
               â””â”€â–¶ TableManageDialog æ˜¾ç¤º

3. Hover æ˜¾ç¤ºæ—¶çŠ¶æ€æ æç¤º
   â””â”€â–¶ useLanguageServer ç›‘å¬ hover çŠ¶æ€
       â””â”€â–¶ æ›´æ–° editorStore.hoverHint
           â””â”€â–¶ StatusBar å“åº”æ˜¾ç¤ºæç¤º
```

## 3. è¯¦ç»†è®¾è®¡

### 3.1 HoverProvider.ts ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `src/main/sql-language-server/providers/hoverProvider.ts`

**ä¸»è¦å˜æ›´**:

1. **ä¿®æ”¹ createTableHover æ–¹æ³•** - æ˜¾ç¤ºæ‰€æœ‰å­—æ®µ

```typescript
private createTableHover(table: TableInfo): Hover {
  const lines: string[] = []
  
  // è¡¨åï¼ˆå¯ç‚¹å‡»æ ·å¼ï¼‰
  lines.push(`**è¡¨**: \`${table.name}\``)
  lines.push('')
  
  if (table.comment) {
    lines.push(`**è¯´æ˜**: ${table.comment}`)
    lines.push('')
  }
  
  lines.push(`**å­—æ®µæ•°**: ${table.columns.length}`)
  lines.push('')
  
  // æ˜¾ç¤ºæ‰€æœ‰å­—æ®µï¼ˆä¸å†é™åˆ¶ï¼‰
  if (table.columns.length > 0) {
    lines.push('**å­—æ®µåˆ—è¡¨**:')
    lines.push('')  // ç©ºè¡Œä½¿æ ·å¼æ›´å¥½
    
    for (const col of table.columns) {
      const nullable = col.nullable ? '' : ' NOT NULL'
      const pkIcon = col.isPrimaryKey ? ' ğŸ”‘' : ''
      const comment = col.comment ? ` // ${col.comment}` : ''
      lines.push(`- \`${col.name}\`${pkIcon}: ${col.type}${nullable}${comment}`)
    }
  }

  return {
    contents: {
      kind: MarkupKind.Markdown,
      value: lines.join('\n')
    }
  }
}
```

2. **è¿”å›è¡¨å…ƒæ•°æ®** - ç”¨äºå‰ç«¯ç‚¹å‡»å¤„ç†

```typescript
// åœ¨ provideHover æ–¹æ³•ä¸­è¿”å›é¢å¤–çš„è¡¨ä¿¡æ¯
return {
  hover: {
    contents: { kind: MarkupKind.Markdown, value: ... },
  },
  // æ–°å¢ï¼šè¡¨å…ƒæ•°æ®ï¼Œç”¨äºå‰ç«¯ç‚¹å‡»å¤„ç†
  tableInfo: {
    name: table.name,
    database: this.metadataService.getCurrentDatabase()
  }
}
```

### 3.2 IPC æ¥å£æ‰©å±•

**ä¿®æ”¹æ–‡ä»¶**: `src/main/sql-language-server/index.ts` å’Œ `src/preload/api.ts`

**hover è¿”å›å€¼å¢å¼º**:

```typescript
interface HoverResult {
  success: boolean
  hover?: {
    contents: { kind: string; value: string }
  }
  // æ–°å¢
  tableInfo?: {
    name: string
    database: string
  }
}
```

### 3.3 useLanguageServer.ts ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `src/renderer/composables/useLanguageServer.ts`

**ä¸»è¦å˜æ›´**:

1. **æ³¨å†Œ Monaco Command** - å¤„ç†è¡¨åç‚¹å‡»

```typescript
// åœ¨ registerProviders ä¸­æ·»åŠ 
monaco.editor.registerCommand('sql.openTableManage', (accessor, tableName, database) => {
  const connectionId = lastConnectionId.value
  if (connectionId && database && tableName) {
    connectionStore.openTableManageDialog(connectionId, database, tableName)
  }
})
```

2. **ä¿®æ”¹ provideHover** - æ·»åŠ å¯ç‚¹å‡»çš„è¡¨åå’ŒçŠ¶æ€æ æç¤º

```typescript
hoverDisposable = monaco.languages.registerHoverProvider('sql', {
  provideHover: async (model, position) => {
    const documentText = model.getValue()
    const line = position.lineNumber - 1
    const character = position.column - 1

    try {
      const result = await window.api.sqlLanguageServer.hover(documentText, line, character)
      
      if (!result.success || !result.hover) {
        editorStore.setHoverHint(null)  // æ¸…é™¤æç¤º
        return null
      }

      // å¦‚æœæ˜¯è¡¨ hoverï¼Œè®¾ç½®çŠ¶æ€æ æç¤º
      if (result.tableInfo) {
        editorStore.setHoverHint('ğŸ’¡ ç‚¹å‡»è¡¨åæ‰“å¼€è¡¨ç®¡ç†')
      }

      // è¿”å› hover å†…å®¹
      return {
        contents: [{ 
          value: result.hover.contents.value,
          supportHtml: true  // æ”¯æŒ HTML
        }]
      }
    } catch (error) {
      console.error('æ‚¬æµ®æç¤ºè¯·æ±‚å¤±è´¥:', error)
      return null
    }
  }
})
```

### 3.4 editorStore æ‰©å±•

**ä¿®æ”¹æ–‡ä»¶**: `src/renderer/stores/editor.ts`

**æ–°å¢çŠ¶æ€**:

```typescript
// çŠ¶æ€æ  hover æç¤º
const hoverHint = ref<string | null>(null)

// è®¾ç½® hover æç¤º
function setHoverHint(hint: string | null) {
  hoverHint.value = hint
}
```

### 3.5 StatusBar.vue ä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `src/renderer/components/StatusBar.vue`

**ä¸»è¦å˜æ›´**:

```vue
<template>
  <div class="status-bar">
    <div class="left">
      <span class="status-item">{{ connectionStatus }}</span>
      <span v-if="serverVersion" class="status-item">{{ serverVersion }}</span>
      <!-- æ–°å¢ï¼šhover æç¤º -->
      <span v-if="hoverHint" class="status-item hover-hint">{{ hoverHint }}</span>
    </div>
    <div class="right">
      <span class="status-item">{{ cursorPosition }}</span>
      <span class="status-item">UTF-8</span>
      <span class="status-item">LF</span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useEditorStore } from '../stores/editor'

const editorStore = useEditorStore()
const hoverHint = computed(() => editorStore.hoverHint)
</script>

<style scoped>
.hover-hint {
  color: #4fc3f7;  /* æµ…è“è‰²ï¼Œæ›´é†’ç›® */
  font-style: italic;
}
</style>
```

### 3.6 Monaco Hover æ»šåŠ¨æ ·å¼

Monaco Editor çš„ hover widget æœ¬èº«æ”¯æŒæ»šåŠ¨ï¼Œéœ€è¦é€šè¿‡ CSS æ§åˆ¶æœ€å¤§é«˜åº¦ã€‚

**ä¿®æ”¹æ–‡ä»¶**: `src/renderer/config/monaco-theme.ts` æˆ–åœ¨å…¨å±€æ ·å¼ä¸­æ·»åŠ 

```css
/* Monaco hover widget æ ·å¼ */
.monaco-editor .monaco-hover-content {
  max-height: 300px;
  overflow-y: auto;
}

.monaco-editor .monaco-hover-content::-webkit-scrollbar {
  width: 8px;
}

.monaco-editor .monaco-hover-content::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}
```

### 3.7 è¡¨åç‚¹å‡»å®ç°æ–¹æ¡ˆ

Monaco Editor çš„ hover å†…å®¹æ”¯æŒ Markdownï¼Œä½†ä¸ç›´æ¥æ”¯æŒç‚¹å‡»äº‹ä»¶ã€‚é‡‡ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š

**æ–¹æ¡ˆï¼šä½¿ç”¨ Monaco Command URI**

Monaco æ”¯æŒåœ¨ Markdown ä¸­ä½¿ç”¨ command URI æ ¼å¼çš„é“¾æ¥ï¼š

```markdown
[è¡¨å](command:sql.openTableManage?[å‚æ•°])
```

**å®ç°**:

```typescript
// HoverProvider.ts
private createTableHover(table: TableInfo, database: string): Hover {
  const lines: string[] = []
  
  // ä½¿ç”¨ command URI ä½¿è¡¨åå¯ç‚¹å‡»
  const commandArgs = encodeURIComponent(JSON.stringify([table.name, database]))
  lines.push(`**è¡¨**: [\`${table.name}\`](command:sql.openTableManage?${commandArgs})`)
  // ...
}
```

**å‰ç«¯æ³¨å†Œ command**:

```typescript
// useLanguageServer.ts
monaco.editor.registerCommand('sql.openTableManage', (accessor, ...args) => {
  const [tableName, database] = args
  if (connectionStore.currentConnectionId && database && tableName) {
    connectionStore.openTableManageDialog(
      connectionStore.currentConnectionId,
      database,
      tableName
    )
  }
})
```

## 4. æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶è·¯å¾„ | å˜æ›´ç±»å‹ | å˜æ›´è¯´æ˜ |
|---------|---------|---------|
| `src/main/sql-language-server/providers/hoverProvider.ts` | ä¿®æ”¹ | æ˜¾ç¤ºæ‰€æœ‰å­—æ®µã€ä¸»é”®æ ‡è¯†ã€æ³¨é‡Šã€command URI |
| `src/renderer/composables/useLanguageServer.ts` | ä¿®æ”¹ | æ³¨å†Œç‚¹å‡»å‘½ä»¤ã€å¤„ç†çŠ¶æ€æ æç¤º |
| `src/renderer/stores/editor.ts` | ä¿®æ”¹ | æ·»åŠ  hoverHint çŠ¶æ€ |
| `src/renderer/components/StatusBar.vue` | ä¿®æ”¹ | æ˜¾ç¤º hover æç¤º |
| `src/renderer/components/SqlEditor.vue` | ä¿®æ”¹ | æ·»åŠ  hover æ ·å¼ï¼ˆå¯é€‰ï¼‰ |
| `src/preload/api.ts` | ä¿®æ”¹ | æ‰©å±• hover è¿”å›å€¼ç±»å‹ï¼ˆå¦‚éœ€è¦ï¼‰ |

## 5. é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|-----|------|---------|
| Monaco command URI å…¼å®¹æ€§ | å¯èƒ½åœ¨æŸäº›ç‰ˆæœ¬ä¸æ”¯æŒ | æµ‹è¯• Monaco 0.45.0+ ç‰ˆæœ¬ |
| hover å†…å®¹è¿‡é•¿å½±å“æ€§èƒ½ | å¤§è¡¨æ»šåŠ¨å¡é¡¿ | CSS é™åˆ¶é«˜åº¦ã€è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚éœ€è¦ï¼‰ |
| ç‚¹å‡»åŒºåŸŸè¯¯è§¦å‘ | ç”¨æˆ·ä½“éªŒä¸‹é™ | æ˜ç¡®çš„è§†è§‰æç¤ºã€åˆé€‚çš„ç‚¹å‡»åŒºåŸŸ |

## 6. æµ‹è¯•è®¡åˆ’

### 6.1 å•å…ƒæµ‹è¯•
- HoverProvider.createTableHover æ–¹æ³•æµ‹è¯•
- å„ç§å­—æ®µæ•°é‡æƒ…å†µçš„è¾“å‡ºéªŒè¯

### 6.2 é›†æˆæµ‹è¯•
- hover å®Œæ•´æµç¨‹æµ‹è¯•
- ç‚¹å‡»æ‰“å¼€è¡¨ç®¡ç†å¯¹è¯æ¡†æµ‹è¯•
- çŠ¶æ€æ æç¤ºæ˜¾ç¤º/éšè—æµ‹è¯•

### 6.3 æ€§èƒ½æµ‹è¯•
- 100+ å­—æ®µè¡¨çš„ hover å“åº”æ—¶é—´
- æ»šåŠ¨æµç•…åº¦æµ‹è¯•
