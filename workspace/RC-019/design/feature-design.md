# RC-019 功能详细设计文档

---
change_id: RC-019
name: 多语言遗漏修复与文件标题优化
stage: feature-design
document_type: feature-design
created_at: 2026-02-04
updated_at: 2026-02-04
version: 1.0
---

## 1. 功能分解

### 1.1 功能清单

| 功能编号 | 功能名称 | 优先级 | 预估工时 | 依赖功能 |
|----------|----------|--------|----------|----------|
| F-01 | 多语言遗漏修复 - 消息面板 | P0 | 0.5d | 无 |
| F-02 | 多语言遗漏修复 - 右键菜单 | P0 | 0.5d | 无 |
| F-03 | 文件标题显示优化 | P0 | 1d | 无 |
| F-04 | 文件路径悬停提示 | P1 | 0.5d | F-03 |
| F-05 | 结果面板高度拖动优化 | P1 | 1d | 无 |
| F-06 | 消息面板显示 SQL 语句 | P1 | 1d | 无 |
| F-07 | 消息面板复制 SQL 功能 | P1 | 0.5d | F-06 |
| F-08 | 消息面板执行历史追加 | P1 | 1d | F-06 |
| F-09 | 编辑器标签页拖动排序 | P2 | 1.5d | 无 |

### 1.2 功能依赖图

```
F-01 多语言-消息面板     F-02 多语言-右键菜单
    │                          │
    └──────────┬───────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
F-03 文件标题优化      F-05 结果面板拖动
    │
    ├──── F-04 路径悬停提示
    │
    └──── F-09 标签拖动排序

F-06 显示 SQL ───┬─── F-07 复制 SQL
                 │
                 └─── F-08 执行历史追加
```

### 1.3 用户故事映射

| 用户活动 | 国际化体验 | 文件管理 | 编辑体验 | 执行追溯 |
|----------|-----------|----------|----------|----------|
| **P0 (必须有)** | | | | |
| | 消息面板多语言 | 标题持久显示 | | |
| | 右键菜单多语言 | | | |
| **P1 (应该有)** | | | | |
| | | 路径悬停提示 | 面板拖动优化 | |
| | | | | 显示执行SQL |
| | | | | 复制SQL功能 |
| | | | | 历史记录保留 |
| **P2 (可以有)** | | | | |
| | | | | 标签拖拽排序 |

---

## 2. 用例设计

### 2.1 F-01: 多语言遗漏修复 - 消息面板

#### 正常用例

**UC-F01-001: 执行 SQL 后显示多语言消息**
- **参与者**: 国际化用户
- **前置条件**: 应用已设置语言为英文/中文/繁体中文
- **主流程**:
  1. 用户在 SQL 编辑器中输入 SQL
  2. 用户执行 SQL
  3. 系统根据当前语言显示对应的消息文本
- **后置条件**: 消息面板显示正确语言的结果消息

**语言映射**:
| 语言 | 影响行数 | 查询成功 |
|------|----------|----------|
| en-US | {n} row(s) affected | Query successful, {n} row(s) affected |
| zh-CN | 影响 {n} 行 | 查询成功，影响 {n} 行 |
| zh-TW | 影響 {n} 行 | 查詢成功，影響 {n} 行 |

#### 异常用例

**UC-F01-002: 语言文件缺失**
- **触发条件**: 语言文件未找到或损坏
- **处理流程**: 回退到默认语言（英文）
- **结果**: 显示英文消息，记录警告日志

**UC-F01-003: 消息 key 未定义**
- **触发条件**: 新消息类型未在语言文件中定义
- **处理流程**: 显示 key 本身（如 "message.rowsAffected"）
- **结果**: 提示开发者补充翻译

#### 边界用例

**UC-F01-004: 影响 0 行**
- **边界**: rowsAffected = 0
- **期望**: 英文显示 "0 rows affected"（复数形式）

**UC-F01-005: 影响 1 行**
- **边界**: rowsAffected = 1
- **期望**: 英文显示 "1 row affected"（单数形式）

**UC-F01-006: 语言动态切换**
- **边界**: 执行 SQL 后切换语言
- **期望**: 已显示的消息保持原语言，新消息使用新语言

---

### 2.2 F-02: 多语言遗漏修复 - 右键菜单

#### 正常用例

**UC-F02-001: 右键菜单显示多语言**
- **参与者**: 国际化用户
- **前置条件**: 应用已设置语言为英文/中文/繁体中文
- **主流程**:
  1. 用户在 SQL 编辑器中右键点击
  2. 系统显示对应语言的上下文菜单
- **后置条件**: 菜单项显示正确语言的文本

**语言映射**:
| 语言 | 执行 |
|------|------|
| en-US | Execute |
| zh-CN | 执行 |
| zh-TW | 執行 |

#### 异常用例

**UC-F02-002: 菜单项国际化 key 缺失**
- **触发条件**: contextMenu.execute 未定义
- **处理流程**: 显示硬编码默认值 "Execute"
- **结果**: 功能可用，但提示开发者补充

#### 边界用例

**UC-F02-003: 菜单项非常多**
- **边界**: 上下文菜单项超过 10 个
- **期望**: 所有菜单项都应正确国际化

---

### 2.3 F-03: 文件标题显示优化

#### 正常用例

**UC-F03-001: 保存文件后标题更新**
- **参与者**: 用户
- **前置条件**: 新建查询，标题为 "Query1.sql"
- **主流程**:
  1. 用户编辑 SQL 内容
  2. 用户保存文件为 `/home/user/test.sql`
  3. 系统提取文件名 `test.sql`
  4. 标签标题更新为 `test.sql`
- **后置条件**: 标签标题正确显示文件名

**UC-F03-002: 切换标签后标题保持**
- **参与者**: 用户
- **前置条件**: 已保存文件，标题为 `test.sql`
- **主流程**:
  1. 用户切换到其他标签页
  2. 用户切回原标签页
  3. 系统读取标签状态
  4. 标题保持显示 `test.sql`
- **后置条件**: 标签标题不恢复为默认名称

**UC-F03-003: 文件修改后标题标记**
- **参与者**: 用户
- **前置条件**: 已保存文件，标题为 `test.sql`
- **主流程**:
  1. 用户修改文件内容
  2. 系统检测内容变化
  3. 标题更新为 `test.sql *`
- **后置条件**: 标题显示修改标记

#### 异常用例

**UC-F03-004: 状态丢失**
- **触发条件**: 标签状态未正确保存
- **处理流程**: 从编辑器状态重新计算标题
- **结果**: 如果 filePath 存在，显示文件名；否则显示默认标题

**UC-F03-005: 文件名提取失败**
- **触发条件**: 文件路径格式异常
- **处理流程**: 显示完整路径或默认标题
- **结果**: 记录错误日志

#### 边界用例

**UC-F03-006: 无扩展名文件**
- **边界**: 保存文件为 `query`（无 .sql 扩展名）
- **期望**: 标题显示 `query`

**UC-F03-007: 超长文件名**
- **边界**: 文件名超过 50 个字符
- **期望**: 标题截断显示，tooltip 显示完整路径

**UC-F03-008: 特殊字符文件名**
- **边界**: 文件名包含 `@#$%^&()` 等特殊字符
- **期望**: 正常显示，不影响标签功能

---

### 2.4 F-04: 文件路径悬停提示

#### 正常用例

**UC-F04-001: 已保存文件显示路径**
- **参与者**: 用户
- **前置条件**: 文件已保存，路径为 `/home/user/test.sql`
- **主流程**:
  1. 用户鼠标悬停在标签标题上
  2. 系统读取 filePath
  3. 显示 tooltip: `/home/user/test.sql`
- **后置条件**: 用户看到完整文件路径

**UC-F04-002: 从未保存文件显示未保存**
- **参与者**: 用户
- **前置条件**: 新建查询，从未保存
- **主流程**:
  1. 用户鼠标悬停在标签标题上
  2. 系统检测到无 filePath
  3. 显示 tooltip: "未保存"
- **后置条件**: 用户知道文件未保存

**UC-F04-003: 已保存但已修改文件显示路径和状态**
- **参与者**: 用户
- **前置条件**: 文件已保存但被修改
- **主流程**:
  1. 用户鼠标悬停在标签标题上
  2. 系统读取 filePath 和 isModified 状态
  3. 显示 tooltip: `/home/user/test.sql (已修改)`
- **后置条件**: 用户知道文件路径和修改状态

#### 异常用例

**UC-F04-004: Tooltip 显示延迟**
- **触发条件**: 鼠标快速滑过
- **处理流程**: 设置延迟显示（300ms）
- **结果**: 避免闪烁和误触发

#### 边界用例

**UC-F04-005: 超长路径**
- **边界**: 文件路径超过 200 字符
- **期望**: Tooltip 支持换行或横向滚动

**UC-F04-006: 路径包含中文**
- **边界**: 路径为 `/用户/文档/测试.sql`
- **期望**: 正确显示中文字符

---

### 2.5 F-05: 结果面板高度拖动优化

#### 正常用例

**UC-F05-001: 向上拖动调整高度**
- **参与者**: 用户
- **前置条件**: 编辑区高度 300px，结果面板高度 200px
- **主流程**:
  1. 用户向上拖动分隔条
  2. 编辑区高度减小，结果面板高度增加
  3. 编辑区高度最小限制为 100px
- **后置条件**: 编辑区高度 >= 100px

**UC-F05-002: 拖动到极限位置**
- **参与者**: 用户
- **前置条件**: 编辑区高度 150px
- **主流程**:
  1. 用户继续向上拖动
  2. 编辑区高度达到 100px
  3. 系统阻止进一步缩小
- **后置条件**: 编辑区高度保持 100px

**UC-F05-003: 向下拖动恢复高度**
- **参与者**: 用户
- **前置条件**: 编辑区高度 100px
- **主流程**:
  1. 用户向下拖动分隔条
  2. 编辑区高度增加，结果面板高度减小
- **后置条件**: 正常调整高度比例

#### 异常用例

**UC-F05-004: 拖动时窗口大小变化**
- **触发条件**: 拖动过程中窗口被缩放
- **处理流程**: 重新计算可用高度
- **结果**: 保持编辑区高度 >= 100px

**UC-F05-005: 窗口高度不足**
- **触发条件**: 窗口高度 < 200px
- **处理流程**: 按比例分配空间
- **结果**: 编辑区和结果面板按比例缩小

#### 边界用例

**UC-F05-006: 编辑区刚好 100px**
- **边界**: 编辑区高度 = 100px
- **期望**: 拖动平滑停止，无抖动

**UC-F05-007: 快速拖动**
- **边界**: 用户快速拖动分隔条
- **期望**: 高度变化平滑，无卡顿

---

### 2.6 F-06: 消息面板显示 SQL 语句

#### 正常用例

**UC-F06-001: 显示短 SQL**
- **参与者**: 用户
- **前置条件**: 执行 SQL: `SELECT * FROM users`
- **主流程**:
  1. 系统执行 SQL
  2. 第一行显示: `14:27:06 Executing... SELECT * FROM users`
  3. 第二行显示: `14:27:06 Query returned 5 rows, took 43ms`
- **后置条件**: 消息面板显示完整 SQL

**UC-F06-002: 显示长 SQL（截断）**
- **参与者**: 用户
- **前置条件**: 执行超长 SQL (>100 字符)
- **主流程**:
  1. 系统执行 SQL
  2. 截断 SQL 到 100 字符
  3. 第一行显示: `14:27:06 Executing... SELECT very_long_sql...`
- **后置条件**: SQL 显示截断版本

#### 异常用例

**UC-F06-003: SQL 为空**
- **触发条件**: 执行空 SQL
- **处理流程**: 显示 "Executing... (empty)"
- **结果**: 提示用户 SQL 为空

**UC-F06-004: SQL 包含换行**
- **触发条件**: SQL 是多行文本
- **处理流程**: 移除换行符，显示为单行
- **结果**: 保持单行显示格式

#### 边界用例

**UC-F06-005: SQL 刚好 100 字符**
- **边界**: SQL 长度 = 100
- **期望**: 完整显示，不添加 "..."

**UC-F06-006: SQL 刚好 101 字符**
- **边界**: SQL 长度 = 101
- **期望**: 显示前 100 字符 + "..."

**UC-F06-007: SQL 包含特殊字符**
- **边界**: SQL 包含 emoji 或控制字符
- **期望**: 正常显示或过滤特殊字符

---

### 2.7 F-07: 消息面板复制 SQL 功能

#### 正常用例

**UC-F07-001: 复制 SQL 成功**
- **参与者**: 用户
- **前置条件**: 消息面板显示执行历史
- **主流程**:
  1. 用户点击"复制"按钮
  2. 系统将完整 SQL 复制到剪贴板
  3. 按钮文字变为"已复制"
  4. 2 秒后按钮文字恢复"复制"
- **后置条件**: SQL 已复制，用户可粘贴

#### 异常用例

**UC-F07-002: 剪贴板访问被拒绝**
- **触发条件**: 浏览器/Electron 权限限制
- **处理流程**: 显示"复制失败"提示
- **结果**: 提示用户手动复制

**UC-F07-003: 剪贴板写入失败**
- **触发条件**: 系统剪贴板异常
- **处理流程**: 显示"复制失败"提示
- **结果**: 记录错误日志

#### 边界用例

**UC-F07-004: 连续快速点击复制**
- **边界**: 用户在 2 秒内多次点击
- **期望**: 每次都执行复制，按钮状态正常更新

**UC-F07-005: SQL 超长（10000+ 字符）**
- **边界**: SQL 超过剪贴板限制
- **期望**: 尽可能复制，或提示 SQL 过长

---

### 2.8 F-08: 消息面板执行历史追加

#### 正常用例

**UC-F08-001: 追加执行记录**
- **参与者**: 用户
- **前置条件**: 消息面板已有 3 条历史记录
- **主流程**:
  1. 用户执行新 SQL
  2. 系统将新记录添加到数组头部
  3. 消息面板显示 4 条记录，最新在最上
- **后置条件**: 历史记录保留

**UC-F08-002: 历史记录达到上限**
- **参与者**: 用户
- **前置条件**: 已有 100 条历史记录
- **主流程**:
  1. 用户执行新 SQL
  2. 添加新记录到头部
  3. 移除数组末尾（最旧）的记录
  4. 保持 100 条记录
- **后置条件**: FIFO 淘汰最旧记录

**UC-F08-003: 切换标签页历史隔离**
- **参与者**: 用户
- **前置条件**: 标签 A 有 5 条历史，标签 B 有 3 条历史
- **主流程**:
  1. 用户切换到标签 B
  2. 显示标签 B 的 3 条历史
  3. 用户切换回标签 A
  4. 显示标签 A 的 5 条历史
- **后置条件**: 各标签历史相互独立

#### 异常用例

**UC-F08-004: 内存不足**
- **触发条件**: 大量历史记录占用内存
- **处理流程**: 自动清理最旧记录
- **结果**: 保持内存使用在合理范围

**UC-F08-005: 执行失败记录**
- **触发条件**: SQL 执行失败
- **处理流程**: 同样记录到历史，标记为错误状态
- **结果**: 用户可查看失败记录和错误信息

#### 边界用例

**UC-F08-006: 第一条执行记录**
- **边界**: 历史记录为空
- **期望**: 正常添加，显示 1 条记录

**UC-F08-007: 第 101 条执行记录**
- **边界**: 从 100 条增加到 101 条
- **期望**: 添加新记录，移除最旧，保持 100 条

**UC-F08-008: 标签页关闭后历史清理**
- **边界**: 标签页关闭
- **期望**: 该标签页的历史记录被垃圾回收

---

### 2.9 F-09: 编辑器标签页拖动排序

#### 正常用例

**UC-F09-001: 拖动标签改变顺序**
- **参与者**: 用户
- **前置条件**: 标签顺序: [A] [B] [C]
- **主流程**:
  1. 用户拖动标签 B 到 A 左侧
  2. 显示拖拽占位符
  3. 释放鼠标
  4. 标签顺序更新为: [B] [A] [C]
- **后置条件**: 标签顺序已改变

**UC-F09-002: 拖动到首位**
- **参与者**: 用户
- **前置条件**: 标签顺序: [A] [B] [C]
- **主流程**:
  1. 用户拖动标签 C 到最左侧
  2. 标签顺序更新为: [C] [A] [B]
- **后置条件**: 标签 C 移至首位

**UC-F09-003: 拖动到末位**
- **参与者**: 用户
- **前置条件**: 标签顺序: [A] [B] [C]
- **主流程**:
  1. 用户拖动标签 A 到最右侧
  2. 标签顺序更新为: [B] [C] [A]
- **后置条件**: 标签 A 移至末位

#### 异常用例

**UC-F09-004: 拖拽过程中标签被关闭**
- **触发条件**: 其他用户或操作关闭标签
- **处理流程**: 取消拖拽操作
- **结果**: 标签顺序不变

**UC-F09-005: 拖拽到非法区域**
- **触发条件**: 拖到标签栏外部
- **处理流程**: 取消拖拽，恢复原位置
- **结果**: 标签顺序不变

**UC-F09-006: 拖拽后内容不匹配**
- **触发条件**: 状态同步异常
- **处理流程**: 重新加载标签内容
- **结果**: 标签内容与标题匹配

#### 边界用例

**UC-F09-007: 只有两个标签**
- **边界**: 标签数量 = 2
- **期望**: 可互相交换位置

**UC-F09-008: 大量标签（20+）**
- **边界**: 标签数量 > 20
- **期望**: 拖拽性能正常，无卡顿

**UC-F09-009: 拖动距离很小**
- **边界**: 拖动距离 < 10px
- **期望**: 视为点击，不触发排序

---

## 3. 输入输出定义

### 3.1 数据类型定义

```typescript
// 编辑器标签
interface EditorTab {
  id: string;                    // 唯一标识
  title: string;                 // 显示标题（文件名或默认名）
  filePath?: string;             // 完整文件路径
  content: string;               // 编辑器内容
  isSaved: boolean;              // 是否已保存
  isModified: boolean;           // 是否已修改
  executionHistory: ExecutionMessage[];  // 执行历史
}

// 执行消息
interface ExecutionMessage {
  id: string;                    // 唯一标识
  timestamp: number;             // 执行时间戳
  sql: string;                   // 完整 SQL 语句
  displaySql: string;            // 截断后的 SQL（用于显示）
  status: 'success' | 'error';
  rowsAffected: number;
  duration: number;              // 执行耗时（ms）
  message?: string;              // 错误信息（如有）
}

// 面板尺寸
interface PanelSize {
  editorHeight: number;          // 编辑器高度（px）
  resultHeight: number;          // 结果面板高度（px）
  minEditorHeight: 100;          // 编辑器最小高度
}

// 语言包
interface LocaleMessages {
  message: {
    rowsAffected: string;        // 影响行数模板
    querySuccess: string;        // 查询成功模板
  };
  contextMenu: {
    execute: string;             // 执行菜单项
  };
}
```

### 3.2 功能输入输出

#### F-01: 多语言遗漏修复 - 消息面板

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| rowsAffected | number | 是 | 影响行数 |
| status | 'success' \| 'error' | 是 | 执行状态 |
| currentLocale | string | 是 | 当前语言 |

| 输出 | 类型 | 说明 |
|------|------|------|
| messageText | string | 本地化后的消息文本 |

#### F-02: 多语言遗漏修复 - 右键菜单

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| menuItems | MenuItem[] | 是 | 菜单项列表 |
| currentLocale | string | 是 | 当前语言 |

| 输出 | 类型 | 说明 |
|------|------|------|
| localizedMenuItems | MenuItem[] | 本地化后的菜单项 |

#### F-03: 文件标题显示优化

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| filePath | string | 否 | 完整文件路径 |
| isModified | boolean | 是 | 是否已修改 |
| defaultTitle | string | 是 | 默认标题 |

| 输出 | 类型 | 说明 |
|------|------|------|
| displayTitle | string | 显示的标题（含修改标记） |

#### F-04: 文件路径悬停提示

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| filePath | string | 否 | 完整文件路径 |
| isSaved | boolean | 是 | 是否已保存 |
| isModified | boolean | 是 | 是否已修改 |

| 输出 | 类型 | 说明 |
|------|------|------|
| tooltipText | string | Tooltip 显示文本 |

#### F-05: 结果面板高度拖动优化

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| dragDeltaY | number | 是 | 拖动垂直位移 |
| currentEditorHeight | number | 是 | 当前编辑器高度 |
| containerHeight | number | 是 | 容器总高度 |

| 输出 | 类型 | 说明 |
|------|------|------|
| newEditorHeight | number | 新的编辑器高度（>=100） |
| newResultHeight | number | 新的结果面板高度 |

#### F-06: 消息面板显示 SQL 语句

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sql | string | 是 | 完整 SQL |
| maxDisplayLength | number | 否 | 最大显示长度，默认100 |

| 输出 | 类型 | 说明 |
|------|------|------|
| displaySql | string | 截断后的 SQL |

#### F-07: 消息面板复制 SQL 功能

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| sql | string | 是 | 完整 SQL |

| 输出 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否复制成功 |
| errorMessage | string | 错误信息（失败时） |

#### F-08: 消息面板执行历史追加

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| newMessage | ExecutionMessage | 是 | 新执行消息 |
| currentHistory | ExecutionMessage[] | 是 | 当前历史记录 |
| maxHistorySize | number | 否 | 最大容量，默认100 |

| 输出 | 类型 | 说明 |
|------|------|------|
| updatedHistory | ExecutionMessage[] | 更新后的历史记录 |

#### F-09: 编辑器标签页拖动排序

| 输入 | 类型 | 必填 | 说明 |
|------|------|------|------|
| tabs | EditorTab[] | 是 | 当前标签列表 |
| dragTabId | string | 是 | 被拖动标签ID |
| dropIndex | number | 是 | 目标位置索引 |

| 输出 | 类型 | 说明 |
|------|------|------|
| reorderedTabs | EditorTab[] | 重新排序后的标签列表 |

---

## 4. 边界条件处理

### 4.1 数据边界

| 功能 | 数据类型 | 边界条件 | 处理策略 |
|------|----------|----------|----------|
| F-01 | 行数 | rowsAffected = 0 | 英文显示 "0 rows affected"（复数） |
| F-01 | 行数 | rowsAffected = 1 | 英文显示 "1 row affected"（单数） |
| F-03 | 文件名 | 长度 > 50 | 标题截断显示 |
| F-03 | 文件名 | 包含特殊字符 | 正常显示，不转义 |
| F-04 | 路径 | 长度 > 200 | Tooltip 支持换行 |
| F-06 | SQL | 长度 > 100 | 截断到 100 + "..." |
| F-06 | SQL | 为空字符串 | 显示 "(empty)" |
| F-08 | 历史记录 | 数量 = 0 | 正常添加第一条 |
| F-08 | 历史记录 | 数量 = 100 | 添加新记录，移除最旧 |

### 4.2 并发边界

| 功能 | 并发场景 | 处理策略 |
|------|----------|----------|
| F-03 | 同时保存多个标签 | 各标签独立处理，无竞态 |
| F-07 | 快速连续点击复制 | 防抖处理，每次点击都执行 |
| F-08 | 快速连续执行 SQL | 按顺序添加，不丢失记录 |
| F-09 | 拖拽时标签被关闭 | 取消拖拽，恢复原状态 |

### 4.3 性能边界

| 功能 | 性能指标 | 处理策略 |
|------|----------|----------|
| F-03 | 标题更新 | < 50ms，无感知延迟 |
| F-04 | Tooltip 显示 | 延迟 300ms，避免闪烁 |
| F-05 | 拖动响应 | 60fps 流畅拖动 |
| F-08 | 历史记录 100 条 | 渲染性能 < 100ms |
| F-09 | 20+ 标签拖拽 | 虚拟滚动或优化渲染 |

### 4.4 状态边界

| 功能 | 状态场景 | 处理策略 |
|------|----------|----------|
| F-03 | 从未保存 → 已保存 | 更新标题为文件名 |
| F-03 | 已保存 → 已修改 | 标题添加 "*" 标记 |
| F-03 | 已修改 → 已保存 | 标题移除 "*" 标记 |
| F-04 | 未保存状态 | 显示 "未保存" |
| F-04 | 已保存但已修改 | 显示路径 + "(已修改)" |
| F-08 | 标签页关闭 | 历史记录随标签销毁 |

---

## 5. 错误处理设计

### 5.1 错误码定义

| 错误码 | 错误类型 | 说明 | 用户提示 |
|--------|----------|------|----------|
| I18N_001 | 国际化错误 | 语言文件缺失 | 使用默认语言 |
| I18N_002 | 国际化错误 | 翻译 key 未定义 | 显示 key 本身 |
| FILE_001 | 文件操作错误 | 文件名提取失败 | 显示默认标题 |
| FILE_002 | 文件操作错误 | 路径解析错误 | 显示完整路径 |
| CLIP_001 | 剪贴板错误 | 复制失败 | "复制失败，请重试" |
| CLIP_002 | 剪贴板错误 | 权限被拒绝 | "请允许剪贴板访问" |
| DRAG_001 | 拖拽错误 | 拖拽取消 | 无提示 |
| UI_001 | UI 错误 | 渲染异常 | 自动恢复或刷新 |

### 5.2 错误处理策略

| 功能 | 错误场景 | 处理策略 | 重试机制 |
|------|----------|----------|----------|
| F-01 | 语言文件缺失 | 回退默认语言 | 无 |
| F-03 | 状态读取失败 | 从编辑器重新计算 | 无 |
| F-07 | 复制失败 | 显示错误提示 | 用户手动重试 |
| F-09 | 拖拽异常 | 恢复原顺序 | 无 |

### 5.3 降级方案

| 功能 | 降级场景 | 降级策略 |
|------|----------|----------|
| F-01 | 国际化完全失效 | 显示硬编码英文 |
| F-04 | Tooltip 组件失效 | 使用原生 title 属性 |
| F-05 | 拖动组件失效 | 使用固定比例布局 |
| F-07 | 剪贴板 API 失效 | 显示 SQL 供手动复制 |
| F-09 | 拖拽功能失效 | 保持固定标签顺序 |

---

## 6. 功能间交互设计

### 6.1 功能依赖关系

```
F-04 文件路径悬停提示
    │
    ├─ 依赖: F-03 文件标题显示优化
    │   └─ 需要 filePath, isSaved, isModified
    │
    └─ 依赖: 全局状态 EditorTab

F-07 复制 SQL 功能
    │
    ├─ 依赖: F-06 显示 SQL 语句
    │   └─ 需要 ExecutionMessage.sql
    │
    └─ 依赖: 系统剪贴板 API

F-08 执行历史追加
    │
    ├─ 依赖: F-06 显示 SQL 语句
    │   └─ 生成 ExecutionMessage
    │
    └─ 依赖: 标签页状态 EditorTab.executionHistory
```

### 6.2 数据流设计

#### 文件保存流程

```
用户保存文件
    ↓
F-03 提取文件名 ← filePath
    ↓
更新 EditorTab.title
    ↓
触发标签重新渲染
    ↓
F-04 悬停时读取 filePath 显示 Tooltip
```

#### SQL 执行流程

```
用户执行 SQL
    ↓
F-06 生成 ExecutionMessage
    ↓
F-01 本地化消息文本
    ↓
F-08 追加到 executionHistory
    ↓
消息面板渲染
    ↓
F-07 点击复制时读取 message.sql
```

#### 标签拖拽流程

```
用户开始拖拽
    ↓
F-09 记录 dragTabId
    ↓
显示占位符视觉反馈
    ↓
用户释放
    ↓
F-09 计算新顺序
    ↓
更新全局 tabs 状态
    ↓
触发标签栏重新渲染
```

### 6.3 状态管理

| 状态 | 所属功能 | 作用域 | 持久化 |
|------|----------|--------|--------|
| EditorTab.title | F-03 | 标签页 | 否 |
| EditorTab.filePath | F-03 | 标签页 | 否 |
| EditorTab.isModified | F-03 | 标签页 | 否 |
| EditorTab.executionHistory | F-08 | 标签页 | 否 |
| tabs 顺序 | F-09 | 全局 | 否 |
| PanelSize | F-05 | 全局 | 是（可配置） |
| currentLocale | F-01/F-02 | 全局 | 是 |

---

## 7. 测试策略

### 7.1 单元测试

| 功能 | 测试重点 | 测试数量 |
|------|----------|----------|
| F-01 | 本地化函数、单复数处理 | 9 |
| F-02 | 菜单本地化 | 3 |
| F-03 | 文件名提取、标题生成 | 6 |
| F-04 | Tooltip 文本生成 | 3 |
| F-05 | 高度计算、边界限制 | 5 |
| F-06 | SQL 截断函数 | 4 |
| F-07 | 剪贴板操作 | 3 |
| F-08 | FIFO 淘汰逻辑 | 4 |
| F-09 | 数组重排算法 | 5 |

### 7.2 集成测试

| 场景 | 涉及功能 | 测试用例 |
|------|----------|----------|
| 完整执行流程 | F-01/F-06/F-08 | 执行 SQL → 显示消息 → 保留历史 |
| 文件操作 | F-03/F-04 | 保存 → 更新标题 → 悬停显示路径 |
| 标签管理 | F-03/F-09 | 拖拽排序 → 切换标签 → 标题保持 |

### 7.3 验收测试

| 需求 ID | 验收标准 | 测试方式 |
|---------|----------|----------|
| TC01-06 | 多语言显示 | 手动切换语言验证 |
| TC07-11 | 文件标题优化 | 自动化 E2E 测试 |
| TC12-14 | 面板拖动 | 手动交互测试 |
| TC15-20 | 消息面板历史 | 自动化 E2E 测试 |
| TC21-26 | 标签拖拽排序 | 手动交互测试 |

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| EditorTab | 编辑器标签页对象 |
| ExecutionMessage | SQL 执行消息对象 |
| FIFO | 先进先出（First In First Out） |
| Tooltip | 鼠标悬停提示组件 |
| Locale | 语言区域设置 |

### 8.2 变更历史

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2026-02-04 | 1.0 | 初始创建 | AI |

---

*文档结束*
