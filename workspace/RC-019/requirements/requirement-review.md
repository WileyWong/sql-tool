# RC-019 需求审查文档

---
name: 多语言遗漏修复与文件标题优化
change_id: RC-019
created_at: 2026-02-04
updated_at: 2026-02-04
---

## 1. 概述

### 1.1 需求信息

| 项目 | 内容 |
|------|------|
| 需求编号 | RC-019 |
| 需求名称 | 多语言遗漏修复与文件标题优化 |
| 提出日期 | 2026-01-30 |
| 优先级 | 中 |
| 需求来源 | requirements_change/requirements_change_19.md |

### 1.2 背景与目标

**背景**: 在 RC-018 多语言支持功能完成后，经过测试发现部分界面文本仍未被国际化，同时用户反馈文件保存后标题显示不够直观。

**目标**:
1. 修复多语言遗漏的文本
2. 优化文件保存后的标题显示逻辑
3. 添加文件路径悬停提示功能

---

## 2. 功能需求（FR）

### FR-1: 多语言遗漏修复 - 消息面板

**功能描述**: 修复消息面板中"影响 X 行"等文本的硬编码中文问题

**用户故事**: 作为国际化用户，我希望在执行 SQL 后看到对应语言的结果提示

**涉及文本**:
| Key | 中文 | 英文 | 繁体中文 |
|-----|------|------|----------|
| message.rowsAffected | 影响 {n} 行 | {n} row(s) affected | 影響 {n} 行 |
| message.querySuccess | 查询成功，影响 {n} 行 | Query successful, {n} row(s) affected | 查詢成功，影響 {n} 行 |

**验收标准**:
- [ ] TC01: 英文环境下显示 "{n} row(s) affected"
- [ ] TC02: 简体中文环境下显示 "影响 {n} 行"
- [ ] TC03: 繁体中文环境下显示 "影響 {n} 行"

**确认项**:
- [ ] [P2-清晰性] 单数/复数处理: 英文中 1 row / n rows 的单复数形式是否需要区分 - 建议实现单复数自动切换
- [ ] [P2-可验证性] 测试用例是否覆盖 0行/1行/n行 三种情况

---

### FR-2: 多语言遗漏修复 - SQL编辑器右键菜单

**功能描述**: 修复 SQL 编辑器右键菜单中"执行"选项的硬编码中文问题

**用户故事**: 作为国际化用户，我希望在右键菜单中看到对应语言的执行选项

**涉及文本**:
| Key | 中文 | 英文 | 繁体中文 |
|-----|------|------|----------|
| contextMenu.execute | 执行 | Execute | 執行 |

**验收标准**:
- [ ] TC04: 英文环境下右键菜单显示 "Execute"
- [ ] TC05: 简体中文环境下右键菜单显示 "执行"
- [ ] TC06: 繁体中文环境下右键菜单显示 "執行"

**确认项**:
- [ ] [P1-完整性] 右键菜单是否还有其他未国际化的文本需要一并修复 - 建议全面检查右键菜单所有选项

---

### FR-3: 文件标题显示优化

**功能描述**: 保存文件后，标签页标题持久显示为实际文件名，切换标签后标题不恢复为默认

**用户故事**: 作为用户，我希望保存文件后标签标题正确显示文件名，且切换标签后保持不变

**业务规则**:
1. 保存文件后，标签标题显示为文件名（不含路径）
2. 切换标签页后，标题保持显示文件名
3. 文件修改后，标题显示文件名 + "*"

**输入/输出**:
- 输入: 文件路径 `/home/user/documents/test.sql`
- 输出: 标题显示 `test.sql`

**验收标准**:
- [ ] TC07: 新建查询并保存为 test.sql，标签页标题变为 "test.sql"
- [ ] TC08: 保存文件后修改内容，标题显示 "test.sql *"
- [ ] TC11: 保存到不同目录的同名文件，正确显示各自路径，标题显示文件名

**确认项**:
- [ ] [P0-准确性] 当前问题描述中提到"切换到其他编辑器标签再切回来后，标题又恢复为默认名称" - 这是一个 Bug 修复，需要确认状态管理逻辑是否正确
- [ ] [P1-完整性] 文件名提取逻辑需要考虑 Windows(\) 和 Unix(/) 路径分隔符的兼容性

---

### FR-4: 文件路径悬停提示

**功能描述**: 鼠标悬停在已保存查询的标签页标题上时，显示完整文件路径

**用户故事**: 作为用户，我希望悬停标签时能快速查看文件的完整路径

**业务规则**:
1. 已保存文件: 显示完整文件路径
2. 从未保存文件: 显示 "未保存"
3. 已保存但已修改: 显示完整路径 + "(已修改)"

**验收标准**:
- [ ] TC09: 鼠标悬停在已保存文件标签上，Tooltip 显示完整文件路径
- [ ] TC10: 鼠标悬停在从未保存文件标签上，Tooltip 显示 "未保存"
- [ ] TC10-1: 鼠标悬停在已保存但已修改文件标签上，Tooltip 显示完整路径 + "(已修改)"

**确认项**:
- [x] [CLARIFIED] 未保存文件的 Tooltip 显示规则 - 区分两种状态：从未保存显示"未保存"，已保存但修改显示路径+"(已修改)"

---

### FR-5: 结果面板高度拖动优化

**功能描述**: 调整结果面板拖动高度限制，只限制 SQL 编辑区的最小高度为 100px

**用户故事**: 作为用户，我希望更灵活地调整编辑区和结果区的高度比例

**业务规则**:
1. 结果面板向上拖动时，SQL 编辑区最小高度限制为 100px
2. 移除其他固定高度限制
3. 接近 100px 时平滑停止，避免抖动

**验收标准**:
- [ ] TC12: 向上拖动结果面板分隔条，SQL 编辑区高度可缩小至最小 100px
- [ ] TC13: 继续向上拖动（编辑区已达 100px），编辑区保持 100px，不再缩小
- [ ] TC14: 向下拖动结果面板分隔条，结果面板正常缩小，编辑区正常扩大

**确认项**:
- [ ] [P2-清晰性] "平滑停止"的具体交互效果需要明确 - 建议使用 CSS transition 实现平滑动画

---

### FR-6: 消息面板执行历史 - 显示 SQL 语句

**功能描述**: 在执行消息中追加显示本次执行的 SQL 语句

**用户故事**: 作为用户，我希望消息面板能显示每次执行的具体 SQL 语句，便于追溯

**业务规则**:
1. 第一行显示: `14:27:06 Executing... SELECT * FROM users...`
2. 第二行显示: `14:27:06 Query returned 5 rows, took 43ms`
3. SQL 语句单行显示，超长时截断并添加 "..." 后缀
4. 最大显示长度: 100 字符（固定值）
5. 点击复制按钮复制完整 SQL（非截断版本）

**数据模型**:
```typescript
interface ExecutionMessage {
  id: string;           // 唯一标识
  timestamp: number;    // 执行时间戳
  sql: string;          // 完整 SQL 语句
  status: 'success' | 'error';
  rowsAffected: number;
  message?: string;     // 错误信息（如有）
}
```

**验收标准**:
- [ ] TC15: 执行一条短 SQL，消息显示 "Executing... SELECT * FROM users" 及复制按钮
- [ ] TC16: 执行一条长 SQL（超过 100 字符），消息显示截断后的 SQL，带 "..." 后缀

**确认项**:
- [x] [CLARIFIED] SQL 截断显示规则 - 固定最大长度 100 字符，复制时复制完整 SQL

---

### FR-7: 消息面板执行历史 - 复制 SQL 功能

**功能描述**: 每条执行消息第一行右侧增加"复制"链接按钮，点击后复制完整 SQL

**用户故事**: 作为用户，我希望能快速复制历史执行过的 SQL 语句

**业务规则**:
1. 每条执行消息第一行右侧显示"复制"链接按钮
2. 点击后复制该次执行的完整 SQL 语句到剪贴板
3. 复制成功后按钮文字变为"已复制"，2 秒后恢复"复制"
4. 复制失败时显示"复制失败"提示

**验收标准**:
- [ ] TC17: 点击"复制"链接，完整 SQL 被复制到剪贴板，按钮文字变为"已复制"
- [ ] TC17-1: 2 秒后按钮文字自动恢复为"复制"
- [ ] TC17-2: 复制失败时显示"复制失败"提示

**确认项**:
- [x] [CLARIFIED] 复制成功提示方式 - 按钮文字从"复制"变为"已复制"，2秒后恢复
- [ ] [P1-完整性] 剪贴板操作失败时的错误处理机制需要定义 - 显示"复制失败"提示

---

### FR-8: 消息面板执行历史 - 追加策略

**功能描述**: 采用追加模式保留历史执行消息，最多保留 100 条，FIFO 淘汰

**用户故事**: 作为用户，我希望消息面板能保留历史执行记录，便于查看之前的执行结果

**业务规则**:
1. 追加模式，保留历史执行消息
2. 最新执行的消息显示在最上方（倒序排列）
3. 每个标签页独立计算，最多保留 100 条执行记录
4. 淘汰策略: FIFO（先进先出）
5. 历史记录不持久化，标签页关闭后数据销毁

**验收标准**:
- [ ] TC18: 连续执行 5 次 SQL，消息面板显示 5 条历史记录，最新在上
- [ ] TC19: 连续执行 101 次 SQL，消息面板只显示最近 100 条，最早 1 条被移除
- [ ] TC20: 查看历史消息，每条消息显示执行时间、SQL 语句、影响行数
- [ ] TC20-1: 标签页 A 执行 3 条 SQL，切换到标签页 B 执行 2 条 SQL，切换回 A 仍显示 3 条历史
- [ ] TC20-2: 关闭标签页后重新打开，该标签页历史记录为空

**确认项**:
- [x] [CLARIFIED] 历史记录容量管理方式 - 单标签页独立计算，不持久化，不支持下动清空，标签关闭后数据销毁

---

### FR-9: 编辑器标签页拖动排序

**功能描述**: 支持鼠标拖拽标签页改变其排列顺序

**用户故事**: 作为用户，我希望通过拖拽整理编辑器标签的顺序

**业务规则**:
1. 支持鼠标拖拽标签页改变排列顺序
2. 拖拽时有视觉反馈（半透明效果、占位符指示）
3. 拖拽结束后标签顺序立即生效
4. 标签顺序仅在当前会话有效，应用重启后不恢复

**验收标准**:
- [ ] TC21: 拖动标签页改变顺序，标签顺序成功交换，视觉效果平滑
- [ ] TC22: 拖动标签到首位，被拖动标签移至最左侧
- [ ] TC23: 拖动标签到末位，被拖动标签移至最右侧
- [ ] TC24: 打开 5 个标签，拖动第 3 个到第 1 个位置，顺序变为 3-1-2-4-5
- [ ] TC25: 拖动过程中，显示拖拽占位符或半透明效果
- [ ] TC26: 拖动结束后切换标签，各标签内容显示正确，与标题匹配
- [ ] TC26-1: 重启应用后，标签顺序不保留上次调整

**确认项**:
- [x] [CLARIFIED] 拖拽排序持久化策略 - 不持久化，仅内存中调整，重启后不恢复
- [ ] [P1-完整性] 拖拽排序与标签页关闭/新增操作的边界情况需要定义

---

## 3. 业务规则（BR）

| 编号 | 规则描述 | 关联FR |
|------|----------|--------|
| BR-1 | 文件名从完整路径中提取，支持 Windows(\) 和 Unix(/) 分隔符 | FR-3 |
| BR-2 | 文件修改状态用 "*" 标记，显示在标题末尾 | FR-3 |
| BR-3 | SQL 编辑区最小高度为 100px | FR-5 |
| BR-4 | 消息历史最多保留 100 条，FIFO 淘汰 | FR-8 |
| BR-5 | 消息按时间倒序排列，最新在上 | FR-8 |
| BR-6 | SQL 显示最大长度 100 字符，超长截断 | FR-6 |

---

## 4. 数据模型（DM）

### DM-1: 执行消息

```typescript
interface ExecutionMessage {
  id: string;           // 唯一标识
  timestamp: number;    // 执行时间戳
  sql: string;          // 完整 SQL 语句
  status: 'success' | 'error';
  rowsAffected: number;
  duration: number;     // 执行耗时(ms)
  message?: string;     // 错误信息（如有）
}
```

### DM-2: 编辑器标签

```typescript
interface EditorTab {
  id: string;
  title: string;           // 显示标题（文件名）
  filePath?: string;       // 完整文件路径
  isSaved: boolean;
  isModified: boolean;
  content: string;
  executionHistory: ExecutionMessage[];  // 执行历史
}
```

---

## 5. 异常处理

| 场景 | 处理方式 | 关联FR |
|------|----------|--------|
| 剪贴板复制失败 | 显示"复制失败"提示 | FR-7 |
| 历史记录达到 100 条 | 自动移除最旧的一条 | FR-8 |
| 拖拽过程中标签页被关闭 | 取消拖拽操作 | FR-9 |
| 文件路径包含特殊字符 | 正常提取文件名 | FR-3 |

---

## 6. 测试策略

### 6.1 单元测试重点

- 文件名提取逻辑（各种路径格式）
- SQL 截断逻辑（边界值）
- 历史记录 FIFO 淘汰逻辑

### 6.2 集成测试重点

- 标签切换后标题保持
- 多语言切换后文本更新
- 拖拽排序与状态管理一致性

### 6.3 验收测试覆盖

| 类别 | 用例数 | 覆盖率 |
|------|--------|--------|
| 多语言修复 | 6 | TC01-TC06 |
| 文件标题优化 | 5 | TC07-TC11 |
| 结果面板拖动 | 3 | TC12-TC14 |
| 消息面板历史 | 6 | TC15-TC20 |
| 标签拖动排序 | 6 | TC21-TC26 |

---

## 7. 风险评估

### 7.1 整体评估

- **P0 问题**: 0 个
- **P1 问题**: 3 个
- **P2 问题**: 5 个
- **整体风险**: 🟢 低
- **建议**: ✅ 可进入设计阶段（所有问题已澄清）

### 7.2 风险详情

| 维度 | 风险描述 | 等级 | 缓解措施 |
|------|----------|------|----------|
| 技术风险 | 标签切换后标题恢复问题涉及状态管理，可能存在深层 Bug | 🟡 中 | 详细代码审查 |
| 业务风险 | 消息历史倒序排列与常规习惯不同，用户可能不适应 | 🟢 低 | 确认需求意图 |
| 项目风险 | 功能点较多但都是修复类，范围可控 | 🟢 低 | 按 FR 逐一实现 |

### 7.3 问题清单

| 优先级 | 数量 | 问题描述 |
|--------|------|----------|
| P0 | 0 | - |
| P1 | 3 | 1. FR-2 右键菜单全面检查<br>2. FR-3 状态管理 Bug 修复<br>3. FR-7 复制失败处理 |
| P2 | 5 | 1. FR-1 单复数处理<br>2. FR-3 路径兼容性<br>3. FR-5 平滑动画<br>4. FR-8 倒序习惯<br>5. FR-9 拖拽边界 |

### 7.4 已澄清问题

| 编号 | 问题 | 关联FR | 决议 |
|------|------|--------|------|
| 1 | 历史记录容量管理方式 | FR-8 | 单标签页独立，不持久化，不支持下动清空 |
| 2 | 未保存文件 Tooltip 显示 | FR-4 | 区分状态：从未保存显示"未保存"，已保存但修改显示路径+"(已修改)" |
| 3 | SQL 截断显示规则 | FR-6 | 固定最大长度 100 字符，复制时复制完整 SQL |
| 4 | 拖拽排序持久化策略 | FR-9 | 不持久化，仅内存中调整，重启后不恢复 |
| 5 | 复制成功提示方式 | FR-7 | 按钮文字从"复制"变为"已复制"，2秒后恢复 |

---

*文档创建时间: 2026-02-04*  
*更新时间: 2026-02-04*  
*审查标准: 6维度质量扫描（一致性、完整性、清晰性、准确性、无重复性、可验证性）*  
*状态: 所有问题已澄清，可进入设计阶段*
