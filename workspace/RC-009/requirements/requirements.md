# RC-009 需求规格说明书

## 1. 概述

| 项目 | 内容 |
|------|------|
| 变更编号 | RC-009 |
| 变更日期 | 2026-01-19 |
| 优先级 | P2-中 |
| 影响范围 | 全栈 |
| 需求来源 | requirements/requirements_change/requirements_change_9.md |

### 变更范围

本次变更涉及 SQL 编辑器的四个功能增强：
1. ORDER BY 子句字段自动补全
2. 自动添加 LIMIT 功能修复
3. 结果导出功能升级（新增 Excel 格式）
4. 大数据量结果切换性能优化

## 2. 业务目标

### 2.1 解决的问题
- 用户在编写 ORDER BY 子句时无法获得字段提示，影响编写效率
- 带分号的 SQL 语句执行时因自动添加 LIMIT 导致语法错误
- 用户需要将查询结果导出为 Excel 格式进行数据分析
- 大数据量查询结果导致编辑器切换卡顿，影响使用体验

### 2.2 用户价值
- 提高 SQL 编写效率（字段补全）
- 确保 SQL 执行准确性（LIMIT 修复）
- 增强数据导出便利性（Excel 支持）
- 提升大数据量场景下的操作流畅度（性能优化）

## 3. 功能性需求（FR）

---

### FR-001: ORDER BY 子句字段自动补全

**优先级**: P0

**功能描述**: 在 SQL 语句的 ORDER BY 子句后，自动提示当前查询涉及的表的字段列表，提高用户编写排序语句的效率。

**用户场景**: 
- 用户编写 `SELECT * FROM table ORDER BY ` 时，系统自动弹出可排序的字段提示
- 用户可以通过键盘选择或输入部分字段名进行过滤

**输入/输出**: 
- 输入: SQL 语句文本，光标位置位于 ORDER BY 关键字后
- 输出: 当前查询涉及的所有表的字段补全列表

**业务规则**:
1. **单表查询**: 提示该表的所有字段
   - 示例: `SELECT * FROM users ORDER BY ` → 提示 users 表所有字段
2. **多表 JOIN 查询**: 提示所有涉及表的字段
   - 多表场景下字段应带表别名/表名前缀
   - 示例: `SELECT * FROM users u JOIN orders o ON ... ORDER BY ` → 提示 `u.id`, `u.name`, `o.order_id` 等
3. **表别名解析**: 正确解析 AS 别名和隐式别名
4. **子查询支持**: 如果 FROM 子句包含子查询，提示子查询的输出列

**异常处理**:
- 如果无法解析表名，不提供字段补全
- 如果表在元数据中不存在，仅提示关键字

**验收标准**:
- [x] `SELECT * FROM post_recruit_post ORDER BY ` → 提示 post_recruit_post 表字段
- [x] `SELECT * FROM post_recruit_post p INNER JOIN post_data d ON p.post_data_id = d.post_data_id ORDER BY ` → 提示 p 和 d 两个表的字段（带前缀）
- [x] 支持 ORDER BY 后已有部分输入时的过滤提示
- [x] 支持 GROUP BY 子句后的字段补全（同样逻辑）

---

### FR-002: 自动添加 LIMIT 功能修复

**优先级**: P0

**功能描述**: 修复当 SQL 语句末尾带分号时，自动添加 LIMIT 导致语法错误的问题。

**用户场景**: 
- 用户执行 `SELECT * FROM table;`（注意末尾分号）
- 当前系统错误生成 `SELECT * FROM table; LIMIT 5000`
- 期望系统生成 `SELECT * FROM table LIMIT 5000`

**输入/输出**:
- 输入: 用户提交的 SQL 语句（可能带分号）
- 输出: 正确添加 LIMIT 子句的 SQL 语句

**业务规则**:
1. **检测现有 LIMIT**: 如果 SQL 已包含 LIMIT 子句，不再添加
2. **处理末尾分号**: 在添加 LIMIT 前，移除 SQL 末尾的分号
3. **添加 LIMIT**: 在处理后的 SQL 末尾添加 ` LIMIT {maxRows}`
4. **仅处理 SELECT**: 只对 SELECT 语句添加 LIMIT

**异常处理**:
- 多条 SQL 语句（分号分隔）：每条 SELECT 语句单独处理
- 非 SELECT 语句：不添加 LIMIT

**验收标准**:
- [x] `SELECT * FROM table;` → 执行 `SELECT * FROM table LIMIT 5000`，正常返回结果
- [x] `SELECT * FROM table` → 执行 `SELECT * FROM table LIMIT 5000`，正常返回结果
- [x] `SELECT * FROM table LIMIT 100;` → 执行 `SELECT * FROM table LIMIT 100`，不添加额外 LIMIT
- [x] `SELECT * FROM table;  ` （末尾有空格）→ 正确处理
- [x] 多条语句 `SELECT * FROM t1; SELECT * FROM t2;` → 每条独立处理

---

### FR-003: 结果导出功能升级 - Excel 格式支持

**优先级**: P1

**功能描述**: 在现有 CSV/JSON 导出基础上，增加 Excel (xlsx) 格式导出，并优化导出按钮的交互方式。

**用户场景**: 
- 用户查询数据后，希望导出为 Excel 格式进行进一步分析
- 用户点击导出按钮时，可选择不同的导出格式

**输入/输出**:
- 输入: 当前查询结果集（columns + rows）
- 输出: xlsx / csv / json 格式的文件

**业务规则**:
1. **UI 交互**:
   - 显示一个主按钮（默认显示 xlsx 或"导出"）
   - 鼠标悬停时显示下拉菜单，包含三个选项：xlsx、CSV、JSON
   - 点击选项后触发对应格式的导出
2. **Excel 导出规则**:
   - 第一行为列头（列名）
   - 数据从第二行开始
   - 列宽自适应内容
   - 支持中文内容
   - 日期/时间类型正确格式化
3. **文件命名**: 默认文件名为 `export.xlsx`，用户可修改

**异常处理**:
- 无查询结果时，导出按钮禁用或提示
- 导出失败时显示错误信息

**验收标准**:
- [x] 导出按钮鼠标悬停显示下拉菜单（xlsx、CSV、JSON）
- [x] 点击 xlsx 选项，弹出保存对话框
- [x] 保存的 Excel 文件可用 Excel/WPS 正确打开
- [x] Excel 文件包含正确的列头和数据
- [x] 中文内容正确显示，无乱码
- [x] 原有 CSV/JSON 导出功能不受影响

---

### FR-004: 大数据量结果切换性能优化

**优先级**: P2

**功能描述**: 优化当查询结果行数和列数较多时，切换编辑器标签页的性能，减少卡顿感。

**用户场景**: 
- 用户执行查询返回 5000 行 × 20 列数据
- 用户切换到其他编辑器标签页时感觉明显卡顿
- 优化后切换应流畅无感知延迟

**输入/输出**:
- 输入: 大数据量查询结果（数千行、数十列）
- 输出: 流畅的标签页切换体验

**业务规则**:
1. **性能目标**: 5000 行 × 20 列数据，切换标签页响应时间 < 100ms
2. **优化策略**:
   - 可采用虚拟滚动（只渲染可视区域行）
   - 可采用结果数据懒加载
   - 可优化 DOM 更新策略
3. **兼容性**: 优化后不影响现有功能（编辑、导出、查看等）

**异常处理**:
- 极大数据量（超过 10000 行）时可考虑分页或提示

**验收标准**:
- [x] 5000 行 × 20 列数据，切换标签页无明显卡顿
- [x] 表格滚动流畅
- [x] 双击编辑、右键菜单等功能正常
- [x] 导出功能正常（导出完整数据，非仅可视区域）

---

## 4. 非功能性需求（NFR）

### 4.1 性能要求
- ORDER BY 补全响应时间 < 200ms
- 标签页切换响应时间 < 100ms（5000行数据）
- Excel 导出 5000 行数据时间 < 3s

### 4.2 兼容性要求
- 导出的 Excel 文件兼容 Excel 2007+、WPS
- 支持 Windows/Mac 系统

### 4.3 易用性要求
- 导出按钮交互直观，无需额外学习成本
- 字段补全与现有补全体验一致

## 5. 验收标准总览

### 功能验收清单

| 功能 | 验收项 | 优先级 |
|------|--------|--------|
| FR-001 | 单表 ORDER BY 字段补全 | P0 |
| FR-001 | 多表 JOIN ORDER BY 字段补全 | P0 |
| FR-002 | 带分号 SQL 正确执行 | P0 |
| FR-002 | 不重复添加 LIMIT | P0 |
| FR-003 | Excel 导出功能可用 | P1 |
| FR-003 | 下拉菜单交互正确 | P1 |
| FR-004 | 大数据量切换流畅 | P2 |

### 非功能验收清单

| 类型 | 验收项 |
|------|--------|
| 性能 | 补全响应 < 200ms |
| 性能 | 切换响应 < 100ms |
| 兼容 | Excel 文件可正确打开 |

## 6. 附录

### 变更历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 1.0 | 2026-01-21 | AI | 初始版本 |

### 参考文档

- 原始需求: requirements/requirements_change/requirements_change_9.md
- SQL Language Server 设计: requirements/tech-design/sql-language-server.md
