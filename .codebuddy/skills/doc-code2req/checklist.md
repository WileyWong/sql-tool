# 代码逆向需求推导检查清单

完整的代码逆向需求推导检查清单，确保分析质量和完整性。

---

## 前置条件检查

- [ ] 已获取完整源代码或目标代码片段
- [ ] 代码可编译或结构完整
- [ ] 已明确分析范围和重点
- [ ] 已了解基本业务背景（可选但推荐）
- [ ] 已确认输出路径（默认 `docs/reverse/requirement/`）

---

## 步骤 1: 确定范围

- [ ] 已明确代码范围（项目/模块/功能/片段）
- [ ] 已明确分析重点（全面/功能/业务规则/数据/非功能）
- [ ] 已询问或了解业务背景（系统用途、核心流程）
- [ ] 已确认是否有特殊约束或关注点

---

## 步骤 2: 强制读取所有项目文件（⚠️ 关键步骤）

### 2.1 文件扫描

- [ ] 已使用 `search_file` 扫描所有 `*.java` 文件
- [ ] 已使用 `search_file` 扫描所有 `*.yml` 配置文件
- [ ] 已使用 `search_file` 扫描所有 `*.xml` 配置文件
- [ ] 已使用 `search_file` 扫描所有前端文件（*.vue, *.js, *.ts, *.tsx）
- [ ] 已使用 `search_file` 扫描所有 SQL 文件（*.sql）
- [ ] 文件扫描覆盖完整（未遗漏任何类型）

### 2.2 批量读取

- [ ] 已使用 `read_file` 批量读取所有 Controller 文件
- [ ] 已使用 `read_file` 批量读取所有 Service 文件
- [ ] 已使用 `read_file` 批量读取所有 Mapper 文件
- [ ] 已使用 `read_file` 批量读取所有 Entity 文件
- [ ] 已使用 `read_file` 批量读取所有配置文件
- [ ] 已使用 `read_file` 批量读取前端代码（如适用）

### 2.3 文件索引

- [ ] 已构建完整的文件索引（按类型分类）
- [ ] 已记录 Controller 层文件列表
- [ ] 已记录 Service 层文件列表
- [ ] 已记录 Mapper 层文件列表
- [ ] 已记录 Entity 层文件列表
- [ ] 已记录配置文件列表
- [ ] 已记录前端文件列表（如适用）

### 2.4 验证

- [ ] 文件数量与实际项目匹配
- [ ] 核心业务代码已全部读取
- [ ] 配置文件已全部读取（application.yml, pom.xml 等）
- [ ] 无文件遗漏（对比项目目录结构）

---

## 步骤 3: 识别技术栈

### 3.1 后端框架识别

- [ ] 已识别 Spring Boot 版本（从 pom.xml 或代码注解）
- [ ] 已识别 ORM 框架（MyBatis-Plus/MyBatis/JPA）
- [ ] 已识别数据库类型（MySQL/PostgreSQL/其他）
- [ ] 已识别缓存组件（Redis/Caffeine/其他）
- [ ] 已识别消息队列（RabbitMQ/Kafka/其他，如有）

### 3.2 前端框架识别

- [ ] 已识别前端框架（Vue，如有）
- [ ] 已识别前端版本（从 package.json）
- [ ] 已识别状态管理（Redux/Vuex/Pinia，如有）
- [ ] 已识别 UI 组件库（Ant Design/Element UI，如有）

### 3.3 其他技术组件

- [ ] 已识别认证方式（JWT/Session/OAuth2）
- [ ] 已识别权限框架（Spring Security/Shiro）
- [ ] 已识别日志框架（SLF4J/Log4j2/Logback）
- [ ] 已识别构建工具（Maven/Gradle）

---

## 步骤 4: 功能需求推导

### 4.1 从 Controller 提取 API 接口

- [ ] 已提取所有 Controller 的 API 路径
- [ ] 已提取所有 HTTP 方法（GET/POST/PUT/DELETE）
- [ ] 已提取所有请求参数（路径参数、查询参数、请求体）
- [ ] 已提取所有响应格式
- [ ] 已提取权限控制注解（@PreAuthorize）
- [ ] 已提取参数验证注解（@Valid）

### 4.2 深度跟踪方法调用链（⭐ 核心增强）

**调用链跟踪完整性**:
- [ ] 每个 API 接口都有完整的调用链分析
- [ ] 调用链深度 >= 3 层（Controller → Service → Mapper/外部服务）
- [ ] 已跟踪 Controller 中调用的所有 Service 方法
- [ ] 已跟踪 Service 内部调用的所有子方法
- [ ] 已跟踪所有 Mapper 方法调用
- [ ] 已追溯 Mapper 方法到 SQL 语句（从 XML 文件）
- [ ] 已追溯 SQL 语句到数据库表
- [ ] 已标注所有外部服务调用（第三方 API、消息队列）

**调用链文档化**:
- [ ] 已绘制调用链图（Mermaid graph TD）
- [ ] 调用链图包含所有层级
- [ ] 每个调用层级都有代码位置（文件名:行号）
- [ ] 每个调用层级都有作用说明
- [ ] 已记录每个 Mapper 方法的 SQL 语句
- [ ] 已记录每个 SQL 访问的数据库表
- [ ] 已记录外部服务调用的详细信息

### 4.3 复杂功能拆分分析（⭐ 新增）

**拆分条件识别**:
- [ ] 已识别所有满足拆分条件的复杂功能
- [ ] 调用链深度 >= 4 层的功能已标记
- [ ] 涉及数据库表 >= 3 个的功能已标记
- [ ] 涉及外部服务 >= 2 个的功能已标记
- [ ] Service 方法内部调用 >= 5 个子方法的功能已标记
- [ ] 存在明确业务阶段的功能已标记

**拆分分析执行**:
- [ ] 复杂功能已拆分为多个子步骤
- [ ] 每个子步骤有明确的目标说明
- [ ] 每个子步骤有独立的调用链分析
- [ ] 每个子步骤有详细的业务规则分析
- [ ] 每个子步骤有完整的数据流分析
- [ ] 子步骤之间的数据传递已记录
- [ ] 已绘制完整的业务流程序列图（Mermaid sequenceDiagram）

### 4.4 代码位置标注

- [ ] 每个功能需求都有代码位置（文件名:行号）
- [ ] 每个 API 接口都有 Controller 位置
- [ ] 每个业务流程都有 Service 位置
- [ ] 每个数据操作都有 Mapper 位置
- [ ] 代码位置精确到行号

---

## 步骤 5: 业务规则提取（⭐ 深度分析 + 清晰准确无歧义）

### 5.1 显式规则提取

- [ ] 所有 if-else 条件判断已分析
- [ ] 所有 switch 分支已分析
- [ ] 所有 @Valid 验证规则已提取
- [ ] 所有自定义验证器已分析
- [ ] 所有计算公式已提取
- [ ] 所有状态转换已识别

### 5.2 隐式规则提取

- [ ] 已从代码结构推断隐式规则
- [ ] 已从注释中提取业务规则
- [ ] 已从异常消息推断约束条件
- [ ] 已从循环处理推断批量规则
- [ ] 已标注推断依据（代码位置）

### 5.3 业务流程深度分析（⭐ 核心增强）

**状态转换分析**:
- [ ] 已识别所有状态机（如订单状态、用户状态）
- [ ] 已绘制状态转换图（Mermaid stateDiagram-v2）
- [ ] 状态转换图包含所有状态节点
- [ ] 状态转换图包含所有转换条件
- [ ] 每个状态转换都有代码位置
- [ ] 每个状态转换都有触发事件说明

**分支处理分析**:
- [ ] 已识别所有复杂的分支处理逻辑
- [ ] 已绘制分支处理流程图（Mermaid flowchart TD）
- [ ] 流程图包含所有判断节点
- [ ] 流程图包含所有异常分支
- [ ] 每个判断条件都有业务规则说明

**时序依赖分析**:
- [ ] 已识别所有时序敏感的业务流程
- [ ] 已绘制时序依赖图（Mermaid sequenceDiagram）
- [ ] 时序图标注关键的时序依赖点
- [ ] 已记录时序依赖的业务规则
- [ ] 已标注失败时的回滚策略

### 5.4 业务规则清晰度验证（⭐ v5.0 新增）

**模态动词使用**:
- [ ] 所有规则使用明确的模态动词（必须/应当/禁止/仅当...时/允许）
- [ ] 强制性要求使用"必须" (MUST)
- [ ] 推荐性要求使用"应当" (SHOULD)
- [ ] 明确禁止使用"禁止" (MUST NOT)
- [ ] 条件触发使用"仅当...时" (ONLY WHEN)
- [ ] 无模糊表述（如"可能"、"大概"、"尽量"）

**量化指标**:
- [ ] 所有数值指标都有明确数字（如 "3-20 个字符" 而非 "不能太长"）
- [ ] 所有时间指标都有精确值（如 "30 分钟" 而非 "一段时间"）
- [ ] 所有百分比都有具体值（如 ">= 80%" 而非 "大多数"）
- [ ] 所有阈值都有明确边界（如 ">= 99 元" 而非 "金额较高时"）

**时间点明确**:
- [ ] 所有时间点都有精确表述（如 "凌晨 2:00" 而非 "每天定期"）
- [ ] 所有时间段都有具体数值（如 "7 天" 而非 "一段时间后"）
- [ ] 所有超时时间都有精确值（如 "30 分钟" 而非 "超时后"）

**状态和条件精确**:
- [ ] 所有状态都有明确的枚举值（如 `PENDING_PAYMENT` 而非 "待处理"）
- [ ] 所有条件都有精确的比较运算符（>、<、≥、≤、==）
- [ ] 所有布尔条件都有明确的判断逻辑

**业务术语具体**:
- [ ] 使用项目中的实际术语（而非通用描述）
- [ ] 使用具体的业务动作（如 "发送短信和站内信" 而非 "通知用户"）
- [ ] 使用明确的业务对象（如 "支付宝API" 而非 "第三方服务"）

**异常处理明确**:
- [ ] 每个规则都明确异常类型（如 `ValidationException`）
- [ ] 每个异常都有明确的错误消息
- [ ] 每个异常都有明确的触发条件

**数学公式精确**:
- [ ] 所有计算公式都有完整的数学表达式
- [ ] 使用数学符号（Σ、×、÷、floor、ceil）
- [ ] 明确运算顺序和取整规则（向上/向下取整）
- [ ] 提供计算示例（如 "258.00 元 → 25 分"）

**优先级和范围明确**:
- [ ] 使用明确的限定词（最多/最少/至少/不超过）
- [ ] 明确数量限制（如 "最多 1 张满减券 + 1 张折扣券"）
- [ ] 明确范围边界（包含/不包含边界值）

**无二义性**:
- [ ] 每条规则只有唯一解释
- [ ] 无"可能"、"大概"、"尽量"等不确定表述
- [ ] 每条规则都可以写出明确的测试用例
- [ ] 给定输入可以明确预期输出

### 5.5 异常处理和边界条件

- [ ] 已分析所有 try-catch 异常处理逻辑
- [ ] 已记录异常处理策略（重试/回滚/通知）
- [ ] 已识别所有边界条件（最大值/最小值/空值）
- [ ] 已记录边界条件的验证逻辑
- [ ] 已标注异常处理的代码位置

---

## 步骤 6: 数据需求分析

### 6.1 数据模型

- [ ] 已提取所有 Entity 类的字段定义
- [ ] 已记录字段类型、长度、约束
- [ ] 已记录数据库注解（@Table, @Column, @Id）
- [ ] 已记录 MyBatis-Plus 注解（@TableName, @TableId, @TableField）
- [ ] 已记录字段的业务含义

### 6.2 数据关系

- [ ] 已识别所有一对一关系（@OneToOne）
- [ ] 已识别所有一对多关系（@OneToMany）
- [ ] 已识别所有多对一关系（@ManyToOne）
- [ ] 已识别所有多对多关系（@ManyToMany）
- [ ] 已绘制 ER 图（Mermaid erDiagram）
- [ ] ER 图包含所有实体和关系

### 6.3 数据流

- [ ] 已分析数据流转过程（输入 → 验证 → 处理 → 存储 → 输出）
- [ ] 已记录 DTO 转 Entity 的转换逻辑
- [ ] 已记录 Entity 转 VO 的转换逻辑
- [ ] 已记录缓存策略（Redis 缓存的数据类型）
- [ ] 已记录数据流转的代码位置

### 6.4 验证规则

- [ ] 已提取所有字段约束（@NotNull, @Size, @Pattern）
- [ ] 已提取所有业务验证（唯一性、引用完整性）
- [ ] 已记录数据格式要求（日期、金额、邮箱）
- [ ] 已记录验证失败的错误消息

---

## 步骤 7: 非功能需求推导

### 7.1 性能需求

- [ ] 已识别缓存机制（@Cacheable, Redis）
- [ ] 已识别分页处理（MyBatis-Plus Page）
- [ ] 已从日志/监控推断响应时间要求
- [ ] 已识别并发控制（@Async, 线程池）
- [ ] 已记录性能相关配置（连接池大小、缓存过期时间）

### 7.2 安全需求

- [ ] 已识别认证方式（JWT, Session, OAuth2）
- [ ] 已识别授权控制（@PreAuthorize, RBAC）
- [ ] 已识别数据加密（密码、敏感字段）
- [ ] 已识别 SQL 注入防护（MyBatis 参数化查询）
- [ ] 已识别 XSS 防护（输入输出转义）
- [ ] 已记录安全相关配置（密码强度、会话超时）

### 7.3 可靠性需求

- [ ] 已识别异常处理（@ControllerAdvice）
- [ ] 已识别事务管理（@Transactional）
- [ ] 已识别日志记录（@Slf4j, log.info/error）
- [ ] 已识别重试机制（@Retryable）
- [ ] 已记录可靠性相关配置（事务超时、重试次数）

### 7.4 可维护性需求

- [ ] 已评估代码规范遵守情况
- [ ] 已评估注释完整性
- [ ] 已评估单元测试覆盖率（如有测试代码）
- [ ] 已评估模块化和解耦程度
- [ ] 已记录技术债务和改进建议

---

## 步骤 8: 生成需求文档

### 8.1 文档结构

- [ ] 文档包含 YAML Frontmatter（title, generated_date, source_code, files_analyzed, tech_stack）
- [ ] 文档包含项目概览章节（技术栈、代码结构、已分析文件清单）
- [ ] 文档包含功能需求章节（所有 FR）
- [ ] 文档包含业务规则章节（所有 BR）
- [ ] 文档包含数据需求章节（实体模型、ER 图、数据流）
- [ ] 文档包含非功能需求章节（所有 NFR）
- [ ] 文档包含代码位置索引（功能模块、API 接口、关键配置）
- [ ] 文档包含技术债务与改进建议

### 8.2 功能需求章节

- [ ] 每个功能需求有唯一编号（FR-001, FR-002）
- [ ] 每个功能需求有功能描述
- [ ] 每个功能需求有复杂度评估（调用链深度、表数量、外部服务数量）
- [ ] 每个功能需求有完整调用链（Mermaid graph TD）
- [ ] 每个功能需求有调用链详情（层级说明、代码位置）
- [ ] 复杂功能有子步骤拆分分析
- [ ] 复杂功能有完整业务流程序列图（Mermaid sequenceDiagram）
- [ ] 每个功能需求有 API 接口定义
- [ ] 每个功能需求有核心代码片段
- [ ] 每个功能需求有关联业务规则引用
- [ ] 每个功能需求有关联数据表列表

### 8.3 业务规则章节

- [ ] 每个业务规则有唯一编号（BR-001, BR-002）
- [ ] 每个业务规则有规则类型（显式/隐式/状态转换/计算公式/验证规则）
- [ ] 每个业务规则有清晰准确的规则描述（使用模态动词、量化指标）
- [ ] 每个业务规则有代码位置（文件名:行号）
- [ ] 每个业务规则有实现逻辑（代码片段）
- [ ] 每个业务规则有约束条件（前置条件、后置条件、触发时机）
- [ ] 每个业务规则有关联功能引用
- [ ] 复杂业务规则有业务流程图（State Diagram/Flowchart/Sequence Diagram）
- [ ] 每个业务规则有异常处理说明

### 8.4 数据需求章节

- [ ] 每个实体有完整的字段定义表格
- [ ] 字段定义表格包含代码位置
- [ ] 每个实体有索引设计说明
- [ ] 每个实体有关联关系说明
- [ ] 包含完整的 ER 图（Mermaid erDiagram）
- [ ] ER 图包含所有实体和关系
- [ ] 包含数据流图（可选）

### 8.5 非功能需求章节

- [ ] 每个非功能需求有唯一编号（NFR-001, NFR-002）
- [ ] 每个非功能需求有需求描述
- [ ] 每个非功能需求有代码实现说明（代码位置）
- [ ] 每个非功能需求有量化指标（响应时间、并发数、可用性等）
- [ ] 每个非功能需求有相关配置说明

### 8.6 代码位置索引

- [ ] 包含功能模块索引表格（模块 → 文件映射）
- [ ] 包含 API 接口索引表格（路径 → 功能 → 代码位置）
- [ ] 包含关键配置索引表格（配置项 → 文件 → 作用）
- [ ] 索引表格清晰完整

### 8.7 输出路径

- [ ] 文档输出到规范路径（`docs/reverse/requirement/{模块名}-requirements.md`）
- [ ] 文件命名规范（模块名-requirements.md）
- [ ] 文档格式正确（Markdown）

---

## 遵循项目规范

- [ ] 遵循 [通用规范](mdc:.codebuddy/spec/global/standards/common/index.md)
- [ ] 遵循 [文档生成原则](mdc:.codebuddy/spec/global/standards/common/document-generation-rules.md)
- [ ] 遵循 [输出目录规范](mdc:.codebuddy/spec/global/standards/common/output-directory-standard.md)
- [ ] 只在用户明确要求时生成文档
- [ ] 优先原地修改现有文档

---

## 常见错误检查

### 错误 1: 未执行强制文件扫描

- [ ] 没有只读取部分文件就开始分析
- [ ] 没有基于猜测或假设分析代码
- [ ] 没有跳过配置文件或工具类
- [ ] 没有忽略前端代码（对于全栈项目）

### 错误 2: 方法调用跟踪不够深入

- [ ] 没有只记录 Controller → Service 的一层调用
- [ ] 没有忽略 Service 层的内部调用
- [ ] 没有忽略 Mapper 调用
- [ ] 调用链深度 >= 3 层（Controller → Service → Mapper/外部服务）
- [ ] 每个 Mapper 方法都追溯到了 SQL 语句和数据库表

### 错误 3: 复杂功能未拆分分析

- [ ] 没有对复杂功能只记录整体流程
- [ ] 满足拆分条件的功能都已拆分
- [ ] 每个子步骤都有详细分析（调用链、业务规则、数据流）
- [ ] 已绘制完整的业务流程序列图

### 错误 4: 业务规则提取不深入

- [ ] 没有只提取显式的 if-else 判断
- [ ] 已识别并绘制状态转换图
- [ ] 已识别并绘制分支处理流程图
- [ ] 已识别并绘制时序依赖图
- [ ] 所有计算公式已提取

### 错误 5: 业务规则描述模糊不清

- [ ] 没有使用模糊表述（"可能"、"大概"、"尽量"）
- [ ] 所有规则使用明确的模态动词
- [ ] 所有指标都有量化值
- [ ] 所有时间点都有精确表述
- [ ] 所有条件都有精确判断
- [ ] 每条规则都可以写出唯一的测试用例

### 错误 6: 忽略业务背景

- [ ] 没有只描述技术实现
- [ ] 已询问或了解业务场景
- [ ] 需求描述包含业务语义
- [ ] 使用业务术语而非纯技术术语

### 错误 7: 缺少代码位置

- [ ] 没有需求无法溯源的情况
- [ ] 每个需求都有代码位置（文件名:行号）
- [ ] 每个业务规则都有代码位置
- [ ] 每个调用层级都有代码位置

### 错误 8: 配置文件未分析

- [ ] 已读取 application.yml / application.properties
- [ ] 已读取 pom.xml / package.json
- [ ] 已读取 mybatis-config.xml（如适用）
- [ ] 已读取日志配置文件（如有）
- [ ] 配置信息已反映在非功能需求中

---

## 最终验证

### 完整性验证

- [ ] 所有文件都已读取和分析
- [ ] 所有功能需求都已提取
- [ ] 所有业务规则都已识别
- [ ] 所有数据模型都已分析
- [ ] 所有非功能需求都已推导

### 准确性验证

- [ ] 技术栈识别正确
- [ ] 调用链分析正确
- [ ] 业务规则描述准确
- [ ] 数据模型完整
- [ ] 代码位置标注正确

### 清晰度验证（⭐ v5.0 新增）

- [ ] 业务规则无二义性
- [ ] 所有指标量化明确
- [ ] 所有条件精确清晰
- [ ] 每条规则可测试可验证
- [ ] 文档可读性良好

### 文档质量验证

- [ ] 文档结构清晰完整
- [ ] 章节内容充实准确
- [ ] 图表清晰易懂（调用链图、ER 图、流程图）
- [ ] 代码位置索引详细
- [ ] 格式符合 Markdown 规范

---

## 使用建议

### 审查流程

1. **准备阶段**: 检查前置条件，明确分析范围
2. **扫描阶段**: 强制读取所有项目文件（步骤 2）
3. **识别阶段**: 识别技术栈和核心组件（步骤 3）
4. **分析阶段**: 深度分析功能、业务规则、数据（步骤 4-6）
5. **推导阶段**: 推导非功能需求（步骤 7）
6. **生成阶段**: 生成完整的需求文档（步骤 8）
7. **验证阶段**: 验证文档完整性和准确性

### 审查重点

- **完整性优先**: 确保所有文件都已读取和分析
- **深度优先**: 深度跟踪调用链，深度提取业务规则
- **清晰度优先**: 业务规则描述清晰准确无歧义
- **溯源性**: 每个需求都能溯源到代码位置

### 团队协作

- **统一标准**: 使用统一的检查清单
- **定期审查**: 定期验证分析质量
- **持续改进**: 根据反馈优化分析方法
- **知识分享**: 分享分析经验和最佳实践
