# tdd-testing 检查清单

## ⚠️ 强制检查点说明

> **重要**: 每个检查点必须通过才能进入下一步，不可跳过！

| 检查点 | 位置 | 检查内容 | 不通过处理 |
|--------|------|----------|-----------|
| **检查点1** | 步骤1完成后 | 测试用例内容完整、符合规范 | 修正后重新检查 |
| **检查点2** | 步骤2完成后 | 代码完整、无语法错误、无编译错误 | 修正后重新检查 |
| **检查点3** | 步骤3完成后 | 输出详细测试报告文档并包含总结 | 补充报告内容 |
| **清理询问** | 流程结束时 | 如需清理，询问用户是否执行 | 等待用户确认 |

---

## 步骤 0: 输入判断

### 输入类型识别

- [ ] 判断输入是代码文件还是文档
- [ ] 如果是代码，识别是 HTTP RESTful API 代码还是业务代码
- [ ] 如果是文档，判断是否为测试用例设计文档
- [ ] 确定使用的策略路径

### 代码类型判断

```yaml
HTTP_RESTful_API_代码标识:
  - 包含 @RestController 注解
  - 包含 @Controller 注解
  - 包含 @RequestMapping/@GetMapping/@PostMapping 等
  - 文件名包含 Controller/Resource/Endpoint

业务代码标识:
  - 包含 @Service 注解
  - 包含 @Repository 注解
  - 文件名包含 Service/Repository/Utils/Helper
```

### 文档类型判断

```yaml
测试用例设计文档标识:
  必须包含:
    - 测试用例列表（含用例ID/名称）
    - 测试场景描述
    - 预期结果
  
非测试用例文档:
  - API 接口文档（OpenAPI/Swagger）
  - 需求文档（PRD/用户故事）
  - 设计文档（技术方案）
```

---

## 步骤 1: 设计测试用例文档

### api-test 策略检查

- [ ] 分析接口文档或 API 代码
- [ ] 提取所有 API 端点
- [ ] 设计功能测试用例（正常流程）
- [ ] 设计参数验证用例（必填/边界/格式）
- [ ] 设计业务规则用例
- [ ] 设计异常场景用例（401/403/404/409/500）
- [ ] 设计安全测试用例（认证/授权/注入）
- [ ] 设计性能测试用例（可选）

### whitebox 策略检查

- [ ] 分析代码实现
- [ ] 提取验证规则和约束
- [ ] 识别业务分支和条件
- [ ] 识别异常处理逻辑
- [ ] 识别事务边界
- [ ] 设计覆盖所有分支的用例
- [ ] 设计边界值测试用例
- [ ] 设计异常触发用例

### normalize 策略检查

- [ ] 检查文档结构完整性
- [ ] 补充缺失的元信息
- [ ] 统一用例 ID 格式
- [ ] 统一用例命名规范
- [ ] 补充缺失的前置条件
- [ ] 补充缺失的测试步骤
- [ ] 补充缺失的预期结果
- [ ] 补充清理策略（集成测试）

---

## ✅ 检查点1: 测试用例完整性验证（必须通过）

> **⚠️ 强制要求**: 此检查点必须全部通过才能进入步骤2！

### 结构完整性

- [ ] 包含文档元信息（change_id/domain/test_type）
- [ ] 包含测试范围说明
- [ ] 包含用例分类

### 用例规范性

- [ ] 每个用例有唯一 ID
- [ ] 用例命名遵循 Method-Scenario-Expected 模式
- [ ] 包含前置条件
- [ ] 包含测试步骤
- [ ] 包含预期结果

### 覆盖完整性

- [ ] 正常流程覆盖
- [ ] 参数验证覆盖
- [ ] 异常场景覆盖
- [ ] 业务规则覆盖

### 可执行性

- [ ] 测试数据明确
- [ ] 清理策略明确（集成测试）

### 检查点1通过标准

```
✅ 通过条件:
  - 所有结构完整性检查项通过
  - 所有用例规范性检查项通过
  - 覆盖完整性检查项至少 80% 通过
  - 所有可执行性检查项通过

❌ 不通过处理:
  1. 列出未通过的检查项
  2. 修正测试用例文档
  3. 重新执行检查点1验证
  4. 直到全部通过才能继续
```

---

## 步骤 2: 生成测试代码

### api-test 代码检查

- [ ] 使用 OkHttp3 构建 HTTP 请求
- [ ] 正确设置请求头（Content-Type/Authorization）
- [ ] 正确构建请求体
- [ ] 正确解析响应
- [ ] 断言状态码
- [ ] 断言响应体结构
- [ ] 断言业务数据
- [ ] 生成清理代码

### unit-test 代码检查

- [ ] 使用 JUnit 5 + Mockito
- [ ] 正确 Mock 依赖
- [ ] 遵循 AAA 模式（Arrange-Act-Assert）
- [ ] 测试方法命名规范
- [ ] 覆盖正常场景
- [ ] 覆盖异常场景
- [ ] 覆盖边界场景
- [ ] 验证 Mock 交互

---

## ✅ 检查点2: 代码完整性验证（必须通过）

> **⚠️ 强制要求**: 此检查点必须全部通过才能进入步骤3！

### 代码完整性

- [ ] 所有测试方法已生成
- [ ] 所有 import 语句完整
- [ ] 所有依赖类已引用
- [ ] 清理代码已生成（集成测试）

### 语法检查

- [ ] 无 Java 语法错误
- [ ] 括号匹配正确
- [ ] 字符串闭合正确
- [ ] 注解使用正确

### 编译检查

- [ ] 执行 `mvn compile -DskipTests` 成功
- [ ] 执行 `mvn test-compile` 成功
- [ ] 无编译错误
- [ ] 无编译警告（可选）

### 规范检查

- [ ] 测试方法命名规范（test_Method_Scenario_Expected）
- [ ] 遵循 AAA 模式（Arrange-Act-Assert）
- [ ] Mock 配置正确（单元测试）
- [ ] HTTP 请求配置正确（集成测试）

### 检查点2通过标准

```
✅ 通过条件:
  - 所有代码完整性检查项通过
  - 所有语法检查项通过
  - 所有编译检查项通过
  - 规范检查项至少 80% 通过

❌ 不通过处理:
  1. 列出编译错误和语法错误
  2. 修正测试代码
  3. 重新执行编译检查
  4. 直到全部通过才能继续

验证命令:
  mvn compile -DskipTests    # 编译主代码
  mvn test-compile           # 编译测试代码
```

---

## 步骤 3: 执行测试

### 执行前检查

- [ ] 测试环境配置正确
- [ ] 数据库连接可用
- [ ] 目标服务可访问（集成测试）
- [ ] 测试数据已准备

### 执行命令

```bash
# Maven
mvn test -Dtest=XxxTest

# Gradle
./gradlew test --tests "XxxTest"
```

---

## ✅ 检查点3: 测试报告输出（必须完成）

> **⚠️ 强制要求**: 测试执行完成后，必须输出详细测试报告并包含总结！

### 报告必须包含

- [ ] 测试执行时间
- [ ] 测试环境信息
- [ ] 测试范围说明
- [ ] 总用例数
- [ ] 通过数量及百分比
- [ ] 失败数量及百分比
- [ ] 跳过数量及百分比
- [ ] 执行总耗时
- [ ] 每个测试类的执行结果
- [ ] 失败用例的详细信息（原因/期望值/实际值/堆栈/建议）
- [ ] 测试结论
- [ ] 主要问题汇总
- [ ] 风险评估
- [ ] 后续建议

### 报告模板

```markdown
# 测试执行报告

## 基本信息
- **执行时间**: YYYY-MM-DD HH:mm:ss
- **测试环境**: [开发/测试/预发布]
- **测试范围**: [被测模块/接口名称]

## 测试统计

| 指标 | 数值 | 百分比 |
|------|------|--------|
| 总用例数 | N | 100% |
| 通过 | X | X% |
| 失败 | Y | Y% |
| 跳过 | Z | Z% |
| 执行耗时 | Xs | - |

## 详细结果

### 通过的测试
- ✅ test_Method1_Scenario1_Expected1
...

### 失败的测试

#### ❌ test_MethodX_ScenarioX_ExpectedX
- **失败原因**: [具体原因]
- **期望值**: [期望结果]
- **实际值**: [实际结果]
- **修复建议**: [具体建议]

## 总结

### 测试结论
[通过/失败] - [简要说明]

### 主要问题
1. [问题描述]

### 风险评估
[低/中/高] - [风险说明]

### 后续建议
1. [建议内容]
```

---

## 步骤 4: 清理（仅集成测试）

### 清理询问（必须执行）

> **⚠️ 强制要求**: 如果是集成测试，必须询问用户是否执行清理！

- [ ] 检查是否为集成测试
- [ ] 检查是否有待清理的测试数据
- [ ] 向用户展示待清理数据摘要
- [ ] 询问用户: "是否需要执行清理代码清理测试数据？[是/否]"
- [ ] 等待用户确认后再执行或跳过清理

### 清理检查（用户确认后执行）

- [ ] 按依赖顺序逆序清理
- [ ] 清理子表数据
- [ ] 清理主表数据
- [ ] 验证清理完成

### 清理方式

```yaml
推荐方式:
  1. 事务回滚（@Transactional）
  2. 显式删除（@AfterEach）
  3. 数据标记清理
  4. 数据库快照恢复
```

---

## AI 执行验证清单

```yaml
执行前:
  - [ ] 确认输入类型已正确识别
  - [ ] 确认策略路径已选择

步骤1完成后（检查点1）:
  - [ ] 确认测试用例设计文档已生成
  - [ ] 确认结构完整性检查通过
  - [ ] 确认用例规范性检查通过
  - [ ] 确认覆盖完整性检查通过
  - [ ] 确认可执行性检查通过
  - [ ] ⚠️ 未通过则修正后重新检查

步骤2完成后（检查点2）:
  - [ ] 确认测试代码语法正确
  - [ ] 确认测试代码可编译（mvn test-compile）
  - [ ] 确认无编译错误
  - [ ] ⚠️ 未通过则修正后重新检查

步骤3完成后（检查点3）:
  - [ ] 确认测试报告已生成
  - [ ] 确认报告包含所有必要内容
  - [ ] 确认报告包含总结
  - [ ] ⚠️ 未完成则补充报告内容

流程结束时（清理询问）:
  - [ ] 如果是集成测试，询问用户是否清理
  - [ ] 等待用户确认
  - [ ] 根据用户选择执行或跳过清理
```
