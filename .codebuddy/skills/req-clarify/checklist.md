---
title: req-clarify 检查清单
description: 需求澄清完成后的验证清单
---

# 需求澄清检查清单

## 前置条件检查

- [ ] 需求来源已提供（PRD/TAPD/文档链接/文本）
- [ ] 变更 ID 格式正确（格式: `YYYY-MM-DD-feature-name`）
- [ ] 已了解项目开发规范（参考 [开发指南](mdc:.spec-code/memory/guidelines.md)）
- [ ] 输出目录已确定（`workspace/{变更ID}/requirements/`）

---

## 步骤 1: 选择推进方式 - 质量检查

### 1.1 推进方式选择

- [ ] 已向用户展示 3 种推进方式（单个问题/按模块/一次性）
- [ ] 已说明每种方式的优点和适用场景
- [ ] 用户已明确选择推进方式（1/2/3）

**推进方式说明**:
```markdown
1️⃣ 单个问题逐一确认
   - 优点: 高精度决策，深入讨论每个问题
   - 适用: 复杂需求、需要深度澄清
   - 流程: 问题 1 → 决议 → 问题 2 → 决议 → ...

2️⃣ 按模块/功能点逐项确认（推荐）
   - 优点: 结构化推进，逻辑清晰
   - 适用: 需求已拆分为多个功能点（FR）
   - 流程: 模块 1（问题 1-4）→ 模块 2（问题 5-7）→ ...

3️⃣ 一次性全部确认
   - 优点: 快速闭环，减少沟通轮次
   - 适用: 问题数量少（<10 个）、时间紧迫
   - 流程: 一次性提出所有问题 → 批量回答 → 批量记录决议
```

### 1.2 推进方式记录

- [ ] 推进方式已写入 `clarifications.md` 的"执行策略"章节
- [ ] 执行策略章节包含：推进方式、优点、适用场景

**执行策略章节示例**:
```markdown
## 执行策略

**推进方式**: 按模块/功能点逐项确认

**优点**:
- 结构化推进，逻辑清晰
- 可按优先级处理不同模块
- 便于团队协作和分工

**适用场景**:
- 需求已拆分为多个功能点（FR）
- 需要分模块澄清业务规则
- 团队成员可并行处理不同模块
```

### 1.3 常见错误检查

**错误 1: 未询问推进方式**
- [ ] 必须询问用户选择推进方式（不能默认选择）
- [ ] 用户选择后才能开始澄清

**错误 2: 推进方式未记录**
- [ ] 推进方式必须写入 `clarifications.md` 的"执行策略"章节
- [ ] 方便后续回顾和审计

---

## 步骤 2: 识别问题（4 大维度扫描）- 质量检查

### 2.1 业务规则扫描

**业务规则待澄清问题识别**:
- [ ] 正常流程已分析（是否有模糊的流程步骤）
- [ ] 异常场景已分析（失败/超时/重复/并发/依赖服务失败）
- [ ] 边界条件已分析（数值边界、时间边界、数量边界）
- [ ] 业务约束已分析（限制条件、前置条件、触发条件）

**业务规则扫描示例**:
```markdown
✅ 正确识别:
原始需求: "用户可以下单购买商品"
待澄清问题: 
1. 库存不足时如何处理？（拒绝下单/预下单/等待补货）
2. 支付超时订单如何处理？（自动取消/保留订单/用户手动取消）
3. 并发下单同一商品如何处理？（行锁/乐观锁/队列）

❌ 错误识别:
原始需求: "用户可以下单购买商品"
待澄清问题: "使用哪种数据库？"（这是技术实现，不应澄清）
```

### 2.2 数据模型扫描

**数据模型待澄清问题识别**:
- [ ] 实体属性已分析（哪些字段模糊或缺失）
- [ ] 字段类型已分析（字符串/数字/日期/布尔）
- [ ] 必填/可选已分析（是否必填、默认值）
- [ ] 唯一性约束已分析（是否唯一、如何保证）
- [ ] 实体关系已分析（一对一/一对多/多对多）

**数据模型扫描示例**:
```markdown
✅ 正确识别:
原始需求: "用户注册时填写用户名和密码"
待澄清问题:
1. 用户名是否必填？（必填/非必填）
2. 用户名是否唯一？（唯一/可重复）
3. 用户名长度限制？（最少/最多字符）
4. 用户名是否可修改？（可修改/不可修改）

❌ 错误识别:
原始需求: "用户注册时填写用户名和密码"
待澄清问题: "用户名字段使用 VARCHAR 还是 TEXT？"（这是技术实现）
```

### 2.3 权限可见性扫描

**权限可见性待澄清问题识别**:
- [ ] 访问权限已分析（谁可以访问）
- [ ] 编辑权限已分析（谁可以编辑）
- [ ] 数据范围已分析（可见的数据范围）
- [ ] 权限粒度已分析（页面级/按钮级/字段级）

**权限可见性扫描示例**:
```markdown
✅ 正确识别:
原始需求: "用户可以查看订单详情"
待澄清问题:
1. 用户能否查看他人订单？（仅自己/所有订单/部门订单）
2. 订单中的敏感信息是否脱敏？（收货地址/手机号/金额）
3. 管理员权限是否不同？（管理员可查看所有订单）

❌ 错误识别:
原始需求: "用户可以查看订单详情"
待澄清问题: "使用 RBAC 还是 ABAC 权限模型？"（这是技术实现）
```

### 2.4 异常边界扫描

**异常边界待澄清问题识别**:
- [ ] 输入异常已分析（空值/超长/非法字符/特殊字符）
- [ ] 并发冲突已分析（同时修改/重复提交）
- [ ] 依赖服务失败已分析（第三方 API 失败/数据库超时）
- [ ] 资源耗尽已分析（库存耗尽/余额不足/超出限额）

**异常边界扫描示例**:
```markdown
✅ 正确识别:
原始需求: "用户可以发送验证码"
待澄清问题:
1. 验证码发送失败如何处理？（自动重试/提示用户/人工介入）
2. 短信服务不可用如何处理？（降级方案/邮件通知）
3. 同一手机号短时间内多次发送如何限制？（频率限制）

❌ 错误识别:
原始需求: "用户可以发送验证码"
待澄清问题: "使用阿里云短信还是腾讯云短信？"（这是技术实现）
```

### 2.5 扫描完整性验证

- [ ] 4 个维度全部扫描完成（业务规则、数据模型、权限可见性、异常边界）
- [ ] 每个维度至少识别 1 个待澄清问题（如果需求复杂）
- [ ] 待澄清问题数量合理（3-15 个，视需求复杂度而定）
- [ ] 待澄清问题已按模块/功能点分组（如果选择按模块推进）

**待澄清问题数量验证**:
```markdown
✅ 合理数量:
- 简单需求（如用户注册）: 3-5 个问题
- 中等需求（如订单管理）: 6-10 个问题
- 复杂需求（如支付系统）: 10-15 个问题

❌ 不合理数量:
- 问题过少（<3 个）: 可能扫描不完整
- 问题过多（>20 个）: 可能需求本身不清晰，建议先进行需求审查
```

### 2.6 常见错误检查

**错误 1: 识别了技术实现问题**
- [ ] 所有问题都是业务逻辑问题（不涉及技术选型、接口设计、性能指标）
- [ ] ❌ 错误示例: "使用 MySQL 还是 PostgreSQL？"
- [ ] ✅ 正确示例: "用户名是否唯一？"

**错误 2: 问题过于宽泛**
- [ ] 每个问题都是具体的、可回答的
- [ ] ❌ 错误示例: "订单功能如何设计？"
- [ ] ✅ 正确示例: "库存不足时如何处理？"

**错误 3: 问题重复**
- [ ] 没有重复的问题（不同表述但相同含义）
- [ ] 每个问题都是独立的

**错误 4: 遗漏关键问题**
- [ ] 核心业务规则都已识别（特别是异常场景）
- [ ] 数据模型的关键字段都已识别

---

## 步骤 3: 生成确认项 - 质量检查

### 3.1 确认项结构完整性

**每个确认项必须包含**:
- [ ] 标题（`## [NEEDS CLARIFICATION] {类别}: {标题}`）
- [ ] 当前描述（原始需求的相关描述）
- [ ] 关联功能（功能名称 + FR 编号，如有）
- [ ] 需要澄清的问题（1-3 个具体问题）
- [ ] 方案选项（2-4 个方案，每个方案包含描述、优点、缺点）
- [ ] 建议方案（推荐的方案 + 理由）
- [ ] 影响评估（如不澄清可能导致的风险）

**确认项结构示例**:
```markdown
✅ 正确结构:
## [NEEDS CLARIFICATION] 业务规则: 库存不足处理

**当前描述**: 订单提交后，系统扣减库存

**关联功能**: 订单下单功能（FR-001）

**需要澄清的问题**:
1. 库存不足时，是否允许下单？
2. 如何提示用户？

**方案选项**（三选一）:
- **方案 A: 拒绝下单**
  - 描述: 库存不足时提示"库存不足"，不创建订单
  - 优点: 逻辑简单，避免超卖
  - 缺点: 用户体验稍差
- **方案 B: 支持预下单**
  - 描述: 订单状态为"待补货"，补货后发货
  - 优点: 用户体验好，不丢失订单
  - 缺点: 增加状态管理复杂度
- **方案 C: 超卖后退款**
  - 描述: 允许下单，库存不足时扣款后退款
  - 优点: 最大化订单数量
  - 缺点: 用户体验极差

**建议方案**: 方案 A（拒绝下单）
- 理由: 初期逻辑简单，避免超卖风险；后期可升级为方案 B

**影响评估**: 
如不澄清，可能导致:
- 业务流程无法确定（开发无法编码）
- 用户体验不一致
- 后期大量返工
- 风险等级: 🔴 P0（阻塞性问题）

---

❌ 错误结构（缺少方案选项）:
## [NEEDS CLARIFICATION] 业务规则: 库存不足处理

**需要澄清的问题**: 库存不足时如何处理？

（缺少方案选项，无法让用户快速决策）
```

### 3.2 方案选项质量验证

**方案选项数量**:
- [ ] 每个问题提供 2-4 个方案选项
- [ ] ❌ 不能只提供 1 个方案（没有选择空间）
- [ ] ❌ 不能提供 >5 个方案（选择过多，决策困难）
- [ ] ✅ 2-4 个方案最佳（平衡选择空间和决策效率）

**方案选项内容质量**:
- [ ] 每个方案都有清晰的描述（是什么）
- [ ] 每个方案都有优点（为什么好）
- [ ] 每个方案都有缺点（为什么不好）
- [ ] 方案之间有明显区别（不能是同一方案的变体）

**方案选项示例**:
```markdown
✅ 正确方案选项:
- **方案 A: 拒绝下单**
  - 描述: 库存不足时提示"库存不足"，不创建订单
  - 优点: 逻辑简单，避免超卖
  - 缺点: 用户体验稍差

- **方案 B: 支持预下单**
  - 描述: 订单状态为"待补货"，补货后发货
  - 优点: 用户体验好，不丢失订单
  - 缺点: 增加状态管理复杂度

（2 个方案，明显区别，优缺点清晰）

---

❌ 错误方案选项:
- **方案 A**: 拒绝下单
- **方案 B**: 支持预下单

（缺少描述、优点、缺点）
```

### 3.3 建议方案合理性

- [ ] 建议方案已明确标注（方案 A/B/C/D）
- [ ] 建议方案有充分的理由（为什么推荐这个方案）
- [ ] 建议方案符合项目实际情况（考虑开发成本、时间、复杂度）

**建议方案示例**:
```markdown
✅ 正确建议:
**建议方案**: 方案 A（拒绝下单）
- 理由: 初期逻辑简单，避免超卖风险；后期可根据业务需要升级为方案 B

❌ 错误建议:
**建议方案**: 方案 A
（缺少理由，用户不知道为什么推荐这个方案）
```

### 3.4 影响评估准确性

**影响评估必须包含**:
- [ ] 不澄清的具体风险（业务流程无法确定/用户体验不一致/后期返工）
- [ ] 风险等级（🔴 P0 / 🟡 P1 / 🟢 P2）

**风险等级判断标准**:
```markdown
🔴 P0（阻塞性问题）:
- 影响核心业务流程
- 开发无法继续进行
- 可能导致严重的用户体验问题
- 示例: 库存不足处理、支付超时处理、权限控制

🟡 P1（重要问题）:
- 影响用户体验或业务效率
- 开发可暂时绕过，但后期需返工
- 示例: 数据保留时长、提示文案、默认值

🟢 P2（优化问题）:
- 不影响核心功能
- 可后期优化
- 示例: 界面细节、辅助功能
```

### 3.5 确认项分组（按模块推进时）

**如果选择"按模块/功能点逐项确认"**:
- [ ] 确认项已按模块/功能点分组（模块 1、模块 2、模块 3...）
- [ ] 每个模块有清晰的标题（如"模块 1: 订单下单（FR-001）"）
- [ ] 每个模块下的确认项编号连续（问题 1/4、问题 2/4...）

**分组示例**:
```markdown
✅ 正确分组:
## 模块 1: 订单下单（FR-001）

### [NEEDS CLARIFICATION] 业务规则: 库存不足处理
【确认项内容...】

### [NEEDS CLARIFICATION] 业务规则: 支付超时处理
【确认项内容...】

---

## 模块 2: 订单查看（FR-002）

### [NEEDS CLARIFICATION] 权限可见性: 订单可见范围
【确认项内容...】

---

❌ 错误分组（未分组，混乱）:
### [NEEDS CLARIFICATION] 业务规则: 库存不足处理
### [NEEDS CLARIFICATION] 权限可见性: 订单可见范围
### [NEEDS CLARIFICATION] 业务规则: 支付超时处理

（没有按模块分组，逻辑不清晰）
```

### 3.6 确认项写入文件

- [ ] 所有确认项已写入 `clarifications.md` 文件
- [ ] 文件路径: `workspace/{变更ID}/requirements/clarifications.md`
- [ ] 文件包含 YAML Frontmatter（变更 ID、创建时间、状态）
- [ ] 文件包含"执行策略"章节（推进方式）
- [ ] 文件包含所有确认项（按模块分组或按顺序排列）

**clarifications.md 文件结构**:
```markdown
---
变更ID: 2025-11-07-order-management
执行策略: 按模块/功能点逐项确认
创建时间: 2025-11-07 09:00
状态: 进行中
---

# 需求澄清记录

## 执行策略
【执行策略内容...】

---

## 模块 1: 订单下单（FR-001）

### [NEEDS CLARIFICATION] 业务规则: 库存不足处理
【确认项内容...】

### [NEEDS CLARIFICATION] 业务规则: 支付超时处理
【确认项内容...】

---

## 模块 2: 订单查看（FR-002）

【确认项内容...】
```

### 3.7 常见错误检查

**错误 1: 方案选项过少**
- [ ] 每个问题至少提供 2 个方案选项
- [ ] ❌ 错误: 只提供 1 个方案 → 用户没有选择空间

**错误 2: 方案选项缺少优缺点**
- [ ] 每个方案都有优点和缺点
- [ ] ❌ 错误: 只有方案描述，没有优缺点分析

**错误 3: 影响评估过于模糊**
- [ ] 影响评估具体明确（不能只说"影响很大"）
- [ ] ❌ 错误: "影响评估: 影响很大"
- [ ] ✅ 正确: "影响评估: 业务流程无法确定，开发无法编码"

**错误 4: 确认项未按模块分组（按模块推进时）**
- [ ] 如果选择"按模块推进"，确认项必须按模块分组
- [ ] ❌ 错误: 所有确认项混在一起

---

## 步骤 4: 提问并记录决议 - 质量检查

### 4.1 提问方式（根据推进方式）

**单个问题逐一确认**:
- [ ] 每次只提问 1 个问题
- [ ] 用户回答后，立即记录决议
- [ ] 继续提问下一个问题
- [ ] 提问格式: "问题 X/N: {问题标题}"

**按模块/功能点逐项确认**:
- [ ] 按模块顺序提问（模块 1 → 模块 2 → ...）
- [ ] 每个模块的所有问题一次性提出
- [ ] 用户回答后，记录该模块的所有决议
- [ ] 继续下一个模块
- [ ] 提问格式: "现在开始澄清 **模块 X: {模块名称}** 的问题"

**一次性全部确认**:
- [ ] 一次性提出所有问题
- [ ] 用户一次性回答所有问题
- [ ] 批量记录所有决议
- [ ] 提问格式: "现在一次性提出所有需要澄清的问题，请逐一回答"

### 4.2 提问格式规范

**提问内容必须包含**:
- [ ] 问题编号（如"问题 1/5"）
- [ ] 问题标题（如"库存不足处理"）
- [ ] 当前描述（原始需求的相关描述）
- [ ] 需要澄清的问题（1-3 个具体问题）
- [ ] 方案选项（2-4 个方案，含优缺点）
- [ ] 建议方案（推荐方案 + 理由）
- [ ] 请用户选择（"请选择（A/B/C）或提供其他方案"）

**提问示例**:
```markdown
✅ 正确提问:
---

**问题 1/5: 库存不足处理**

**当前描述**: 订单提交后，系统扣减库存

**需要澄清的问题**:
1. 库存不足时，是否允许下单？
2. 如何提示用户？

**方案选项**（三选一）:
- **方案 A: 拒绝下单**（推荐）
  - 描述: 库存不足时提示"库存不足"，不创建订单
  - 优点: 逻辑简单，避免超卖
  - 缺点: 用户体验稍差

- **方案 B: 支持预下单**
  - 描述: 订单状态为"待补货"，补货后发货
  - 优点: 用户体验好，不丢失订单
  - 缺点: 增加状态管理复杂度

- **方案 C: 超卖后退款**
  - 描述: 允许下单，库存不足时扣款后退款
  - 优点: 最大化订单数量
  - 缺点: 用户体验极差

**建议方案**: 方案 A（拒绝下单）
- 理由: 初期逻辑简单，避免超卖风险

**请选择方案（A/B/C）或提供其他方案**: 

---

❌ 错误提问（过于简单）:
库存不足时如何处理？请选择:
A. 拒绝下单
B. 支持预下单

（缺少方案描述、优缺点、建议方案）
```

### 4.3 决议记录规范

**决议记录必须包含**:
- [ ] 标题（`## [CLARIFIED] {类别}: {标题}`）
- [ ] 关联功能（功能名称 + FR 编号，如有）
- [ ] 决议（选择的方案 + 方案名称）
- [ ] 理由（为什么选择这个方案）
- [ ] 验收标准（2-5 个可测试的标准）
- [ ] 影响范围（影响的功能模块）
- [ ] 决议时间（YYYY-MM-DD HH:MM）
- [ ] 决议人（姓名或角色）

**决议记录示例**:
```markdown
✅ 正确决议记录:
### [CLARIFIED] 业务规则: 库存不足处理

**关联功能**: 订单下单功能（FR-001）

**决议**: **方案 A**（拒绝下单）
**理由**: 初期逻辑简单，避免超卖风险；后期可根据业务需要升级为方案 B

**验收标准**:
1. 库存不足时提示 "库存不足，请稍后再试"
2. 不创建订单记录
3. 不扣减库存
4. 不扣减用户余额或积分

**影响范围**: 订单功能、库存功能

**决议时间**: 2025-11-07 09:15
**决议人**: 产品经理张三

---

❌ 错误决议记录（缺少验收标准）:
### [CLARIFIED] 业务规则: 库存不足处理

**决议**: 拒绝下单

（缺少理由、验收标准、影响范围、决议时间、决议人）
```

### 4.4 验收标准质量验证

**验收标准必须是**:
- [ ] 具体的（不能模糊）
- [ ] 可测试的（可验证是否实现）
- [ ] 可量化的（有明确的判断标准）
- [ ] 完整的（覆盖核心场景）

**验收标准示例**:
```markdown
✅ 正确验收标准:
1. 库存不足时提示 "库存不足，请稍后再试"（具体的提示文案）
2. 不创建订单记录（可测试：查询订单表，订单不存在）
3. 不扣减库存（可测试：库存数量不变）
4. 不扣减用户余额或积分（可测试：余额/积分不变）

❌ 错误验收标准:
1. 库存不足时正确处理（模糊，无法测试）
2. 用户体验良好（主观，无法量化）
```

### 4.5 用户自定义方案处理

**如果用户选择"自定义方案"**:
- [ ] 记录用户的自定义方案描述
- [ ] 提取自定义方案的验收标准
- [ ] 标注为"用户自定义方案"

**自定义方案示例**:
```markdown
**用户回复**: "B，但是希望用户可以手动延长一次"

**AI 的记录**:
### [CLARIFIED] 业务规则: 支付超时处理

**决议**: **方案 B**（30 分钟超时）+ **用户可手动延长一次**（用户自定义）
**理由**: 
- 30 分钟给用户充足的支付时间
- 支持延长功能提升用户体验
- 避免恶意占用库存

**验收标准**:
1. 订单创建后 30 分钟内未支付，自动取消订单
2. 用户可在超时前 5 分钟内点击"延长支付时间"按钮，延长 15 分钟（仅一次）
3. 订单取消后自动释放库存
4. 发送通知提醒用户支付（超时前 5 分钟）

**额外说明**: 
- 延长功能仅限一次，避免用户无限延长
- 延长按钮在超时前 5 分钟出现
```

### 4.6 决议更新 clarifications.md

**更新规则**:
- [ ] 将 `[NEEDS CLARIFICATION]` 替换为 `[CLARIFIED]`
- [ ] 保留原始确认项的所有内容（当前描述、问题、方案选项）
- [ ] 追加决议内容（决议、理由、验收标准、影响范围、决议时间、决议人）
- [ ] 不删除原始确认项（保留完整的澄清过程）

**更新示例**:
```markdown
✅ 正确更新（保留原始内容）:
### [CLARIFIED] 业务规则: 库存不足处理

**当前描述**: 订单提交后，系统扣减库存
**关联功能**: 订单下单功能（FR-001）

**需要澄清的问题**:
1. 库存不足时，是否允许下单？
2. 如何提示用户？

**方案选项**（三选一）:
- **方案 A: 拒绝下单**
  【方案内容...】
- **方案 B: 支持预下单**
  【方案内容...】
- **方案 C: 超卖后退款**
  【方案内容...】

**建议方案**: 方案 A（拒绝下单）

---

**决议**: **方案 A**（拒绝下单）
**理由**: 初期逻辑简单，避免超卖风险

**验收标准**:
1. 库存不足时提示 "库存不足，请稍后再试"
【验收标准...】

**决议时间**: 2025-11-07 09:15
**决议人**: 产品经理张三

---

❌ 错误更新（删除了原始内容）:
### [CLARIFIED] 业务规则: 库存不足处理

**决议**: 方案 A（拒绝下单）

（删除了原始的问题描述、方案选项，无法回溯澄清过程）
```

### 4.7 迭代澄清处理

**如果决议引发新问题**:
- [ ] 识别新问题（分析决议是否引发新的待澄清问题）
- [ ] 询问用户是否需要澄清新问题
- [ ] 如果用户确认，追加新的确认项到 `clarifications.md`
- [ ] 标注新问题的来源（"本问题由 XXX 决议引发"）

**迭代澄清示例**:
```markdown
**AI 的分析**:
⚠️ 检测到新问题:

用户选择了"已签收（7 天内）可退款"，这引发了新的待澄清问题:
1. 如果商品已拆封/已使用，是否仍可退款？
2. 签收时间如何计算？
3. 退货运费由谁承担？

是否需要澄清这些新问题？（是/否）

---

**用户回复**: 是

---

**AI 的记录**（追加到 clarifications.md）:
### [NEEDS CLARIFICATION] 业务规则: 商品状态限制（追加）

**关联功能**: 订单退款功能（FR-003）
**关联决议**: 可退款的订单状态（方案 C）

**需要澄清的问题**:
1. 如果商品已拆封/已使用，是否仍可退款？

【方案选项...】

**备注**: 本问题由"可退款的订单状态"决议引发
```

### 4.8 常见错误检查

**错误 1: 提问格式不规范**
- [ ] 提问必须包含完整的方案选项和建议方案
- [ ] ❌ 错误: 只提问题，不提供方案选项

**错误 2: 决议记录不完整**
- [ ] 决议记录必须包含验收标准、影响范围、决议时间、决议人
- [ ] ❌ 错误: 只记录选择的方案，缺少验收标准

**错误 3: 验收标准不可测试**
- [ ] 验收标准必须是可测试的
- [ ] ❌ 错误: "用户体验良好"（主观，无法测试）
- [ ] ✅ 正确: "库存不足时提示'库存不足，请稍后再试'"（具体，可测试）

**错误 4: 删除原始确认项内容**
- [ ] 更新决议时，不能删除原始确认项的内容
- [ ] ❌ 错误: 只保留决议，删除了问题描述和方案选项

---

## 步骤 5: 回填审查文档（可选）- 质量检查

### 5.1 检查审查文档是否存在

- [ ] 检查路径: `workspace/{变更ID}/requirements/requirement-review.md`
- [ ] 如果文件存在，读取文件内容
- [ ] 如果文件不存在，跳过回填步骤

### 5.2 识别需要回填的决议

- [ ] 找到 `requirement-review.md` 中的 `[NEEDS CLARIFICATION]` 标记
- [ ] 匹配 `clarifications.md` 中的对应决议（通过关联功能/问题标题）
- [ ] 确定需要回填的决议数量

### 5.3 回填决议到审查文档

**回填规则**:
- [ ] 将 `[NEEDS CLARIFICATION]` 替换为 `[CLARIFIED]`
- [ ] 保留原始确认项的问题描述和优先级
- [ ] 追加决议内容（决议、理由、验收标准、决议时间、决议人）
- [ ] 不删除原始确认项（保留完整的澄清过程）

**回填示例**:
```markdown
✅ 正确回填:

**原始 requirement-review.md（澄清前）**:
## FR-001: 用户登录

### 确认项

#### [NEEDS CLARIFICATION] 登录方式

**问题**: 支持哪些登录方式？（手机号/邮箱/用户名）
**优先级**: P0
**影响**: 影响用户体验和技术实现

---

**更新后 requirement-review.md（澄清后）**:
## FR-001: 用户登录

### 确认项

#### [CLARIFIED] 登录方式

**问题**: 支持哪些登录方式？（手机号/邮箱/用户名）
**优先级**: P0
**影响**: 影响用户体验和技术实现

**决议**: 支持手机号 + 密码登录（初期）
**理由**: 简化开发，后期可扩展邮箱/第三方登录
**决议时间**: 2025-11-11 14:00
**决议人**: 产品经理王五

**验收标准**:
1. 用户输入手机号 + 密码
2. 验证手机号格式（11 位数字）
3. 验证密码正确性
4. 登录成功后生成 JWT Token

---

❌ 错误回填（删除了原始内容）:
#### [CLARIFIED] 登录方式

**决议**: 支持手机号 + 密码登录

（删除了原始的问题描述、优先级、影响）
```

### 5.4 通知用户回填结果

- [ ] 通知用户决议已回填到 `requirement-review.md`
- [ ] 列出回填的决议数量和具体内容

**通知示例**:
```markdown
✅ 决议已同步回填到 requirement-review.md

更新内容:
- FR-001: 登录方式（NEEDS CLARIFICATION → CLARIFIED）
- FR-002: 验证码有效期（NEEDS CLARIFICATION → CLARIFIED）
- FR-003: 密码强度要求（NEEDS CLARIFICATION → CLARIFIED）

共回填 3 个决议。
```

### 5.5 常见错误检查

**错误 1: 未检查审查文档是否存在**
- [ ] 必须先检查文件是否存在，再进行回填
- [ ] ❌ 错误: 直接尝试回填，导致文件不存在错误

**错误 2: 删除原始确认项内容**
- [ ] 回填时，不能删除原始确认项的内容
- [ ] ❌ 错误: 只保留决议，删除了问题描述和优先级

**错误 3: 未通知用户回填结果**
- [ ] 回填完成后，必须通知用户
- [ ] ❌ 错误: 回填完成后没有任何提示

---

## 步骤 6: 验证闭环 - 质量检查

### 6.1 统计数据准确性

**统计数据必须包含**:
- [ ] 已澄清数量（`[CLARIFIED]` 标记的数量）
- [ ] 待澄清数量（`[NEEDS CLARIFICATION]` 标记的数量）
- [ ] 不需澄清数量（`[NOT-NEEDED]` 标记的数量，如有）
- [ ] 总数（已澄清 + 待澄清 + 不需澄清）

**统计数据验证**:
- [ ] 统计数据准确（手动验证数量）
- [ ] 占比计算正确（百分比 = 数量 / 总数 × 100%）
- [ ] 占比总和为 100%

**统计数据示例**:
```markdown
✅ 正确统计:
### 统计数据

| 状态 | 数量 | 占比 |
|------|------|------|
| 已澄清（CLARIFIED） | 9 | 100% |
| 待澄清（NEEDS CLARIFICATION） | 0 | 0% |
| 不需澄清（NOT-NEEDED） | 0 | 0% |
| **总计** | 9 | 100% |

（数据准确，占比总和为 100%）

---

❌ 错误统计:
已澄清: 9 个
待澄清: 2 个

（数量不准确，实际待澄清为 0 个）
```

### 6.2 影响的功能模块统计

**功能模块统计必须包含**:
- [ ] 模块名称（如"订单下单"）
- [ ] FR 编号（如 FR-001）
- [ ] 澄清问题数（该模块的问题数量）
- [ ] 状态（✅ 已完成 / ⏳ 进行中 / ⏸️ 未开始）

**功能模块统计示例**:
```markdown
✅ 正确统计:
### 影响的功能模块

| 模块名称 | FR 编号 | 澄清问题数 | 状态 |
|----------|---------|------------|------|
| 订单下单 | FR-001 | 4 | ✅ 已完成 |
| 订单查看 | FR-002 | 2 | ✅ 已完成 |
| 订单退款 | FR-003 | 3 | ✅ 已完成 |
| **总计** | - | 9 | ✅ 已完成 |

（数据完整，状态准确）
```

### 6.3 关键决议摘要

**关键决议摘要必须包含**:
- [ ] 按模块分组（模块 1、模块 2、模块 3...）
- [ ] 每个模块的关键决议（1-3 句话概述）
- [ ] 决议简洁明了（不超过 20 字/条）

**关键决议摘要示例**:
```markdown
✅ 正确摘要:
### 关键决议摘要

**FR-001: 订单下单**
1. 库存不足 → 拒绝下单
2. 支付超时 → 30 分钟超时 + 手动延长一次
3. 订单金额计算 → 商品 + 运费 - 优惠券 - 积分
4. 并发下单 → 数据库行锁 + 乐观锁

**FR-002: 订单查看**
1. 权限控制 → 用户只能查看自己的订单
2. 历史保留 → 保留 3 年，超期归档

（简洁明了，一目了然）

---

❌ 错误摘要:
**FR-001: 订单下单**
1. 库存不足时，系统拒绝下单，提示"库存不足，请稍后再试"，不创建订单记录，不扣减库存，不扣减用户余额或积分。

（过于详细，不是摘要）
```

### 6.4 后续行动明确

**后续行动必须包含**:
- [ ] 当前阶段完成情况（✅ 已完成 / ⏳ 进行中）
- [ ] 下一阶段行动（清单形式）
- [ ] 相关技能推荐（如 `req-explain`、`design-api`）

**后续行动示例**:
```markdown
✅ 正确后续行动:
### 后续行动

✅ 澄清阶段已完成，可以进入下一阶段:
- [ ] 生成正式的需求规格说明书（使用 `req-explain` 技能）
- [ ] 进行 API 设计（使用 `design-api` 技能）
- [ ] 进行数据库设计（使用 `design-db` 技能）

（明确下一步行动，推荐相关技能）
```

### 6.5 相关文档路径

**相关文档路径必须包含**:
- [ ] 澄清记录路径（`clarifications.md`）
- [ ] 需求审查路径（`requirement-review.md`，如存在）
- [ ] 其他相关文档路径（如有）

**相关文档路径示例**:
```markdown
✅ 正确路径:
### 相关文档

- 澄清记录: `workspace/2025-11-07-order-management/requirements/clarifications.md`
- 需求审查: `workspace/2025-11-07-order-management/requirements/requirement-review.md`（不存在）

（路径准确，标注文件是否存在）
```

### 6.6 澄清摘要报告写入文件

- [ ] 澄清摘要报告已追加到 `clarifications.md` 文件末尾
- [ ] 摘要报告包含所有必需章节（统计数据、功能模块、关键决议、后续行动、相关文档）
- [ ] 文件状态已更新为"已完成"（YAML Frontmatter）

**文件状态更新示例**:
```markdown
✅ 更新前（进行中）:
---
变更ID: 2025-11-07-order-management
执行策略: 按模块/功能点逐项确认
创建时间: 2025-11-07 09:00
状态: 进行中
---

✅ 更新后（已完成）:
---
变更ID: 2025-11-07-order-management
执行策略: 按模块/功能点逐项确认
创建时间: 2025-11-07 09:00
完成时间: 2025-11-07 10:00
状态: 已完成
---
```

### 6.7 常见错误检查

**错误 1: 统计数据不准确**
- [ ] 统计数据必须手动验证（不能直接估算）
- [ ] ❌ 错误: 已澄清 9 个，实际只有 8 个

**错误 2: 关键决议过于详细**
- [ ] 关键决议应简洁（不超过 20 字/条）
- [ ] ❌ 错误: 详细描述整个决议过程

**错误 3: 缺少后续行动**
- [ ] 必须明确下一步行动
- [ ] ❌ 错误: 只说"澄清完成"，没有后续行动

**错误 4: 文件状态未更新**
- [ ] 澄清完成后，文件状态必须更新为"已完成"
- [ ] ❌ 错误: 状态仍为"进行中"

---

## 最终验证清单

### 功能验证

- [ ] 推进方式已选择并记录
- [ ] 4 个维度扫描完成（业务规则、数据模型、权限可见性、异常边界）
- [ ] 所有问题已生成确认项（含方案选项、建议方案、影响评估）
- [ ] 所有问题已提问并记录决议（含验收标准、影响范围、决议时间、决议人）
- [ ] 迭代澄清已处理（决议引发新问题时追加）
- [ ] 审查文档已回填（如存在 `requirement-review.md`）
- [ ] 澄清摘要报告已生成（统计数据、功能模块、关键决议、后续行动）

### 质量验证

- [ ] 方案选项数量合理（2-4 个）
- [ ] 方案选项包含描述、优点、缺点
- [ ] 建议方案有充分理由
- [ ] 验收标准具体、可测试、可量化
- [ ] 决议记录完整（决议、理由、验收标准、影响范围、决议时间、决议人）
- [ ] 统计数据准确（已澄清/待澄清数量）

### 输出验证

- [ ] `clarifications.md` 文件已生成
- [ ] 文件路径正确（`workspace/{变更ID}/requirements/clarifications.md`）
- [ ] 文件包含 YAML Frontmatter（变更 ID、执行策略、创建时间、状态）
- [ ] 文件包含所有确认项（按模块分组或按顺序排列）
- [ ] 文件包含澄清摘要报告
- [ ] 文件状态已更新为"已完成"

### 规范验证

- [ ] 只澄清业务逻辑（不涉及技术实现、接口设计、性能、安全）
- [ ] 所有决议都有验收标准（具体、可测试）
- [ ] 原始确认项内容未删除（保留完整澄清过程）
- [ ] 迭代澄清已标注来源（"本问题由 XXX 决议引发"）

---

## 示例检查场景

### 场景 1: 电商订单管理（按模块推进）

**验证要点**:
- [ ] 推进方式: 按模块/功能点逐项确认
- [ ] 识别问题: 3 个模块，共 9 个问题
- [ ] 确认项分组: 按模块分组（模块 1: 4 个问题，模块 2: 2 个问题，模块 3: 3 个问题）
- [ ] 提问方式: 按模块顺序提问（模块 1 → 模块 2 → 模块 3）
- [ ] 决议记录: 9 个决议，全部包含验收标准
- [ ] 澄清摘要: 统计数据准确（已澄清 9 个，待澄清 0 个）
- [ ] 后续行动: 明确下一步（生成需求规格说明书、API 设计、数据库设计）

### 场景 2: 用户注册功能（单个问题逐一确认）

**验证要点**:
- [ ] 推进方式: 单个问题逐一确认
- [ ] 识别问题: 5 个问题
- [ ] 提问方式: 每次只提问 1 个问题（问题 1/5 → 问题 2/5 → ...）
- [ ] 决议记录: 5 个决议，全部包含验收标准
- [ ] 用户自定义方案: 正确处理（如"B，但是希望发送频率是 60 秒"）
- [ ] 澄清摘要: 统计数据准确（已澄清 5 个，待澄清 0 个）

### 场景 3: 商品评价功能（一次性全部确认）

**验证要点**:
- [ ] 推进方式: 一次性全部确认
- [ ] 识别问题: 4 个问题
- [ ] 提问方式: 一次性提出所有问题
- [ ] 用户回复格式: "问题1-A, 问题2-A, 问题3-B, 问题4-C"
- [ ] 决议记录: 批量记录 4 个决议
- [ ] 澄清摘要: 统计数据准确（已澄清 4 个，待澄清 0 个）

### 场景 4: 订单退款功能（迭代澄清）

**验证要点**:
- [ ] 第一轮澄清: 3 个问题
- [ ] 决议引发新问题: 识别 3 个追加问题
- [ ] 询问用户: "是否需要澄清这些新问题？"
- [ ] 第二轮澄清: 3 个追加问题
- [ ] 追加问题标注: "本问题由 XXX 决议引发"
- [ ] 澄清摘要: 统计数据准确（已澄清 6 个，含追加问题）

### 场景 5: 用户登录功能（回填审查文档）

**验证要点**:
- [ ] 检查审查文档: `requirement-review.md` 存在
- [ ] 读取文件内容: 提取 `[NEEDS CLARIFICATION]` 标记
- [ ] 回填决议: 更新为 `[CLARIFIED]`，保留原始内容
- [ ] 通知用户: "决议已同步回填到 requirement-review.md"
- [ ] 列出回填内容: FR-001、FR-002、FR-003

---

## 常见问题排查

### 问题 1: 识别了技术实现问题

**检查点**:
- [ ] 所有问题都是业务逻辑问题（不涉及技术选型、接口设计、性能指标）
- [ ] ❌ 错误示例: "使用 MySQL 还是 PostgreSQL？"
- [ ] ✅ 正确示例: "用户名是否唯一？"

**解决方案**: 重新扫描需求，只识别业务逻辑问题。

### 问题 2: 方案选项过少或缺少优缺点

**检查点**:
- [ ] 每个问题至少提供 2 个方案选项
- [ ] 每个方案都有描述、优点、缺点
- [ ] ❌ 错误示例: 只提供 1 个方案，或只有方案描述
- [ ] ✅ 正确示例: 2-4 个方案，每个方案含描述、优点、缺点

**解决方案**: 补充方案选项，添加优缺点分析。

### 问题 3: 验收标准不可测试

**检查点**:
- [ ] 验收标准必须是可测试的
- [ ] ❌ 错误示例: "用户体验良好"（主观，无法测试）
- [ ] ✅ 正确示例: "库存不足时提示'库存不足，请稍后再试'"（具体，可测试）

**解决方案**: 将模糊的验收标准改为具体、可测试的标准。

### 问题 4: 删除原始确认项内容

**检查点**:
- [ ] 更新决议时，不能删除原始确认项的内容
- [ ] ❌ 错误示例: 只保留决议，删除了问题描述和方案选项
- [ ] ✅ 正确示例: 保留原始确认项，追加决议内容

**解决方案**: 重新读取 `clarifications.md`，恢复原始确认项内容。

### 问题 5: 统计数据不准确

**检查点**:
- [ ] 统计数据必须手动验证（不能直接估算）
- [ ] ❌ 错误示例: 已澄清 9 个，实际只有 8 个
- [ ] ✅ 正确示例: 手动统计，已澄清 8 个

**解决方案**: 重新统计 `[CLARIFIED]` 和 `[NEEDS CLARIFICATION]` 标记的数量。

---

## AI 执行检查清单

**在开始需求澄清前，请确认**:
- [ ] 用户已提供需求来源（PRD/TAPD/文档/文本）
- [ ] 用户已提供变更 ID（格式: `YYYY-MM-DD-feature-name`）
- [ ] 输出目录已确定（`workspace/{变更ID}/requirements/`）

**在生成确认项时，请确认**:
- [ ] 每个问题提供 2-4 个方案选项
- [ ] 每个方案包含描述、优点、缺点
- [ ] 建议方案有充分理由
- [ ] 影响评估明确风险等级（P0/P1/P2）

**在记录决议时，请确认**:
- [ ] 决议包含选择的方案 + 理由
- [ ] 验收标准具体、可测试、可量化（2-5 个）
- [ ] 影响范围明确（影响的功能模块）
- [ ] 决议时间和决议人已记录
- [ ] 原始确认项内容未删除

**在生成摘要报告时，请确认**:
- [ ] 统计数据准确（已澄清/待澄清数量）
- [ ] 功能模块统计完整（模块名称、FR 编号、问题数、状态）
- [ ] 关键决议摘要简洁（不超过 20 字/条）
- [ ] 后续行动明确（清单形式）
- [ ] 相关文档路径准确

**在完成澄清后，请确认**:
- [ ] `clarifications.md` 文件已生成
- [ ] 文件状态已更新为"已完成"
- [ ] 审查文档已回填（如存在 `requirement-review.md`）
- [ ] 用户已收到澄清摘要报告
