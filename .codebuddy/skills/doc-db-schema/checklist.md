# 数据库表结构文档生成 - 验证清单

本清单用于验证 `doc-db-schema` skill 的输出质量，确保数据库表结构文档生成符合最佳实践和项目规范。

---

## 📋 前置条件检查

在开始生成数据库表结构文档前，确认以下条件已满足：

- [ ] MySQL 数据库已部署（版本 >= 5.7，推荐 8.0+）
- [ ] 拥有数据库读权限（SELECT 权限）
- [ ] 可访问 `information_schema` 系统库
- [ ] 数据库表已创建完成
- [ ] 已准备数据库连接信息（主机、端口、数据库名、用户名、密码）
- [ ] 已确定输出路径

---

## 步骤 1: 连接数据库并验证权限 - 质量检查

### 【必须】数据库连接成功

- [ ] **连接参数正确**：
  - [ ] 主机地址正确（localhost 或远程 IP）
  - [ ] 端口正确（默认 3306）
  - [ ] 数据库名正确
  - [ ] 用户名和密码正确

- [ ] **连接成功**：
  - [ ] 成功建立到 MySQL 数据库的连接
  - [ ] 获取 MySQL 服务器版本信息
  - [ ] 打印连接成功消息

- [ ] **字符集正确**：
  - [ ] 使用 `charset='utf8mb4'`
  - [ ] 使用 `use_unicode=True`
  - [ ] 确保支持完整的 Unicode 字符集（包括 Emoji）

### 【必须】权限验证通过

- [ ] **查询权限验证**：
  - [ ] 执行 `SHOW GRANTS FOR CURRENT_USER` 成功
  - [ ] 用户具有 SELECT 权限
  - [ ] 用户可以访问 `information_schema` 系统库

- [ ] **必要权限清单**：
  - [ ] SHOW TABLES 权限
  - [ ] SHOW CREATE TABLE 权限
  - [ ] SELECT on information_schema.TABLES
  - [ ] SELECT on information_schema.COLUMNS
  - [ ] SELECT on information_schema.STATISTICS
  - [ ] SELECT on information_schema.TABLE_CONSTRAINTS（可选）
  - [ ] SELECT on information_schema.KEY_COLUMN_USAGE（可选）

### 常见错误检查

- [ ] ❌ 错误1：连接被拒绝
  - ✅ 解决：检查连接参数，确认数据库服务正在运行

- [ ] ❌ 错误2：权限不足
  - ✅ 解决：联系 DBA 授予 SELECT 权限

- [ ] ❌ 错误3：字符集问题导致中文乱码
  - ✅ 解决：添加 `charset='utf8mb4'` 参数

---

## 步骤 2: 提取数据库表列表 - 质量检查

### 【必须】SQL 查询正确

- [ ] **查询 SQL 正确**：
  - [ ] 查询 `information_schema.TABLES`
  - [ ] 过滤条件：`TABLE_SCHEMA = 'your_database'`
  - [ ] 过滤条件：`TABLE_TYPE = 'BASE TABLE'`（排除视图和系统表）
  - [ ] 排序条件：`ORDER BY TABLE_NAME ASC`

- [ ] **提取字段完整**：
  - [ ] TABLE_NAME（表名）
  - [ ] TABLE_COMMENT（表注释）
  - [ ] ENGINE（存储引擎）
  - [ ] CREATE_TIME（创建时间）
  - [ ] TABLE_ROWS（数据行数）
  - [ ] DATA_LENGTH（数据大小）
  - [ ] INDEX_LENGTH（索引大小）

### 【必须】表列表完整

- [ ] **所有表都已提取**：
  - [ ] 表数量正确（与数据库实际表数量一致）
  - [ ] 无遗漏表
  - [ ] 无重复表

- [ ] **表信息准确**：
  - [ ] 表名正确
  - [ ] 表注释存在（如果数据库中有注释）
  - [ ] 存储引擎正确（InnoDB/MyISAM）
  - [ ] 创建时间格式正确
  - [ ] 数据行数合理

### 常见错误检查

- [ ] ❌ 错误1：包含了视图
  - ✅ 解决：添加过滤条件 `TABLE_TYPE = 'BASE TABLE'`

- [ ] ❌ 错误2：表注释为空
  - ✅ 解决：在数据库中为表添加注释

---

## 步骤 3: 提取表字段信息 - 质量检查

### 【必须】SQL 查询正确

- [ ] **查询 SQL 正确**：
  - [ ] 查询 `information_schema.COLUMNS`
  - [ ] 过滤条件：`TABLE_SCHEMA = 'your_database'`
  - [ ] 过滤条件：`TABLE_NAME = 'your_table'`
  - [ ] 排序条件：`ORDER BY ORDINAL_POSITION ASC`

- [ ] **提取字段完整**（11 个字段）：
  - [ ] COLUMN_NAME（字段名）
  - [ ] DATA_TYPE（数据类型）
  - [ ] COLUMN_TYPE（完整类型定义）
  - [ ] IS_NULLABLE（是否可空）
  - [ ] COLUMN_DEFAULT（默认值）
  - [ ] COLUMN_COMMENT（字段注释）
  - [ ] COLUMN_KEY（键类型：PRI/UNI/MUL）
  - [ ] EXTRA（额外信息：auto_increment/on update）
  - [ ] CHARACTER_SET_NAME（字符集）
  - [ ] COLLATION_NAME（排序规则）
  - [ ] ORDINAL_POSITION（字段位置）

### 【必须】字段定义完整

- [ ] **所有字段都已提取**：
  - [ ] 字段数量正确（与实际表字段数量一致）
  - [ ] 无遗漏字段
  - [ ] 字段顺序正确（按 ORDINAL_POSITION 排序）

- [ ] **字段信息准确**：
  - [ ] 字段名正确
  - [ ] 数据类型正确（BIGINT/VARCHAR/DATETIME等）
  - [ ] 完整类型定义正确（VARCHAR(255)/DECIMAL(10,2)等）
  - [ ] 是否可空正确（YES/NO）
  - [ ] 默认值正确（NULL/CURRENT_TIMESTAMP/数值等）
  - [ ] 字段注释存在且准确
  - [ ] 键类型正确（PRI/UNI/MUL/-）
  - [ ] 额外信息正确（auto_increment/on update CURRENT_TIMESTAMP）

### 【必须】标准字段验证

遵循 [数据库字段规范指南](mdc:.codebuddy/spec/global/standards/backend/common/database-fields.md)：

- [ ] **主键字段**：
  - [ ] 存在 `id` 字段
  - [ ] 类型为 `BIGINT UNSIGNED`
  - [ ] 主键约束（COLUMN_KEY = 'PRI'）
  - [ ] 自增（EXTRA = 'auto_increment'）

- [ ] **时间字段**：
  - [ ] 存在 `create_time` 字段（创建时间）
  - [ ] 存在 `update_time` 字段（更新时间）
  - [ ] 类型为 `DATETIME`
  - [ ] create_time 默认值为 `CURRENT_TIMESTAMP`
  - [ ] update_time 额外信息包含 `on update CURRENT_TIMESTAMP`

- [ ] **审计字段**（可选，推荐）：
  - [ ] create_by（创建人）
  - [ ] update_by（更新人）

- [ ] **逻辑删除字段**（可选）：
  - [ ] delete_flag 或 delete_time

### 常见错误检查

- [ ] ❌ 错误1：字段注释为空
  - ✅ 解决：在数据库中为字段添加注释

- [ ] ❌ 错误2：字符集不一致
  - ✅ 解决：统一字符集为 utf8mb4

- [ ] ❌ 错误3：缺少标准字段
  - ✅ 解决：添加 id、create_time、update_time 等标准字段

---

## 步骤 4: 提取表索引信息 - 质量检查

### 【必须】SQL 查询正确

- [ ] **查询 SQL 正确**：
  - [ ] 查询 `information_schema.STATISTICS`
  - [ ] 过滤条件：`TABLE_SCHEMA = 'your_database'`
  - [ ] 过滤条件：`TABLE_NAME = 'your_table'`
  - [ ] 排序条件：`ORDER BY INDEX_NAME, SEQ_IN_INDEX`

- [ ] **提取字段完整**（6 个字段）：
  - [ ] INDEX_NAME（索引名）
  - [ ] COLUMN_NAME（字段名）
  - [ ] SEQ_IN_INDEX（字段在索引中的位置）
  - [ ] NON_UNIQUE（是否唯一：0-唯一，1-非唯一）
  - [ ] INDEX_TYPE（索引类型：BTREE/HASH/FULLTEXT）
  - [ ] INDEX_COMMENT（索引注释）

### 【必须】索引定义完整

- [ ] **所有索引都已提取**：
  - [ ] 主键索引（PRIMARY）
  - [ ] 唯一索引（uk_*）
  - [ ] 普通索引（idx_*）
  - [ ] 全文索引（如适用）

- [ ] **索引信息准确**：
  - [ ] 索引名正确
  - [ ] 索引类型正确（BTREE/HASH/FULLTEXT）
  - [ ] 索引字段正确
  - [ ] 唯一性正确（是/否）
  - [ ] 复合索引字段顺序正确

### 【必须】索引合并正确

- [ ] **复合索引字段合并**：
  - [ ] 同一索引的多个字段已合并
  - [ ] 字段顺序正确（按 SEQ_IN_INDEX 排序）
  - [ ] 使用逗号分隔多个字段

### 【必须】索引命名规范验证

遵循 [数据库索引设计指南](mdc:.codebuddy/spec/global/standards/backend/common/index-design-guide.md)：

- [ ] **主键索引**：
  - [ ] 索引名为 `PRIMARY`

- [ ] **唯一索引**：
  - [ ] 索引名前缀为 `uk_`（unique key）
  - [ ] 示例：`uk_username`、`uk_email`

- [ ] **普通索引**：
  - [ ] 索引名前缀为 `idx_`（index）
  - [ ] 示例：`idx_create_time`、`idx_user_status`

- [ ] **联合索引**：
  - [ ] 索引名包含多个字段名（按顺序）
  - [ ] 示例：`idx_user_status_time`（user_id, status, create_time）

### 常见错误检查

- [ ] ❌ 错误1：复合索引字段未合并
  - ✅ 解决：按 INDEX_NAME 分组，合并同一索引的多个字段

- [ ] ❌ 错误2：索引命名不规范
  - ✅ 解决：重命名索引，使用 uk_/idx_ 前缀

---

## 步骤 5: 提取表约束信息 - 质量检查（可选）

### 【可选】约束信息提取

- [ ] **查询 SQL 正确**：
  - [ ] 查询 `information_schema.TABLE_CONSTRAINTS`
  - [ ] 关联查询 `information_schema.KEY_COLUMN_USAGE`
  - [ ] 过滤条件：`CONSTRAINT_TYPE IN ('FOREIGN KEY', 'CHECK', 'UNIQUE')`

- [ ] **提取字段完整**：
  - [ ] CONSTRAINT_NAME（约束名）
  - [ ] CONSTRAINT_TYPE（约束类型）
  - [ ] COLUMN_NAME（字段名）
  - [ ] REFERENCED_TABLE_NAME（关联表名）
  - [ ] REFERENCED_COLUMN_NAME（关联字段名）

### 【必须】外键约束策略验证

遵循 [设计决策框架](mdc:.codebuddy/spec/global/standards/backend/common/design-decisions.md)：

- [ ] **生产环境**：
  - [ ] 不使用显式外键约束
  - [ ] 在应用层保证数据一致性
  - [ ] 文档中注明"生产环境无显式外键约束"

- [ ] **开发环境**（可选）：
  - [ ] 可使用外键约束辅助开发
  - [ ] 文档中标注仅用于开发环境

### 常见错误检查

- [ ] ❌ 错误1：生产环境使用了外键约束
  - ✅ 解决：移除外键约束，在应用层保证一致性

---

## 步骤 6: 生成表的 DDL 语句 - 质量检查

### 【必须】DDL 语句提取成功

- [ ] **查询 SQL 正确**：
  - [ ] 执行 `SHOW CREATE TABLE table_name`
  - [ ] 使用反引号包裹表名（防止保留字冲突）

- [ ] **DDL 语句完整**：
  - [ ] 包含 CREATE TABLE 语句
  - [ ] 包含所有字段定义
  - [ ] 包含所有索引定义
  - [ ] 包含所有约束定义
  - [ ] 包含存储引擎
  - [ ] 包含字符集
  - [ ] 包含表注释

### 【必须】DDL 语句可执行

- [ ] **DDL 验证**：
  - [ ] DDL 语句语法正确
  - [ ] 可在 MySQL 中直接执行
  - [ ] 执行后可重建完全相同的表结构

### 【必须】DDL 格式化（可选，推荐）

- [ ] 缩进正确（2 或 4 个空格）
- [ ] 每个字段定义占一行
- [ ] 每个索引定义占一行
- [ ] 使用反引号包裹字段名和表名

### 常见错误检查

- [ ] ❌ 错误1：DDL 语句不完整
  - ✅ 解决：确保使用 `SHOW CREATE TABLE`，而不是手动拼接

- [ ] ❌ 错误2：DDL 语句无法执行
  - ✅ 解决：在测试环境验证 DDL 可执行性

---

## 步骤 7: 生成 Markdown 文档 - 质量检查

### 【必须】文档结构完整

- [ ] **YAML 元数据**（可选，推荐）：
  - [ ] 生成时间
  - [ ] 数据库名称
  - [ ] MySQL 版本
  - [ ] 表数量
  - [ ] 统计信息

- [ ] **文档标题**：
  - [ ] 包含数据库名称
  - [ ] 包含"数据库表结构文档"字样

- [ ] **文档头部信息**：
  - [ ] 生成时间（格式：YYYY-MM-DD HH:mm:ss）
  - [ ] 数据库名称
  - [ ] MySQL 版本
  - [ ] 表数量
  - [ ] 总数据行数
  - [ ] 总数据大小
  - [ ] 总索引大小

- [ ] **表列表章节**：
  - [ ] 使用有序列表
  - [ ] 每个表项包含：表名（锚点链接）、表注释、数据行数
  - [ ] 按表名排序

- [ ] **每个表的详细章节**：
  - [ ] 表名作为二级标题（`##`）
  - [ ] 表说明
  - [ ] 存储引擎
  - [ ] 创建时间
  - [ ] 数据行数
  - [ ] 数据大小
  - [ ] 索引大小

- [ ] **字段定义表格**：
  - [ ] 表头：字段名、类型、可空、默认值、键、额外、说明
  - [ ] 所有字段都在表格中
  - [ ] 使用反引号包裹字段名
  - [ ] 使用 Markdown 表格格式

- [ ] **索引定义表格**：
  - [ ] 表头：索引名、类型、字段、唯一性、说明
  - [ ] 所有索引都在表格中
  - [ ] 复合索引字段用逗号分隔
  - [ ] 使用反引号包裹索引名和字段名

- [ ] **约束定义表格**（可选）：
  - [ ] 表头：约束名、类型、字段、关联表、关联字段
  - [ ] 所有约束都在表格中

- [ ] **DDL 语句代码块**：
  - [ ] 使用 SQL 代码块（```sql）
  - [ ] DDL 语句完整
  - [ ] 格式化正确

- [ ] **数据库统计章节**：
  - [ ] 表统计（总表数、总数据行数、总数据大小、总索引大小）
  - [ ] 字段统计（总字段数、包含注释的字段、标准字段覆盖率）
  - [ ] 索引统计（主键索引、唯一索引、普通索引、总索引数）
  - [ ] 字符集统计（数据库字符集、排序规则、一致性检查）

### 【必须】Markdown 格式正确

- [ ] **标题层级正确**：
  - [ ] 一级标题（#）：文档标题
  - [ ] 二级标题（##）：表名、统计章节
  - [ ] 三级标题（###）：字段定义、索引定义、DDL 语句

- [ ] **表格格式正确**：
  - [ ] 表头分隔符正确（`|---|---|`）
  - [ ] 列对齐正确
  - [ ] 单元格内容无格式错误

- [ ] **代码块格式正确**：
  - [ ] 使用 ```sql 包裹 SQL 语句
  - [ ] 代码块缩进正确

- [ ] **锚点链接正确**：
  - [ ] 表列表中的链接可以跳转到对应表章节
  - [ ] 锚点名称与表名一致

### 【必须】内容准确性

- [ ] **无数据丢失**：
  - [ ] 所有表都在文档中
  - [ ] 所有字段都在表格中
  - [ ] 所有索引都在表格中

- [ ] **无中文乱码**：
  - [ ] 表注释正常显示
  - [ ] 字段注释正常显示
  - [ ] 索引注释正常显示

- [ ] **数据一致性**：
  - [ ] 字段定义表格与 DDL 语句一致
  - [ ] 索引定义表格与 DDL 语句一致
  - [ ] 统计数据准确（表数量、字段数量、索引数量）

### 常见错误检查

- [ ] ❌ 错误1：Markdown 表格格式错误
  - ✅ 解决：检查表头分隔符、列对齐

- [ ] ❌ 错误2：锚点链接无法跳转
  - ✅ 解决：确保锚点名称与表名一致（小写、无空格）

- [ ] ❌ 错误3：中文注释乱码
  - ✅ 解决：使用 utf8mb4 字符集连接数据库

- [ ] ❌ 错误4：代码块未语法高亮
  - ✅ 解决：使用 ```sql 而不是 ```

- [ ] ❌ 错误5：统计数据不准确
  - ✅ 解决：重新统计表数量、字段数量、索引数量

---

## 步骤 8: 验证文档完整性 - 质量检查

### 【必须】功能验证

- [ ] 成功连接到数据库
- [ ] 成功提取所有表的列表
- [ ] 成功提取所有表的字段定义
- [ ] 成功提取所有表的索引信息
- [ ] 成功提取所有表的约束信息（如适用）
- [ ] 成功提取所有表的 DDL 语句
- [ ] 成功生成 Markdown 文档

### 【必须】质量验证

- [ ] **文档完整性**：
  - [ ] 文档包含所有表（无遗漏）
  - [ ] 字段定义完整（字段名、类型、注释、默认值、约束）
  - [ ] 索引定义正确（索引名、类型、字段、唯一性）
  - [ ] DDL 语句可执行（复制到 MySQL 可直接运行）

- [ ] **字符集验证**：
  - [ ] 中文注释无乱码（使用 utf8mb4 字符集）
  - [ ] Emoji 显示正常（如适用）

- [ ] **格式验证**：
  - [ ] Markdown 格式正确（表格、代码块、标题）
  - [ ] 锚点链接可用
  - [ ] 代码块语法高亮正确

### 【必须】技术栈验证

- [ ] **MySQL 最佳实践**：
  - [ ] 遵循 [MySQL 文档](mdc:.codebuddy/spec/global/knowledge/stack/mysql.md) 的连接管理最佳实践
  - [ ] 使用 utf8mb4 字符集
  - [ ] 正确关闭数据库连接

- [ ] **字段规范验证**：
  - [ ] 遵循 [数据库字段规范指南](mdc:.codebuddy/spec/global/standards/backend/common/database-fields.md)
  - [ ] 标准字段存在（id、create_time、update_time）
  - [ ] 字段命名规范（snake_case）
  - [ ] 字段注释完整

- [ ] **索引规范验证**：
  - [ ] 遵循 [数据库索引设计指南](mdc:.codebuddy/spec/global/standards/backend/common/index-design-guide.md)
  - [ ] 索引命名规范（PRIMARY、uk_*、idx_*）
  - [ ] 主键索引存在
  - [ ] 联合索引字段顺序合理

- [ ] **设计决策验证**：
  - [ ] 遵循 [设计决策框架](mdc:.codebuddy/spec/global/standards/backend/common/design-decisions.md)
  - [ ] 生产环境无显式外键约束
  - [ ] 使用软删除而非物理删除（delete_flag/delete_time）

### 【必须】性能验证

- [ ] **执行效率**：
  - [ ] 文档生成时间合理（< 1 分钟，视表数量而定）
  - [ ] 内存使用合理（< 100MB，视数据库规模而定）

- [ ] **资源清理**：
  - [ ] 数据库连接正确关闭（无连接泄漏）
  - [ ] 游标正确关闭
  - [ ] 临时数据已清理

### 常见问题排查

**问题 1: 文档中部分表缺失**
- [ ] 检查表列表查询是否正确
- [ ] 检查是否过滤了某些表（TABLE_TYPE 条件）
- [ ] 检查权限是否足够

**问题 2: 字段注释为空**
- [ ] 检查数据库表设计，确认字段是否有注释
- [ ] 如果没有注释，在数据库中添加注释后重新生成

**问题 3: 索引信息不完整**
- [ ] 检查索引合并逻辑是否正确
- [ ] 检查是否按 INDEX_NAME 和 SEQ_IN_INDEX 排序

**问题 4: DDL 语句无法执行**
- [ ] 在测试环境执行 DDL 语句
- [ ] 检查字符集、存储引擎等配置

**问题 5: 中文乱码**
- [ ] 检查数据库连接字符集（使用 utf8mb4）
- [ ] 检查数据库/表的字符集设置
- [ ] 检查文档保存字符集（UTF-8）

---

## 高级验证场景

### 场景 1: 大型数据库验证（100+ 表）

- [ ] 文档生成时间 < 5 分钟
- [ ] 内存使用 < 200MB
- [ ] 所有表都在文档中
- [ ] 文档大小合理（< 10MB）

### 场景 2: 多模块数据库验证

- [ ] 按模块分组生成文档
- [ ] 每个模块的表都正确分组
- [ ] 模块说明准确

### 场景 3: 特定表过滤验证

- [ ] 只生成指定表的文档
- [ ] 指定表的结构完整
- [ ] 未指定的表不在文档中

### 场景 4: 数据库变更对比验证

- [ ] 识别新增的表
- [ ] 识别删除的表
- [ ] 识别修改的表（字段变更、索引变更）
- [ ] 生成变更对比文档

---

## 输出验证

### 【必须】文件输出正确

- [ ] **输出路径正确**：
  - [ ] 遵循项目输出目录规范
  - [ ] 文件名规范（database-name-schema.md）

- [ ] **文件格式正确**：
  - [ ] Markdown 格式（.md 扩展名）
  - [ ] UTF-8 编码
  - [ ] 无 BOM

- [ ] **文件可读性**：
  - [ ] 可在 Markdown 编辑器中正常打开
  - [ ] 可在 GitHub/GitLab 中正常渲染
  - [ ] 可导出为 HTML/PDF

### 【必须】版本控制友好

- [ ] 文本格式（Markdown），易于 diff
- [ ] 无不必要的空行或格式变化
- [ ] 可纳入 Git 版本控制

---

## 最终验证清单

### 【必须】功能完整性

- [ ] 所有表都已提取
- [ ] 所有字段都已提取
- [ ] 所有索引都已提取
- [ ] 所有 DDL 语句都已提取
- [ ] Markdown 文档已生成

### 【必须】质量标准

- [ ] 文档结构完整（标题、表列表、表详情、统计）
- [ ] 字段定义准确（字段名、类型、注释、默认值、约束）
- [ ] 索引定义正确（索引名、类型、字段、唯一性）
- [ ] DDL 语句可执行
- [ ] 中文注释无乱码
- [ ] Markdown 格式正确

### 【必须】技术栈符合性

- [ ] 遵循 MySQL 最佳实践
- [ ] 遵循数据库字段规范指南
- [ ] 遵循数据库索引设计指南
- [ ] 遵循设计决策框架

### 【必须】性能标准

- [ ] 文档生成时间合理
- [ ] 内存使用合理
- [ ] 数据库连接正确关闭

---

**验证完成标准**: 所有【必须】检查项都已通过，文档可以交付使用。
