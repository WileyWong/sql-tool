# 诊断示例

真实场景下的诊断案例

---

## 示例 1: 新创公司项目的快速体检

**场景**: 一个 3 个月大的电商项目，需要快速诊断为融资做准备

### 诊断焦点

- 架构是否健全?
- 代码质量是否可接受?
- 是否有明显的技术债?

### 诊断过程

#### 第 1 步: 快速扫描 (10 分钟)

```
工具: Task (Explore Agent)

输入提示:
"快速分析这个 3 个月大的电商项目:
  1. 整体架构是什么样的?
  2. 主要模块有哪些?
  3. 是否有明显的架构问题?"

输出:
✓ 分层架构基本清晰 (Controller/Service/Repo)
✓ 模块划分合理 (用户/订单/支付)
⚠️ 缺少日志和监控
⚠️ 测试模块很薄弱
✗ 缺少基础配置模块
```

#### 第 2 步: 代码质量检查 (10 分钟)

```
工具: Bash (npm run lint & npm run test)

输出:
- 代码覆盖率: 45% (很低，应该 >70%)
- Lint 错误: 89 个
  - 安全性: 5 个 (SQL 注入风险)
  - 性能: 12 个 (N+1 查询)
  - 风格: 72 个

TODO 注释: 23 个
- "TODO: 优化查询" (3 处)
- "FIXME: 错误处理" (8 处)
```

#### 第 3 步: 文件结构检查 (5 分钟)

```
工具: Glob

检查结果:
✓ src/controller/    - 存在
✓ src/service/       - 存在
✓ src/repository/    - 存在
✗ src/config/        - 缺失!
✗ src/exception/     - 缺失!
✗ src/utils/         - 缺失!
✗ test/              - 极少测试

结论: 基础设施模块缺失，急需补完
```

#### 第 4 步: 采集关键见解 (5 分钟)

```
工具: AskUserQuestion

Q1: "项目最大的痛点是什么?"
A: 代码质量和稳定性

Q2: "融资前最希望改进什么?"
A: 降低缺陷率, 提升代码质量

Q3: "有多少开发人员?"
A: 3 个后端开发
```

### 诊断结果 (总计 30 分钟)

#### 执行摘要

| 维度 | 评分 | 评价 |
|------|------|------|
| 架构设计 | ⭐⭐⭐⭐☆ (4/5) | 基本健全，缺少基础模块 |
| 代码质量 | ⭐⭐⭐☆☆ (3/5) | 覆盖率低，技术债多 |
| 测试完整 | ⭐⭐☆☆☆ (2/5) | 严重不足 |
| **综合** | **⭐⭐⭐☆☆ (3/5)** | **可融资但需改进** |

#### 核心问题

1. **P0 - 高优先级**
   - 代码覆盖率仅 45%，需提升到 70%+
   - 5 个 SQL 注入风险需立即修复
   - 缺少异常处理框架

2. **P1 - 中优先级**
   - 缺少日志框架，难以排查问题
   - N+1 查询问题 (12 处)
   - 缺少基础配置模块

3. **P2 - 低优先级**
   - 代码风格不统一 (72 个 Lint 警告)
   - 缺少工具类库

#### 改进方案

**方案 A: 安全加固 (2 周)**
- 消除 5 个 SQL 注入风险 (2 天)
- 添加全局异常处理 (1 天)
- 集成日志框架 (1 天)
- 补全基础配置模块 (2 天)
- 测试和验证 (2 天)

**预期收益**: 降低缺陷 50%，改善投资方印象

**方案 B: 测试补强 (4 周)**
- 提升代码覆盖率到 70% (3 周)
- 建立 CI/CD pipeline (1 周)

**预期收益**: 提升代码质量，降低风险

### 最终输出

```
诊断报告 (1 页摘要)
├─ 整体评分: 3/5
├─ 核心问题 5 个
├─ 改进方案 2 个
└─ 预期工作量: 6 周

改进任务清单 (优先级排序)
├─ P0: 5 个任务 (2 周)
├─ P1: 8 个任务 (4 周)
└─ P2: 12 个任务 (后续优化)

预期时间表:
  第 1-2 周: 安全和质量改进
  第 3-6 周: 测试补强和代码优化
  第 7 周+: 持续改进
```

---

## 示例 2: 遗留系统的深度诊断

**场景**: 一个 5 年的老系统，维护困难，需要规划重构

### 诊断过程

#### 第 1 步: 架构深度分析 (1 小时)

```
工具: Task (Explore) + Read

发现:
- 代码行数: 250,000 LOC
- 主要问题: 严重违反 MVC 模式
- 描述: 大量业务逻辑混入 Controller
- 模块划分: 不清楚，存在多个循环依赖
- 测试: 几乎没有
```

#### 第 2 步: 代码债务扫描 (1 小时)

```
工具: Grep + Bash

发现:
- 代码重复率: 35% (应该 <5%)
- 平均方法长度: 120 行 (应该 <30)
- 圈复杂度: 平均 8.5 (应该 <3)
- 代码覆盖率: 8% (应该 >70%)
- 安全问题: 
  ✗ 18 处 SQL 注入
  ✗ 12 处 XSS 风险
  ✗ 8 处敏感信息泄露

技术债规模: 严重
```

#### 第 3 步: 依赖分析 (30 分钟)

```
工具: Bash (dependency:tree) + Read (pom.xml)

发现:
- 框架版本: Spring 4.x (已 EOL)
- 依赖冲突: 7 个
- 过时的库: 18 个
- 安全漏洞: 5 个高危，12 个中危
```

#### 第 4 步: 需求验证 (1 小时)

```
工具: Read + Grep + AskUserQuestion

发现:
- 需求文档: 缺失 (没有 Spec)
- 业务规则: 分散在代码中
- 隐藏的功能: 15 个 (代码实现但未文档)
- 生产环境特殊逻辑: 8 处 (未记录)
```

#### 第 5 步: 采集关键见解 (30 分钟)

```
工具: AskUserQuestion (多轮对话)

Q1: "这个系统的生命周期?"
A: 5 年运营，日均 10 万用户，高可用要求

Q2: "主要维护困难?"
A: 代码难理解，bug 修复风险大，添加功能困难

Q3: "未来计划?"
A: 需要支持移动端，计划扩展到国际市场

Q4: "现有团队规模?"
A: 5 个开发 + 1 个架构师

Q5: "重构意愿?"
A: 愿意重构，但不能影响现有业务
```

### 诊断结果

#### 执行摘要

| 维度 | 评分 | 评价 |
|------|------|------|
| 架构设计 | ⭐☆☆☆☆ (1/5) | 严重混乱，需重构 |
| 代码质量 | ⭐☆☆☆☆ (1/5) | 技术债危机 |
| 需求清晰 | ⭐⭐☆☆☆ (2/5) | 文档缺失 |
| 可维护性 | ⭐☆☆☆☆ (1/5) | 极度困难 |
| **综合** | **⭐☆☆☆☆ (1/5)** | **需要立即行动** |

#### 核心问题 (按风险)

1. **P0 - 致命问题**
   - 18 处 SQL 注入风险 (安全漏洞)
   - 代码理解难度极高 (维护困难)
   - 无测试保护 (修改风险)
   - 业务规则未文档化 (知识流失风险)

2. **P1 - 严重问题**
   - 35% 代码重复 (维护成本)
   - 框架已 EOL (安全/支持风险)
   - 依赖冲突 (集成困难)

3. **P2 - 技术债**
   - 代码风格混乱
   - 缺少工具类库

#### 改进策略 (3 年规划)

**阶段 1: 应急 (1-3 个月)**
- 消除安全漏洞 (SQL 注入、XSS)
- 添加关键业务文档
- 建立基础测试

**阶段 2: 补强 (4-6 个月)**
- 框架升级到 Spring 6
- 模块梳理和分离
- 关键模块重构 (支付、订单等)

**阶段 3: 重构 (7-24 个月)**
- 模块化架构改造
- 微服务评估
- 移动端支持

**阶段 4: 演进 (24+ 个月)**
- 微服务实施
- 国际化支持
- 高可用架构

#### 投入预估

| 阶段 | 工作量 | 风险 | 收益 |
|------|--------|------|------|
| 应急 | 10 人月 | 低 | 消除高风险 |
| 补强 | 15 人月 | 中 | 改善可维护性 |
| 重构 | 30 人月 | 高 | 架构现代化 |
| 演进 | 20 人月 | 低 | 开放新市场 |
| **总计** | **75 人月** | - | - |

### 关键建议

1. **立即启动应急计划**
   - 分配 3 人专职处理安全漏洞
   - 预计 1 个月消除高风险

2. **文档化业务逻辑**
   - 采集 5 年来的隐藏规则
   - 为重构建立基础

3. **建立测试基础设施**
   - 关键路径覆盖 >80%
   - 减少修改风险

4. **渐进式重构策略**
   - 不中断现有业务
   - 逐步替换模块

5. **团队能力建设**
   - 技术人员培训
   - 从外部引入架构经验

---

## 示例 3: 规划工作坊 - 技术栈演进

**场景**: 中型产品公司，需要规划 1 年的技术演进

### 诊断过程 (半天工作坊)

#### 阶段 1: 现状评估 (1 小时)

```
工具: Task (Explore) + Read

当前技术栈分析:
- 后端: Spring Boot 2.7, MyBatis, MySQL 5.7
- 前端: Vue 2, Webpack
- 基础: 无容器化, 无服务网格, 无可观测性

现状评分: 3/5 (稳定但落后)
```

#### 阶段 2: 需求采集 (1 小时)

```
工具: AskUserQuestion (多轮)

参与者: 架构师, 产品经理, 技术负责人, 运维负责人

采集信息:
1. 业务需求变化?
   - 需要国际化支持
   - 需要移动端支持
   - 预计用户数增长 10 倍

2. 技术需求?
   - 提升系统可观测性
   - 改善部署灵活性
   - 降低运维成本

3. 风险考虑?
   - 不能中断现有业务
   - 团队学习曲线
   - 成本预算限制

4. 人员状况?
   - 15 个后端开发
   - 10 个前端开发
   - 2 个 DevOps
```

#### 阶段 3: 技术评估 (1 小时)

```
工具: Read (技术方案对比文档)

备选方案评估:

Spring Boot 升级:
  收益: 安全补丁, 性能改进, 新特性
  风险: 迁移复杂度高
  推荐: 立即进行 (增量式)

Vue 3 升级:
  收益: 更好的类型支持, 性能
  风险: 学习曲线
  推荐: 逐步过渡

容器化 (Docker + K8s):
  收益: 部署灵活性, 弹性扩展
  风险: 运维复杂度, 成本
  推荐: 先 Docker, 再考虑 K8s

可观测性 (日志/链路/指标):
  收益: 快速问题定位, 性能优化
  风险: 集成工作量
  推荐: 优先部署
```

#### 阶段 4: 规划生成 (1.5 小时)

```
工具: TodoWrite + AskUserQuestion

生成规划:
- 3 月目标
- 6 月目标
- 12 月目标
- 关键里程碑
- 资源预估
- 风险评估
```

### 最终规划

#### 技术栈演进路线图 (12 个月)

**Q1 (1-3 月)**
```
目标: 基础现代化
里程碑:
  - [ ] Spring Boot 升级到 3.x (2 月)
  - [ ] 依赖更新和优化 (1 月)
  - [ ] Vue 2 -> Vue 3 前置工作 (2 月)

工作量: 12 人月
风险: 低 (充分测试)
```

**Q2 (4-6 月)**
```
目标: 容器化和可观测性
里程碑:
  - [ ] Docker 集成 (1 月)
  - [ ] 日志系统 ELK 集成 (2 月)
  - [ ] 分布式追踪 Jaeger (1 月)

工作量: 10 人月
风险: 中 (运维学习)
```

**Q3-Q4 (7-12 月)**
```
目标: 架构优化和功能扩展
里程碑:
  - [ ] 国际化支持 (3 月)
  - [ ] 移动端 API 适配 (2 月)
  - [ ] K8s 评估和试点 (2 月)
  - [ ] 性能优化 (1 月)

工作量: 20 人月
风险: 中
```

#### 资源配置

| 角色 | 数量 | 分配 |
|------|------|------|
| 后端技术负责人 | 1 | 全职 (规划 + 实施) |
| 后端开发 | 5 | 全职 (框架升级) |
| 后端开发 | 3 | 兼职 (功能开发) |
| 前端技术负责人 | 1 | 全职 (Vue 3 迁移) |
| 前端开发 | 4 | 全职 (Vue 3 迁移) |
| DevOps 工程师 | 2 | 全职 (容器化) |

#### 投入预估

- 总工作量: 52 人月 (全年)
- 预算成本: 根据人力成本计算
- 预期收益: 
  - 系统性能提升 25%
  - 部署时间降低 60%
  - 可观测性提升 100%
  - 支持国际和移动

---

## 通用诊断检查清单

可复用的诊断框架

### 快速体检 (30 分钟)

- [ ] 项目整体架构? (Task)
- [ ] 主要文件组织? (Glob)
- [ ] 代码质量指标? (Bash lint/test)
- [ ] 明显的问题? (Grep)
- [ ] 技术栈现状? (Read pom.xml/package.json)

### 标准诊断 (2 小时)

- [ ] 详细架构分析 (Task + Read)
- [ ] 代码债务清单 (Grep + Bash)
- [ ] 需求覆盖度 (Read + Grep)
- [ ] 技术栈评估 (Read + AskUserQuestion)
- [ ] 改进方案生成 (TodoWrite)

### 深度诊断 (1 天)

- [ ] 所有标准诊断项
- [ ] 关键模块深度分析 (Read)
- [ ] 性能基准测试 (Bash)
- [ ] 安全审计 (Grep)
- [ ] 团队访谈 (AskUserQuestion)
- [ ] 完整报告和规划 (综合输出)

