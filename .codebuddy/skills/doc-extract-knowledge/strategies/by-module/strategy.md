---
name: doc-extract-by-module
description: 从大型项目的指定模块中按3个一批提取知识库文档，支持断点续传。当用户提到"为模块生成文档"、"提取模块知识"、"模块文档化"或"按模块生成知识库"时使用。**必须严格按照流程执行，不可跳过任何步骤**
category: documentation
---

# 按模块提取知识库

> # 🚨 致AI：这是一个"按3个文件批量"处理的技能！🚨
> 
> **关键词：3个一批、小批量、每批3个、不是1个、不是大批量**
> 
> - ✅ 每次处理3个文件（成批）
> - ❌ 不是每次处理1个文件
> - ❌ 不是每次处理5个文件
> - ❌ 不是大批量处理（10个以上）
> - 🔴 必须：每处理完3个文件后立即更新索引！
> 
> **🔴 关键：你的任务是直接生成高质量文档，不是写代码！**
> - ✅ 使用 `write_to_file` 工具直接生成 Markdown 文档
> - ✅ 阅读代码后用自然语言撰写文档内容
> - ❌ 绝对禁止编写 Python/JavaScript/Shell 脚本来生成文档
> - ❌ 绝对禁止创建批处理程序或自动化脚本
> - 📝 你是"文档撰写者"，不是"工具开发者"
> 
> **⛔ 绝对禁止的话术：**
> - ❌ "让我快速为剩余的N个文件生成文档"
> - ❌ "由于token消耗较大，我将提高处理效率"
> - ❌ "以更精简的方式继续处理"
> - ❌ "批量处理剩余文件"
> - ❌ "继续生成剩余5个文件"
> - ❌ "现在处理文件28-33（并行读取以加快速度）"
> - ❌ "并行处理"或"同时读取多个文件"
> 
> **✅ 唯一允许的话术：**
> - ✅ "现在处理第N-M个文件（3个一批）"
> - ✅ "处理完这3个文件，立即更新索引，继续下一批"
- ✅ "已处理文件1/3, 2/3, 3/3 → 现在更新索引"
> 
> **如果你打算批量处理多个文件或编写代码，请立即停止并重新阅读文档！**

为大型项目的指定模块生成结构化的文件级知识库文档，支持断点续传和进度跟踪。

## 🎯 核心特性

- **模块级处理** - 用户指定模块目录，精准控制文档生成范围
- **3个一批生成** - 按文件顺序每3个生成文档，避免上下文过载（禁止大批量！）
- **断点续传** - 中断后可从上次位置继续，不重复处理
- **进度可视化** - 实时跟踪每个文件的处理状态
- **灵活模板** - 根据文件类型选择合适的文档模板

## 📋 快速开始

```
用户：为 src/main/java/com/xxx/user 模块生成文档
AI：
1. 扫描模块，建立文件索引 (.file-list.md)
2. 按3个一批读取并生成文档（用工具直接写文档，不写代码）
3. 实时更新文件索引、进度状态（每3个文件完成后立即更新）
4. 完成后输出总结
```

## 🔄 执行流程

> # 🚨🚨🚨 致AI：在执行之前必须阅读此警告！🚨🚨🚨
> 
> ## ⛔ 批量处理要控制在3个！⛔

**这个技能是"3个一批"小批量处理，超过3个就是错误的！**
> 
> ### 你会犯的最大错误：
> 
> **❌❌❌ 错误的思维方式（绝对不要这样想）：**
> ```
> "我看到有45个文件需要处理，让我规划一下：
>  1. 先读取前5个文件
>  2. 为这5个文件生成文档
>  3. 然后批量更新这5个文件的索引
>  4. 再处理下一批5个文件"
> ```
> **这种思维方式会导致任务失败！**
> 
> **✅✅✅ 正确的思维方式（你必须这样想）：**
> ```
> "我现在处理1个批次，每批处理3个文件：
>  1. 读取第1-3个文件的代码
>  2. 为这3个文件生成文档
>  3. 立即更新这3个文件的索引
>  4. 然后再处理下一批（第4-6个文件）
>  5. 为这3个文件生成文档
>  6. 立即更新这3个文件的索引
>  7. ... 每批重复直到完成"
> ```
> **这是唯一正确的思维方式！每批3个，处理后立即更新！**
> 
> ### 🔴 禁止的行为清单：
> 
> - ❌ 禁止一次性读取多个文件
> - ❌ 禁止批量生成多个文档
> - ❌ 禁止积攒多个文件后批量更新索引
> - ❌ 禁止说"我先处理这一批，再更新索引"
> - ❌ 禁止说"为了提高效率，我批量处理"
> - ❌ 禁止跳过步骤2.4（更新索引）
> - ❌ 禁止延后索引更新
> 
> **✅ 必须的行为清单：**
>
> - ✅ 每批读取3个文件
> - ✅ 每批生成3个文档
> - ✅ 每批处理完后立即更新索引
> - ✅ 索引更新完成后才能继续下一批
> - ✅ 严格按照步骤2.1→2.2→2.3→2.4→2.5的顺序
> - ✅ 步骤2.4（更新索引）绝对不能跳过
> 
> ## ⚠️ 执行前必读：核心规则 ⚠️
> 
> ### 🔴 最重要的规则（违反将导致任务失败）
> 
> **这个技能是"3个一批"处理，不是"逐文件"处理！**
> 
> #### 正确的执行方式 ✅
> ```
> 处理文件1-3 → 保存文档1-3 → 立即更新索引 → 处理文件4-6 → 保存文档4-6 → 立即更新索引 → ...
> ```
> 
> #### 错误的执行方式 ❌
> ```
> ❌ 处理文件1-5 → 保存文档1-5 → 批量更新索引（应为3个一批，不是5个）
> ❌ 按5个一批处理（应为3个一批）
> ❌ 处理所有文件后才更新索引（应每批3个后立即更新）
> ❌ 逐文件处理（应3个一批处理）
> ```
> 
> #### 关键要求
> - 🔴 **每完成3个文件，必须立即更新索引**
> - 🔴 **不允许积攒超过3个文件后批量更新**
> - 🔴 **处理下一批文件之前，必须确保当前批次的索引已更新**
> - 🔴 **索引条目绝对不可变（不能增删改序号和路径）**

### 参数获取

执行前获取两个关键参数：

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| **SOURCE_DIR** | 源代码模块目录（必需） | 无，需用户指定 | `src/main/java/com/xxx/user` |
| **DOC_DIR** | 文档输出目录（可选） | `kb/{模块名}` | `kb/user` 或 `docs/api` |

**获取方式**：
- **SOURCE_DIR**: 优先从用户消息中提取（如"为 xxx 目录生成文档"），其次从当前上下文推断（用户打开的文件夹）
- **DOC_DIR**: 如未指定，自动从 SOURCE_DIR 提取最后一级目录名，生成 `kb/{模块名}` 格式
- 如果都无法确定，提示用户指定

**示例提示**：
```
请指定要生成文档的模块目录：
- 示例：src/main/java/com/xxx/user
- 或者：backend/services/order

文档将保存到：kb/{模块名} （默认从SOURCE_DIR自动提取）
如需修改，请告知目标目录。
```

### 阶段1：建立文件索引

#### 步骤1.1：检查索引文件是否存在

检查 `{DOC_DIR}/.file-list.md` 是否存在：

```
📋 阶段1：建立文件索引
检查索引文件: kb/user/.file-list.md ... ❌ 不存在
⚠️ 需要创建文件索引

```

#### 步骤1.2：扫描模块并创建索引

**情况A：索引文件不存在 → 创建新索引**

使用 `list_files` 工具递归扫描 `SOURCE_DIR`，创建 `{DOC_DIR}/.file-list.md`：

**🔴 关键：统计文件数量时必须排除目录**
- ✅ 只统计真正的代码文件（.java/.ts/.js/.py等）
- ❌ 不要统计目录/文件夹的数量
- 使用工具时过滤掉 `isDirectory: true` 的条目

输出示例：
```
📂 扫描模块: src/main/java/com/xxx/user
扫描到的文件数: 45 个（已排除目录）
文件类型分布: Controller(5) Service(8) Mapper(6) Entity(10) DTO(9) Utils(7)
创建索引: kb/user/.file-list.md ✅
```

**索引文件格式** - 参考 [file-list.md](./templates/file-list.md)：

| 序号 | 代码文件路径 | 文件大小 | 文档文件路径 | 文档大小 | 状态 |
|------|--------------|----------|--------------|----------|------|
| 1 | controller/UserController.java | 3.2KB | controller/UserController.md | - | 待创建 |
| ... | ... | ... | ... | ... | ... |

**关键要求**：
- ✅ 按文件路径升序排列
- ✅ 路径相对于 `SOURCE_DIR`
- ✅ 初始状态全部为"待创建"
- ✅ 文档路径和大小初始为空
- ✅ **只索引文件，不索引目录**

**情况B：索引文件存在 → 验证完整性**

输出验证结果：索引记录数 vs 实际文件数（**排除目录后**的文件数）

**情况C：索引不一致 → 重新创建**

输出不一致信息（新增/删除的文件），自动重新扫描（**排除目录**），保留已生成状态。

### 阶段2：按3个一批生成文档

> # 🚨🚨🚨 致AI：这是最关键的部分！🚨🚨🚨
> 
> ## ⚠️ 在开始执行之前，请先阅读以下规则 3 遍！⚠️
> 
> ### 🔴 规则1：必须是3个一批！🔴
> 
> **你可能会想这样做（❌ 绝对错误！）：**
> ```
> # ❌❌❌ 千万不要这样做！ ❌❌❌
> 
> ❌ 错误的方式：
>   - 一次性处理超过3个文件
>   - 处理完3个文件后不更新索引
>   - 大批量处理（10个以上）
> 
> ❌ 更错误的方式：
>   - 并行处理多个文件
>   - 处理完所有文件后统一更新索引
> ```
> 
> **你必须这样做（✅ 唯一正确的方式）：**
> ```
> # ✅✅✅ 这是唯一正确的执行流程！ ✅✅✅
> 
> 处理第1批（文件1-3）：
>   1. 读取文件1的代码 → 生成文档1
>   2. 读取文件2的代码 → 生成文档2
>   3. 读取文件3的代码 → 生成文档3
>   4. 🔴 立即更新索引文件（批量更新文件1-3的状态）
>   
> 处理第2批（文件4-6）：
>   1. 读取文件4的代码 → 生成文档4
>   2. 读取文件5的代码 → 生成文档5
>   3. 读取文件6的代码 → 生成文档6
>   4. 🔴 立即更新索引文件（批量更新文件4-6的状态）
>   
> ... 继续每批3个文件的流程
> ```
> 
> ### 🔴 规则2：绝对禁止预先规划多个文件！🔴
> 
> **❌ 禁止的思维方式：**
> - "我先读取5个文件，然后批量生成"
> - "我先看看有哪些文件需要处理，然后一起处理"
> - "我先规划一下，处理文件1-10"
> 
> **✅ 正确的思维方式：**
> - "我现在处理1个批次（3个文件）"
> - "处理完这3个文件并更新索引后，再考虑下一批"
> - "每次只关注当前这1个批次（3个文件）"
> 
> ### 🔴 规则3：每完成3个文件必须立即更新索引！🔴
> 
> **执行顺序（不可改变）：**
> ```
> ┌────────────────────────────────────────────────────┐
> │ 📄 处理第N批（3个文件）                           │
> ├────────────────────────────────────────────────────┤
> │ 1. 读取文件N、N+1、N+2的代码                      │
> │ 2. 为这3个文件生成文档                             │
> │ 3. 保存文档到文件系统                               │
> │ 4. 🔴 立即批量更新索引（更新3个文件的状态）🔴      │
> │    ↓                                                │
> │    ❌ 不允许跳到步骤5之前就开始处理下一批             │
> │    ❌ 不允许处理超过3个文件后才更新索引              │
> │    ✅ 必须确认索引已更新才能继续下一批               │
> │ 5. 获取下一批待处理文件（文件N+3, N+4, N+5）       │
> └────────────────────────────────────────────────────┘
> ```
> 
> ### 🔴 规则4：索引更新是阻塞操作！🔴
> 
> - 📍 更新索引完成之前，**禁止**读取下一批文件
> - 📍 更新索引完成之前，**禁止**生成下一批文档
> - 📍 更新索引完成之前，**禁止**规划下一批文件
> - ✅ 更新索引完成之后，**才能**继续下一批（3个文件）
> 
> ### 🔴 规则5：如果你违反了以上规则 🔴
> 
> **任务将会失败，因为：**
> - 断点续传机制会失败
> - 进度跟踪会不准确
> - 会话中断后无法恢复
> - 用户会看到错误的进度
> 
> ### ✅ 自查清单（每处理1个批次前必须检查）
> 
> - [ ] 我是否只读取了3个文件？（不是1个、5个或10个）
> - [ ] 我是否只生成了3个文档？（不是1个或超过3个）
> - [ ] 我是否立即更新了索引？（不是延后或超过3个才更新）
> - [ ] 我是否确认索引已更新才继续下一批？（不是跳过更新）

---

## 🔄 现在开始执行：按3个一批处理文件

#### 步骤2.1：🔴 只读取3个文件（不是1个、5个或10个）

> **⚠️ 重要提醒：**
> - ✅ 只读取3个文件的信息（这是1个批次）
> - ❌ 不要只读取1个文件
> - ❌ 不要读取5个文件
> - ❌ 不要读取10个文件
> - ❌ 不要读取所有待处理文件
> - 🔴 读取3个，处理3个，更新3个，然后再读取下一批（下3个）

从 `.file-list.md` 中读取**前3条**状态为"待创建"的记录（每批只读3条）：

```
📄 处理第1批（文件1-3）

文件1: controller/UserController.java → 模板: controller.md
文件2: service/UserService.java → 模板: service.md
文件3: entity/UserEntity.java → 模板: entity.md
```

> **🔴 确认：步骤2.1完成检查**
> - [ ] 我只读取了3个文件吗？（是的，是3个）
> - [ ] 我没有读取超过3个文件吗？（是的，只读了3个）
> - [ ] 现在准备进入步骤2.2为这3个文件选择模板

#### 步骤2.2：🔴 为这3个文件选择模板

> **⚠️ 重要提醒：**
> - ✅ 为当前这3个文件选择模板
> - ❌ 不要为超过3个文件批量选择模板
> - 🔴 当前文件是：步骤2.1读取的那3个文件（Controller、Service、Entity）

根据文件类型（从路径或类注解推断）为**当前这3个文件**选择模板：

| 文件类型 | 模板文件 | 说明 |
|---------|---------|------|
| Interface | `templates/interface.md` | 接口定义 |
| Abstract | `templates/abstract.md` | 抽象类 |
| Controller | `templates/controller.md` | REST API 控制器 |
| Service | `templates/service.md` | 业务逻辑服务 |
| Mapper | `templates/mapper.md` | 数据访问层 |
| Entity | `templates/entity.md` | 实体类 |
| DTO | `templates/dto.md` | 数据传输对象 |
| VO/Response | `templates/vo-response.md` | 视图对象/响应对象 |
| Request | `templates/request.md` | 请求对象/查询对象 |
| Enum | `templates/enum.md` | 枚举类 |
| Exception | `templates/exception.md` | 异常类 |
| Feign | `templates/feign.md` | Feign 远程调用客户端 |
| Handler | `templates/handler.md` | 处理器/监听器 |
| Job/Task | `templates/job-task.md` | 定时任务/调度任务 |
| MQ Listener | `templates/mq-listener.md` | 消息队列监听器 |
| Constants | `templates/constants.md` | 常量类 |
| Annotation | `templates/annotation.md` | 自定义注解 |
| Utils | `templates/utils.md` | 工具类 |
| Config | `templates/config.md` | 配置类 |
| 其他 | `templates/default.md` | 通用模板 |

**模板选择逻辑**（按优先级）：
```
1. 从类类型推断（interface → Interface, abstract → Abstract, enum → Enum）
2. 从类注解推断（@RestController/@Controller → Controller, @Service → Service, 
   @Mapper → Mapper, @FeignClient → Feign, @Configuration → Config）
3. 从继承关系推断（extends Exception → Exception, extends RuntimeException → Exception）
4. 从类名后缀推断（xxxService → Service, xxxDTO → DTO, xxxVO → VO, 
   xxxRequest → Request, xxxHandler → Handler, xxxConstants → Constants, 
   xxxListener → MQ Listener）
5. 从方法注解推断（@Scheduled/@XxlJob → Job/Task, 
   @RabbitListener/@KafkaListener → MQ Listener）
6. 从文件路径推断（controller/xxx → Controller, service/xxx → Service）
7. 默认使用 default.md
```

> **🔴 确认：步骤2.2完成检查**
> - [ ] 我只为3个文件选择了模板吗？（是的，为3个文件）
> - [ ] 我没有为超过3个文件批量选择模板吗？（是的，只有3个）
> - [ ] 现在准备进入步骤2.3为这3个文件生成文档

#### 步骤2.3：🔴 只生成3个文档（不是大批量）

> **⚠️ 重要提醒：**
> - ✅ 生成当前这3个文件的文档
> - ❌ 不要批量生成超过3个文档
> - ❌ 不要规划生成10个文档
> - 🔴 当前文件是：步骤2.1读取的那3个文件
> - 🔴 生成完这3个文档后，必须立即跳到步骤2.4更新索引！
> 
> **🚨 关键：如何生成文档？🚨**
> - ✅ 直接使用 `write_to_file` 工具生成 Markdown 文档
> - ✅ 基于模板内容，用自然语言描述生成文档
> - ❌ 绝对禁止编写 Python/JavaScript/任何脚本代码来生成文档
> - ❌ 绝对禁止创建自动化脚本来批量生成文档
> - 📝 这是一个"人工智能写文档"的任务，不是"写代码生成文档"的任务

按选定模板格式为**当前这3个文件**生成文档：

```
生成文档...

  文件1✅
  文件2✅
  文件3✅

✅ 3个文档生成完成
```

> **🔴 确认：步骤2.3完成检查**
> - [ ] 我只生成了3个文档吗？（是的，生成了3个）
> - [ ] 我没有批量生成超过3个文档吗？（是的，只有3个）
> - [ ] 文档已保存到文件系统吗？（是的，已保存）
> - [ ] 🚨 现在必须立即进入步骤2.4更新索引！🚨
> - [ ] 🚨 不允许跳过步骤2.4直接处理下一批文件！🚨

**文档格式要求** - 参考各模板文件：
- 包含类的完整路径和职责说明
- 列出所有公共方法的签名
- 标注依赖的其他类
- 关键业务逻辑的简要说明

#### 步骤2.4：🚨🚨🚨 立即更新索引（这是最关键的步骤！）🚨🚨🚨

> # ⛔ 停！在继续之前，你必须执行这一步！⛔
> 
> ## 🔴 这是整个流程中最容易被跳过的步骤！🔴
> 
> **AI最常犯的错误：**
> - ❌ "我先生成5个文档，然后批量更新索引" ← 错误！
> - ❌ "我先处理完这一批，再统一更新索引" ← 错误！
> - ❌ "索引稍后更新，我先继续处理下一个" ← 错误！
> - ❌ "我可以跳过这步，直接处理下一个文件" ← 错误！
> - ❌ "让我快速为剩余的N个文件生成文档" ← 错误！
> - ❌ "由于token消耗较大，我将提高效率批量处理" ← 错误！
> - ❌ "以更精简的方式继续处理剩余文件" ← 错误！
> - ❌ "现在处理文件28-33（并行读取以加快速度）" ← 错误！
> - ❌ 任何形式的"并行处理"或"同时读取" ← 错误！
> 
> **唯一正确的做法：**
> - ✅ "我刚生成了3个文档，现在立即批量更新索引，然后才能处理下一批"
> 
> ## 🔴 执行检查清单（必须全部勾选才能继续）
> 
> - [ ] 我刚才在步骤2.3生成了3个文档吗？（必须是3个，不是1个或超过3个）
> - [ ] 这个文档已经保存到文件系统了吗？（必须确认已保存）
> - [ ] 我现在要更新这3个文件的索引状态吗？（必须是刚生成的这3个）
> - [ ] 我没有打算批量更新超过3个文件吗？（必须只更新3个）
> - [ ] 我没有打算跳过这步直接处理下一个吗？（必须先更新索引）
> 
> **如果以上5个问题有任何1个回答"否"，你的做法就是错误的！**
> 
> ---
> 
> ## 🚨 强制要求 🚨
> 
> - 🔴 **在处理下一批文件之前，必须完成当前批次的索引更新**
> - 🔴 **不允许积攒超过3个文件后批量更新**
> - 🔴 **不允许说"稍后更新"或"批量更新超过3个"或"快速处理剩余N个"**
> - 🔴 **此步骤绝对不能省略、延后或超过3个批量执行**
> - 🔴 **token消耗大不是大批量处理的理由，质量>效率**
> - 🔴 **即使剩余文件很多，也必须每3个文件更新一次**
> - 🔴 **更新完索引之前，禁止读取下一批文件**
> - 🔴 **更新完索引之前，禁止规划下一批文件**

**执行流程（必须严格按顺序执行）：**

```
🔄 步骤2.4：立即更新索引文件（批量更新刚生成的3个文件）

⚠️ 在开始之前再次确认：
- 你刚才生成了几个文档？（必须回答：3个）
- 你打算更新几个文件的索引？（必须回答：3个）
- 你打算批量更新索引吗？（必须回答：是，更新3个）

1. 确认文档已成功保存到文件系统 ✅
2. 🔴 立即打开索引文件: kb/user/.file-list.md
3. 🔴 定位到序号为 1-3 的记录（找这3条记录）
4. 🔴 只更新这3条记录的3个字段：
   - 文档文件路径: controller/UserController.md, service/UserService.md, entity/UserEntity.md
   - 文档大小: 5.8KB, 6.2KB, 4.3KB
   - 状态: 待创建 → 已生成 ✅
5. 🔴 保存索引文件: kb/user/.file-list.md ✅
6. 🔴 确认索引文件已保存成功

⚠️ 严格约束：
- ❌ 绝对禁止：只更新1个文件的记录
- ❌ 绝对禁止：预先更新还没生成的文件
- ❌ 绝对禁止：跳过索引更新直接处理下一个
- ✅ 只更新：刚才在步骤2.3生成的那3个文件

✅ 文件 1-3/45 处理完成（包括索引更新）

🔴 索引已更新！现在才可以继续处理下一个批次（返回步骤2.1）
🔴 在索引更新完成之前，禁止处理下一批文件！
```

**索引更新的约束规则**：

| 操作 | 是否允许 | 说明 |
|------|---------|------|
| 更新当前文件的状态 | ✅ 允许 | 待创建 → 已生成 |
| 更新当前文件的文档路径 | ✅ 允许 | 填写实际生成的路径 |
| 更新当前文件的文档大小 | ✅ 允许 | 填写实际文件大小 |
| 修改序号 | ❌ 禁止 | 序号绝对不可变 |
| 修改代码文件路径 | ❌ 禁止 | 代码文件路径不可变 |
| 修改文件大小 | ❌ 禁止 | 原始文件大小不可变 |
| 新增记录 | ❌ 禁止 | 索引条目数量不可变 |
| 删除记录 | ❌ 禁止 | 索引条目数量不可变 |
| 批量更新多个文件 | ❌ 禁止 | 每批只更新当前处理的3个文件 |
| 延后更新 | ❌ 禁止 | 必须在处理下一批文件之前完成 |

#### 步骤2.5：继续处理下一批文件

重复步骤 2.1 - 2.4，自动连续处理直到所有文件处理完成：

```
已完成: 15/45 (33.3%)
继续处理下一批3个文件...
```

**执行策略**：
- 自动连续处理所有文件，无需用户确认
- 每批3个文件完成后立即更新索引
- 所有文件处理完成后统一总结

### 阶段3：生成目录索引与完成总结

当所有文件状态都变为"已生成"时，按以下顺序执行：

#### 步骤3.1：询问是否生成 README.md（必须询问）

> **🚨 这是必须执行的步骤！🚨**
> - 虽然生成 README.md 是可选的，但**询问用户**是必须的
> - 所有文档生成完成后，必须立即询问用户
> - 不能跳过这个询问步骤

```
📋 阶段3：生成目录索引

所有 45 个文件的文档已生成完成！

是否为文档目录生成 README.md 索引文件？

选项：
  [1] 生成 README.md（如已存在则更新）
  [2] 跳过

请选择（1/2）：
```

> **🔴 必须等待用户选择！🔴**
> - ✅ 输出上述询问后，**必须停止并等待用户回复**
> - ❌ 禁止在输出询问后继续执行任何操作
> - ❌ 禁止自动选择默认选项
> - ❌ 禁止跳过等待直接输出完成总结
> - 只有在用户明确回复 1 或 2 后，才能继续执行步骤3.2

#### 步骤3.2：根据用户选择执行（等待用户回复后）

**用户选择"生成/更新"时执行：**

**3.2.1：扫描文档目录**

```
📂 扫描文档目录: kb/user/

扫描到的文档文件: 45 个（排除 .file-list.md 和 README.md）

按类型分组:
  - Controller: 5 个
  - Service: 8 个
  - Mapper: 6 个
  - Entity: 10 个
  - DTO: 9 个
  - Utils: 7 个
```

**3.2.2：读取模板并生成 README.md**

```
读取模板: templates/directory-index.md ✅

生成索引文件...
  - 填充模块信息
  - 生成目录结构
  - 按类型分类统计
  - 生成详细清单
  - 添加使用指南

保存文件: kb/user/README.md ✅
  - 文件大小: 12.5KB

✅ 目录索引生成完成
```

**用户选择"跳过"时：**

```
⏭️ 跳过 README.md 生成

如需后续生成，可执行：
  "为 kb/user/ 目录生成 README.md 索引"
```

#### 步骤3.3：输出完成总结

无论用户是否选择生成 README.md，最后都必须输出完成总结：

```
🎉 文档生成完成
模块: src/main/java/com/xxx/user
文档目录: kb/user/

📊 统计信息:
  - 总文件数: 45
  - 已生成文档: 45
  - 文档总大小: 256.7KB
  - README.md: ✅ 已生成 / ⏭️ 已跳过
  
📂 文档分布:
  - controller/: 5 个文档
  - service/: 8 个文档
  - mapper/: 6 个文档
  - entity/: 10 个文档
  - dto/: 9 个文档
  - utils/: 7 个文档

📋 生成的文件:
  - 索引文件: kb/user/.file-list.md
  - 目录索引: kb/user/README.md（如已生成）
  - 文档文件: 45 个

✅ 所有文档已保存到 kb/ 目录
```

## 🔄 断点续传

### 检测断点

每次执行前自动检测断点：

```
🔍 检测断点信息
索引文件: kb/user/.file-list.md ✅ 存在

进度统计:
  - 已完成: 28 个 (62.2%)
  - 待处理: 17 个 (37.8%)
  
下一批文件:
  - 序号: 29-31
  - 文件: dto/UserQueryDTO.java 等3个
  - 状态: 待创建

⚠️ 检测到未完成的任务，将从断点继续执行

✅ 自动从文件 29 开始处理（每批3个）
```

### 续传策略

- **自动续传**：读取 `.file-list.md`，找到第一个"待创建"状态的文件
- **跳过已完成**：不重复处理"已生成"的文件
- **验证一致性**：确认文档文件确实存在且有效
- **同步状态**：如果文档已存在但状态为"待创建"，自动更新状态

## ⚠️ 执行规则

```
┌─────────────────────────────────────────────────────────────────┐
│                    ⚠️ 强制执行规则（必须遵守）                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  🔴 规则1：参数验证                                              │
│     ├── 执行前必须确认 SOURCE_DIR 和 DOC_DIR                     │
│     ├── SOURCE_DIR 必须存在且包含代码文件                        │
│     └── DOC_DIR 不存在时自动创建                                 │
│                                                                  │
│  🔴 规则2：索引文件优先                                          │
│     ├── 必须先检查 .file-list.md 是否存在                        │
│     ├── 存在则验证完整性，不一致则自动重建索引                 │
│     └── 不存在才进行扫描和创建                                   │
│                                                                  │
│  🔴 规则3：严格按序处理                                          │
│     ├── 必须从第一个"待创建"状态的文件开始                       │
│     ├── 按序号顺序每批3个处理，不得跳过                           │
│     └── 不得并行处理多个文件                                     │
│                                                                  │
│  🔴 规则4：每批3个文件完成后立即更新索引 ⭐⭐⭐（最关键）         │
│     ├── 🚨 生成3个文档后立即更新索引，然后才能处理下一批         │
│     ├── ❌ 禁止：批量生成5个文档后再更新索引                      │
│     ├── ❌ 禁止：积攒多个文档后批量更新                          │
│     ├── ✅ 更新内容：文档路径、文档大小、状态                     │
│     └── ❌ 不得修改序号/代码路径/文件大小，不得增删记录          │
│                                                                  │
│  🔴 规则5：模板必须存在                                          │
│     ├── 生成前必须读取对应类型的模板文件                         │
│     ├── 模板不存在则使用 default.md                              │
│     └── 不得自行创造文档格式                                     │
│                                                                  │
│  🔴 规则6：自动连续处理                                          │
│     ├── 自动处理所有文件，无需每批询问用户                       │
│     ├── 每批3个文件完成后立即更新索引                             │
│     └── 支持断点续传，中断后可从上次位置继续                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 📂 文件组织

```
skills/doc-extract-by-module/
├── SKILL.md                      # 本文件
├── templates/                    # 文档模板（23个模板）
│   ├── file-list.md              # 索引文件模板
│   ├── directory-index.md        # 目录索引模板
│   ├── architecture.md           # 架构关系图模板
│   ├── interface.md              # Interface 文档模板
│   ├── abstract.md               # Abstract 文档模板
│   ├── annotation.md             # Annotation 文档模板
│   ├── controller.md             # Controller 文档模板
│   ├── service.md                # Service 文档模板
│   ├── mapper.md                 # Mapper 文档模板
│   ├── entity.md                 # Entity 文档模板
│   ├── dto.md                    # DTO 文档模板
│   ├── vo-response.md            # VO/Response 文档模板
│   ├── request.md                # Request 文档模板
│   ├── enum.md                   # Enum 文档模板
│   ├── exception.md              # Exception 文档模板
│   ├── feign.md                  # Feign Client 文档模板
│   ├── handler.md                # Handler 文档模板
│   ├── job-task.md               # Job/Task 文档模板
│   ├── mq-listener.md            # MQ Listener 文档模板
│   ├── constants.md              # Constants 文档模板
│   ├── utils.md                  # Utils 文档模板
│   ├── config.md                 # Config 文档模板
│   └── default.md                # 默认模板
└── examples.md                   # 使用示例

项目中的输出（示例）:
kb/user/
├── .file-list.md                 # 文件索引（自动生成）
├── README.md                     # 目录索引（阶段3可选生成）
├── controller/
│   ├── UserController.md
│   └── RoleController.md
├── service/
│   ├── UserService.md
│   └── UserServiceImpl.md
└── ...
```

## 🆚 与 doc-extract-proj-bottom-up 的区别

| 特性 | doc-extract-by-module | doc-extract-proj-bottom-up |
|------|----------------------|---------------------------|
| **适用场景** | 单个模块/子目录 | 整个项目 |
| **处理单位** | 按3个一批处理 | 分批处理（每批10个） |
| **任务管理** | 单一索引文件 | 完整清单 + 计划 + 进度 |
| **依赖分析** | ❌ 不包含 | ✅ 完整依赖图和反向依赖 |
| **架构图** | ❌ 不生成 | ✅ 自动生成 |
| **汇总索引** | ✅ 可选生成 README.md | ✅ README + 分类索引 |
| **复杂度** | 简单轻量 | 功能完整 |
| **执行速度** | 较快（无汇总开销） | 较慢（包含分析汇总） |

**选择建议**：
- ✅ 使用 `doc-extract-by-module`：只需要为特定模块生成文档，不需要依赖分析
- ✅ 使用 `doc-extract-proj-bottom-up`：需要完整的项目知识库，包含依赖关系和架构图

## ❌ 常见错误和纠正

### 错误1：按批次批量处理 ⚠️⚠️⚠️

**错误表现**：
```
❌ 读取文件1-5
❌ 生成文档1-5
❌ 批量更新索引（更新5条记录）
```

**正确做法**：
```
✅ 读取文件1-3 → 生成文档1-3 → 立即更新索引（3条记录）→
   读取文件4-6 → 生成文档4-6 → 立即更新索引（3条记录）→
   读取文件7-9 → 生成文档7-9 → 立即更新索引（3条记录）→ ...
```

**问题根源**：
- 把"3个一批处理"理解成了"大批量处理（5个以上）"
- 没有严格遵守"3个文件就必须更新一次"的规则
- 误认为可以批量处理后批量更新

**纠正方法**：
1. 明确：这个技能是**3个一批处理**，每3个就要更新一次
2. 每3个文件的完整流程是：读取→生成→保存→**立即更新索引**
3. 只有完成这4步后，才能开始处理下一批文件
4. 自动连续处理所有文件，无需暂停询问

---

### 错误2：积攒多个文件后才更新索引

**错误表现**：
```
❌ 生成文档1 → 生成文档2 → 生成文档3 → 继续处理4,5,6 → 等处理完一批后才更新索引
```

**正确做法**：
```
✅ 生成文档1-3 → 立即更新索引（文件1,2,3）→ 生成文档4-6 → 立即更新索引（文件4,5,6）
```

**问题根源**：
- 没有严格遵守"每3个文件完成就要立即更新"的规则
- 没有理解断点续传的原理

**纠正方法**：
1. 每批3个文件完成后都必须立即更新索引
2. 自动连续处理，索引始终保持最新状态

---

### 错误3：延后更新索引

**错误表现**：
```
❌ 处理多个文件后才批量更新索引
❌ 认为可以先积累一批再统一更新
```

**正确做法**：
```
✅ 处理文件1-3并立即更新索引
✅ 处理文件4-6并立即更新索引
✅ 处理文件7-9并立即更新索引
✅ ... 自动连续处理直到完成
```

**问题根源**：
- 认为批量更新更高效
- 不理解断点续传依赖实时更新

**纠正方法**：
1. 每3个文件完成后都必须立即更新索引
2. 自动连续处理，索引始终保持最新状态

---

### 错误4：修改索引条目的序号或路径

**错误表现**：
```
❌ 修改文件序号
❌ 修改代码文件路径
❌ 新增或删除记录
```

**正确做法**：
```
✅ 仅更新：文档路径、文档大小、状态
✅ 其他字段保持不变
```

**问题根源**：
- 认为索引文件可以随意修改
- 不理解索引条目的不可变性

**纠正方法**：
1. 索引条目一旦创建，序号和代码路径就不可变
2. 只有3个字段可以更新：文档路径、文档大小、状态
3. 任何增删改操作都会破坏断点续传机制

---

### 错误5：文档未生成就标记为"已生成"

**错误表现**：
```
❌ 预先批量更新所有状态为"已生成"
❌ 文档生成失败但仍标记为"已生成"
```

**正确做法**：
```
✅ 确认文档已保存到文件系统
✅ 确认文档大小 > 0
✅ 然后才更新状态为"已生成"
```

**问题根源**：
- 为了快速完成而跳过实际生成
- 没有验证文档是否真的生成成功

**纠正方法**：
1. 必须基于实际结果更新状态
2. 生成成功 → "已生成"
3. 生成失败 → "待创建"（保持不变）或标记错误

---

### 总结：执行流程检查清单

**每个批次（3个文件）的正确执行流程**：
```
┌─────────────────────────────────────────┐
│ 1. 读取文件N-N+2的代码（共3个）        │
│ 2. 为这3个文件识别类型并读取模板        │
│ 3. 生成这3个文件的文档内容              │
│ 4. 保存这3个文档到文件系统              │
│ 5. 确认这3个文档都已成功保存            │
│ 6. 🔴 立即更新索引（这3个文件）  ← 关键步骤！
│ 7. 继续处理下一批3个文件（返回步骤1）   │
└─────────────────────────────────────────┘
```

**自查问题**：
- [ ] 是否每批3个文件完成后都立即更新了索引？
- [ ] 是否有批量更新超过3个文件的情况？
- [ ] 是否在处理下一批文件之前确保当前批次的索引已更新？
- [ ] 是否只更新了允许更新的3个字段（文档路径、文档大小、状态）？
- [ ] 是否基于实际生成结果更新了状态？

## ✅ 质量检查清单

执行完成后，验证以下项目：

**索引文件完整性**：
- [ ] `.file-list.md` 存在且格式正确
- [ ] 所有记录状态为"已生成"
- [ ] 记录数与实际文件数一致
- [ ] 无重复或缺失的记录

**文档质量**：
- [ ] 所有文档文件已创建
- [ ] 文档大小合理（> 0 KB）
- [ ] 文档格式符合模板要求
- [ ] 包含必要的信息（类名、方法、依赖）

**目录结构**：
- [ ] 文档目录结构与源码目录一致
- [ ] 文件路径正确（相对路径）
- [ ] 无孤立或错位的文档文件

## 🔗 相关资源

- [doc-extract-proj-bottom-up](../doc-extract-proj-bottom-up/SKILL.md) - 完整项目知识库提取
- [技术栈索引](../../global/knowledge/stack/index.md)
- [Spring Boot 3](../../global/knowledge/stack/springboot3.md)
- [文档生成原则](../../../.codebuddy/spec/global/standards/common/document-generation-rules.md)

## 📝 版本历史

- **v1.0** (2025-12-11): 初始版本
  - 支持模块级文档生成
  - 按3个一批处理和进度跟踪
  - 断点续传机制
  - 多类型模板支持

---

**作者**: johnsonyang
