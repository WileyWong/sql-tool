# 进度清单

## 参数确认

```
参数确认:
- [ ] SOURCE_DIR 已明确（源代码模块目录）
- [ ] DOC_DIR 已确定（默认为 kb/{模块名}）
- [ ] 参数信息已展示给用户
```

---

## 阶段1：建立索引（必须）

```
建立索引:
- [ ] 使用 search_file 工具扫描模块目录
- [ ] 精确统计 Java 文件数量（不使用预估）
- [ ] 生成文件清单和统计信息
- [ ] 检查索引文件是否存在
  - [ ] 不存在 → 创建新索引文件
  - [ ] 存在 → 检测断点续传
- [ ] 索引文件路径: DOC_DIR/.file-list.md
```

---

## 阶段2：按3个一批生成（核心）

### ⚠️ 强制执行规则

```
强制规则:
- [ ] 🔴 规则1：必须按索引顺序处理文件
  - [ ] 从索引文件中读取待处理文件列表
  - [ ] 按文件序号顺序处理
  - [ ] 不得跳过或重新排序

- [ ] 🔴 规则2：必须按模板生成文档
  - [ ] 根据识别的类型读取对应模板
  - [ ] 模板路径: templates/{type}.md
  - [ ] 生成的文档必须包含模板中的所有章节
  - [ ] ❌ 禁止省略、简化或合并模板中的任何章节
  - [ ] ❌ 禁止凭记忆生成，必须实际读取模板
  - [ ] 章节顺序必须与模板一致

- [ ] 🔴 规则3：每批3个文件完成后立即更新索引
  - [ ] 生成文档后【立即】更新索引文件
  - [ ] 必须在处理下一批文件【之前】完成更新
  - [ ] 将该批次文件状态从 ⏳ 更新为 ✅ 或 ❌
  - [ ] ❌ 禁止等到超过3个文件后才更新
  - [ ] ❌ 禁止批量更新超过3个文件的状态

- [ ] 🔴 规则4：索引条目绝对不可变
  - [ ] ❌ 禁止新增任何文件条目
  - [ ] ❌ 禁止删除任何文件条目
  - [ ] ❌ 禁止修改文件路径
  - [ ] ❌ 禁止修改文件序号
  - [ ] ✅ 仅允许更新：状态、生成文档路径、方法数

- [ ] 🔴 规则5：必须基于实际生成结果更新索引
  - [ ] ✅ 文档实际生成成功 → 状态更新为 ✅
  - [ ] ❌ 文档生成失败 → 状态更新为 ❌
  - [ ] ❌ 禁止在文档未生成时将状态标记为 ✅
  - [ ] ❌ 禁止预先批量更新状态
```

### 单文件处理流程

```
单文件处理流程:
- [ ] 读取源码文件
  - [ ] 完整读取文件内容（不截断）
  - [ ] 确认文件读取完整

- [ ] 类型识别
  - [ ] 根据类定义识别类型（注解 > 继承/关键字 > 命名）
  - [ ] ❌ 禁止根据目录名识别
  - [ ] 确定文档输出路径: DOC_DIR/{type}/{className}.md

- [ ] 读取模板（⚠️ 必须执行）
  - [ ] 根据识别的类型，读取对应模板文件
  - [ ] 模板路径: templates/{type}.md
  - [ ] 确认模板包含的所有章节
  - [ ] ❌ 禁止跳过此步骤
  - [ ] ❌ 禁止凭记忆生成

- [ ] 分析代码
  - [ ] 提取类信息（包名、类名、职责）
  - [ ] 统计代码行数（SLOC）
  - [ ] 提取所有方法（含完整签名）
  - [ ] 识别依赖关系
  - [ ] 提取关键注解

- [ ] 生成文档
  - [ ] 严格按照模板结构生成
  - [ ] 必须包含模板中的所有章节
  - [ ] 章节顺序与模板一致
  - [ ] 为每个方法生成完整签名
  - [ ] 填充所有统计信息

- [ ] 保存文档
  - [ ] 创建必要的目录
  - [ ] 将文档写入文件系统
  - [ ] 确认文档已成功保存

- [ ] 立即更新索引（⚠️ 必须在处理下一批文件之前完成）
  - [ ] 确认文档已成功写入文件系统
  - [ ] 立即更新该批次文件在索引中的状态
  - [ ] 状态: ⏳ → ✅（成功）或 ❌（失败）
  - [ ] 填写实际生成的文档路径
  - [ ] 填写实际提取的方法数量
  - [ ] ❌ 禁止增减任何条目
  - [ ] ❌ 禁止修改文件路径、序号
  - [ ] ⚠️ 完成更新后才能处理下一批文件
```

### 断点续传检查

```
断点续传:
- [ ] 读取索引文件
- [ ] 检查是否有未完成的任务（⏳ 状态）
- [ ] 进度同步检查（防止会话中断导致不一致）
  - [ ] 对于状态为 ⏳ 的文件
  - [ ] 检查对应文档是否已存在
  - [ ] 若已存在 → 更新状态为 ✅
  - [ ] 若不存在 → 保持原状态，从此文件继续
- [ ] 若存在断点
  - [ ] 自动从断点继续执行
  - [ ] 从第一个 ⏳ 状态的文件开始处理
```

---

## 阶段3：生成目录索引与完成总结

> **执行顺序：先询问 README.md → 生成 README.md（如选择）→ 输出完成总结**

### 步骤3.1：询问是否生成 README.md（必须询问）

> **🚨 这是必须执行的步骤！🚨**
> - 虽然生成 README.md 是可选的，但**询问用户**是必须的
> - 所有文档生成完成后，必须立即询问用户
> - 不能跳过这个询问步骤

```
询问用户:
- [ ] 所有文件文档已生成完成
- [ ] 🔴 必须询问用户是否生成 README.md
  - [ ] 选项1：生成 README.md（如已存在则更新）
  - [ ] 选项2：跳过
- [ ] ❌ 禁止跳过询问直接输出完成总结
- [ ] 🔴 输出询问后必须停止并等待用户回复
  - [ ] ❌ 禁止在输出询问后继续执行任何操作
  - [ ] ❌ 禁止自动选择默认选项
  - [ ] ✅ 只有用户明确回复后才能继续
```

### 步骤3.2：根据用户选择执行（等待用户回复后）

```
用户选择"生成/更新"时执行:
- [ ] 扫描文档目录
  - [ ] 列出 DOC_DIR 下所有 .md 文件
  - [ ] 排除 .file-list.md 和 README.md
  - [ ] 按类型分组统计

- [ ] 读取模板
  - [ ] 读取 templates/directory-index.md
  - [ ] ❌ 禁止凭记忆生成

- [ ] 生成 README.md
  - [ ] 填充模块信息（模块名、路径、文件数、生成时间）
  - [ ] 生成目录结构树
  - [ ] 按类型分类统计表
  - [ ] 生成详细清单（每个文档的链接）
  - [ ] 添加使用指南（新人入门/日常开发/问题排查）
  - [ ] 添加相关文档链接

- [ ] 保存文件
  - [ ] 保存到 DOC_DIR/README.md
  - [ ] 确认文件已成功保存

用户选择"跳过"时:
- [ ] 记录跳过状态
- [ ] 继续执行步骤3.3
```

### 步骤3.3：输出完成总结（最后执行）

```
完成总结（无论是否生成 README.md 都必须执行）:
- [ ] 统计生成结果
  - [ ] 成功生成的文档数量
  - [ ] 失败的文件数量
  - [ ] 按类型分组统计
  - [ ] README.md 状态（已生成/已跳过）

- [ ] 更新索引文件
  - [ ] 确认所有文件状态已更新
  - [ ] 更新总体进度信息
  - [ ] 记录完成时间

- [ ] 输出摘要报告
  - [ ] 展示文档目录结构
  - [ ] 列出生成的文档列表
  - [ ] 指出索引文件位置
  - [ ] 指出 README.md 位置（如已生成）
  - [ ] 提供查看建议
```

---

## 模板使用检查（⚠️ 关键）

```
模板使用检查:
- [ ] 生成前是否实际读取了模板文件
  - [ ] ❌ 禁止凭记忆生成
  - [ ] ✅ 必须读取 templates/{type}.md

- [ ] 生成的文档是否包含模板中的所有章节
  - [ ] 头部信息（路径、类型、职责、代码行数）
  - [ ] 📊 统计信息
  - [ ] 📋 方法/接口列表（含完整签名）
  - [ ] 🔗 依赖组件（我依赖谁）
  - [ ] 🔙 被依赖方（谁依赖我）
  - [ ] 🏷️ 关键注解

- [ ] 章节顺序是否与模板一致
- [ ] 章节格式是否与模板一致
- [ ] 是否有省略或简化模板内容
```

---

## 方法签名完整性检查（⚠️ 关键）

```
方法签名检查:
- [ ] 方法注解已记录（@GetMapping, @Transactional, @Async 等）
- [ ] 访问修饰符已记录（public/protected/private）
- [ ] 返回类型完整（含泛型，如 List<UserVO>）
- [ ] 方法名正确
- [ ] 参数列表完整
- [ ] 异常声明已记录（throws 子句）

参数信息检查:
- [ ] 参数注解已记录（@PathVariable, @RequestParam, @RequestBody 等）
- [ ] 注解属性已记录（value, required, defaultValue）
- [ ] 参数类型完整（含泛型）
- [ ] 参数名称正确
- [ ] 参数说明表格完整

Controller 方法特殊检查:
- [ ] HTTP 方法已记录（GET/POST/PUT/DELETE）
- [ ] 请求路径已记录
- [ ] 权限注解已记录（@PreAuthorize 等）
- [ ] 验证注解已记录（@Valid 等）

Service 方法特殊检查:
- [ ] 事务注解已记录（@Transactional）
- [ ] 缓存注解已记录（@Cacheable, @CacheEvict 等）
- [ ] 业务异常已列出

Mapper 方法特殊检查:
- [ ] SQL 注解已记录（@Select, @Insert 等）
- [ ] @Param 注解已记录
- [ ] SQL 语句已记录（如适用）
```

---

## 质量检查

```
质量检查:
- [ ] 每个类生成独立文件
- [ ] 文件路径正确（按类型组织: DOC_DIR/{type}/{className}.md）
- [ ] 类型识别正确（基于注解/继承/作用，完全忽略目录名）
- [ ] 使用正确模板（必须实际读取模板文件）
- [ ] 生成的文档包含模板中的所有章节
- [ ] 章节顺序与模板一致
- [ ] 统计表格完整
- [ ] 方法无遗漏（必须列出全部方法）
- [ ] 方法签名完整（见"方法签名完整性检查"）
- [ ] 代码行数已记录（SLOC）
- [ ] 依赖组件已记录
- [ ] 被依赖方已记录（通过分析引用关系）
- [ ] 索引文件完整准确
- [ ] README.md 生成正确（如用户选择生成）
  - [ ] 包含目录导航
  - [ ] 包含架构概览
  - [ ] 包含详细清单
  - [ ] 包含使用指南
  - [ ] 文档链接有效
```

---

## 索引文件检查

```
索引文件检查:
- [ ] 文件路径: DOC_DIR/.file-list.md
- [ ] 包含完整文件清单
  - [ ] 每个 Java 文件都有对应条目
  - [ ] 每个条目包含: 序号、文件路径、类型、状态、方法数

- [ ] 统计信息准确
  - [ ] 文件总数正确
  - [ ] 按类型分组统计正确
  - [ ] 处理进度准确

- [ ] 状态信息实时更新
  - [ ] 每批3个文件完成后立即更新
  - [ ] 状态标记准确（⏳/✅/❌）
  - [ ] 生成文档路径已填写
  - [ ] 方法数量已填写
```

---

## 常见错误自查

```
常见错误:
- [ ] 按目录名而非注解识别类型
- [ ] 文件读取不完整
- [ ] 遗漏部分文件
- [ ] 多类合并到一个文档
- [ ] 缺少被依赖方章节
- [ ] 缺少代码行数
- [ ] 遗漏 Interface/Abstract/Exception/Enum/Constants
- [ ] 方法签名不完整（缺少参数注解、异常声明）
- [ ] 参数说明表格不完整
- [ ] 缺少方法注解
- [ ] 凭记忆生成而非读取模板
- [ ] 省略或简化模板章节
- [ ] 批量更新状态而非逐个更新
- [ ] 文档未生成就标记为 ✅
- [ ] 修改索引条目而非仅更新状态
```

---

## 类型识别检查

```
类型识别检查:
- [ ] Interface 类已识别（interface 关键字，非 @interface）
- [ ] Abstract 类已识别（abstract class 关键字）
- [ ] Controller 类已识别（@RestController/@Controller）
- [ ] Service 类已识别（@Service 或 *ServiceImpl）
- [ ] Mapper 类已识别（@Mapper 或 extends BaseMapper）
- [ ] Entity 类已识别（@Entity/@TableName）
- [ ] DTO 类已识别（*DTO.java）
- [ ] VO/Response 类已识别（*VO.java/*Response.java）
- [ ] Request 类已识别（*Request.java）
- [ ] Enum 类已识别（enum 关键字）
- [ ] Exception 类已识别（extends Exception/RuntimeException）
- [ ] Constants 类已识别（*Constants.java）
- [ ] Feign 类已识别（@FeignClient）
- [ ] Handler 类已识别（*Handler.java）
- [ ] Job/Task 类已识别（@Scheduled/@XxlJob）
- [ ] MQ Listener 类已识别（@RabbitListener/@KafkaListener）
- [ ] Annotation 类已识别（@interface 定义）
- [ ] Utils 类已识别（*Util.java/*Utils.java）
- [ ] Config 类已识别（@Configuration）
```

---

## 必含章节检查

```
每个类文档必须包含以下章节:
- [ ] 头部信息（路径、类型、职责、代码行数 SLOC）
- [ ] 📊 统计信息
- [ ] 📋 方法/接口列表
- [ ] 🔗 依赖组件（我依赖谁）
- [ ] 🔙 被依赖方（谁依赖我）
- [ ] 🏷️ 关键注解
```

---

## 索引更新约束检查 ⭐⭐⭐

```
索引更新约束检查:

📌 更新时机检查:
- [ ] 每生成3个文档后是否【立即】更新了对应条目
- [ ] 是否在处理下一批文件【之前】完成了更新
- [ ] ❌ 是否存在批量更新超过3个的情况
- [ ] ❌ 是否存在跳过更新直接处理下一批文件的情况

📌 更新内容检查:
- [ ] 状态是否基于实际生成结果更新
- [ ] 生成文档路径是否为实际生成的路径
- [ ] 方法数是否为实际提取的数量
- [ ] ❌ 是否存在填写预估值或虚假值的情况

✅ 允许的操作:
- [ ] 更新文件状态: ⏳ → ✅ 或 ❌
- [ ] 填写生成文档路径（实际路径）
- [ ] 填写方法数量（实际数量）

❌ 禁止的操作（条目不可变）:
- [ ] 不得新增文件条目
- [ ] 不得删除文件条目
- [ ] 不得修改文件路径
- [ ] 不得修改文件序号
- [ ] 不得重新排序条目
- [ ] 不得在文档未生成时标记为 ✅

📌 正确的更新流程（阶段2）:
1. [ ] 读取3个源码文件
2. [ ] 读取对应类型的模板
3. [ ] 生成3个文档并写入文件系统
4. [ ] 确认3个文档已成功写入
5. [ ] 立即更新索引文件中该批次条目的状态
6. [ ] 自动继续处理下一批3个文件（无需询问）

📌 正确的更新流程（阶段3 - README.md生成）:
1. [ ] 扫描文档目录下所有 .md 文件
2. [ ] 排除 .file-list.md 和 README.md
3. [ ] 读取 templates/directory-index.md 模板
4. [ ] 按模板格式生成 README.md
5. [ ] 保存到 DOC_DIR/README.md

❌ 错误的更新流程（禁止）:
- [ ] 先批量更新状态，再生成文档
- [ ] 生成超过3个文档后，才更新状态
- [ ] 文档未生成就更新状态为 ✅
- [ ] 修改条目内容而非仅更新状态
```
