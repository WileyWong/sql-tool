# db-mysql-run 执行检查清单

## AI 自动执行检查

### ⚠️ 关键检查项（AI 必须执行）

1. **MCP 连接检查**（最高优先级）
   - [ ] 已调用 `mcp_get_tool_description` 检查连接
   - [ ] 如未配置，已显示安装指南并停止执行
   - [ ] 如已配置，继续后续步骤

2. **SQL 解析和预览**
   - [ ] 已读取/接收 SQL 内容
   - [ ] 已解析为独立语句（按 `;` 分割）
   - [ ] 已显示操作摘要（CREATE/ALTER/DROP 等）
   - [ ] 已提取表名和影响范围

3. **安全检查**
   - [ ] 已检测 DROP DATABASE（拒绝）
   - [ ] 已检测 DELETE 无 WHERE（拒绝）
   - [ ] 已检测 DROP TABLE（警告）
   - [ ] 已检测 TRUNCATE（警告）
   - [ ] 已标注风险等级

4. **用户确认**
   - [ ] 已显示预览和风险评估
   - [ ] 已等待用户明确确认（yes/no）

5. **执行和监控**
   - [ ] 逐条执行 SQL
   - [ ] 实时显示进度 [N/总数]
   - [ ] 记录每条结果（成功/失败）
   - [ ] 失败时提供选项（skip/stop/rollback）

6. **报告生成**
   - [ ] 已生成执行报告（统计+详情）
   - [ ] 已生成回滚脚本（逆序 DROP）
   - [ ] 已保存执行日志到文件
   - [ ] 已提供验证建议

## 用户检查项

### 执行前（可选）

- [ ] 确认目标数据库正确
- [ ] 重要表已备份
- [ ] 了解当前数据库状态
- [ ] 脚本已在测试环境验证

### 执行后（建议）

- [ ] 验证表结构（DESC table）
- [ ] 验证数据完整性
- [ ] 保存执行日志到版本控制
- [ ] 保存回滚脚本备用

## 风险等级判断

| 操作 | 风险 | 要求 |
|------|------|------|
| CREATE TABLE/INDEX | 低 | 预览 |
| ALTER TABLE | 中 | 警告 |
| DROP TABLE | 高 | 警告+确认 |
| DELETE 有 WHERE | 中 | 警告 |
| DELETE 无 WHERE | 极高 | 拒绝 |
| DROP DATABASE | 极高 | 拒绝 |
| TRUNCATE | 高 | 警告+确认 |

## 常见问题处理

### 表已存在
- AI 询问: skip / replace
- 建议: 使用 `IF NOT EXISTS`

### 外键约束失败
- AI 提示: 先创建父表
- 建议: 调整 SQL 顺序

### 权限不足
- AI 提示: 联系 DBA
- 建议: 检查用户权限

### 大脚本 (> 100 条)
- AI 询问: 是否分批执行
- 建议: 每批 50 条

## 最佳实践

✅ **DO**
- 使用 `IF NOT EXISTS` 避免重复
- 添加详细 COMMENT 注释
- 保存日志和回滚脚本
- 验证执行结果

❌ **DON'T**
- 直接执行未测试脚本
- 忽略安全警告
- 删除执行日志
- 修改系统表
