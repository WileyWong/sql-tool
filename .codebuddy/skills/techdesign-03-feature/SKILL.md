---
name: techdesign-03-feature
description: 基于需求文档，设计功能的详细用例、输入输出、边界条件和错误处理
category: techdesign
keywords: [功能设计, 用例设计, 边界条件, 错误处理, 功能分解]
---

# Skill: 功能详细设计

## 工作流位置

```
techdesign-01 架构设计
    ↓ 输出：架构方案、技术选型
techdesign-02 流程设计（可选）
    ↓ 输出：流程图、状态机
techdesign-03 功能设计 ← 当前技能
    ↓ 输出：功能规格、用例设计、边界条件、错误处理
techdesign-04 实体设计
    ↓ 输出：实体模型、领域模型
techdesign-05 数据库设计 ─┬─ 可并行
techdesign-06 API设计    ─┘
    ↓ 输出：DDL、API文档
techdesign-07 交付规划（可选）
```

**上游输入**: 01-architecture 架构方案、02-process 流程设计（可选）
**下游使用**: 04-entity、06-api 将使用本技能输出的功能规格

## 路径选择指南

> 本技能是以下路径的**入口点**：新功能开发、快速原型

### 以 03-feature 为入口的路径

| 场景 | 推荐路径 | 说明 |
|------|---------|------|
| ➕ **新功能开发** | 03→04→05+06 | 在现有系统上添加新功能，复用现有架构 |
| ⚡ **快速原型** | 03→06 | 最小路径，快速验证想法 |

### 路径决策

```
从 03-feature 开始
 │
 ├─ 是快速原型/MVP验证吗？
 │   ├─ 是 → 03→06（最小路径）
 │   └─ 否 → 继续
 │
 └─ 需要持久化数据吗？
     ├─ 是 → 03→04→05+06（完整功能路径）
     └─ 否 → 03→06
```

### 何时从 03 开始（而非 01）

- ✅ 现有系统已有成熟架构
- ✅ 添加独立功能模块
- ✅ 快速原型验证
- ✅ 小型功能迭代

### 何时应从 01 开始

- ❌ 新系统开发
- ❌ 架构重构
- ❌ 技术选型变更
- ❌ 跨模块大型功能

**完整路径选择**: 参见 [techdesign-01-architecture 路径选择指南](mdc:skills/techdesign-01-architecture/SKILL.md)

将需求转化为可执行的功能规格，包括用例设计、输入输出定义、边界条件处理和错误处理设计。

## 核心原则（15 秒速查）

1. **原子性聚焦** - 只关注功能逻辑设计，不涉及技术架构、数据库、API
2. **用例全覆盖** - 正常/异常/边界用例全面设计（≥ 3 个异常、≥ 3 个边界）
3. **输入输出明确** - 字段完整、类型明确、验证规则清晰、示例具体
4. **边界条件完整** - 数据/并发/性能/状态边界全面处理
5. **错误处理友好** - 用户可理解、清晰明确、不暴露敏感信息
6. **可测试性设计** - 每个功能都有明确的测试契约

## 🎯 目标

解决软件研发中 **如何将需求转化为可执行的功能规格** 的问题。

**职责边界**:
- ✅ 功能分解和优先级
- ✅ 详细用例设计（正常/异常/边界）
- ✅ 输入输出定义（字段、类型、验证）
- ✅ 边界条件处理（数据/并发/性能/状态）
- ✅ 错误处理设计（错误码、重试、降级）
- ✅ 功能间交互设计（依赖关系、数据传递）

**不涉及**:
- ❌ 技术架构设计（由 `techdesign-01-architecture` 负责）
- ❌ 业务流程设计（由 `techdesign-02-process` 负责）
- ❌ 数据库表设计（由 `techdesign-05-database` 负责）
- ❌ API 接口设计（由 `techdesign-06-api` 负责）

## 📋 前置条件

### 📂 必需文件检查

- [ ] 需求文档存在且完整
    - **路径**: `workspace/{变更ID}/requirements/requirements.md`
    - **检查**: 功能需求明确、用户故事清晰、验收标准完整

### 📄 可选依赖文件

- [ ] 架构设计文档（如存在）
    - **路径**: `workspace/{变更ID}/design/architecture-design.md`
    - **作用**: 了解技术架构和约束

- [ ] 业务流程设计（如存在）
    - **路径**: `workspace/{变更ID}/design/process-design.md`
    - **作用**: 了解业务流程和规则

- [ ] 需求澄清文档（如存在）
    - **路径**: `workspace/{变更ID}/requirements/clarifications.md`
    - **作用**: 了解需求的澄清结果

### 📄 现有设计文档（可选）

- [ ] 功能设计文档（可选）
    - **路径**: `workspace/{变更ID}/design/feature-design.md`
    - **作用**: 如果已存在，则在现有基础上完善
    - **处理**: 原地修改，不创建新版本

## 🔄 执行步骤

### 步骤 1: 功能识别和分解

**目标**: 将需求转化为结构化的功能清单，明确功能边界和优先级

**操作**:
1. 阅读需求文档，提取功能需求
2. 识别主要功能模块（按业务领域划分）
3. 分解每个功能点为原子性子功能
4. 按优先级排序（P0 必须、P1 重要、P2 可选、P3 增强）

**验收标准**:
- [ ] 主要功能模块已识别（≥ 3 个）
- [ ] 每个功能已分解为子功能（≥ 2 个）
- [ ] 功能优先级已明确（P0/P1/P2/P3）
- [ ] 功能边界清晰，无重叠或遗漏

### 步骤 2: 用例设计

**目标**: 为每个功能设计详细的用例，包括正常用例、异常用例和边界用例

**正常用例**（Happy Path）:
- 主流程设计：描述"一切顺利"的场景
- 包含：用例 ID、名称、参与者、前置条件、主流程、后置条件

**异常用例**（Alternate Flows）:
- 识别所有可能的异常情况（≥ 3 个）
- 包含：触发条件、处理流程、结果
- 示例：用户名不存在、密码错误、账户被冻结、网络超时

**边界用例**（Edge Cases）:
- 识别极端情况和边界条件（≥ 3 个）
- 示例：用户名为空、密码为空、用户名长度超限、密码长度不足

**验收标准**:
- [ ] 每个功能都有正常用例（≥ 1 个）
- [ ] 每个功能都有异常用例（≥ 3 个）
- [ ] 每个功能都有边界用例（≥ 3 个）
- [ ] 用例描述清晰、完整

### 步骤 3: 定义输入输出

**目标**: 为每个功能明确定义输入、输出和数据格式

**输入定义**:
- 字段名、类型、长度、格式、必填性、默认值、示例
- 验证规则（非空检查、长度检查、格式检查）

**成功输出**:
- 字段名、类型、格式、说明、示例

**失败输出**:
- 错误码、错误信息、错误详情
- 错误码定义（4xxx 客户端错误、5xxx 服务器错误）

**数据格式规范**:
- 日期时间（ISO 8601、UTC 时区）
- 布尔值（true/false）
- 数字（整数、小数保留 2 位）
- 字符串（UTF-8、HTML 转义）

**验收标准**:
- [ ] 每个功能的输入已定义（字段、类型、验证规则）
- [ ] 每个功能的成功输出已定义
- [ ] 每个功能的失败输出已定义（错误码、错误信息）
- [ ] 数据格式已统一

### 步骤 4: 边界条件处理

**目标**: 识别并处理功能的边界条件和极限情况

**数据边界**:
- 字符串长度（最小长度、最大长度、空字符串、超长字符串、特殊字符）
- 数值边界（最小值、最大值、负数、小数位数、溢出）
- 日期时间（最早日期、最晚日期、历史日期、未来日期、时区）
- 集合边界（空集合、单元素、最大元素、重复元素）

**并发边界**:
- 重复提交（幂等性、分布式锁）
- 库存扣减（防止超卖、乐观锁/悲观锁）
- 同时登录（多设备登录、单设备登录）
- 数据竞态（防止数据不一致、乐观锁/悲观锁）

**性能边界**:
- 响应时间（正常响应 < 200ms、慢查询 200-1000ms、超时 > 5000ms）
- 并发量（正常并发、峰值并发、超限处理）
- 数据量（单次查询、批量操作、超限处理）

**状态边界**:
- 状态转移边界（终态、时间边界）

**验收标准**:
- [ ] 数据边界已定义
- [ ] 并发边界已处理
- [ ] 性能边界已定义
- [ ] 状态边界已定义

### 步骤 5: 错误处理设计

**目标**: 为功能设计全面的错误处理机制

**错误分类**:
- 客户端错误（4xxx）：请求错误、认证错误、授权错误、资源不存在
- 服务器错误（5xxx）：内部错误、网关错误、服务不可用

**错误信息设计**:
- 用户友好（使用用户可理解的语言）
- 清晰明确（说明错误原因和解决方案）
- 安全性（不暴露敏感信息）
- 一致性（同类错误使用统一的格式）

**重试机制**:
- 自动重试（网络超时、临时故障，指数退避，最多 3 次）
- 手动重试（用户操作失败，提供"重试"按钮）
- 不重试（业务错误，直接返回错误）

**降级方案**:
- 功能降级、服务降级、数据降级、限流降级

**验收标准**:
- [ ] 错误码已定义（≥ 20 个）
- [ ] 错误信息已设计（用户友好、清晰明确、安全）
- [ ] 重试机制已设计
- [ ] 降级方案已设计（≥ 3 个场景）

### 步骤 6: 功能间交互设计

**目标**: 设计功能之间的交互和依赖关系

**功能依赖**:
- 识别每个功能依赖的其他功能
- 定义依赖关系和调用时序

**交互流程**:
- 定义功能间的调用顺序和数据传递
- 包含：步骤、输入、输出、异常处理

**数据传递**:
- 同步调用（HTTP/gRPC）
- 异步调用（消息队列 Kafka/RabbitMQ）
- 事件驱动（事件总线 EventBus）

**数据一致性**:
- 强一致性（事务、分布式事务）
- 最终一致性（消息队列、补偿机制）
- 弱一致性（异步、重试）

**验收标准**:
- [ ] 功能依赖已识别
- [ ] 交互流程已设计
- [ ] 数据传递方式已明确
- [ ] 数据一致性要求已定义

### 步骤 7: 输出功能设计文档

**目标**: 将功能设计内容输出到设计文档

**输出路径**: `workspace/{变更ID}/design/feature-design.md`

**文档结构**:
- YAML Frontmatter（change_id、stage、document_type、created_at、updated_at、version）
- 功能分解
- 用例设计
- 输入输出定义
- 边界条件处理
- 错误处理设计
- 功能间交互设计

**验收标准**:
- [ ] 功能设计已输出到正确路径
- [ ] YAML Frontmatter 完整
- [ ] 包含所有必需章节
- [ ] 如果是更新现有文档，已原地修改而不是创建新文件

---

## ✅ 最佳实践

1. **功能分解要合理** - 粒度适中（1-3 天可完成）、职责单一、可测试、独立性强
2. **用例要全面** - 正常用例覆盖主流程、异常用例 ≥ 3 个、边界用例 ≥ 3 个
3. **输入输出要明确** - 字段完整、类型明确、验证规则清晰、示例具体

## ❌ 常见错误

1. **功能边界不清** - 包含了技术实现细节（API path、数据库表）
2. **用例不完整** - 只考虑正常用例，忽略异常和边界用例
3. **错误处理不友好** - 错误信息过于技术化，用户无法理解

## 🔍 验证清单

详细的质量检查清单请查看 `checklist.md`。

核心验证项:
- [ ] 功能分解验证（≥ 3 个模块，≥ 2 个子功能，优先级明确）
- [ ] 用例设计验证（≥ 1 个正常用例，≥ 3 个异常用例，≥ 3 个边界用例）
- [ ] 输入输出验证（字段完整、类型明确、格式统一）
- [ ] 边界条件验证（数据/并发/性能/状态边界全面）
- [ ] 错误处理验证（≥ 20 个错误码，重试机制，≥ 3 个降级方案）

### 🚨 红灯信号

遇到以下情况，立即停止并重新设计：

- ❌ **功能边界模糊** - 包含技术实现细节（API path、数据库表、具体框架）
- ❌ **用例覆盖不全** - 只有正常用例，缺少异常用例（< 3 个）或边界用例（< 3 个）
- ❌ **输入输出不明确** - 字段缺少类型、验证规则或示例
- ❌ **错误处理不友好** - 错误信息过于技术化（如"NullPointerException"）
- ❌ **功能粒度不当** - 单个功能过大（> 5 天）或过小（< 2 小时）
- ❌ **依赖关系混乱** - 功能间存在循环依赖或依赖关系不明确
- ❌ **边界条件遗漏** - 未考虑并发、性能、状态边界
- ❌ **降级方案缺失** - 关键功能无降级策略

## 📚 可重用资源

详细的参考文档和示例请查看:
- `checklist.md` - 完整的质量检查清单（7 大类验证项）
- `examples.md` - 完整的功能设计示例（3 个典型场景）
- `reference.md` - 功能设计参考资料和最佳实践

## 🔗 相关技能

- `techdesign-01-architecture` - 系统架构设计
- `techdesign-02-process` - 业务流程设计
- `techdesign-05-database` - 数据库设计
- `techdesign-06-api` - API 接口设计

---

## 📖 高级方法论

### 用户故事映射 (User Story Mapping)

将功能需求组织为用户旅程视图，帮助理解全局和优先级。

**故事映射结构**:
```
用户活动 (Activities)
    │
    ├── 用户任务 (Tasks) ─── 按时间顺序排列 ───→
    │       │
    │       ├── 用户故事 (Stories) ─── 按优先级垂直排列
    │       │       │                        │
    │       │       ├── MVP (必须有)          ↓
    │       │       ├── 增强 (应该有)      优先级
    │       │       └── 可选 (可以有)        降低
```

**示例：电商购物流程**:
```markdown
## 用户故事映射：购物流程

### 活动：在线购物

| 浏览商品 | 加入购物车 | 下单结算 | 支付 | 收货 |
|---------|-----------|---------|------|------|
| **MVP** |
| 商品列表 | 添加商品 | 确认订单 | 在线支付 | 查看物流 |
| 商品详情 | 修改数量 | 选择地址 | 支付回调 | 确认收货 |
| **增强** |
| 商品搜索 | 购物车列表 | 使用优惠券 | 多种支付 | 评价商品 |
| 商品筛选 | 删除商品 | 发票信息 | 分期付款 | 申请退货 |
| **可选** |
| 商品推荐 | 收藏商品 | 礼品包装 | 积分抵扣 | 晒单分享 |
```

**使用场景**:
- 新项目启动，需要规划功能范围
- 需要与产品/业务对齐功能优先级
- 迭代规划，确定 MVP 范围

---

### 功能点分析 (FPA)

使用功能点分析法进行工作量估算，比"人天"更客观。

**功能点类型**:
| 类型 | 说明 | 复杂度权重 |
|------|------|-----------|
| EI (外部输入) | 数据输入（创建、更新、删除） | 简单3/中等4/复杂6 |
| EO (外部输出) | 数据输出（报表、导出） | 简单4/中等5/复杂7 |
| EQ (外部查询) | 数据查询（列表、详情） | 简单3/中等4/复杂6 |
| ILF (内部逻辑文件) | 内部数据存储（表/实体） | 简单7/中等10/复杂15 |
| EIF (外部接口文件) | 外部数据引用（第三方API） | 简单5/中等7/复杂10 |

**复杂度判断**:
| 复杂度 | 数据元素 | 文件引用 |
|--------|---------|---------|
| 简单 | 1-5 | 0-1 |
| 中等 | 6-15 | 2 |
| 复杂 | >15 | ≥3 |

**功能点估算示例**:
```markdown
## 用户管理模块功能点

| 功能 | 类型 | 复杂度 | 功能点 |
|------|------|--------|--------|
| 用户注册 | EI | 中等 | 4 |
| 用户登录 | EI | 简单 | 3 |
| 用户列表 | EQ | 中等 | 4 |
| 用户详情 | EQ | 简单 | 3 |
| 用户更新 | EI | 中等 | 4 |
| 用户删除 | EI | 简单 | 3 |
| 用户表 | ILF | 中等 | 10 |
| **合计** | | | **31 FP** |

### 工作量转换
- 团队生产率: 10 FP/人天（根据历史数据）
- 预估工作量: 31 / 10 = 3.1 人天
- 加缓冲(20%): 3.7 人天
```

---

### TDD 测试契约

为每个功能定义测试契约，确保可测试性。

**测试契约模板**:
```markdown
## 功能: {功能名称}

### 测试契约

#### TC-001: {测试场景名称}
**类型**: 正常用例 | 异常用例 | 边界用例
**优先级**: P0 | P1 | P2

**Given** (前置条件):
- 条件1: ...
- 条件2: ...

**When** (操作):
- 操作描述

**Then** (预期结果):
- 结果1: ...
- 结果2: ...

**验证点**:
- [ ] 验证点1
- [ ] 验证点2
```

**测试契约示例**:
```markdown
## 功能: 用户登录

### 测试契约

#### TC-001: 正常登录
**类型**: 正常用例
**优先级**: P0

**Given**:
- 用户已注册，用户名: test_user
- 密码: Test@123456
- 账户状态: 正常

**When**:
- 调用登录功能，传入用户名和密码

**Then**:
- 返回成功状态码 200
- 返回有效的访问令牌（JWT）
- 令牌有效期 2 小时
- 用户最后登录时间更新

**验证点**:
- [ ] 令牌格式正确（JWT 三段式）
- [ ] 令牌包含用户ID和角色
- [ ] 令牌可解析且未过期

---

#### TC-002: 密码错误
**类型**: 异常用例
**优先级**: P0

**Given**:
- 用户已注册，用户名: test_user
- 正确密码: Test@123456
- 账户状态: 正常

**When**:
- 调用登录功能，传入用户名和错误密码 "wrong_password"

**Then**:
- 返回错误状态码 401
- 返回错误信息 "用户名或密码错误"
- 不返回具体是用户名还是密码错误（安全考虑）
- 登录失败次数 +1

**验证点**:
- [ ] 错误信息不泄露具体原因
- [ ] 失败次数正确记录

---

#### TC-003: 账户锁定
**类型**: 边界用例
**优先级**: P0

**Given**:
- 用户已注册，用户名: test_user
- 连续登录失败 4 次
- 账户状态: 正常

**When**:
- 第 5 次使用错误密码登录

**Then**:
- 返回错误状态码 423
- 返回错误信息 "账户已锁定，请15分钟后重试"
- 账户状态变更为 "锁定"
- 锁定时间记录

**验证点**:
- [ ] 第 5 次失败触发锁定
- [ ] 锁定时间为 15 分钟
- [ ] 锁定期间正确密码也无法登录
```

**测试契约检查清单**:
- [ ] 每个功能至少 1 个正常用例契约
- [ ] 每个功能至少 3 个异常用例契约
- [ ] 每个功能至少 3 个边界用例契约
- [ ] 每个契约包含 Given/When/Then
- [ ] 每个契约有明确的验证点
