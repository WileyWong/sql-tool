# 业务流程设计示例

## 示例1: 电商订单系统

### 场景
设计电商订单系统的业务流程，包含订单创建、支付、发货、收货全流程。

### 核心业务对象

```markdown
### 订单 (Order)
**生命周期**: 创建 → 待支付 → 已支付 → 已发货 → 已收货 → 已完成

**关键事件**:
- 创建订单 (create_order)
- 支付订单 (pay_order)
- 发货 (ship_order)
- 确认收货 (confirm_delivery)
- 取消订单 (cancel_order)
```

### 状态机设计

```markdown
## 订单状态机

### 状态定义
| 状态 | 说明 | 可执行操作 |
|------|------|----------|
| pending | 待支付 | 支付、取消 |
| paid | 已支付 | 发货、申请退款 |
| shipped | 已发货 | 确认收货 |
| delivered | 已收货 | 评价 |
| completed | 已完成 | 无 |
| canceled | 已取消 | 无 |

### 关键转移

#### pending → paid
- **触发**: 支付成功
- **前置**: 订单未过期（30分钟内）
- **动作**: 扣减库存、生成支付单、发送通知
- **后置**: 库存已扣减

#### pending → canceled
- **触发**: 用户取消 或 超时
- **前置**: 订单为pending
- **动作**: 释放库存、发送通知
- **后置**: 库存已释放
```

### 业务规则

```markdown
## 业务规则

### 计算规则
- 订单总额 = 商品小计 + 运费 - 优惠金额
- 运费: 订单金额<50元收10元，≥50元免运费

### 决策规则
- 库存扣减时机: 支付成功时（非创建订单时）
- 自动取消: 30分钟未支付 → 自动取消

### 验证规则
- 订单创建: 用户已登录、商品存在、库存充足、地址完整
- 支付验证: 状态为pending、未过期、金额正确
```

---

## 示例2: 请假审批流程

### 场景
设计员工请假审批流程，包含提交、审批、归档。

### 状态机设计

```markdown
## 请假单状态机

### 状态定义
| 状态 | 说明 | 可执行操作 |
|------|------|----------|
| draft | 草稿 | 提交、删除 |
| pending | 待审批 | 审批、撤回 |
| approved | 已通过 | 归档 |
| rejected | 已拒绝 | 修改、重新提交 |
| withdrawn | 已撤回 | 修改、重新提交 |

### 关键转移

#### draft → pending
- **触发**: 员工提交请假单
- **前置**: 请假单信息完整（日期、原因）
- **动作**: 发送审批通知
- **后置**: 状态为pending

#### pending → approved
- **触发**: 审批人通过
- **前置**: 审批人有权限
- **动作**: 更新状态、发送通知、扣减年假额度
- **后置**: 年假额度已扣减

#### pending → rejected
- **触发**: 审批人拒绝
- **前置**: 审批人有权限
- **动作**: 更新状态、发送通知、记录拒绝原因
- **后置**: 状态为rejected
```

### 业务规则

```markdown
## 业务规则

### 验证规则
- 请假天数 ≤ 剩余年假天数
- 提前3天提交（紧急情况除外）
- 同一时间段不能重复请假

### 决策规则
- 请假天数 ≤ 3天: 直接主管审批
- 请假天数 > 3天: 直接主管 + 部门经理审批
- 请假天数 > 7天: 直接主管 + 部门经理 + HR审批

### 计算规则
- 年假额度 = 入职年限 × 5天
- 已用年假 = Σ(已通过的请假天数)
- 剩余年假 = 年假额度 - 已用年假
```

---

## 示例3: 文章发布审核流程

### 场景
设计内容平台文章发布审核流程。

### 状态机设计

```markdown
## 文章状态机

### 状态定义
| 状态 | 说明 | 可执行操作 |
|------|------|----------|
| draft | 草稿 | 编辑、提交审核、删除 |
| reviewing | 审核中 | 通过、拒绝 |
| approved | 已通过 | 发布、撤回 |
| published | 已发布 | 下架、编辑 |
| rejected | 已拒绝 | 修改、重新提交 |
| offline | 已下架 | 重新发布、删除 |

### 异常处理

#### 审核超时
- **触发**: 提交审核后24小时未处理
- **处理**: 自动通过（低风险内容）或 发送提醒（高风险内容）

#### 违规内容
- **触发**: 审核发现违规内容
- **处理**: 拒绝 + 扣分 + 通知作者修改
```

---

## 关键点总结

### 状态机设计
- 状态完整（包含所有生命周期阶段）
- 转移明确（触发事件、前置条件、动作、后置条件）
- 约束清晰（禁止的转移、时间约束）

### 业务规则
- 规则量化（用具体数字）
- 规则完整（包含条件和结果）
- 规则可验证

### 异常处理
- 识别充分（≥10个异常）
- 处理明确（每个异常都有方案）
- 考虑补偿和重试
