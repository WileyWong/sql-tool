# MySQL 脚本审查检查清单

快速检查清单，用于 MySQL SQL 脚本的代码审查。

## 1. 语法规范 (20%)

### 1.1 命名规范

| 检查项 | 状态 |
|--------|------|
| 数据库名使用小写 + 下划线 | ☐ |
| 表名使用小写 + 下划线，单数形式 | ☐ |
| 字段名使用小写 + 下划线 | ☐ |
| 索引名格式：`idx_表名_字段名` | ☐ |
| 唯一索引格式：`uk_表名_字段名` | ☐ |
| 存储过程格式：`sp_功能描述` | ☐ |
| 函数格式：`fn_功能描述` | ☐ |
| 触发器格式：`tr_表名_时机_操作` | ☐ |

### 1.2 格式规范

| 检查项 | 状态 |
|--------|------|
| SQL 关键字使用大写 | ☐ |
| 复杂查询有适当缩进 | ☐ |
| 每个主要子句独占一行 | ☐ |
| 多字段使用逗号对齐 | ☐ |

### 1.3 注释规范

| 检查项 | 状态 |
|--------|------|
| 复杂逻辑有注释说明 | ☐ |
| 存储过程有功能说明 | ☐ |
| 变更脚本有版本信息 | ☐ |
| 表和字段有 COMMENT | ☐ |

## 2. 性能优化 (30%)

### 2.1 索引使用

| 检查项 | 状态 |
|--------|------|
| WHERE 条件字段有索引 | ☐ |
| JOIN 关联字段有索引 | ☐ |
| ORDER BY 字段考虑建索引 | ☐ |
| 避免在索引字段使用函数 | ☐ |
| 避免前导通配符 LIKE '%xxx' | ☐ |
| 复合索引顺序正确（遵循最左前缀） | ☐ |
| 避免隐式类型转换（字符串字段用字符串查询） | ☐ |
| 长字符串字段考虑前缀索引 | ☐ |
| 大表 DDL 使用 pt-online-schema-change | ☐ |

### 2.1.1 高级索引检查 (MySQL 8.0+)

| 检查项 | 状态 | 版本要求 |
|--------|------|---------|
| 考虑使用函数索引替代计算列 | ☐ | MySQL 8.0.13+ |
| 使用不可见索引测试索引效果 | ☐ | MySQL 8.0+ |
| 使用 EXPLAIN ANALYZE 分析实际执行 | ☐ | MySQL 8.0.18+ |
| 考虑使用降序索引 | ☐ | MySQL 8.0+ |

### 2.2 查询优化

| 检查项 | 状态 |
|--------|------|
| 避免 SELECT * | ☐ |
| 大表查询有 LIMIT | ☐ |
| 子查询考虑改用 JOIN | ☐ |
| OR 条件考虑改用 UNION | ☐ |
| IN 列表不超过 1000 个值 | ☐ |
| 避免 SELECT DISTINCT 滥用 | ☐ |

### 2.3 大数据量操作

| 检查项 | 状态 |
|--------|------|
| 大批量 UPDATE/DELETE 分批执行 | ☐ |
| 批量 INSERT 使用批量语法 | ☐ |
| 大表 DDL 考虑在线变更 | ☐ |
| 避免长事务 | ☐ |

### 2.4 并发安全

| 检查项 | 状态 |
|--------|------|
| 多表更新按固定顺序加锁（防死锁） | ☐ |
| 高并发场景考虑乐观锁 | ☐ |
| 避免 SELECT ... FOR UPDATE 范围过大 | ☐ |
| 使用合适的事务隔离级别 | ☐ |
| 避免在事务中执行耗时操作 | ☐ |

## 3. 安全防护 (25%)

### 3.1 SQL 注入防护

| 检查项 | 状态 |
|--------|------|
| 无字符串拼接 SQL | ☐ |
| 使用参数化查询 | ☐ |
| 存储过程参数已验证 | ☐ |
| 动态 SQL 使用预处理语句 | ☐ |
| 防范二次注入（存储后再查询） | ☐ |
| 防范时间盲注（限制 SLEEP/BENCHMARK） | ☐ |
| 整数参数验证边界值 | ☐ |

### 3.2 权限控制

| 检查项 | 状态 |
|--------|------|
| 遵循最小权限原则 | ☐ |
| 应用账号无 DDL 权限 | ☐ |
| 敏感表限制访问 | ☐ |
| 无 GRANT ALL 授权 | ☐ |

### 3.3 敏感数据

| 检查项 | 状态 |
|--------|------|
| 敏感数据查询已脱敏 | ☐ |
| 密码字段不明文存储 | ☐ |
| 日志不记录敏感信息 | ☐ |
| 导出数据已脱敏 | ☐ |

### 3.4 DDL 安全

| 检查项 | 状态 |
|--------|------|
| DROP/TRUNCATE 前有备份 | ☐ |
| 使用 IF EXISTS 避免报错 | ☐ |
| 变更脚本有回滚方案 | ☐ |
| 生产环境变更有审批 | ☐ |

## 4. 数据完整性 (10%)

### 4.1 约束检查

| 检查项 | 状态 |
|--------|------|
| 表有主键 | ☐ |
| 必要字段有 NOT NULL | ☐ |
| 唯一字段有唯一约束 | ☐ |
| 外键关系正确定义 | ☐ |
| 枚举字段使用 ENUM 或 CHECK | ☐ |

### 4.2 字段类型

| 检查项 | 状态 |
|--------|------|
| 主键使用 BIGINT UNSIGNED | ☐ |
| 金额使用 DECIMAL | ☐ |
| 时间使用 DATETIME | ☐ |
| 状态使用 TINYINT 或 ENUM | ☐ |
| 字符集使用 utf8mb4 | ☐ |

### 4.3 事务使用

| 检查项 | 状态 |
|--------|------|
| 关联操作使用事务 | ☐ |
| 事务粒度合适 | ☐ |
| 有异常回滚处理 | ☐ |
| 避免事务中的长时间操作 | ☐ |

## 5. 可维护性 (15%)

### 5.1 代码组织

| 检查项 | 状态 |
|--------|------|
| 存储过程功能单一 | ☐ |
| 复杂逻辑拆分子过程 | ☐ |
| 公共逻辑抽取为函数 | ☐ |
| 代码结构清晰 | ☐ |

### 5.2 变更管理

| 检查项 | 状态 |
|--------|------|
| 变更脚本有版本号 | ☐ |
| 有前置检查 | ☐ |
| 有回滚脚本 | ☐ |
| 有验证步骤 | ☐ |

### 5.3 错误处理

| 检查项 | 状态 |
|--------|------|
| 存储过程有错误处理 | ☐ |
| 使用 SIGNAL 抛出业务异常 | ☐ |
| 错误信息清晰明确 | ☐ |
| 有适当的日志记录 | ☐ |

### 5.4 MySQL 8.0+ 特性使用

| 检查项 | 状态 | 版本要求 |
|--------|------|---------|
| 考虑使用窗口函数替代子查询 | ☐ | MySQL 8.0+ |
| 考虑使用 CTE 提升可读性 | ☐ | MySQL 8.0+ |
| JSON 字段使用 JSON_TABLE 解析 | ☐ | MySQL 8.0.4+ |
| 使用 EXPLAIN ANALYZE 分析实际执行 | ☐ | MySQL 8.0.18+ |
| 考虑使用直方图优化查询 | ☐ | MySQL 8.0+ |

## 快速检查命令

```sql
-- 检查表结构
DESCRIBE table_name;
SHOW CREATE TABLE table_name;

-- 检查索引
SHOW INDEX FROM table_name;

-- 分析查询性能
EXPLAIN SELECT ...;
EXPLAIN ANALYZE SELECT ...;  -- MySQL 8.0.18+
EXPLAIN FORMAT=TREE SELECT ...;  -- MySQL 8.0.16+

-- 检查慢查询
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- 检查表大小
SELECT 
    table_name,
    table_rows,
    ROUND(data_length/1024/1024, 2) AS data_mb,
    ROUND(index_length/1024/1024, 2) AS index_mb
FROM information_schema.tables
WHERE table_schema = 'database_name';

-- 检查用户权限
SHOW GRANTS FOR 'username'@'host';

-- MySQL 8.0+ 检查索引使用情况
SELECT * FROM sys.schema_unused_indexes;
SELECT * FROM sys.schema_redundant_indexes;

-- MySQL 8.0+ 检查锁等待
SELECT * FROM performance_schema.data_lock_waits;
```

## 常见问题模式

| 问题 | 风险 | 修复 |
|------|------|------|
| SELECT * | 性能浪费 | 明确指定字段 |
| 无 LIMIT | 返回大量数据 | 添加分页 |
| 字符串拼接 | SQL 注入 | 参数化查询 |
| 索引字段用函数 | 索引失效 | 改写条件 |
| FLOAT 存金额 | 精度丢失 | 改用 DECIMAL |
| 无事务 | 数据不一致 | 添加事务 |
| 全表扫描 | 性能问题 | 添加索引 |
| 长事务 | 锁等待 | 拆分事务 |
| 隐式类型转换 | 索引失效 | 保持类型一致 |
| 二次注入 | SQL 注入 | 输出时也参数化 |
| 无序加锁 | 死锁 | 固定加锁顺序 |
| BIGINT 溢出 | 数据错误 | 边界值检查 |

---

**相关资源**：
- [mysql-review.md](mysql-review.md) - MySQL 审查详细指南
- [examples/](examples/) - MySQL 审查示例
