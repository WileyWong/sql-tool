# Python 代码审查检查清单

Python 代码审查检查清单，确保审查质量和一致性。

---

## 🟢 基础审查 (15-30min)

### 代码规范
- [ ] `black` / `isort` 格式化通过
- [ ] `flake8` 无警告
- [ ] 命名遵循 PEP 8（snake_case / PascalCase）
- [ ] 导入按标准库/第三方/本地分组

### 命名规范
- [ ] 变量/函数使用 snake_case
- [ ] 类名使用 PascalCase
- [ ] 常量使用 UPPER_CASE
- [ ] 私有成员使用单下划线前缀

### 类型注解
- [ ] 函数有参数和返回值类型注解
- [ ] 可能为 None 的返回值使用 `Optional`
- [ ] 无 `Any` 滥用

### 异常处理
- [ ] 无裸 `except:` 语句
- [ ] 捕获具体异常类型
- [ ] 异常有适当的日志记录

---

## 🟡 标准审查 (45-60min)

**包含基础审查 +**

### 类型安全深度
- [ ] `mypy` 检查通过
- [ ] 复杂类型使用 `TypedDict` / `dataclass`
- [ ] 泛型类型正确使用
- [ ] 无可变默认参数

### 异常处理深度
- [ ] 使用 `raise from` 保留异常链
- [ ] 自定义业务异常层次合理
- [ ] 资源使用 `with` 语句管理
- [ ] 上下文管理器正确实现 `__exit__`

### 安全性
- [ ] SQL 使用参数化查询 / ORM
- [ ] 无 `shell=True` 的 subprocess 调用
- [ ] 无 `pickle` 反序列化不可信数据
- [ ] YAML 使用 `safe_load`
- [ ] 无硬编码密钥/密码
- [ ] 敏感信息不打印到日志

### 性能基础
- [ ] 大数据集使用生成器
- [ ] 适当使用 `lru_cache`
- [ ] 查找操作使用 `set` / `dict`
- [ ] 无循环内重复计算

---

## 🔴 专业审查 (2-3h)

**包含标准审查 +**

### 安全深度
- [ ] 文件操作有路径遍历防护
- [ ] 用户输入有完整验证
- [ ] 密码使用安全哈希（bcrypt/argon2）
- [ ] 时间比较使用 `hmac.compare_digest`
- [ ] 随机数使用 `secrets` 模块

### 异步编程
- [ ] 异步函数无同步阻塞调用
- [ ] 正确使用 `asyncio.gather`
- [ ] 异步上下文管理器正确实现
- [ ] 事件循环无阻塞

### 性能优化
- [ ] 热点代码有性能分析
- [ ] 内存使用合理（无泄漏）
- [ ] 数据库查询有索引
- [ ] N+1 查询已解决

### 测试覆盖
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 边界条件有测试
- [ ] 异常路径有测试
- [ ] Mock 外部依赖

### 可维护性
- [ ] 函数行数 ≤ 50 行
- [ ] 圈复杂度 ≤ 10
- [ ] 嵌套层级 ≤ 4 层
- [ ] 参数数量 ≤ 5 个

---

## 常见问题检查

### 类型注解问题
- [ ] 没有 `Optional` 遗漏（返回 None 的函数）
- [ ] 没有 `Any` 滥用
- [ ] 没有可变默认参数 `def f(items: list = [])`
- [ ] Python 3.8 使用 `typing.List` 而非 `list[int]`
- [ ] 没有 `Optional[Optional[T]]` 嵌套

### 异常处理问题
- [ ] 没有裸 `except:` 捕获
- [ ] 没有空 `except` 块（吞掉异常）
- [ ] 没有只打印不抛出的异常处理
- [ ] 资源清理在 `finally` 或 `with` 中
- [ ] 没有在循环中捕获异常导致静默失败

### 安全问题
- [ ] 没有 SQL 字符串拼接 / f-string
- [ ] 没有 `subprocess.run(..., shell=True)` + 用户输入
- [ ] 没有 `pickle.loads()` 处理不可信数据
- [ ] 没有 `yaml.load()` 使用（应用 `safe_load`）
- [ ] 没有硬编码的密钥、密码、Token
- [ ] 没有敏感信息写入日志
- [ ] 没有 `eval()` / `exec()` 执行用户输入
- [ ] 文件路径有遍历攻击防护

### 性能问题
- [ ] 没有循环内数据库查询（N+1）
- [ ] 没有大列表一次性加载到内存
- [ ] 没有循环内字符串 `+` 拼接
- [ ] 没有重复计算可缓存的结果
- [ ] 没有 `list` 用于频繁查找（应用 `set`）
- [ ] 异步代码没有同步阻塞调用

### 代码风格问题
- [ ] 没有超长函数（> 50 行）
- [ ] 没有过深嵌套（> 4 层）
- [ ] 没有过多参数（> 5 个）
- [ ] 没有魔法数字（应定义常量）
- [ ] 没有重复代码（DRY 原则）

---

## 框架专项检查

### Django
- [ ] ORM 查询使用 `select_related` / `prefetch_related`
- [ ] 表单使用 `clean_*` 方法验证
- [ ] 视图有 `@login_required` / 权限装饰器
- [ ] 模板无 `|safe` 滥用（XSS 风险）
- [ ] settings 敏感配置从环境变量读取
- [ ] `DEBUG = False` 在生产环境
- [ ] CSRF 中间件已启用

### FastAPI
- [ ] 请求体使用 Pydantic 模型验证
- [ ] 路径参数有类型注解
- [ ] 依赖注入正确使用
- [ ] 异步端点使用 `async def`
- [ ] 数据库操作使用异步 ORM
- [ ] OpenAPI 文档完整

### Flask
- [ ] 蓝图组织路由
- [ ] `SECRET_KEY` 从环境变量获取
- [ ] CORS 配置正确
- [ ] 请求上下文正确使用 `g`
- [ ] 错误处理器已注册

---

## 检查工具

```bash
# 格式化
black .
isort .

# Lint 检查
flake8 .
pylint .

# 类型检查
mypy --strict .

# 安全扫描
bandit -r .
safety check
pip-audit

# 复杂度检查
radon cc . -a -s
radon mi .

# 测试覆盖
pytest --cov=. --cov-report=html --cov-fail-under=80

# 依赖检查
pipdeptree
```

---

## 评分计算

| 维度 | 权重 | 得分 |
|------|------|------|
| 代码规范 | 20% | /100 |
| 类型安全 | 15% | /100 |
| 异常处理 | 15% | /100 |
| 安全防护 | 20% | /100 |
| 性能优化 | 15% | /100 |
| 可维护性 | 15% | /100 |
| **综合得分** | | **/100** |

**等级**: A级(≥85) / B级(70-84) / C级(60-69) / D级(<60)

---

## Python 版本特性检查

| 版本 | 特性 | 审查要点 |
|------|------|----------|
| Python 3.8 | walrus `:=` | 赋值表达式合理使用 |
| Python 3.8 | `TypedDict` | 结构化字典类型 |
| Python 3.9 | 内置泛型 | `list[int]` 替代 `List[int]` |
| Python 3.10 | `match` 语句 | 模式匹配替代 if-elif |
| Python 3.10 | `\|` Union | `int \| str` 替代 `Union[int, str]` |
| Python 3.11 | 异常组 | `ExceptionGroup` 使用 |
| Python 3.12 | 类型参数 | `class C[T]:` 语法 |

### 版本兼容性检查
- [ ] 确认项目最低 Python 版本要求
- [ ] 新特性使用与目标版本兼容
- [ ] 第三方库版本与 Python 版本兼容
- [ ] `pyproject.toml` 中 `requires-python` 正确设置
