# 通用错误处理规范

适用于所有语言的错误处理最佳实践。

---

## 错误处理原则

| 原则 | 说明 |
|------|------|
| 快速失败 | 尽早发现并报告错误 |
| 明确具体 | 错误信息清晰、可操作 |
| 不吞异常 | 不捕获后忽略 |
| 分层处理 | 在合适的层级处理错误 |
| 安全优先 | 不泄露敏感信息 |

---

## 错误分类

### 按来源分类

| 类型 | 说明 | 处理方式 |
|------|------|---------|
| 输入错误 | 用户输入不合法 | 返回 400，提示修正 |
| 业务错误 | 违反业务规则 | 返回 4xx，说明原因 |
| 系统错误 | 内部异常 | 返回 500，记录日志 |
| 外部错误 | 第三方服务失败 | 重试/降级/熔断 |

### 按严重程度分类

| 级别 | 说明 | 处理方式 |
|------|------|---------|
| 致命 | 系统无法继续 | 停止服务，告警 |
| 严重 | 功能不可用 | 降级，告警 |
| 一般 | 部分功能受影响 | 重试，记录 |
| 轻微 | 不影响主流程 | 记录，忽略 |

---

## 错误响应格式

### 标准格式

```json
{
  "code": "ERROR_CODE",
  "message": "用户友好的错误信息",
  "details": {
    "field": "具体字段",
    "reason": "详细原因"
  },
  "timestamp": "2025-12-22T10:30:00Z",
  "traceId": "abc123"
}
```

### HTTP 状态码使用

| 状态码 | 含义 | 使用场景 |
|--------|------|---------|
| 400 | Bad Request | 参数验证失败 |
| 401 | Unauthorized | 未认证 |
| 403 | Forbidden | 无权限 |
| 404 | Not Found | 资源不存在 |
| 409 | Conflict | 资源冲突（如重复） |
| 422 | Unprocessable Entity | 业务规则校验失败 |
| 429 | Too Many Requests | 限流 |
| 500 | Internal Server Error | 系统内部错误 |
| 502 | Bad Gateway | 上游服务错误 |
| 503 | Service Unavailable | 服务不可用 |

---

## 错误处理模式

### 1. 统一异常处理

```yaml
优点:
  - 集中管理错误响应
  - 统一格式
  - 减少重复代码

实现:
  - 全局异常处理器
  - 异常到响应的映射
  - 日志记录
```

### 2. 错误码体系

```yaml
格式: [模块][类型][序号]
示例:
  USER_001: 用户不存在
  USER_002: 用户名已存在
  ORDER_001: 订单不存在
  ORDER_002: 订单状态不允许操作
  SYSTEM_001: 系统繁忙

设计原则:
  - 唯一性: 每个错误码唯一
  - 可读性: 从错误码能推断含义
  - 可扩展: 预留序号空间
```

### 3. 错误恢复策略

```yaml
重试:
  - 适用: 临时性错误（网络抖动）
  - 策略: 指数退避 + 最大次数
  - 示例: 1s, 2s, 4s, 8s, 最多5次

降级:
  - 适用: 非核心功能失败
  - 策略: 返回默认值/缓存数据
  - 示例: 推荐服务失败返回热门商品

熔断:
  - 适用: 依赖服务持续失败
  - 策略: 快速失败，定期探测
  - 示例: 错误率>50%触发熔断
```

---

## 错误信息规范

### ✅ 好的错误信息

```
用户友好:
  "用户名已被注册，请更换其他用户名"
  "订单已发货，无法取消"
  "余额不足，当前余额 100 元，需要 150 元"

开发友好:
  "参数验证失败: username 长度必须在 3-20 之间，当前长度 2"
  "数据库连接失败: 连接超时(30s)，host=db.example.com:3306"
```

### ❌ 坏的错误信息

```
太模糊:
  "操作失败"
  "系统错误"
  "参数错误"

泄露信息:
  "SQL 语法错误: SELECT * FROM users WHERE id = '1 OR 1=1'"
  "文件不存在: /etc/passwd"
  "连接失败: admin:password@db.example.com"
```

---

## 日志记录规范

### 错误日志必须包含

```yaml
必须:
  - 错误类型/错误码
  - 错误消息
  - 堆栈跟踪（系统错误）
  - 请求上下文（traceId, userId, 请求参数）
  - 时间戳

建议:
  - 错误发生位置（类名、方法名、行号）
  - 环境信息（服务名、实例ID）
  - 相关业务数据（订单号、用户ID）
```

### 日志示例

```
2025-12-22 10:30:45 ERROR [traceId=abc123] [UserService.register] 
用户注册失败 | userId=null, username=test, reason=用户名已存在
com.example.exception.DuplicateKeyException: 用户名已存在
    at com.example.service.UserServiceImpl.register(UserServiceImpl.java:45)
    at com.example.controller.UserController.register(UserController.java:30)
    ...
```

---

## 各语言实现参考

| 语言 | 详细文档 |
|------|---------|
| Java | [java/exception.md](../java/exception.md) |
| Go | [go/error-handling.md](../go/error-handling.md) |
| TypeScript | [typescript/error-handling.md](../typescript/error-handling.md) |

---

## 检查清单

- [ ] 所有错误都被处理（不吞异常）
- [ ] 错误信息清晰、可操作
- [ ] 使用正确的 HTTP 状态码
- [ ] 系统错误记录完整日志
- [ ] 错误响应不泄露敏感信息
- [ ] 实现错误恢复策略（重试/降级/熔断）
- [ ] 统一错误响应格式
