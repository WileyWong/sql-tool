# 需求变更单

## 基本信息

| 项目 | 内容 |
|------|------|
| 变更编号 | RC-014 |
| 变更日期 | 2026-01-28 |
| 提出人 | |
| 优先级 | P1-高 |
| 影响范围 | 前端 |

---

## 1. 变更概述

> 在 SQL 查询结果展示区域增加数据操作功能，支持删除行、新增行和修改行，并统一操作行为为点击提交按钮保存

---

## 2. 变更背景

### 2.1 现状问题

> 描述当前系统存在的问题或不足

- **结果数据不可操作**：当前 SQL 查询结果仅为只读展示，用户无法直接在结果区域对数据进行增删改操作
- **单元格保存行为不一致**：当前编辑单元格后按回车即保存，与其他操作行为不统一
- **无修改标识**：用户无法直观看到哪些数据已被修改
- **无未保存提示**：当用户修改了数据但未保存时，重新执行 SQL 会直接丢失修改，没有提示

### 2.2 变更原因

> 说明为什么需要进行这个变更

- 提升数据操作效率，用户可以直接在查询结果中进行简单的数据维护
- 统一操作行为，所有修改类操作都通过提交按钮完成
- 增强用户体验，通过视觉标识和二次确认避免误操作

---

## 3. 变更内容

### 3.1 前置条件

> 以下功能仅在满足条件时可用

- 查询结果包含**主键字段**时才支持删除和修改操作
- **单表查询**时才支持新增操作（JOIN 联表查询不支持新增）
- **单表查询**时才支持删除和修改操作（JOIN 联表查询不可删除和修改）
- 无主键或联表查询时，相关按钮禁用（按钮可见但不可点击，显示禁用原因 tooltip）
- 复选框列始终显示，无主键或联表查询时复选框禁用

### 3.2 功能需求

> 详细描述需要实现的功能

#### 3.2.1 删除行功能

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 复选框列 | 表格第一列增加复选框，用于选择要删除的行 | 每行数据前显示复选框，无主键或联表时禁用 |
| 2 | 操作按钮 | 结果/消息标签右侧增加操作按钮（图标+tooltip），根据状态切换功能 | 有选中行时显示删除功能，有修改时显示提交功能 |
| 3 | 二次确认 | 点击删除时弹出二次确认对话框，显示即将执行的 DELETE 语句预览 | 对话框包含 SQL 预览区域，提示"删除后不可恢复，是否继续？" |
| 4 | SQL预览滚动 | 当 DELETE 语句超过10行时，SQL预览区域显示滚动条 | 预览区域最大高度 200px，超出时滚动 |
| 5 | 立即执行 | 用户确认后立即执行 DELETE 语句 | 执行成功后刷新表格数据，取消则不做任何操作 |

#### 3.2.2 新增行功能

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 新增按钮 | 结果/消息标签右侧增加新增按钮（图标+tooltip） | 点击后在表格最后一行新增空行 |
| 2 | 新增行标识 | 新增行使用浅绿色背景与已存在数据区分 | 视觉上明确区分新增行和原有数据 |
| 3 | 默认值处理 | 用户未填的字段，INSERT 语句不包含该字段，由 MySQL 使用建表时的默认值 | 生成 INSERT 语句时仅包含用户填写的字段 |
| 4 | 自增主键 | 自增主键逻辑与 MySQL 一致：用户填了就按填的插入，没填就不在 INSERT 语句中 | 符合 MySQL 自增规则 |
| 5 | 用户输入 | 用户可在新增行中输入各字段值 | 支持编辑单元格内容 |
| 6 | 二次确认 | 点击提交按钮后弹出二次确认对话框，显示即将执行的 INSERT 语句预览 | 对话框包含 SQL 预览区域，提示"是否确认提交？" |
| 7 | SQL预览滚动 | 当 INSERT 语句超过10行时，SQL预览区域显示滚动条 | 预览区域最大高度 200px，超出时滚动 |

#### 3.2.3 修改行功能

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 单元格编辑 | 支持双击单元格进入编辑模式 | 可修改单元格内容 |
| 2 | 回车行为变更 | **行为变更**：原回车保存改为回车仅退出编辑模式，不保存数据 | 编辑后按回车仅退出编辑，修改暂存在前端 |
| 3 | 提交保存 | 点击提交按钮后保存所有修改 | 触发二次确认，确认后执行 UPDATE 语句 |
| 4 | 按钮状态 | 有数据修改时提交按钮才可用 | 无修改时提交按钮禁用 |
| 5 | 二次确认 | 点击提交按钮后弹出二次确认对话框，显示即将执行的 UPDATE 语句预览 | 对话框包含 SQL 预览区域，提示"是否确认提交？"，支持复合主键 |
| 6 | SQL预览滚动 | 当 UPDATE 语句超过10行时，SQL预览区域显示滚动条 | 预览区域最大高度 200px，超出时滚动 |

#### 3.2.4 还原功能

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 还原按钮 | 结果/消息标签右侧增加还原按钮（图标+tooltip） | 有修改时可用，点击还原所有修改 |
| 2 | 还原范围 | 还原所有未提交的修改（包括修改的单元格和新增的行） | 还原后数据恢复到查询时的状态 |
| 3 | 按钮状态 | 有数据修改或新增行时还原按钮可用 | 无修改且无新增行时还原按钮禁用 |

#### 3.2.5 修改标识

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 修改单元格标识 | 已修改的单元格有明显视觉标识 | 单元格左边框显示橙色标记 |
| 2 | 新增行标识 | 新增的行使用浅绿色背景 | 与已存在数据明确区分 |

#### 3.2.6 未保存提示

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 提示触发 | 有未提交的修改时，用户重新执行 SQL 语句前提示 | 检测到数据变化且未提交时触发 |
| 2 | 提示选项 | 提供三个选项：立即提交、放弃、取消 | 立即提交：先提交再执行新 SQL；放弃：不提交直接执行新 SQL；取消：返回不执行新 SQL |

### 3.3 按钮布局

> 按钮放置在结果/消息标签右侧，使用图标+tooltip 方式

```
┌───────────────────────────────────────────────────────────────────────────┐
│ 结果    消息    [+新增] [↩还原] [🗑️删除/✓提交]                            │
├───────────────────────────────────────────────────────────────────────────┤
│  ☑ │ id │ name │ age │ email │ created_at                                 │
│  ──┼────┼──────┼─────┼───────┼──────────                                  │
│  ☑ │ 1  │ 张三 │ 25  │ ...   │ ...                                        │
│  ☑ │ 2  │ 李四 │ 30  │ ...   │ ...                                        │
│  ☐ │    │      │     │ ...   │ ...    ← 新增行（浅绿色背景）               │
└───────────────────────────────────────────────────────────────────────────┘
```

**按钮说明：**
- **新增**：点击新增一行空行
- **还原**：还原所有未提交的修改（有修改时可用）
- **删除/提交**：统一操作按钮
  - 有选中行时：显示为删除功能，点击执行删除
  - 有修改时：显示为提交功能，点击提交修改
  - 删除和修改互斥，不会同时触发

### 3.4 非功能需求

> 性能、安全、兼容性等要求

- 提交操作支持批量处理（单次提交可包含多条修改/新增记录）

---

## 4. 输入输出示例

### 示例 1：删除行操作

**输入：**
1. 用户执行 `SELECT * FROM users WHERE status = 0`
2. 在结果表格中勾选 id=1 和 id=3 的行
3. 点击删除按钮

**二次确认对话框（带 SQL 预览）：**
```
┌─────────────────────────────────────────────────────┐
│  ⚠️ 确认删除                                         │
│                                                     │
│  即将执行以下 SQL 语句：                              │
│  ┌─────────────────────────────────────────────┐   │
│  │ DELETE FROM users WHERE id = 1;             │   │
│  │ DELETE FROM users WHERE id = 3;             │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ⚠️ 删除后不可恢复，是否继续？                        │
│                                                     │
│  [取消]              [确认删除]                     │
└─────────────────────────────────────────────────────┘
```

**SQL 预览区域说明：**
- 背景使用代码编辑器样式（深色或浅色主题）
- 语句超过 10 行时显示垂直滚动条
- 最大高度固定，确保对话框不会过高

---

### 示例 2：新增行操作

**输入：**
1. 用户执行 `SELECT * FROM users`
2. 点击新增按钮
3. 在新行中输入：name='王五', age=28
4. 点击提交按钮

**二次确认对话框（带 SQL 预览）：**
```
┌─────────────────────────────────────────────────────┐
│  💡 确认提交                                         │
│                                                     │
│  即将执行以下 SQL 语句：                              │
│  ┌─────────────────────────────────────────────┐   │
│  │ INSERT INTO users (name, age)               │   │
│  │ VALUES ('王五', 28);                        │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  是否确认提交？                                      │
│                                                     │
│  [取消]              [确认提交]                     │
└─────────────────────────────────────────────────────┘
```

**生成的 INSERT 语句（假设 id 是自增主键，created_at 有默认值）：**
```sql
INSERT INTO users (name, age) VALUES ('王五', 28);
```

---

### 示例 3：修改行操作

**输入：**
1. 用户执行 `SELECT * FROM users`
2. 双击 name='张三' 的单元格，修改为 '张三丰'
3. 按回车退出编辑模式
4. 点击提交按钮

**修改标识：**
```
┌─────────────────────────────────────┐
│  ☑ │ id │ name        │ age │ ...  │
├────┼────┼─────────────┼─────┼──────┤
│  ☑ │ 1  │▌张三丰      │ 25  │ ...  │  ← 左边框橙色标记表示已修改
│  ☑ │ 2  │ 李四        │ 30  │ ...  │
└─────────────────────────────────────┘
```

**二次确认对话框（带 SQL 预览）：**
```
┌─────────────────────────────────────────────────────┐
│  💡 确认提交                                         │
│                                                     │
│  即将执行以下 SQL 语句：                              │
│  ┌─────────────────────────────────────────────┐   │
│  │ UPDATE users                                │   │
│  │ SET name = '张三丰'                          │   │
│  │ WHERE id = 1;                               │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  是否确认提交？                                      │
│                                                     │
│  [取消]              [确认提交]                     │
└─────────────────────────────────────────────────────┘
```

**生成的 UPDATE 语句：**
```sql
UPDATE users SET name = '张三丰' WHERE id = 1;
```

---

### 示例 4：批量操作（多条语句）

**场景：** 用户同时修改了 3 行数据

**二次确认对话框（带滚动条）：**
```
┌─────────────────────────────────────────────────────┐
│  💡 确认提交                                         │
│                                                     │
│  即将执行以下 SQL 语句（共 3 条）：                    │
│  ┌─────────────────────────────────────────────┐   │
│  │ UPDATE users SET name = '张三' WHERE id=1;  │   │
│  │ UPDATE users SET age = 30 WHERE id = 2;     │   │
│  │ UPDATE users SET email='a@b.c' WHERE id=3;  │   │
│  │                                             │   │
│  │ ...                                         │   │
│  │                                             │   │
│  │ ▼ 滚动条                                    │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  是否确认提交？                                      │
│                                                     │
│  [取消]              [确认提交]                     │
└─────────────────────────────────────────────────────┘
```

---

### 示例 4：未保存提示

**场景：** 用户修改了数据但未提交，直接点击执行新的 SQL

**提示对话框：**
```
┌──────────────────────────────────────┐
│  💡 未提交的修改                     │
│                                      │
│  当前有未提交的修改，请选择操作：     │
│                                      │
│  [立即提交]  [放弃]  [取消]          │
└──────────────────────────────────────┘
```

**选项说明：**
- **立即提交**：先执行 UPDATE/INSERT 提交修改，再执行用户的新 SQL
- **放弃**：不提交修改，直接执行用户的新 SQL
- **取消**：返回编辑器，不执行任何操作

---

## 5. 影响分析

### 5.1 受影响的模块

> 列出需要修改的代码模块

| 模块 | 文件路径 | 修改类型 | 说明 |
|------|----------|----------|------|
| 数据操作组件 | src/renderer/components/ResultDataOperations.vue | **新增** | 抽离编辑、新增、删除逻辑为独立组件 |
| 结果展示组件 | src/renderer/components/ResultTable.vue | 修改 | 集成数据操作组件，修改回车保存逻辑 |
| 结果面板组件 | src/renderer/components/ResultPanel.vue | 修改 | 新增工具栏按钮（新增/还原/删除/提交） |
| SQL 执行区域 | src/renderer/components/SqlEditor.vue | 修改 | 执行前检查未保存修改 |
| 状态管理 | src/renderer/stores/result.ts | 修改 | 新增 pendingChanges、newRows 状态 |

### 5.2 向后兼容性

- ✅ 查询功能完全兼容，不改变原有查询行为
- ✅ 新增功能为可选操作，不影响原有流程
- ✅ 无主键的查询结果仍正常显示，只是操作按钮禁用
- ⚠️ **行为变更**：回车不再保存，需用户适应新的提交流程

### 5.3 代码架构调整

> 为减少对 ResultTable.vue 的冲击，将数据操作逻辑抽离为独立组件

```
ResultPanel.vue
├── 工具栏按钮（新增/还原/删除/提交）
├── ResultTable.vue（表格展示）
└── ResultDataOperations.vue（新增，数据操作逻辑）
    ├── 复选框管理
    ├── 修改跟踪
    ├── 新增行管理
    ├── SQL 语句生成
    └── 确认对话框

---

## 6. 测试用例

> 用于验证变更是否正确实现

| 用例ID | 场景 | 输入 | 期望结果 |
|--------|------|------|----------|
| TC01 | 删除行-正常流程 | 勾选行 → 点击删除 → 确认 | 弹出确认框显示 DELETE 预览，执行后刷新表格 |
| TC02 | 删除行-取消操作 | 勾选行 → 点击删除 → 取消 | 不执行任何操作 |
| TC03 | 删除行-无选择 | 未勾选行 → 点击删除 | 删除按钮禁用，无法点击 |
| TC04 | 删除行-SQL预览 | 勾选多行 → 点击删除 | 确认框中显示所有 DELETE 语句（支持复合主键） |
| TC05 | 新增行-正常流程 | 点击新增 → 填写数据 → 提交 → 确认 | 弹出确认框显示 INSERT 预览，执行后新增行显示 |
| TC06 | 新增行-默认值 | 新增行，不填有默认值的字段 | INSERT 语句不包含该字段 |
| TC07 | 新增行-自增主键 | 新增行，不填自增主键 | INSERT 语句不包含主键字段 |
| TC08 | 新增行-取消确认 | 点击新增 → 填写 → 提交 → 取消 | 不执行 INSERT，数据保留在编辑状态 |
| TC09 | 新增行-视觉标识 | 点击新增 | 新增行显示浅绿色背景 |
| TC10 | 修改行-正常流程 | 双击单元格 → 修改 → 回车 → 提交 → 确认 | 弹出确认框显示 UPDATE 预览，执行后橙色标记消失 |
| TC11 | 修改行-回车不保存 | 双击单元格 → 修改 → 回车 | 退出编辑模式，数据未提交到数据库 |
| TC12 | 修改行-取消确认 | 修改 → 提交 → 取消 | 不执行 UPDATE，橙色标记保留 |
| TC13 | 修改标识 | 修改任意单元格 | 被修改的单元格显示橙色左边框 |
| TC14 | 还原功能 | 修改/新增后 → 点击还原 | 所有修改和新增行被清除，恢复查询时状态 |
| TC15 | 还原按钮状态 | 无修改时 | 还原按钮禁用 |
| TC16 | 操作按钮状态-无修改无选择 | 查询结果未做任何修改且未选择行 | 删除/提交按钮禁用 |
| TC17 | 操作按钮状态-有修改 | 修改任意单元格 | 按钮显示为提交功能，可用 |
| TC18 | 操作按钮状态-有选择 | 勾选任意行 | 按钮显示为删除功能，可用 |
| TC19 | SQL预览-滚动条 | 批量操作超过10条语句 | SQL预览区域显示滚动条（最大高度 200px） |
| TC20 | 未保存提示-立即提交 | 有修改 → 执行新 SQL → 选择立即提交 | 弹出确认框显示 SQL 预览，提交后执行新 SQL |
| TC21 | 未保存提示-放弃 | 有修改 → 执行新 SQL → 选择放弃 | 不提交修改，直接执行新 SQL |
| TC22 | 未保存提示-取消 | 有修改 → 执行新 SQL → 选择取消 | 不执行任何操作，返回编辑器 |
| TC23 | 无主键查询 | SELECT 不包含主键字段 | 复选框禁用，新增/删除/编辑按钮禁用（显示 tooltip 说明原因） |
| TC24 | 联表查询 | SELECT ... FROM a JOIN b | 复选框禁用，新增/删除/编辑按钮禁用（显示 tooltip 说明原因） |
| TC25 | 批量修改提交 | 修改多行后点击提交 | 确认框显示多条 UPDATE 语句，全部成功 |

---

## 7. 备注

> 其他需要说明的事项

### 7.1 设计原则

- 遵循项目现有的代码风格和架构模式
- 按钮图标使用 Element Plus 或 TDesign 内置图标
- tooltip 文字：新增="新增行"、还原="还原所有修改"、删除="删除选中行"、提交="提交修改"
- 禁用状态时 tooltip 显示禁用原因（如"无主键，不支持编辑"、"联表查询，不支持操作"）

### 7.2 异常处理

- **删除失败**：显示错误提示，不刷新表格
- **提交失败**：显示错误提示，保留修改状态，允许用户重新提交
- **SQL 执行错误**：MySQL 返回的错误直接展示给用户（如类型不匹配、非空约束等）

### 7.3 后续优化方向

- 支持撤销/重做功能
- 支持复制粘贴整行数据
- 支持批量编辑（如 Excel 的拖拽填充）
- 支持右键菜单快捷操作

---

## 8. 需求确认记录

> 记录需求分析过程中的疑问和确认结果

| 日期 | 问题 | 确认结果 |
|------|------|----------|
| 2026-01-28 | 回车保存行为是否变更？ | ✅ 确认变更：回车仅退出编辑，不保存 |
| 2026-01-28 | 删除和提交是否用同一按钮？ | ✅ 使用同一按钮，根据状态切换功能 |
| 2026-01-28 | 是否需要获取表字段默认值？ | ❌ 不需要，由 MySQL 处理默认值 |
| 2026-01-28 | 联表查询是否支持操作？ | ❌ 不支持，联表查询禁用增删改功能 |
| 2026-01-28 | 如何取消新增/修改？ | ✅ 新增"还原"按钮，还原所有修改 |
| 2026-01-28 | 新增行是否需要主键？ | ❌ 新增功能不依赖主键，单表查询即可 |
| 2026-01-28 | 复选框何时显示？ | ✅ 始终显示，不可操作时禁用 |
| 2026-01-28 | 不可操作时按钮状态？ | ✅ 禁用（可见但不可点击） |
| 2026-01-28 | 新增行视觉标识？ | ✅ 浅绿色背景 |
| 2026-01-28 | SQL 预览区域最大高度？ | ✅ 200px |
| 2026-01-28 | 代码冲击处理？ | ✅ 抽离为独立组件 ResultDataOperations.vue |

