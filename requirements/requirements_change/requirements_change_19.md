# RC-019 多语言遗漏修复与文件标题优化

## 1. 需求概述

| 项目 | 内容 |
|------|------|
| 需求编号 | RC-019 |
| 需求名称 | 多语言遗漏修复与文件标题优化 |
| 提出日期 | 2026-01-30 |
| 优先级 | 中 |

### 1.1 背景
在 RC-018 多语言支持功能完成后，经过测试发现部分界面文本仍未被国际化，同时用户反馈文件保存后标题显示不够直观。需要修复这些问题以提升用户体验。

### 1.2 目标
1. 修复多语言遗漏的文本
2. 优化文件保存后的标题显示逻辑
3. 添加文件路径悬停提示功能

---

## 2. 需求详情

### 2.1 多语言遗漏项

#### 2.1.1 消息面板 - 影响行数提示

**当前问题**
执行 SQL 语句后，消息面板显示的"影响 X 行"文本为硬编码中文。

**涉及位置**
- 执行 SQL 后的结果消息面板

**需要国际化的文本**
| 中文 | 英文 | 繁体中文 |
|------|------|----------|
| 影响 {n} 行 | {n} row(s) affected | 影響 {n} 行 |
| 查询成功，影响 {n} 行 | Query successful, {n} row(s) affected | 查詢成功，影響 {n} 行 |

#### 2.1.2 SQL 编辑器右键菜单 - 执行选项

**当前问题**
SQL 编辑器右键菜单中的"执行"选项为硬编码中文。

**涉及位置**
- SQL 编辑器右键上下文菜单

**需要国际化的文本**
| 中文 | 英文 | 繁体中文 |
|------|------|----------|
| 执行 | Execute | 執行 |

### 2.2 文件标题显示优化

#### 2.2.1 按实际文件名显示标题

**当前问题**
编辑器标签保存文件后，标题会正确更新为文件名。但切换到其他编辑器标签再切回来后，标题又恢复为默认名称（如"Query1"）。

**问题场景**
1. 打开编辑器标签，默认标题为"Query1.sql"
2. 保存文件为 `test.sql`，标题变为 `test.sql` ✓
3. 切换到其他编辑器标签
4. 切回原标签，标题又变回 `Query1.sql` ✗

**期望行为**
1. 保存文件后，标签页标题持久显示为实际文件名（不含路径）
2. 切换标签页后，标题保持显示文件名，不应恢复为默认标题
3. 示例：保存为 `/home/user/documents/test.sql`，标题始终显示 `test.sql`

**涉及组件**
- 编辑器标签页状态管理
- 标签切换逻辑
- 文件保存逻辑

#### 2.2.2 文件路径悬停提示

**当前问题**
用户无法快速查看已保存查询的完整文件路径。

**期望行为**
1. 鼠标悬停在已保存查询的标签页标题上时，显示完整文件路径
2. 使用浏览器原生 title 属性或自定义 tooltip 组件
3. 未保存的查询不显示路径提示（或显示"未保存"）

**交互设计**
```
鼠标悬停前:
┌─────────────┐
│ test.sql  × │
└─────────────┘

鼠标悬停后:
┌────────────────────────────────────┐
│ /home/user/documents/test.sql      │ ← Tooltip
└────────────────────────────────────┘
```

### 2.3 结果面板高度拖动优化

#### 2.3.1 拖动高度限制调整

**当前问题**
结果面板向上拖动时有固定的高度限制，导致用户无法灵活调整编辑区和结果区的高度比例。

**期望行为**
1. 结果面板向上拖动时，只限制 SQL 编辑区的最小高度为 100px
2. 移除其他固定高度限制，让用户可以更自由地调整面板高度
3. 当拖动使 SQL 编辑区接近 100px 时，应平滑停止，避免抖动

**涉及组件**
- 主界面布局（SQL 编辑区 + 结果面板）
- 拖动分隔条组件

**技术要点**
```
拖动前:
┌─────────────────────────────┐
│                             │
│      SQL 编辑器              │
│      (当前高度 300px)        │
│                             │
├─────────────────────────────┤ ← 拖动分隔条
│                             │
│      结果面板                │
│      (当前高度 200px)        │
│                             │
└─────────────────────────────┘

拖动后 (向上拖动到极限):
┌─────────────────────────────┐
│  SQL 编辑器                  │
│  (最小高度 100px)            │ ← 最低保留 100px
├─────────────────────────────┤
│                             │
│      结果面板                │
│      (扩展高度 400px)        │
│                             │
└─────────────────────────────┘
```

### 2.4 消息面板执行历史优化

#### 2.4.1 显示执行的 SQL 语句

**当前问题**
消息面板仅显示执行状态和影响的行数，不显示具体执行的 SQL 语句，用户难以追溯每次执行的内容。

**期望行为**
1. 在执行消息中追加显示本次执行的 SQL 语句
2. 保持现有两行结构：
   - 第一行：`14:27:06 Executing... SELECT * FROM users...`
   - 第二行：`14:27:06 Query returned 5 rows, took 43ms`
3. SQL 语句显示在 "Executing..." 后方，同一行显示
4. SQL 语句截断规则：
   - 单行显示，不自动换行
   - 超长时截断并添加 "..." 后缀
   - 建议最大显示长度 80-100 字符（根据面板宽度自适应）

#### 2.4.2 复制 SQL 功能

**期望行为**
1. 每条执行消息第一行右侧增加"复制"链接按钮
2. 点击后复制该次执行的完整 SQL 语句到剪贴板
3. 复制成功后给出短暂提示（Toast 或文字变化）

**交互设计**
```
消息面板示例:
┌─────────────────────────────────────────────────────────────┐
│ 14:32:15 Executing... SELECT * FROM users...      [复制]   │
│ 14:32:15 Query returned 5 rows, took 43ms                    │
│                                                              │
│ 14:33:01 Executing... INSERT INTO logs...         [复制]   │
│ 14:33:01 Query OK, 1 row affected                            │
│                                                              │
│ 14:33:25 Executing... UPDATE orders SET status... [复制]   │
│ 14:33:25 Query OK, 10 rows affected                          │
└─────────────────────────────────────────────────────────────┘
```

#### 2.4.3 执行历史追加策略

**当前问题**
每次新的执行会覆盖之前的消息，无法查看历史执行记录。

**期望行为**
1. 采用**追加**模式，保留历史执行消息
2. 最新执行的消息显示在最上方（倒序排列）
3. **容量限制**：最多保留 100 条执行记录
4. **淘汰策略**：FIFO（先进先出），当第 101 条执行时，删除最早的第 1 条记录

**数据管理**
```
执行记录存储结构:
interface ExecutionMessage {
  id: string;           // 唯一标识
  timestamp: number;    // 执行时间戳
  sql: string;          // 完整 SQL 语句
  status: 'success' | 'error';
  rowsAffected: number;
  message?: string;     // 错误信息（如有）
}

容量控制逻辑:
1. 新执行添加到数组头部
2. 检查数组长度 > 100
3. 如果超过，移除数组末尾（最旧）的元素
```

### 2.5 编辑器标签页拖动排序

#### 2.5.1 标签拖拽功能

**当前问题**
编辑器标签页目前固定位置，无法通过拖拽改变顺序，用户整理工作空间时不够灵活。

**期望行为**
1. 支持鼠标拖拽标签页改变其排列顺序
2. 拖拽时有视觉反馈（如半透明效果、占位符指示）
3. 拖拽结束后标签顺序立即生效
4. 标签顺序变化不影响各编辑器的内容和状态

**交互设计**
```
拖拽前:
┌─────────────────────────────────────────┐
│ [Query1]  [test.sql]  [data.sql*]  [+] │
└─────────────────────────────────────────┘

拖拽中 (拖动 test.sql 到 Query1 左侧):
┌─────────────────────────────────────────┐
│ │test.sql│ [Query1]  [data.sql*]  [+]  │ ← 半透明+占位符效果
└─────────────────────────────────────────┘

拖拽后:
┌─────────────────────────────────────────┐
│ [test.sql]  [Query1]  [data.sql*]  [+] │ ← 顺序已改变
└─────────────────────────────────────────┘
```

**涉及组件**
- 标签页容器组件
- 各标签页子组件
- 拖拽事件处理

**技术参考**
- 可使用原生 HTML5 Drag and Drop API
- 或使用第三方库如 `vuedraggable` (Vue 生态)
- 需维护标签顺序数组状态

---

## 3. 验收标准

### 3.1 功能验收

#### 多语言修复
| 编号 | 测试场景 | 预期结果 |
|------|----------|----------|
| TC01 | 执行 SQL 后查看消息面板（英文） | 显示 "{n} row(s) affected" |
| TC02 | 执行 SQL 后查看消息面板（简体中文） | 显示 "影响 {n} 行" |
| TC03 | 执行 SQL 后查看消息面板（繁体中文） | 显示 "影響 {n} 行" |
| TC04 | 右键点击 SQL 编辑器（英文） | 菜单显示 "Execute" |
| TC05 | 右键点击 SQL 编辑器（简体中文） | 菜单显示 "执行" |
| TC06 | 右键点击 SQL 编辑器（繁体中文） | 菜单显示 "執行" |

#### 文件标题优化
| 编号 | 测试场景 | 预期结果 |
|------|----------|----------|
| TC07 | 新建查询并保存为 test.sql | 标签页标题变为 "test.sql" |
| TC08 | 保存文件后修改内容 | 标题显示 "test.sql *"（带修改标记）|
| TC09 | 鼠标悬停在已保存文件标签上 | Tooltip 显示完整文件路径 |
| TC10 | 鼠标悬停在未保存文件标签上 | Tooltip 显示"未保存"或不显示路径 |
| TC11 | 保存到不同目录的同名文件 | 正确显示各自路径，标题显示文件名 |

#### 结果面板拖动优化
| 编号 | 测试场景 | 预期结果 |
|------|----------|----------|
| TC12 | 向上拖动结果面板分隔条 | SQL 编辑区高度可缩小至最小 100px |
| TC13 | 继续向上拖动（编辑区已达 100px）| 编辑区保持 100px，不再缩小 |
| TC14 | 向下拖动结果面板分隔条 | 结果面板正常缩小，编辑区正常扩大 |

#### 消息面板执行历史优化
| 编号 | 测试场景 | 预期结果 |
|------|----------|----------|
| TC15 | 执行一条短 SQL | 消息显示 "Executing... SELECT * FROM users" 及复制按钮 |
| TC16 | 执行一条长 SQL（超过 100 字符）| 消息显示截断后的 SQL，带 "..." 后缀 |
| TC17 | 点击"复制"链接 | 完整 SQL 被复制到剪贴板，有成功提示 |
| TC18 | 连续执行 5 次 SQL | 消息面板显示 5 条历史记录，最新在上 |
| TC19 | 连续执行 101 次 SQL | 消息面板只显示最近 100 条，最早 1 条被移除 |
| TC20 | 查看历史消息 | 每条消息显示执行时间、SQL 语句、影响行数 |

#### 编辑器标签页拖动排序
| 编号 | 测试场景 | 预期结果 |
|------|----------|----------|
| TC21 | 拖动标签页改变顺序 | 标签顺序成功交换，视觉效果平滑 |
| TC22 | 拖动标签到首位 | 被拖动标签移至最左侧 |
| TC23 | 拖动标签到末位 | 被拖动标签移至最右侧 |
| TC24 | 打开 5 个标签，拖动第 3 个到第 1 个位置 | 顺序变为 3-1-2-4-5 |
| TC25 | 拖动过程中 | 显示拖拽占位符或半透明效果 |
| TC26 | 拖动结束后切换标签 | 各标签内容显示正确，与标题匹配 |

### 3.2 覆盖率验收
| 检查项 | 标准 |
|--------|------|
| 消息面板文本 | 100% 国际化 |
| 编辑器右键菜单 | 100% 国际化 |
| 文件标题显示 | 正确显示文件名 |
| 路径提示 | 正确显示完整路径 |
| 结果面板拖动 | 编辑区最小高度限制为 100px |
| 消息面板历史 | 显示 SQL、可复制、最多 100 条 FIFO |
| 标签拖动排序 | 支持拖拽改变标签顺序 |

---

## 4. 技术要点

### 4.1 多语言修复

**语言文件位置**
```
src/renderer/i18n/
├── locales/
│   ├── zh-CN.ts    # 简体中文
│   ├── zh-TW.ts    # 繁体中文
│   └── en-US.ts    # 英文
```

**需要添加的 Key**
```typescript
// 消息面板
message: {
  rowsAffected: '{n} row(s) affected',
  querySuccess: 'Query successful, {n} row(s) affected'
}

// 右键菜单
contextMenu: {
  execute: 'Execute'
}
```

### 4.2 文件标题优化

**状态管理**
```typescript
interface EditorTab {
  id: string;
  title: string;           // 显示标题（文件名）
  filePath?: string;       // 完整文件路径
  isSaved: boolean;
  isModified: boolean;
  content: string;
}
```

**路径提取逻辑**
```typescript
// 从完整路径中提取文件名
const getFileName = (filePath: string): string => {
  return filePath.split(/[/\\]/).pop() || filePath;
};
```

---

## 5. 非功能需求

| 需求类型 | 描述 |
|----------|------|
| 性能 | 文件保存和标题更新无延迟 |
| 兼容性 | 不影响现有多语言功能 |
| 用户体验 | Tooltip 显示有适当的延迟，避免闪烁 |
| 可维护性 | 代码结构清晰，便于后续扩展 |

---

## 6. 变更历史

| 日期 | 变更内容 | 状态 |
|------|----------|------|
| 2026-01-30 | 初始创建 | 待确认 |
