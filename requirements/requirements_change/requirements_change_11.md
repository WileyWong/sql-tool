# 需求变更单

## 基本信息

| 项目 | 内容 |
|------|------|
| 变更编号 | RC-011 |
| 变更日期 | 2026-01-27 |
| 提出人 | |
| 优先级 | P1-高 |
| 影响范围 | 前端 |
| 实现状态 | 已完成 |

---

## 1. 变更概述

> 将结果表格组件从 el-table 替换为基于 @tanstack/vue-virtual 的虚拟滚动表格，以支持大批量数据的高效渲染。

---

## 2. 变更背景

### 2.1 现状问题

- 当前使用 Element Plus 的 el-table 组件渲染查询结果
- 当查询返回大量数据（数万行）时，el-table 会一次性渲染所有 DOM 节点
- 导致页面卡顿、内存占用过高，甚至浏览器崩溃

### 2.2 变更原因

- 用户需要查询和浏览大量数据
- 虚拟滚动技术只渲染可视区域内的行，可显著提升性能
- 提升用户体验，避免大数据量场景下的页面卡顿

---

## 3. 变更内容

### 3.1 功能需求

| 序号 | 功能点 | 描述 | 验收标准 |
|------|--------|------|----------|
| 1 | 虚拟滚动表格 | 使用 @tanstack/vue-virtual 实现虚拟化渲染 | 只渲染可视区域内的行 + overscan 行 |
| 2 | 表头固定 | 表头在垂直滚动时保持固定 | 滚动表体时表头不动 |
| 3 | 表头水平同步滚动 | 表头跟随表体水平滚动同步移动 | 水平滚动时表头列与表体列对齐 |
| 4 | 列宽拖动调整 | 支持拖动表头右边缘调整列宽 | 鼠标悬停右边缘显示拖动提示，拖动时实时调整宽度 |
| 5 | 列名溢出省略 | 列宽过窄时，列名和类型显示省略号 | 拖动列宽至较小值时，列名显示为 `...` 而非覆盖其他列 |
| 6 | 保留原有功能 | 保持双击编辑、右键菜单、格式化查看等功能 | 所有原有功能正常工作 |

### 3.2 非功能需求

- 支持渲染数万行数据，无明显卡顿
- 滚动流畅，帧率稳定
- 行高固定为 36px，便于虚拟化计算

---

## 4. 技术实现

### 4.1 依赖安装

```bash
npm install @tanstack/vue-virtual
```

### 4.2 核心实现

- 使用 `useVirtualizer` 创建虚拟化器，配置 overscan 为 10 行
- 表头使用 `translateX` transform 实现水平滚动同步
- 列宽调整通过监听表头 mousedown 事件，检测点击位置是否在右边缘 5px 内

---

## 5. 影响分析

### 5.1 受影响的模块

| 模块 | 文件路径 | 修改类型 |
|------|----------|----------|
| 结果表格组件 | src/renderer/components/ResultTable.vue | 修改 |
| 依赖配置 | package.json | 修改 |

### 5.2 依赖关系

- 新增依赖：@tanstack/vue-virtual
- 无其他变更依赖

---

## 6. 测试用例

| 用例ID | 场景 | 输入 | 期望结果 |
|--------|------|------|----------|
| TC01 | 大数据量渲染 | 查询返回 10000 行数据 | 页面不卡顿，滚动流畅 |
| TC02 | 垂直滚动 | 上下滚动表格 | 表头固定，数据行正常滚动 |
| TC03 | 水平滚动 | 左右滚动表格 | 表头与表体列对齐，同步滚动 |
| TC04 | 列宽调整 | 拖动表头列右边缘 | 列宽实时变化，最小宽度 50px |
| TC05 | 列名溢出省略 | 将列宽拖动至最小 | 列名显示为省略号，不覆盖其他列 |
| TC06 | 双击编辑 | 双击单元格 | 进入编辑模式，可修改内容 |
| TC07 | 右键菜单 | 右键点击单元格 | 显示查看菜单，可查看完整内容 |

---

## 7. 备注

- @tanstack/vue-virtual 文档：https://tanstack.com/virtual/latest
- 行高固定为 36px，如需调整需同步修改 ROW_HEIGHT 常量和 CSS 样式
- 列宽拖动区域为表头右边缘 5px 范围内
