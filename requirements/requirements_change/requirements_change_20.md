# RC-020 新增/删除数据库功能

## 1. 需求概述

| 项目 | 内容 |
|------|------|
| 需求编号 | RC-020 |
| 需求名称 | 新增/删除数据库功能 |
| 提出日期 | 2026-02-28 |
| 优先级 | 高 |

### 1.1 背景

当前系统已支持对数据库表的操作（新增、修改、删除），但缺少对**数据库本身**的新增和删除操作。用户在左侧连接树中右键点击数据库节点时，仅有"刷新"选项，无法直接创建或删除数据库。

### 1.2 目标

在连接树的右键菜单中，新增"创建数据库"和"删除数据库"两个操作，支持 MySQL 和 SQL Server 两种数据库类型。

---

## 2. 需求详情

### 2.1 创建数据库

**入口：**
- 右键点击**连接节点**（server），上下文菜单增加"创建数据库"选项（需已连接状态）
- 右键点击**数据库节点**（database），上下文菜单增加"创建数据库"选项

**交互流程：**
1. 用户点击"创建数据库"后，弹出对话框
2. 对话框包含以下字段：

| 字段 | 说明 | MySQL | SQL Server |
|------|------|-------|------------|
| 数据库名称 | 必填，文本输入 | ✅ | ✅ |
| 字符集 (Character Set) | 可选，下拉选择，默认 utf8mb4，**从服务器动态查询** | ✅ | ❌ |
| 排序规则 (Collation) | 可选，下拉选择，随字符集联动，**从服务器动态查询** | ✅ | ✅ |

3. 用户填写后点击"确定"，系统生成对应的 `CREATE DATABASE` SQL 并执行
4. 执行成功后：
   - 提示创建成功
   - 自动刷新当前连接节点下的数据库列表
5. 执行失败则提示错误信息

**字符集与排序规则的数据来源（动态查询）：**

字符集和排序规则的可选值从用户已连接的数据库服务器上**实时查询**获取，不硬编码：

| 数据项 | MySQL 查询语句 | SQL Server 查询语句 |
|--------|---------------|-------------------|
| 字符集列表 | `SHOW CHARACTER SET` | ❌ 不适用 |
| 排序规则列表 | `SHOW COLLATION WHERE Charset = '<选中字符集>'` | `SELECT name FROM sys.fn_helpcollations()` |

- MySQL：用户选择字符集后，联动查询对应的排序规则列表
- SQL Server：直接查询全部可用排序规则
- 查询结果可缓存（同一连接内），避免每次打开对话框都重复请求
- 需要**新增后端 IPC 接口**用于获取字符集/排序规则元数据，或复用已有的查询通道

**SQL 生成规则：**

- MySQL：
  ```sql
  CREATE DATABASE `数据库名`
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_general_ci;
  ```
- SQL Server：
  ```sql
  CREATE DATABASE [数据库名]
    COLLATE Chinese_PRC_CI_AS;
  ```

**名称校验规则：**
- 不能为空
- 不能包含特殊字符（空格、`.`、`/`、`\`、`:`、`*`、`?`、`"`、`<`、`>`、`|`）
- 长度限制：MySQL 最长 64 字符，SQL Server 最长 128 字符

### 2.2 删除数据库

**入口：**
- 右键点击**数据库节点**（database），上下文菜单增加"删除数据库"选项

**交互流程：**
1. 用户点击"删除数据库"后，弹出确认对话框
2. 对话框内容：
   - 显示警告信息：此操作将永久删除数据库及其所有数据，不可恢复
   - 显示即将执行的 SQL 语句预览
   - 需用户手动输入数据库名称进行二次确认（防止误操作）
3. 用户确认后执行 `DROP DATABASE` SQL
4. 执行成功后：
   - 提示删除成功
   - 自动刷新当前连接节点下的数据库列表
   - 如果被删除的数据库是当前编辑器正在使用的数据库，清空编辑器的数据库选择
5. 执行失败则提示错误信息

**SQL 生成规则：**

- MySQL：
  ```sql
  DROP DATABASE `数据库名`;
  ```
- SQL Server：
  ```sql
  -- 先断开所有活跃连接
  ALTER DATABASE [数据库名] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
  DROP DATABASE [数据库名];
  ```

**删除前 Session 清理：**
- 执行 DROP DATABASE 前，遍历所有编辑器 Tab，找到**同时满足以下条件**的 Tab：
  - 使用的 connectionId 与当前连接相同
  - 使用的数据库名与待删除数据库相同
- 对这些 Tab 调用 `session.destroy(tabId, connectionId)` 销毁其 session，释放对该数据库的物理连接
- 清空这些 Tab 的数据库选择（设为空）
- 此步骤在生成并执行 DROP DATABASE SQL **之前**完成

**安全限制：**
- 系统数据库不允许删除：
  - MySQL：`mysql`、`information_schema`、`performance_schema`、`sys`
  - SQL Server：`master`、`tempdb`、`model`、`msdb`

## 3. 右键菜单变更汇总

| 节点类型 | 现有菜单项 | 新增菜单项 |
|---------|-----------|-----------|
| 连接（已连接） | 断开连接、编辑连接、删除连接、刷新 | **创建数据库** |
| 数据库 | 刷新 | **创建数据库**、**删除数据库** |

## 4. 涉及修改的模块

| 模块 | 文件 | 变更内容 |
|------|------|---------|
| 连接树组件 | `ConnectionTree.vue` | 右键菜单增加选项，新增菜单点击处理逻辑 |
| 新建数据库对话框 | `CreateDatabaseDialog.vue`（新增） | 创建数据库的表单对话框 |
| i18n 国际化 | `en-US.json`、`zh-CN.json`、`zh-TW.json` | 新增菜单项和对话框的文案翻译 |
| 连接 Store | `connection.ts` | 新增 `createDatabase`、`dropDatabase` 方法，或复用 `executeDDL` |
| DDL 执行 | 复用现有 `DDL_EXECUTE` IPC 通道 | 无需新增 IPC，直接通过已有的 `executeDDL` 执行 SQL |

## 5. 注意事项

- 创建数据库操作通过已有的 `DDL_EXECUTE` IPC 通道执行，无需新增后端接口
- 字符集/排序规则的可选值需要从服务器动态查询，需新增后端 IPC 接口或复用已有查询通道
- 删除数据库因风险极高，必须有二次确认机制（输入数据库名称确认，**大小写不敏感**匹配）
- SQL Server 删除数据库前需先断开活跃连接（`SET SINGLE_USER`），需要 sysadmin 或 db_owner 权限
- 删除数据库前必须先销毁所有使用该数据库的编辑器 Tab session，避免连接泄漏和 DROP 失败

---

## 6. 变更历史

| 日期 | 变更内容 | 状态 |
|------|----------|------|
| 2026-02-28 | 初始创建 | 待确认 |
