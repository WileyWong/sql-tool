## 概述

实现一个sql编辑器功能

UI参考路径：ui/output/index.html

**支持数据库**: MySQL

---

## story拆解

### 1. 首次打开此工具
1. 数据库连接树形展示 区域提示没有数据，并且增加新建连接的功能，点击和新建链接一样。

### 2. 连接数据库
1. 弹出连接数据库弹窗，参见UI文件。
2. **必填字段**：名称、服务地址（host:port格式）、用户名、密码（必填）
3. **可选字段**：默认数据库名
4. **服务地址格式**：host:port，端口默认3306
5. **测试连接与保存独立**：允许直接保存连接，无需先测试成功。测试连接和保存是两个独立操作。
6. 保存后，将连接保存在本地（使用本机MAC地址 + AES对称加密，防止泄漏），并显示在数据库连接树形展示区域。

### 3. 在sql编辑区编写sql

#### 3.1 自动联想
**触发方式**：实时自动触发，输入时自动弹出联想列表
**确认方式**：Tab/Enter确认选择，Esc关闭联想列表
**列表规则**：
- 最大显示20条
- 随用户输入实时更新过滤
- 按字符串排序

联想场景：
- 一个空语句，刚开始输入时，提示sql关键词，如：输入s,会联想出所有s开头的关键字，如：select、set、show等
- 输入select不需要提示，因为还不知道表是哪个
- 输入select * from 提示所有可用表、视图、函数
- 输入select * from t1 时，在*位置提示所有可用字段、函数
- 当光标在注释区域内 /**/ -- 里面时，没有联想
- 输入select * from t1 where 提示所有可用字段、函数
- 输入select * from t1 where t1. 提示所有可用字段、函数
- 输入select * from t1 inner join 提示所有可用表、视图、函数
- 输入select * from t1 inner join t2 on 提示本次查询需要join的表涉及到的字段、函数。 如果字段不唯一，字段名前需要加个表名
- 输入select * from (select f1,f2,f3 from t1) 在第一个*的位置,提示子查询涉及到的字段、函数
- 其他情况
    - 创建表、视图、函数、存储过程、索引等 的语法联想

#### 3.2 语法错误识别
**支持语法**：MySQL
**反馈方式**：红色波浪线 + 悬浮提示
- 错误位置显示红色波浪线
- 鼠标悬停显示错误详情

### 4. 执行sql语句

#### 4.1 执行触发
1. 如果没有选择的sql文本，直接点菜单、功能按钮栏中的执行，执行整个编辑区域中的sql
2. 如果有选择的sql文本，直接点菜单、功能按钮栏中的执行，执行选择的sql文本

#### 4.2 多语句执行策略
**执行方式**：批量执行，遇错停止
- 所有语句一次性发送执行
- 遇到第一个错误即停止，后续语句不再执行

#### 4.3 结果显示
**显示方式**：多结果集标签页
- 每个SELECT结果显示为独立标签页（结果1、结果2...）
- INSERT/UPDATE/DELETE等非查询语句在"消息"区显示影响行数
- 混合语句时，SELECT结果在结果标签页，非查询结果在消息区

#### 4.4 执行超时
**默认超时时间**：10分钟
**后续规划**：增加用户设置功能

#### 4.5 结果集最大行数
**默认最大行数**：5000行
**用户可修改**：在SQL编辑区的工具栏中提供输入框，用户可自行修改，只允许输入数字

### 5. 停止执行
**行为**：仅中断，不回滚
- 发送KILL QUERY命令中断当前查询
- 已提交的数据不回滚
- 用户应自行管理事务

### 6. 执行计划按钮
**支持数据库**：MySQL（EXPLAIN格式）
**展示方式**：
1. "执行计划"标签页以**流程图**形式展示查询计划
2. "结果"标签页以表格形式展示查询计划

### 7. 左侧 数据库连接树形展示 操作
1. 重命名连接
2. 删除连接
3. 展开、折叠树
4. **刷新机制**：手动刷新整个树，点击刷新时重新加载所有连接的数据库结构
5. **右键菜单刷新**：树节点右键增加"刷新"选项，可重新读取数据库结构，并刷新指定节点下的内容

### 8. 结果、消息、执行计划 
点击可切换

### 9. SQL文件标签页管理
**命名规则**：新建查询命名为"查询1"、"查询2"...
**关闭行为**：关闭未保存文件时提示保存
**数量限制**：不限制标签页数量

---

## 数据模型

### 连接信息存储
存储字段（基础字段）：
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 名称 | string | 是 | 连接显示名称 |
| 服务地址 | string | 是 | host:port格式，端口默认3306，如 localhost:3306 |
| 用户名 | string | 是 | 数据库用户名 |
| 密码 | string | 是 | 数据库密码（加密存储） |
| 默认数据库 | string | 否 | 连接后默认选中的数据库 |

**加密方式**：使用本机MAC地址 + AES对称加密，防止泄漏

---

## 需求变更记录

### 变更 1 (2025-12-22)

#### 1. 左侧数据库选择组件增强
1. **双击切换数据库**: 双击数据库名，将自动切换当前查询连接的数据库
2. **CSS 高亮显示**: 当前选中的数据库和服务器，在 CSS 上做区分（服务器：青色加粗，数据库：高亮背景）

#### 2. 查询结果增强
1. **单元格可编辑**: 如果当前查询为单表查询，且表存在主键，双击单元格可修改值，回车自动提交 UPDATE，按 ESC 放弃修改并还原值
2. **导出功能**: 增加导出当前查询结果的功能（CSV/JSON 格式），位置在"结果""消息"页签标题行右侧

#### 3. 快捷键增强
1. **保存快捷键**: 增加 Ctrl+S（Windows）/ Cmd+S（Mac）保存当前查询功能

---

## 需求澄清决议记录

以下决议来自 `requirements/clarifications.md`，确认日期：2025-12-19

| 编号 | 问题 | 决议 |
|------|------|------|
| 1 | 密码是否必填 | 必填 |
| 2 | 测试连接失败处理 | 允许直接保存，无需测试 |
| 3 | 多SQL执行策略 | 批量执行，遇错停止 |
| 4 | 结果显示方式 | 多结果集标签页 |
| 5 | 自动联想触发时机 | 实时自动触发 |
| 6 | 语法错误反馈 | 红色波浪线 + 悬浮提示 |
| 7 | 停止执行行为 | 仅中断，不回滚 |
| 8 | 连接信息存储 | 基础字段 |
| 9 | 数据库树刷新 | 手动刷新整个树 |
| 10 | 标签页管理 | 简单管理 |

---

## 需求审查决议记录

以下决议来自需求审查，确认日期：2025-12-19

| 编号 | 问题 | 决议 |
|------|------|------|
| P0-1 | 执行计划图表展示形式 | 流程图 |
| P1-1 | 服务地址格式 | host:port |
| P1-2 | 端口默认值 | 3306（MySQL） |
| P1-3 | 联想列表最大数量 | 20条 |
| P1-4 | 联想列表更新方式 | 随用户输入实时更新 |
| P1-5 | 联想列表排序规则 | 按字符串排序 |
| P1-6 | 支持的SQL方言 | MySQL |
| P1-7 | 执行超时时间 | 默认10分钟，后续增加用户设置 |
| P1-8 | 执行计划数据库支持 | MySQL（EXPLAIN格式） |
| P2-1 | 加密算法 | AES对称加密 |
| P2-2 | 结果集最大行数 | 默认5000行，用户可修改 |
| P2-3 | 树节点右键菜单 | 增加"刷新"功能 |
